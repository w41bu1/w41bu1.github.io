---
title: CVE-2025-12349 Analysis & POC
description: Security Vulnerability in WordPress Email Subscribers & Newsletters Plugin.
date: 2025-12-14 19:00:00 +0700
categories: [CVE Analysis]
tags: [analyst, plugin, broken access control]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Plugin **Icegram Express â€“ Email Subscribers, Newsletters and Marketing Automation** cho **WordPress** bá»‹ **lá»— há»•ng Authorization** trong cÃ¡c phiÃªn báº£n **tá»« trÆ°á»›c Ä‘áº¿n vÃ  bao gá»“m 5.9.10**. NguyÃªn nhÃ¢n lÃ  do plugin **khÃ´ng xÃ¡c thá»±c Ä‘Ãºng quyá»n cá»§a ngÆ°á»i dÃ¹ng** khi thá»±c hiá»‡n hÃ nh Ä‘á»™ng trong hÃ m **`trigger_mailing_queue_sending`**.
Äiá»u nÃ y cho phÃ©p **káº» táº¥n cÃ´ng khÃ´ng cáº§n xÃ¡c thá»±c (unauthenticated attackers)** cÃ³ thá»ƒ **Ã©p há»‡ thá»‘ng gá»­i email ngay láº­p tá»©c**, **bá» qua lá»‹ch gá»­i (schedule)**, **tÄƒng táº£i mÃ¡y chá»§**, vÃ  **thay Ä‘á»•i tráº¡ng thÃ¡i cá»§a plugin** (vÃ­ dá»¥: **`last-cron-hit`**), tá»« Ä‘Ã³ **táº¡o Ä‘iá»u kiá»‡n cho hÃ nh vi láº¡m dá»¥ng hoáº·c cÃ¡c hiá»‡u á»©ng giá»‘ng DoS**.


* **CVE ID**: [CVE-2025-12349](https://www.cve.org/CVERecord?id=CVE-2025-12349)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 5.9.10
* **Patched Versions**: 5.9.11
* **CVSS severity**: Low (5.3)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Email Subscribers & Newsletters Plugin](https://wordpress.org/plugins/email-subscribers/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Email Subscribers & Newsletters**:  
    * `5.9.10` â€“ **vulnerable**  
    * `5.9.11` â€“ **patched**
* **Diff Tool (diff)** â†’ [**Meld**](https://meldmerge.org/) hoáº·c báº¥t ká»³ cÃ´ng cá»¥ diff nÃ o.

## Analysis 
Plugin Ä‘Äƒng kÃ½ **action hook** nhÆ° sau:

```php {title="class-es-queue.php v5.9.10" hl_lines=[] data-open=true}
add_action(
    'wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending',
    array( $this, 'trigger_mailing_queue_sending' )
);
```

Hook **`wp_ajax_nopriv_`** lÃ  cÆ¡ cháº¿ cho phÃ©p **táº¥t cáº£ ngÆ°á»i dÃ¹ng**, bao gá»“m cáº£ **ngÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p**, truy cáº­p vÃ o **AJAX endpoint** cá»§a WordPress.

VÃ¬ váº­y, khi truy cáº­p endpoint **`/wp-admin/admin-ajax.php`** vá»›i tham sá»‘:

```
action=ig_es_trigger_mailing_queue_sending
```

WordPress sáº½ **gá»i trá»±c tiáº¿p callback** **`trigger_mailing_queue_sending`** mÃ  **khÃ´ng cÃ³ báº¥t ká»³ kiá»ƒm tra xÃ¡c thá»±c hay phÃ¢n quyá»n nÃ o**, dáº«n Ä‘áº¿n viá»‡c **báº¥t ká»³ ai** cÅ©ng cÃ³ thá»ƒ kÃ­ch hoáº¡t **logic gá»­i email qua cron**, **bá» qua lá»‹ch gá»­i**, vÃ  **lÃ m thay Ä‘á»•i tráº¡ng thÃ¡i ná»™i bá»™ cá»§a plugin**.

```php {title="class-es-queue.php v5.9.10" hl_lines=[3,5] data-open=true}
public function trigger_mailing_queue_sending() {
    // Call cron action only when it is not locked.
    if ( ! ES()->cron->is_locked() ) {
        // Start processing of campaigns which are scheduled for current date time.
        do_action( 'ig_es_cron_worker' );
    }
}
```

HÃ m **`trigger_mailing_queue_sending()`** cÃ³ nhiá»‡m vá»¥ **kÃ­ch hoáº¡t tiáº¿n trÃ¬nh cron gá»­i email** cá»§a plugin.

* Äáº§u tiÃªn, hÃ m kiá»ƒm tra tráº¡ng thÃ¡i **lock** cá»§a cron thÃ´ng qua **`ES()->cron->is_locked()`**.
* Náº¿u cron **Ä‘ang bá»‹ khÃ³a**, hÃ m sáº½ **khÃ´ng thá»±c hiá»‡n gÃ¬**, nháº±m trÃ¡nh viá»‡c nhiá»u tiáº¿n trÃ¬nh gá»­i email cháº¡y song song.
* Náº¿u cron **chÆ°a bá»‹ khÃ³a**, hÃ m sáº½ gá»i **`do_action( 'ig_es_cron_worker' )`**.

2 callback Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½ cho action hook `ig_es_cron_worker`:

```php {title="class-es-queue.php v5.9.10" hl_lines=[3,5] data-open=true}
add_action( 'ig_es_cron_worker', array( &$this, 'process_campaigns' ), 10 );
add_action( 'ig_es_cron_worker', array( &$this, 'process_queue' ), 30 );
```

Hook nÃ y sáº½ gá»i callback theo thá»© tá»± Æ°u tiÃªn: `process_campaigns()` cháº¡y trÆ°á»›c vÃ  `process_queue()` cháº¡y sau

```php {title="class-es-queue.php v5.9.10" hl_lines=[] data-open=true}
public function process_campaigns() {

    if ( ES()->cron->should_unlock() ) {
        ES()->cron->unlock();
    }

    ES()->cron->set_last_hit();

    // ...
    $es_c_croncount = ES()->mailer->get_total_emails_send_now();

    if ( $es_c_croncount > 0 ) {

        // ...
        $notification = ES_DB_Mailing_Queue::get_notification_to_be_sent( $campaign_hash );
        $notification_guid = isset( $notification['hash'] ) ? $notification['hash'] : null;
        $campaign_id = isset( $notification['campaign_id'] ) ? $notification['campaign_id'] : 0;

        // ...

        if ( ! is_null( $notification_guid ) ) {

            $cron_job = 'ig_es_cron_worker';

            // ...
            if ( ! $this->is_cron_job_locked( $cron_job ) ) {

                $locking_status = $this->lock_cron_job( $cron_job );
                if ( 'locked' === $locking_status ) {

                    // ...
                    ES_DB_Mailing_Queue::update_sent_status( $notification_guid, 'Sending' );

                    // ...
                    $emails_data = ES_DB_Sending_Queue::get_emails_to_be_sent_by_hash(
                        $notification_guid,
                        $es_c_croncount
                    );

                    if ( count( $emails_data ) > 0 ) {

                        // ...
                        ES()->mailer->send(
                            $notification['subject'],
                            $notification['body'],
                            array_column( $emails_data, 'email' ),
                            array( 'guid' => $notification_guid )
                        );

                        // ...
                        if ( ES_DB_Sending_Queue::get_total_emails_to_be_sent_by_hash( $notification_guid ) === 0 ) {
                            ES_DB_Mailing_Queue::update_sent_status( $notification_guid, 'Sent' );
                        }

                        // ...
                    }

                    $this->unlock_cron_job( $cron_job );
                }
            }
        }
    }
}
```

**HÃ m `process_campaigns()`:**
* Má»Ÿ khÃ³a cron náº¿u cáº§n vÃ  cáº­p nháº­t thá»i Ä‘iá»ƒm cron cháº¡y.
* Láº¥y **giá»›i háº¡n sá»‘ email** cÃ³ thá»ƒ gá»­i trong má»™t láº§n cháº¡y.
* Láº¥y **campaign Ä‘ang chá» gá»­i** tá»« `ig_es_mailing_queue`.
* Kiá»ƒm tra vÃ  **lock cron job** Ä‘á»ƒ trÃ¡nh cháº¡y song song.
* Chuyá»ƒn tráº¡ng thÃ¡i campaign sang **`Sending`**.
* Láº¥y danh sÃ¡ch email cáº§n gá»­i theo **batch size** tá»« `ig_es_sending_queue`.
* Thá»±c hiá»‡n **gá»­i email hÃ ng loáº¡t**.
* Náº¿u Ä‘Ã£ gá»­i háº¿t email, cáº­p nháº­t tráº¡ng thÃ¡i campaign sang **`Sent`**.
* Cuá»‘i cÃ¹ng **unlock cron job** Ä‘á»ƒ cÃ¡c láº§n cháº¡y sau tiáº¿p tá»¥c xá»­ lÃ½.

```php {title="class-es-queue.php v5.9.10" hl_lines=[] data-open=true}
public function process_queue() {

    global $wpdb;

    if ( ES()->cron->should_unlock() ) {
        ES()->cron->unlock();
    }

    ES()->cron->set_last_hit();

    $email_sending_limit = ES()->mailer->get_total_emails_send_now();

    if ( $email_sending_limit > 0 ) {

        $micro_time = microtime( true );

        ...
        $notifications = $wpdb->get_results(
            ...
        );

        $batch_start_time = time();

        if ( is_array( $notifications ) && count( $notifications ) > 0 ) {

            ...
            $contacts = ES()->contacts_db->get_details_by_ids( $contact_ids );

            foreach ( $campaigns_notifications as $campaign_id => $notifications ) {

                ...

                foreach ( $notifications as $notification ) {

                    ...

                    if ( 'optin_confirmation' === $notification_type ) {
                        ...
                    } elseif ( 'optin_welcome_email' === $notification_type ) {
                        ...
                    } else {
                        ...
                    }

                    $email_sending_limit--;

                    if ( $email_sent ) {
                        $this->db->delete_from_queue( $campaign_id, $contact_id );
                    }

                    if (
                        $email_sending_limit <= 0 ||
                        IG_ES_Background_Process_Helper::time_exceeded( $batch_start_time, 0.8 ) ||
                        IG_ES_Background_Process_Helper::memory_exceeded()
                    ) {
                        break 2;
                    }
                }
            }
        }
    }
}
```

**HÃ m `process_queue()`:**

* Kiá»ƒm tra vÃ  má»Ÿ khÃ³a cron náº¿u cáº§n, sau Ä‘Ã³ cáº­p nháº­t thá»i Ä‘iá»ƒm cron cháº¡y láº§n cuá»‘i.
* XÃ¡c Ä‘á»‹nh sá»‘ lÆ°á»£ng email tá»‘i Ä‘a cÃ³ thá»ƒ gá»­i trong má»™t láº§n thá»±c thi.
* Truy váº¥n báº£ng `ig_queue` Ä‘á»ƒ láº¥y cÃ¡c email Ä‘Ã£ Ä‘áº¿n thá»i Ä‘iá»ƒm gá»­i nhÆ°ng chÆ°a Ä‘Æ°á»£c gá»­i.
* Gom cÃ¡c báº£n ghi theo `campaign_id` vÃ  láº¥y thÃ´ng tin contact tÆ°Æ¡ng á»©ng.
* Vá»›i tá»«ng contact trong queue, xÃ¡c Ä‘á»‹nh loáº¡i email vÃ  thá»±c hiá»‡n gá»­i phÃ¹ há»£p.
* Náº¿u gá»­i thÃ nh cÃ´ng, xÃ³a báº£n ghi tÆ°Æ¡ng á»©ng khá»i queue.
* Dá»«ng xá»­ lÃ½ khi Ä‘áº¡t giá»›i háº¡n gá»­i, gáº§n háº¿t thá»i gian thá»±c thi hoáº·c vÆ°á»£t giá»›i háº¡n bá»™ nhá»›.

> [!BUG]
> **Lá»— há»•ng phÃ¡t sinh do khÃ´ng thá»±c hiá»‡n báº¥t ká»³ kiá»ƒm tra quyá»n (capability/permission) nÃ o.**
> HÃ m xá»­ lÃ½ Ä‘Æ°á»£c gáº¯n vá»›i hook **`wp_ajax_nopriv_`**, cho phÃ©p **ngÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p** gá»i trá»±c tiáº¿p endpoint AJAX. Khi callback Ä‘Æ°á»£c thá»±c thi, code **khÃ´ng kiá»ƒm tra quyá»n ngÆ°á»i dÃ¹ng**, **khÃ´ng xÃ¡c thá»±c nonce**, dáº«n Ä‘áº¿n viá»‡c **báº¥t ká»³ ai** cÅ©ng cÃ³ thá»ƒ kÃ­ch hoáº¡t logic ná»™i bá»™ (cron gá»­i email), **bá» qua lá»‹ch gá»­i**, vÃ  **thay Ä‘á»•i tráº¡ng thÃ¡i há»‡ thá»‘ng**.

**Báº£n vÃ¡ (v5.9.11)** kháº¯c phá»¥c lá»— há»•ng báº±ng cÃ¡ch **bá»• sung kiá»ƒm soÃ¡t truy cáº­p vÃ  xÃ¡c thá»±c yÃªu cáº§u** trÆ°á»›c khi cho phÃ©p kÃ­ch hoáº¡t cron gá»­i email.

```php {title="class-es-queue.php v5.9.10" hl_lines=[3,5] data-open=true}
public function trigger_mailing_queue_sending() {
    $can_access_campaign = ES_Common::ig_es_can_access( 'campaigns' );
    $nonce = ig_es_get_request_data( 'nonce' );
    
    if ( ! $can_access_campaign ) {	
        return;
    } 

    if ( empty( $nonce ) || ! wp_verify_nonce( $nonce, 'ig-es-trigger-mailing-queue-sending-nonce' ) ) {
        return;
    }
        
    // Call cron action only when it is not locked.
    if ( ! ES()->cron->is_locked() ) {		
        // Start processing of campaigns which are scheduled for current date time.
        do_action( 'ig_es_cron_worker' );
    }
}
```

* **Kiá»ƒm tra quyá»n (capability check)**

  ```php
  $can_access_campaign = ES_Common::ig_es_can_access( 'campaigns' );
  ```

  Chá»‰ ngÆ°á»i dÃ¹ng cÃ³ quyá»n truy cáº­p **campaigns** má»›i Ä‘Æ°á»£c phÃ©p tiáº¿p tá»¥c. Náº¿u khÃ´ng cÃ³ quyá»n â†’ **return** ngay.

    ```php {title="class-es-common.php v5.9.11" hl_lines=[4,8,10] data-open=true}
    public static function ig_es_can_access( $page ) {
        $user = wp_get_current_user();

        if ( ! $user->exists() ) {
            return false;
        }

        $default_permission = 'manage_options';

        $can_access = $user->has_cap( $default_permission );

        // Is Admin? Have full access.
        if ( $can_access ) {
            return true;
        }

        // We are using this filter in ES Premium to check permission.
        return apply_filters( 'ig_es_can_access', $can_access, $page );
    }
    ```
    HÃ m **`ig_es_can_access()`** dÃ¹ng Ä‘á»ƒ kiá»ƒm tra quyá»n truy cáº­p cá»§a ngÆ°á»i dÃ¹ng hiá»‡n táº¡i. Náº¿u ngÆ°á»i dÃ¹ng **chÆ°a Ä‘Äƒng nháº­p** thÃ¬ bá»‹ tá»« chá»‘i ngay. Máº·c Ä‘á»‹nh, chá»‰ nhá»¯ng user cÃ³ quyá»n **`manage_options`** (Administrator) má»›i Ä‘Æ°á»£c phÃ©p truy cáº­p. TrÆ°á»ng há»£p khÃ´ng cÃ³ quyá»n nÃ y, káº¿t quáº£ sáº½ phá»¥ thuá»™c vÃ o **filter `ig_es_can_access`** Ä‘á»ƒ cho phÃ©p má»Ÿ rá»™ng hoáº·c tÃ¹y chá»‰nh quyá»n.

* **XÃ¡c thá»±c nonce (CSRF protection)**

  ```php
  $nonce = ig_es_get_request_data( 'nonce' );
  wp_verify_nonce( $nonce, 'ig-es-trigger-mailing-queue-sending-nonce' );
  ```

  Äáº£m báº£o request lÃ  há»£p lá»‡ vÃ  Ä‘Æ°á»£c táº¡o tá»« giao diá»‡n há»£p phÃ¡p cá»§a WordPress, ngÄƒn viá»‡c gá»i trá»±c tiáº¿p tá»« bÃªn ngoÃ i.

* **Giá»¯ nguyÃªn logic cÅ© nhÆ°ng Ä‘áº·t sau kiá»ƒm tra báº£o máº­t**
  Chá»‰ sau khi **Ä‘Ã£ qua kiá»ƒm tra quyá»n vÃ  nonce**, hÃ m má»›i kiá»ƒm tra **cron lock** vÃ  gá»i:

  ```php
  do_action( 'ig_es_cron_worker' );
  ```

ğŸ‘‰ Káº¿t quáº£: endpoint AJAX **khÃ´ng cÃ²n bá»‹ láº¡m dá»¥ng bá»Ÿi ngÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p**, ngÄƒn viá»‡c **Ã©p gá»­i email**, **bá» qua lá»‹ch**, vÃ  **DoS-like behavior** nhÆ° trÆ°á»›c.

## Flow
{{< mermaid >}}
graph TD

A["Unauthenticated attacker"] --> B["Send request to /wp-admin/admin-ajax.php?action=ig_es_trigger_mailing_queue_sending"]
B --> C["wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending hook"]
C --> D["trigger_mailing_queue_sending() is executed"]
D --> E{"Capability check?"}
E -- No --> F["No permission validation"]
F --> G{"Nonce verification?"}
G -- No --> H["No CSRF protection"]
H --> I{"Cron locked?"}
I -- No --> J["do_action('ig_es_cron_worker')"]
J --> K["process_campaigns()"]
J --> L["process_queue()"]
K --> M["Force email campaigns to send immediately"]
L --> N["Force queued emails to be sent"]
M --> O["Bypass schedule & update campaign states"]
N --> O
O --> P["Broken Access Control / Abuse / DoS-like behavior"]
{{< /mermaid >}}

## Proof of Concept (PoC)
GÆ°i request vá»›i Unauthenticated user:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost

action=ig_es_trigger_mailing_queue_sending
```

## Conclusion

CVE-2025-12349 xuáº¥t phÃ¡t tá»« viá»‡c plugin Icegram Express Ä‘Äƒng kÃ½ AJAX endpoint vá»›i `wp_ajax_nopriv_` nhÆ°ng khÃ´ng thá»±c hiá»‡n báº¥t ká»³ kiá»ƒm tra quyá»n hay xÃ¡c thá»±c nonce nÃ o trong hÃ m `trigger_mailing_queue_sending`. Äiá»u nÃ y cho phÃ©p ngÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p kÃ­ch hoáº¡t trá»±c tiáº¿p cron ná»™i bá»™ cá»§a plugin, dáº«n Ä‘áº¿n viá»‡c Ã©p gá»­i email, bá» qua lá»‹ch gá»­i, cáº­p nháº­t tráº¡ng thÃ¡i campaign vÃ  gÃ¢y Ã¡p lá»±c khÃ´ng cáº§n thiáº¿t lÃªn há»‡ thá»‘ng. Báº£n vÃ¡ á»Ÿ phiÃªn báº£n 5.9.11 Ä‘Ã£ kháº¯c phá»¥c triá»‡t Ä‘á»ƒ váº¥n Ä‘á» báº±ng cÃ¡ch bá»• sung kiá»ƒm tra capability vÃ  xÃ¡c thá»±c nonce trÆ°á»›c khi cho phÃ©p thá»±c thi logic cron.

## Key Takeaways

* KhÃ´ng bao giá» gáº¯n logic nháº¡y cáº£m vÃ o `wp_ajax_nopriv_` mÃ  thiáº¿u kiá»ƒm tra quyá»n.
* AJAX endpoint trong WordPress luÃ´n pháº£i káº¿t há»£p **capability check** vÃ  **nonce verification**.
* Cron hoáº·c background process cÃ³ tÃ¡c Ä‘á»™ng há»‡ thá»‘ng cáº§n Ä‘Æ°á»£c báº£o vá»‡ nhÆ° cÃ¡c hÃ nh Ä‘á»™ng quáº£n trá»‹.
* Broken Access Control cÃ³ thá»ƒ dáº«n Ä‘áº¿n láº¡m dá»¥ng chá»©c nÄƒng ngay cáº£ khi khÃ´ng rÃ² rá»‰ dá»¯ liá»‡u trá»±c tiáº¿p.

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress Email Subscribers & Newsletters Plugin <= 5.9.10 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/email-subscribers/vulnerability/wordpress-email-subscribers-newsletters-plugin-5-9-10-missing-authentication-to-unauthenticated-mailing-queue-trigger-vulnerability) 