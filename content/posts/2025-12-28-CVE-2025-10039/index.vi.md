---
title: CVE-2025-10039 Analysis & POC
description: Security Vulnerability in WordPress ELEX WordPress HelpDesk & Customer Ticketing System Plugin.
date: 2025-12-28 19:00:00 +0700
categories: [CVE Analysis]
tags: [analyst, plugin, idor]
images: ["app.png"]
featuredImage: "app.png"

lightgallery: true

toc:
  auto: false
---

<!--more-->

## CVE & Basic Info
Plugin **Fluent Forms – Customizable Contact Forms, Survey, Quiz, & Conversational Form Builder** tồn tại **lỗ hổng Insecure Direct Object Reference (IDOR)** trong tất cả các phiên bản **≤ 3.2.9** thông qua tham số `submission_id` trong endpoint xác nhận thanh toán SCA.
Lỗ hổng cho phép **người dùng chưa xác thực** có thể **đánh dấu submission của người khác là failed**, gây gián đoạn quá trình thanh toán.

* **CVE ID**: [CVE-2025-10039](https://www.cve.org/CVERecord?id=CVE-2025-10039)
* **Vulnerability Type**: Insecure Direct Object References (IDOR)
* **Affected Versions**: <= 3.2.9
* **Patched Versions**: 3.3.0
* **CVSS severity**: Low (4.3)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress ELEX WordPress HelpDesk & Customer Ticketing System Plugin](https://wordpress.org/plugins/elex-helpdesk-customer-support-ticket-system/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **ELEX WordPress HelpDesk & Customer Ticketing System**:  
    * `3.2.9` – **vulnerable**  
    * `3.3.0` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đăng ký AJAX handler **cho người dùng đã đăng nhập**:

```php {title="class-crm-ajax-functions.php v3.2.9" data-open=true hl_lines=[]}
add_action( 'wp_ajax_eh_crm_ticket_single_view_client', array( 'CRM_Ajax', 'eh_crm_ticket_single_view_client' ) );
```

`wp_ajax_` là hook dành cho người dùng đã đăng nhập (Subcriber+). Khi có request tới endpoint `/wp-admin/admin-ajax.php` với param `action=eh_crm_ticket_single_view_client` thì callback `eh_crm_ticket_single_view_client` được gọi:

```php {title="class-crm-ajax-functions.php v3.2.9" data-open=true hl_lines=[4]}
public static function eh_crm_ticket_single_view_client() {
    if ( wp_verify_nonce( isset( $_POST['nonce'] ) ? sanitize_text_field( $_POST['nonce'] ) : '', 'wsdesk_nonce' ) ) {
        $ticket_id = isset( $_POST['ticket_id'] ) ? sanitize_text_field( $_POST['ticket_id'] ) : '';
        $content   = self::eh_crm_ticket_single_view_client_gen( $ticket_id );
        wp_send_json_success( array( 'page' => $content ) );
        die;
    }
}
```

Hàm thực hiện kiểm tra `nonce` giúp chống CSRF

Sau đó lấy `ticket_id` từ request, gọi hàm `eh_crm_ticket_single_view_client_gen()` xử lý, lấy nội dung của ticket tương ứng với `ticker_id`

Cuối cùng trả về nội dung dạng JSON.

```php {title="class-crm-ajax-functions.php v3.2.9" data-open=true hl_lines=[]}
public static function eh_crm_ticket_single_view_client_gen( $ticket_id ) {

    // Lấy dữ liệu ticket dựa trên ticket_id do user truyền vào
    $current      = eh_crm_get_ticket( array( 'ticket_id' => $ticket_id ) );
    $current_meta = eh_crm_get_ticketmeta( $ticket_id );

    // Lấy thông tin người dùng nội bộ (agent/admin)
    $users_data = get_users( array(
        'role__in' => array( 'administrator', 'WSDesk_Agents', 'WSDesk_Supervisor' )
    ));

    ...

    // Render nội dung ticket (HTML output)
    echo esc_html( $current[0]['ticket_title'] );
    echo esc_html( $current[0]['ticket_email'] );
    echo esc_html( $current[0]['ticket_date'] );

    ...

    // Hiển thị nội dung hội thoại, file đính kèm, metadata
    self::eh_crm_ticket_reply_section_gen_client( $ticket_id );

    ...

    return ob_get_clean();
}
```

Hàm `eh_crm_ticket_single_view_client_gen` và `eh_crm_get_ticketmeta` được gọi để truy xuất dữ liệu của ticket:

```php {title="class-crm-public-functions.php v3.2.9" data-open=true hl_lines=[]}
function eh_crm_get_ticket( $args, $fields = null ) {
	set_time_limit( 300 );
	$query = wpFluent()->table( tables: 'wsdesk_tickets' )->where( 'ticket_trash', 0 );

	if ( null !== $fields ) {
		$fields = is_array( $fields ) ? $fields : array( $fields );
		foreach ( $fields as $field ) {
			$query->select( $field );
		}
	}

	if ( is_array( $args ) ) {
		foreach ( $args as $key => $value ) {
			$allowed_fileds = array( 'ticket_id', 'ticket_author', 'ticket_email', 'ticket_date', 'ticket_title', 'ticket_parent', 'ticket_category', 'ticket_vendor', 'ticket_trash' );
			if ( in_array( $key, $allowed_fileds, true ) ) {
				$query->where( $key, $value );
			}
		}
	}

	$ticket = (array) $query->first();

	if ( ! $ticket ) {
		return false;
	}

	if ( isset( $ticket['ticket_content'] ) ) {
		$ticket['ticket_content'] = wp_kses_post( $ticket['ticket_content'] );
	}

	return array( $ticket );
}
```


```php {title="class-crm-public-functions.php v3.2.9" data-open=true hl_lines=[]}
function eh_crm_get_ticketmeta( $id, $key = null ) {
	set_time_limit( 300 );
	global $wpdb;
	$data     = $wpdb->get_results( $wpdb->prepare( 'SELECT meta_key,meta_value FROM ' . $wpdb->prefix . 'wsdesk_ticketsmeta WHERE ticket_id = %d', (int) $id ), ARRAY_A );
	$retrived = array();
	if ( null !== $key ) {
		$data = $wpdb->get_results( $wpdb->prepare( 'SELECT meta_key,meta_value FROM ' . $wpdb->prefix . 'wsdesk_ticketsmeta WHERE ticket_id = %d AND meta_key = %s', (int) $id, $key ), ARRAY_A );
	}
	if ( ! $data ) {
		return false;
	}
	if ( null !== $key ) {
		return maybe_unserialize( $data[0]['meta_value'] );
	}
	for ( $i = 0; $i < count( $data ); $i++ ) {
		$retrived[ $data[ $i ]['meta_key'] ] = maybe_unserialize( $data[ $i ]['meta_value'] );
	}
	return maybe_unserialize( $retrived );
}
```

> [!BUG] Không có bất kỳ kiểm tra nào để xác nhận người dùng hiện tại có phải là chủ sở hữu ticket hay không, có quyền xem ticket này hay không => IDOR

**Bản vá v3.3.0**

![Patch](diff.png "Bản vá v3.3.0")

Bản vá đã **ngăn chặn IDOR bằng cách ràng buộc quyền truy cập theo người dùng**, cụ thể:

* So sánh `ticket_author` với `current_user_id` để đảm bảo người xem là chủ sở hữu ticket
* Chỉ cho phép truy cập nếu người dùng thuộc nhóm được cấp quyền (`administrator`, `WSDesk_Agents`, `WSDesk_Supervisor`)
* Từ chối mọi truy cập không hợp lệ trước khi trả dữ liệu

Nhờ đó, không thể truy cập ticket của người khác chỉ bằng cách thay đổi `ticket_id`.

## Flow
{{< mermaid >}}
flowchart TD
A["Authenticated User (Subcriber+)"] 
--> B["Request admin-ajax.php?action=eh_crm_ticket_single_view_client"]

B --> C["Verify nonce"]

C --> D["Get ticket_id from request"]

D --> E["Load ticket by ticket_id"]

E --> F["No ownership check"]
F --> G["No role validation"]

G --> H["Return full ticket data"]

H --> I["User can view other users' tickets (IDOR)"]
{{< /mermaid >}}


## Proof of Concept (PoC)
1. Login với Subcriber+ user:
2. Submit 1 ticket bất kì
3. Tại bảng `Your Tickets`, lấy `nonce` bằng cách view source:

![Nonce](nonce.png "Lấy nonce")

4. Gửi request với `nonce` vừa lấy được

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: Subcriber+ cookie

action=eh_crm_ticket_single_view_client&nonce=4de88a7186&ticket_id=any_ticket_id 
```

**Result**:

![Result](result.png "Result")

Thông tin trả về chứa nội dung của ticket và cả thông tin author của ticket

## Conclusion

Lỗ hổng xảy ra do endpoint `eh_crm_ticket_single_view_client` **không kiểm tra quyền sở hữu ticket**, chỉ dựa vào `ticket_id` do người dùng cung cấp.
Điều này cho phép bất kỳ người dùng đã đăng nhập nào truy cập ticket của người khác → **IDOR**.

Bản vá khắc phục bằng cách:

* So sánh `ticket_author` với `current_user_id`
* Chỉ cho phép các role được cấp quyền truy cập
* Từ chối request nếu không hợp lệ trước khi trả dữ liệu

## Key Takeaways

* `nonce` **không thay thế cho kiểm tra phân quyền**
* Không được tin dữ liệu ID do client gửi lên
* Luôn kiểm tra **ownership** trước khi truy xuất dữ liệu
* Authorization phải được xử lý ở backend, trước khi trả response

## References
[IDOR](https://book.hacktricks.wiki/en/pentesting-web/idor.html)

[WordPress ELEX WordPress HelpDesk & Customer Ticketing System Plugin <= 3.2.9 is vulnerable to Insecure Direct Object References (IDOR)](https://patchstack.com/database/wordpress/plugin/elex-helpdesk-customer-support-ticket-system/vulnerability/wordpress-elex-wordpress-helpdesk-customer-ticketing-system-plugin-3-2-9-authenticated-subscriber-insecure-direct-object-reference-via-eh-crm-ticket-single-view-client-vulnerability)