# CVE-2025-12349 Analysis & POC


<!--more-->

## CVE & Basic Info
The **Icegram Express â€“ Email Subscribers, Newsletters and Marketing Automation** plugin for **WordPress** is affected by an **Authorization vulnerability** in versions **up to and including 5.9.10**. The root cause is that the plugin **does not properly validate user permissions** when performing actions in the **`trigger_mailing_queue_sending`** function.
This allows **unauthenticated attackers** to **force the system to send emails immediately**, **bypass the sending schedule**, **increase server load**, and **modify the pluginâ€™s state** (for example: **`last-cron-hit`**), thereby **enabling abuse or DoS-like effects**.

* **CVE ID**: [CVE-2025-12349](https://www.cve.org/CVERecord?id=CVE-2025-12349)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 5.9.10
* **Patched Versions**: 5.9.11
* **CVSS severity**: Low (5.3)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Email Subscribers & Newsletters Plugin](https://wordpress.org/plugins/email-subscribers/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Email Subscribers & Newsletters**:  
    * `5.9.10` â€“ **vulnerable**  
    * `5.9.11` â€“ **patched**
* **Diff Tool (diff)** â†’ [**Meld**](https://meldmerge.org/) or any diff tool.

## Analysis 
The plugin registers the following **action hook**:

```php {title="class-es-queue.php v5.9.10" hl_lines=[] data-open=true}
add_action(
    'wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending',
    array( $this, 'trigger_mailing_queue_sending' )
);
```

The **`wp_ajax_nopriv_`** hook is a mechanism that allows **all users**, including **unauthenticated users**, to access WordPress **AJAX endpoints**.

Therefore, when accessing the endpoint **`/wp-admin/admin-ajax.php`** with the parameter:

```
action=ig_es_trigger_mailing_queue_sending
```

WordPress will **directly invoke the callback** **`trigger_mailing_queue_sending`** **without any authentication or authorization checks**, allowing **anyone** to trigger the **email sending cron logic**, **bypass the schedule**, and **modify the internal state of the plugin**.

```php {title="class-es-queue.php v5.9.10" hl_lines=[3,5] data-open=true}
public function trigger_mailing_queue_sending() {
    // Call cron action only when it is not locked.
    if ( ! ES()->cron->is_locked() ) {
        // Start processing of campaigns which are scheduled for current date time.
        do_action( 'ig_es_cron_worker' );
    }
}
```

The **`trigger_mailing_queue_sending()`** function is responsible for **triggering the pluginâ€™s email sending cron process**.

* First, the function checks the cron **lock** status via **`ES()->cron->is_locked()`**.
* If the cron **is locked**, the function **does nothing**, preventing multiple email-sending processes from running concurrently.
* If the cron **is not locked**, the function calls **`do_action( 'ig_es_cron_worker' )`**.

Two callbacks are registered for the `ig_es_cron_worker` action hook:

```php {title="class-es-queue.php v5.9.10" hl_lines=[3,5] data-open=true}
add_action( 'ig_es_cron_worker', array( &$this, 'process_campaigns' ), 10 );
add_action( 'ig_es_cron_worker', array( &$this, 'process_queue' ), 30 );
```

This hook invokes callbacks based on priority: `process_campaigns()` runs first and `process_queue()` runs afterward.

```php {title="class-es-queue.php v5.9.10" hl_lines=[] data-open=true}
public function process_campaigns() {

    if ( ES()->cron->should_unlock() ) {
        ES()->cron->unlock();
    }

    ES()->cron->set_last_hit();

    // ...
    $es_c_croncount = ES()->mailer->get_total_emails_send_now();

    if ( $es_c_croncount > 0 ) {

        // ...
        $notification = ES_DB_Mailing_Queue::get_notification_to_be_sent( $campaign_hash );
        $notification_guid = isset( $notification['hash'] ) ? $notification['hash'] : null;
        $campaign_id = isset( $notification['campaign_id'] ) ? $notification['campaign_id'] : 0;

        // ...

        if ( ! is_null( $notification_guid ) ) {

            $cron_job = 'ig_es_cron_worker';

            // ...
            if ( ! $this->is_cron_job_locked( $cron_job ) ) {

                $locking_status = $this->lock_cron_job( $cron_job );
                if ( 'locked' === $locking_status ) {

                    // ...
                    ES_DB_Mailing_Queue::update_sent_status( $notification_guid, 'Sending' );

                    // ...
                    $emails_data = ES_DB_Sending_Queue::get_emails_to_be_sent_by_hash(
                        $notification_guid,
                        $es_c_croncount
                    );

                    if ( count( $emails_data ) > 0 ) {

                        // ...
                        ES()->mailer->send(
                            $notification['subject'],
                            $notification['body'],
                            array_column( $emails_data, 'email' ),
                            array( 'guid' => $notification_guid )
                        );

                        // ...
                        if ( ES_DB_Sending_Queue::get_total_emails_to_be_sent_by_hash( $notification_guid ) === 0 ) {
                            ES_DB_Mailing_Queue::update_sent_status( $notification_guid, 'Sent' );
                        }

                        // ...
                    }

                    $this->unlock_cron_job( $cron_job );
                }
            }
        }
    }
}
```

**`process_campaigns()` function:**

* Unlocks the cron if needed and updates the cron execution timestamp.
* Retrieves the **maximum number of emails** that can be sent in a single run.
* Retrieves **pending campaigns** from `ig_es_mailing_queue`.
* Checks and **locks the cron job** to prevent concurrent execution.
* Updates the campaign status to **`Sending`**.
* Retrieves the list of emails to be sent based on the **batch size** from `ig_es_sending_queue`.
* Performs **bulk email sending**.
* If all emails have been sent, updates the campaign status to **`Sent`**.
* Finally, **unlocks the cron job** to allow subsequent runs.

```php {title="class-es-queue.php v5.9.10" hl_lines=[] data-open=true}
public function process_queue() {

    global $wpdb;

    if ( ES()->cron->should_unlock() ) {
        ES()->cron->unlock();
    }

    ES()->cron->set_last_hit();

    $email_sending_limit = ES()->mailer->get_total_emails_send_now();

    if ( $email_sending_limit > 0 ) {

        $micro_time = microtime( true );

        ...
        $notifications = $wpdb->get_results(
            ...
        );

        $batch_start_time = time();

        if ( is_array( $notifications ) && count( $notifications ) > 0 ) {

            ...
            $contacts = ES()->contacts_db->get_details_by_ids( $contact_ids );

            foreach ( $campaigns_notifications as $campaign_id => $notifications ) {

                ...

                foreach ( $notifications as $notification ) {

                    ...

                    if ( 'optin_confirmation' === $notification_type ) {
                        ...
                    } elseif ( 'optin_welcome_email' === $notification_type ) {
                        ...
                    } else {
                        ...
                    }

                    $email_sending_limit--;

                    if ( $email_sent ) {
                        $this->db->delete_from_queue( $campaign_id, $contact_id );
                    }

                    if (
                        $email_sending_limit <= 0 ||
                        IG_ES_Background_Process_Helper::time_exceeded( $batch_start_time, 0.8 ) ||
                        IG_ES_Background_Process_Helper::memory_exceeded()
                    ) {
                        break 2;
                    }
                }
            }
        }
    }
}
```

**`process_queue()` function:**

* Checks and unlocks the cron if needed, then updates the last cron run timestamp.
* Determines the maximum number of emails that can be sent in a single execution.
* Queries the `ig_queue` table to retrieve emails that are due to be sent but have not yet been sent.
* Groups records by `campaign_id` and retrieves corresponding contact information.
* For each contact in the queue, determines the email type and sends the appropriate email.
* If sending is successful, removes the corresponding record from the queue.
* Stops processing when the sending limit is reached, execution time is nearly exhausted, or memory limits are exceeded.

> [!BUG]
> **The vulnerability arises because no capability or permission checks are performed.**
> The handler is attached to the **`wp_ajax_nopriv_`** hook, allowing **unauthenticated users** to directly call the AJAX endpoint. When the callback is executed, the code **does not check user permissions** and **does not verify a nonce**, allowing **anyone** to trigger internal logic (email sending cron), **bypass scheduling**, and **modify system state**.

**The patch (v5.9.11)** fixes the vulnerability by **adding access control and request validation** before allowing the email sending cron to be triggered.

public function trigger_mailing_queue_sending() {
$can_access_campaign = ES_Common::ig_es_can_access( 'campaigns' );
$nonce = ig_es_get_request_data( 'nonce' );

```php {title="class-es-queue.php v5.9.10" hl_lines=[3,5] data-open=true}
public function trigger_mailing_queue_sending() {
    $can_access_campaign = ES_Common::ig_es_can_access( 'campaigns' );
    $nonce = ig_es_get_request_data( 'nonce' );
    
    if ( ! $can_access_campaign ) {	
        return;
    } 

    if ( empty( $nonce ) || ! wp_verify_nonce( $nonce, 'ig-es-trigger-mailing-queue-sending-nonce' ) ) {
        return;
    }
        
    // Call cron action only when it is not locked.
    if ( ! ES()->cron->is_locked() ) {		
        // Start processing of campaigns which are scheduled for current date time.
        do_action( 'ig_es_cron_worker' );
    }
}
```

* **Capability check**

  ```php
  $can_access_campaign = ES_Common::ig_es_can_access( 'campaigns' );
  ```

  Only users with permission to access **campaigns** are allowed to proceed. If the user lacks permission â†’ **return** immediately.
  ```php {title="class-es-common.php v5.9.11" hl_lines=[4,8,10] data-open=true}
    public static function ig_es_can_access( $page ) {
        $user = wp_get_current_user();

        if ( ! $user->exists() ) {
            return false;
        }

        $default_permission = 'manage_options';

        $can_access = $user->has_cap( $default_permission );

        // Is Admin? Have full access.
        if ( $can_access ) {
            return true;
        }

        // We are using this filter in ES Premium to check permission.
        return apply_filters( 'ig_es_can_access', $can_access, $page );
    }
    ```
  The **`ig_es_can_access()`** function checks the access rights of the current user. If the user **is not logged in**, access is immediately denied. By default, only users with the **`manage_options`** capability (Administrator) are allowed access. If the user does not have this capability, the result depends on the **`ig_es_can_access` filter**, allowing extension or customization of permissions.

* **Nonce verification (CSRF protection)**

  ```php
  $nonce = ig_es_get_request_data( 'nonce' );
  wp_verify_nonce( $nonce, 'ig-es-trigger-mailing-queue-sending-nonce' );
  ```

  Ensures the request is legitimate and generated from a valid WordPress interface, preventing direct external calls.

* **Preserving existing logic but placing it after security checks**
  Only after **passing capability and nonce checks** does the function check the **cron lock** and invoke:

  ```php
  do_action( 'ig_es_cron_worker' );
  ```

ðŸ‘‰ Result: the AJAX endpoint **can no longer be abused by unauthenticated users**, preventing **forced email sending**, **schedule bypass**, and **DoS-like behavior** as before.

## Flow

{{< mermaid >}}
graph TD

A["Unauthenticated attacker"] --> B["Send request to /wp-admin/admin-ajax.php?action=ig_es_trigger_mailing_queue_sending"]
B --> C["wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending hook"]
C --> D["trigger_mailing_queue_sending() is executed"]
D --> E{"Capability check?"}
E -- No --> F["No permission validation"]
F --> G{"Nonce verification?"}
G -- No --> H["No CSRF protection"]
H --> I{"Cron locked?"}
I -- No --> J["do_action('ig_es_cron_worker')"]
J --> K["process_campaigns()"]
J --> L["process_queue()"]
K --> M["Force email campaigns to send immediately"]
L --> N["Force queued emails to be sent"]
M --> O["Bypass schedule & update campaign states"]
N --> O
O --> P["Broken Access Control / Abuse / DoS-like behavior"]
{{< /mermaid >}}

## Proof of Concept (PoC)

Send request as an unauthenticated user:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost

action=ig_es_trigger_mailing_queue_sending
```

## Conclusion

CVE-2025-12349 originates from the Icegram Express plugin registering an AJAX endpoint with `wp_ajax_nopriv_` without performing any capability checks or nonce verification in the `trigger_mailing_queue_sending` function. This allows unauthenticated users to directly trigger the pluginâ€™s internal cron, leading to forced email sending, schedule bypass, campaign state updates, and unnecessary system load. The patch in version 5.9.11 fully resolves the issue by adding capability checks and nonce verification before allowing cron logic execution.

## Key Takeaways

* Never attach sensitive logic to `wp_ajax_nopriv_` without proper permission checks.
* WordPress AJAX endpoints must always combine **capability checks** and **nonce verification**.
* Cron or background processes with system impact should be protected like administrative actions.
* Broken Access Control can lead to functional abuse even without direct data leakage.

## References

[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress Email Subscribers & Newsletters Plugin <= 5.9.10 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/email-subscribers/vulnerability/wordpress-email-subscribers-newsletters-plugin-5-9-10-missing-authentication-to-unauthenticated-mailing-queue-trigger-vulnerability)


---

> Author: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/posts/2025-12-14-cve-2025-12349/  

