# CVE-2025-58674 Analysis & POC


<!--more-->

Lỗ hổng **Stored Cross Site Scripting(XSS)** xảy ra trên WordPress Core trước phiên bản `6.8.3`. Nguyên nhân do sai xử lý đầu vào khi sinh trang web động, tác động đến chức năng tạo menu (`nav menus`)

* **CVE ID**: [CVE-2025-58674](https://www.cve.org/CVERecord?id=CVE-2025-58674)
* **Vulnerability Type**: Cross Site Scripting (XSS)
* **Affected Versions**: <= 6.8.2
* **Patched Versions**: 6.8.3
* **CVSS severity**: Low (5.9)
* **Required Privilege**: Author
* **Product**: [WordPressCore](https://wordpress.org/)

## Requirements

* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Wordpress Core Versions**: **v6.8.2** (vulnerable) và **v6.8.3** (patched).
* **Diff Tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.
* **Theme** - [**Astra**](https://wordpress.org/themes/astra/): Theme rất phổ biến với người dùng WordPress, hỗ trợ tạo **nav memu** nhanh chóng.

## Analysis

WordPress là phần mềm mã nguồn mở, có kho lưu trữ nằm ở github nên ta có thể tìm đến [commit](https://github.com/WordPress/WordPress/commit/e5caef19d3e842cc9c8c94621b223a9a696fb5b3) liên quan đến sự kiện vá lỗ hổng XSS để quan sát sự thay đổi, hiểu được lỗ hổng xảy ra ở đâu.

### Patch diff

**Bản lỗi**:

```js
updateParentDropdown : function() {
    return this.each(function(){
        var menuItems = $( '#menu-to-edit li' ),
            parentDropdowns = $( '.edit-menu-item-parent' );

        $.each( parentDropdowns, function() {
            var parentDropdown = $( this ),
                $html = '',
                $selected = '',
                currentItemID = parentDropdown.closest( 'li.menu-item' ).find( '.menu-item-data-db-id' ).val(),
                currentparentID = parentDropdown.closest( 'li.menu-item' ).find( '.menu-item-data-parent-id' ).val(),
                currentItem = parentDropdown.closest( 'li.menu-item' ),
                currentMenuItemChild = currentItem.childMenuItems(),
                excludeMenuItem = [ currentItemID ];

            if ( currentMenuItemChild.length > 0 ) {
                $.each( currentMenuItemChild, function(){
                    var childItem = $(this),
                        childID = childItem.find( '.menu-item-data-db-id' ).val();

                    excludeMenuItem.push( childID );
                });
            }

            if ( currentparentID == 0 ) {
                $selected = 'selected';
            }

            $html += '<option ' + $selected + ' value="0">' + wp.i18n._x( 'No Parent', 'menu item without a parent in navigation menu' ) + '</option>';

            $.each( menuItems, function() {
                var menuItem = $(this),
                $selected = '',
                menuID = menuItem.find( '.menu-item-data-db-id' ).val(),
                menuTitle = menuItem.find( '.edit-menu-item-title' ).val();

                if ( ! excludeMenuItem.includes( menuID ) ) {
                    if ( currentparentID == menuID ) {
                        $selected = 'selected';
                    }
                    $html += '<option ' + $selected + ' value="' + menuID + '">' + menuTitle + '</option>';
                }
            });

            parentDropdown.html( $html );
        });
        
    });
},
```

Trong phiên bản lỗi, giá trị `menuTitle` được chèn vào thẻ `<option>` và được hiển thị ra HTML bằng phương thức [html()](https://api.jquery.com/html/) của **jQuery** mà không có bất kỳ cơ chế ngăn chặn XSS nào. Hàm [html()](https://api.jquery.com/html/) dùng để thay thế nội dung HTML bên trong phần tử hiện tại, nên nếu `menuTitle` chứa mã độc thì mã đó sẽ được thực thi trên trình duyệt.

**Bản vá**:

```js
updateParentDropdown : function() {
    return this.each(function(){
        var menuItems = $( '#menu-to-edit li' ),
            parentDropdowns = $( '.edit-menu-item-parent' );

        $.each( parentDropdowns, function() {
            var parentDropdown = $( this ),
                currentItemID = parseInt( parentDropdown.closest( 'li.menu-item' ).find( '.menu-item-data-db-id' ).val() ),
                currentParentID = parseInt( parentDropdown.closest( 'li.menu-item' ).find( '.menu-item-data-parent-id' ).val() ),
                currentItem = parentDropdown.closest( 'li.menu-item' ),
                currentMenuItemChild = currentItem.childMenuItems(),
                excludeMenuItem =  /** @type {number[]} */ [ currentItemID ];

            parentDropdown.empty();

            if ( currentMenuItemChild.length > 0 ) {
                $.each( currentMenuItemChild, function(){
                    var childItem = $(this),
                        childID = parseInt( childItem.find( '.menu-item-data-db-id' ).val() );

                    excludeMenuItem.push( childID );
                });
            }

            parentDropdown.append(
                $( '<option>', {
                    value: '0',
                    selected: currentParentID === 0,
                    text: wp.i18n._x( 'No Parent', 'menu item without a parent in navigation menu' ),
                } )
            );

            $.each( menuItems, function() {
                var menuItem = $(this),
                menuID = parseInt( menuItem.find( '.menu-item-data-db-id' ).val() ),
                menuTitle = menuItem.find( '.edit-menu-item-title' ).val();

                if ( ! excludeMenuItem.includes( menuID ) ) {
                    parentDropdown.append(
                        $( '<option>', {
                            value: menuID.toString(),
                            selected: currentParentID === menuID,
                            text: menuTitle,
                        } )
                    );
                }
            });
        });
        
    });
},
```

Bản vá đã khắc phục lỗ hổng bằng cách chỉ định rõ `menuTitle` được gán vào thuộc tính `text` thay vì nội dung HTML.
Điều này đảm bảo giá trị của `menuTitle` được xử lý như văn bản thuần túy, không thể chứa hoặc thực thi mã JavaScript độc hại.
Nhờ đó, dữ liệu được thêm vào thẻ `<option>` hoàn toàn an toàn và loại bỏ khả năng tấn công XSS thông qua giá trị `menuTitle`.

{{< figure src="dif.png" caption="So sánh sự khác biệt giữa bản lỗi và bản vá" >}}

### Vulnerable code

Inpsect code trên trình duyệt ta thấy `menuItems = #menu-to-edit li` là mảng các thẻ `<li>` thuộc thẻ `<ul>` có `id=menu-to-edit`

{{< figure src="viewsource.png" caption="Inspect code trên trình duyệt" >}}

Hàm `updateParentDropdown` sẽ duyệt các thẻ `<li>` lấy value của `<input>` có class `edit-menu-item-title`, gán giá trị đó cho `menuTitle` trong thẻ `<option>` và hiển thị ra HTML.

{{< figure src="viewsource1.png" caption="Inspect DOM sau khi thêm menu" >}}

**Trên UI**:

{{< figure src="UIlist.png" caption="Hình ảnh hiển thị trên giao diện quản trị" >}}

Trong [commit](https://github.com/WordPress/WordPress/commit/e5caef19d3e842cc9c8c94621b223a9a696fb5b3) có một sửa đổi tưởng chừng là hữu ích, nhưng chả có ích cho quá trình phân tích.

{{< figure src="htmlett.png" caption="HTML entity encode (1)" >}}

Tôi đã sử dụng `//` để comment tất cả các dòng liên quan đến `html_entity_decode` của `origin_title` nhưng vẫn khai thác được. Trước đó tôi đã đặt debug đến các vị trí này nhưng không có gì xảy ra.

Ngoài việc sử dụng comment, tôi đã chọn menu chứa XSS payload và click <kbd>Add to Menu</kbd>, bắt request bằng **BurpSuite** để xem giá trị được add có được html entity encode không.

{{< figure src="htmlett1.png" caption="HTML entity encode (2)" >}}

`menu-item-title` là giá trị lấy thẻ input có name `menu-item[-5][menu-item-title]` từ `post-title` được **check** để thêm vào body của request

```html
<input type="hidden" class="menu-item-title" name="menu-item[-5][menu-item-title]" value="<script>alert(document.domain)</script>">
```

Có 1 điều thú vị ở đây, trình duyệt lấy giá trị đã decode html entity để thêm vào request, biết giá trị từ server trước khi echo ra HTML đã được encode

{{< figure src="htmlett2.png" caption="Trình duyệt decode HTML entity trước khi gửi" >}}

👉 Browser đã decode html entity trước khi hiển thị ra HTML.

Trên DOM, sau khi click <kbd>Add to Menu</kbd> => `attachTabsPanelListeners` được gọi và thêm giá trị vừa **selected** vào bottom của menu item.

{{< figure src="addbottom.png" caption="Thêm item vào cuối danh sách menu" >}}

👉 `edit-menu-item-title` có giá trị chứa XSS payload. Hàm `updateParentDropdown` sẽ lấy nó gán cho thẻ `<option>` => XSS xảy ra

### Sources & Sinks

* **Source**: `post-title` tiêu đề của post
* **Sink**: `parentDropdown.html( $html )` có thể chứa HTML độc hại

```php
$html += '<option ' + $selected + ' value="' + menuID + '">' + menuTitle + '</option>';
```

## Exploit

### Proof of Concept (PoC)

* Sử dụng tài khoản author, tạo post có title chứa XSS payload
* Admin truy cập endpoint `wp-admin/nav-menus.php` và thực hiện add menus từ post vừa tạo
* Sự kiện Javascript được kích hoạt

{{< figure src="xss.png" caption="Proof of Concept: XSS" >}}

> Thẻ `<script>` nằm trong `<option>` thuộc `<select>` có thể thực thi được nhưng các thẻ khác thì không, chỉ trả về text chứa trong đó.
> {: .prompt-info }

* Khi browser parse chuỗi HTML, `<script>` không nằm trong flow `<option>` thực sự mà parser “nhấc” script ra khỏi `<option>` và đưa vào DOM tree.

```html
<select name="" id="">
    <option value="">abc</option>
    <option value=""><script>alert(1)</script></option>
</select>
```

* Vì thế, script thực thi ngay, còn `<option>` vẫn tồn tại, nhưng nội dung `<option>` trống hoặc hiển thị text rỗng.

{{< figure src="inspect1.png" caption="Inspect DOM sau khi script được tách" >}}

* Đối với các thẻ khác

```html
<select name="" id="">
	<option value="">abc</option>
	<option value=""><b>abd</b></option>
</select>
```

- Browser tuân thủ spec: `<option>` chỉ chứa text-only.
- Khi parse `<b>` hoặc `<img>` trong `<option>`:
    - `<b>` bị coi là text => mất tag, chỉ hiển thị abd như text.
    - `<img>` bị loại bỏ hoàn toàn.

{{< figure src="inspect2.png" caption="Inspect: render option với thẻ inline" >}}

## Conclusion

CVE-2025-58674 cho thấy rủi ro khi chèn dữ liệu người dùng trực tiếp vào HTML bằng `html()` hoặc `innerHTML`. `<script>` trong `<option>` được parser tách ra và thực thi, trong khi các thẻ khác bị bỏ hoặc coi là text. Bản vá sử dụng thuộc tính `text` để đảm bảo an toàn, loại bỏ XSS.

## Key takeaways

* Không nối chuỗi HTML từ dữ liệu user rồi chèn bằng `html()`/`innerHTML`.
* Dùng API tạo element an toàn (`option.text`, `document.createElement`).
* Luôn escape/sanitize dữ liệu ở cả server và client.
* Hiểu hành vi parser: `<script>` có thể thoát khỏi container inert.

## References

[Cross-site scripting (XSS) cheat sheet — PortSwigger](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

[ WordPress Core <= 6.8.2 is vulnerable to Cross Site Scripting (XSS) ](https://patchstack.com/database/wordpress/wordpress/wordpress/vulnerability/wordpress-wordpress-wordpress-6-8-2-cross-site-scripting-xss-vulnerability)


---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-10-11-cve-2025-58674/  

