<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="vi">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>CVE-2025-9501 Analysis &amp; POC - Bui Van Y</title><meta name="author" content="Bui Van Y">
<meta name="description" content="Security Vulnerability in WordPress W3 Total Cache Plugin."><meta name="keywords" content='analyst, plugin, remote code execution'>
  <meta itemprop="name" content="CVE-2025-9501 Analysis & POC">
  <meta itemprop="description" content="Security Vulnerability in WordPress W3 Total Cache Plugin.">
  <meta itemprop="datePublished" content="2025-11-22T19:00:00+07:00">
  <meta itemprop="dateModified" content="2025-11-23T02:14:28+07:00">
  <meta itemprop="wordCount" content="2273">
  <meta itemprop="image" content="http://localhost:1313/posts/2025-11-22-cve-2025-9501/app.jpg">
  <meta itemprop="keywords" content="Analyst,Plugin,Remote Code Execution"><meta property="og:url" content="http://localhost:1313/vi/posts/2025-11-22-cve-2025-9501/">
  <meta property="og:site_name" content="Bui Van Y">
  <meta property="og:title" content="CVE-2025-9501 Analysis & POC">
  <meta property="og:description" content="Security Vulnerability in WordPress W3 Total Cache Plugin.">
  <meta property="og:locale" content="vi">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-22T19:00:00+07:00">
    <meta property="article:modified_time" content="2025-11-23T02:14:28+07:00">
    <meta property="article:tag" content="Analyst">
    <meta property="article:tag" content="Plugin">
    <meta property="article:tag" content="Remote Code Execution">
    <meta property="og:image" content="http://localhost:1313/posts/2025-11-22-cve-2025-9501/app.jpg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/posts/2025-11-22-cve-2025-9501/app.jpg">
  <meta name="twitter:title" content="CVE-2025-9501 Analysis & POC">
  <meta name="twitter:description" content="Security Vulnerability in WordPress W3 Total Cache Plugin.">
<meta name="application-name" content="Bui Van Y">
<meta name="apple-mobile-web-app-title" content="Bui Van Y"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/svg-spinners--wind-toy.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/vi/posts/2025-11-22-cve-2025-9501/" title="CVE-2025-9501 Analysis &amp; POC - Bui Van Y" /><link rel="prev" type="text/html" href="http://localhost:1313/vi/posts/2025-11-21-cve-2025-2939/" title="CVE-2025-2939 Analysis &amp; POC" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/vi/posts/2025-11-22-cve-2025-9501/index.md" title="CVE-2025-9501 Analysis & POC - Bui Van Y"><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "CVE-2025-9501 Analysis \u0026 POC",
    "inLanguage": "vi",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/vi\/posts\/2025-11-22-cve-2025-9501\/"
    },"image": ["http:\/\/localhost:1313\/images\/avatar.png"],"genre": "posts","keywords": "analyst, plugin, remote code execution","wordcount":  2273 ,
    "url": "http:\/\/localhost:1313\/vi\/posts\/2025-11-22-cve-2025-9501\/","datePublished": "2025-11-22T19:00:00+07:00","dateModified": "2025-11-23T02:14:28+07:00","publisher": {
      "@type": "Organization",
      "name": "/images/avatar.png","logo": "http:\/\/localhost:1313\/images\/avatar.png"},"author": {
        "@type": "Person",
        "name": "Bui Van Y"
      },"description": "Security Vulnerability in WordPress W3 Total Cache Plugin."
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-instant-intensity="viewport" data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/vi/" title="Bui Van Y"><img class="logo" src='/images/svg-spinners--wind-toy.svg' alt="Bui Van Y" height="32" width="32"><span class="header-title-text">Bui Van Y</span></a><span class="typeit header-subtitle"><template>w41bu1</template></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/vi/posts/"><i class="fa-solid fa-file-alt fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/vi/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/vi/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Tìm tiêu đề hoặc nội dung..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Tìm kiếm">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Xoá">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" role="button" aria-label="Đổi chủ đề" title="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></li><li class="menu-item language-switch">
            <span role="button" aria-label="Chọn Ngôn ngữ" title="Chọn Ngôn ngữ"><i class="fa-solid fa-language fa-fw" aria-hidden="true"></i></span>
            <ul class="sub-menu"><li class="menu-item"><a href="/posts/2025-11-22-cve-2025-9501/" class="menu-link" title="English">English</a></li><li class="menu-item"><span class="text-secondary" title="Vietnamese">Vietnamese</span></li></ul>
          </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/vi/" title="Bui Van Y"><img class="logo" src='/images/svg-spinners--wind-toy.svg' alt="Bui Van Y" height="26" width="26"><span class="header-title-text">Bui Van Y</span></a><span class="typeit header-subtitle"><template>w41bu1</template></span></div>
      <div class="theme-switch" role="button" aria-label="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></div>
      <div class="menu-toggle" id="menu-toggle-mobile" role="button" aria-labelledby="menu-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Tìm tiêu đề hoặc nội dung..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Tìm kiếm">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Xoá">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Huỷ
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/vi/posts/"><i class="fa-solid fa-file-alt fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item"><a class="menu-link" href="/vi/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="/vi/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system"><span class="menu-system-item language-switch">
              <span role="button" aria-label="Chọn Ngôn ngữ" title="Chọn Ngôn ngữ">Vietnamese<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i></span>
              <select id="language-select" class="language-select" onchange="location = this.value;"><option value="/posts/2025-11-22-cve-2025-9501/">English</option><option value="/vi/posts/2025-11-22-cve-2025-9501/" selected disabled>Vietnamese</option></select>
            </span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"><div class="details related-details open">
      <div class="details-summary related-summary">
        <i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden="true"></i>
        <span class="related-title">Nội dung liên quan</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
      <div class="details-content related-content">
        <ul class="related-list"><li class="related-item">
              <a href="/vi/posts/2025-11-21-cve-2025-2939/" title="CVE-2025-2939 Analysis &amp; POC">CVE-2025-2939 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-20-cve-2025-49386/" title="CVE-2025-53572 Analysis &amp; POC">CVE-2025-53572 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-19-cve-2025-6742/" title="CVE-2025-6742 Analysis &amp; POC">CVE-2025-6742 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-18-cve-2025-53572/" title="CVE-2025-53572 Analysis &amp; POC">CVE-2025-53572 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-17-cve-2025-49401/" title="CVE-2025-49401 Analysis &amp; POC">CVE-2025-49401 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-14-cve-2025-9083/" title="CVE-2025-9083 Analysis &amp; POC">CVE-2025-9083 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-13-cve-2025-7847/" title="CVE-2025-7847 Analysis &amp; POC">CVE-2025-7847 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-04-cve-2025-62065/" title="CVE-2025-62065 Analysis &amp; POC">CVE-2025-62065 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-03-cve-2025-2940/" title="CVE-2025-2940 Analysis &amp; POC">CVE-2025-2940 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-11-02-cve-2025-1043/" title="CVE-2025-1043 Analysis &amp; POC">CVE-2025-1043 Analysis &amp; POC</a></li></ul>
      </div>
    </div></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>CVE-2025-9501 Analysis &amp; POC</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="github.com/w41bu1" title="Tác giả" rel=" author" class="author"><img class="avatar" src='/images/avatar.png' alt="Bui Van Y" height="16" width="16">&nbsp;Bui Van Y</a></span><span class="post-included-in">&nbsp;trong <a href="/vi/categories/cve-analyst/" class="post-category" title="Danh mục - CVE Analyst"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> CVE Analyst</a></span></div><div class="post-meta-line"><span title="đăng ngày 2025-11-22 19:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-11-22">2025-11-22</time></span>&nbsp;<span title="Cập nhật ngày 2025-11-23 02:14:28"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2025-11-23">2025-11-23</time></span>&nbsp;<span title="2273 từ"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>Khoảng 2300 từ</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>11 phút</span>&nbsp;</div>
    </div><div class="featured-image"><img src='/posts/2025-11-22-cve-2025-9501/app.jpg' alt="/posts/2025-11-22-cve-2025-9501/app.jpg"></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Nội dung</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cve--basic-info">CVE &amp; Basic Info</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#cause">Cause</a></li>
    <li><a href="#analysis">Analysis</a></li>
    <li><a href="#flow">Flow</a></li>
    <li><a href="#proof-of-concept-poc">Proof of Concept (PoC)</a></li>
  </ul>

  <ul>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 class="heading-element" id="cve--basic-info"><span>CVE &amp; Basic Info</span>
  <a href="#cve--basic-info" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Plugin W3 Total Cache WordPress trước phiên bản 2.8.13 tồn tại lỗ hổng command injection thông qua hàm _parse_dynamic_mfunc, cho phép người dùng chưa xác thực thực thi các lệnh PHP bằng cách gửi một comment chứa payload độc hại vào bài viết.</p>
<ul>
<li><strong>CVE ID</strong>: <a href="https://www.cve.org/CVERecord?id=CVE-2025-9501"target="_blank" rel="external nofollow noopener noreferrer">CVE-2025-9501</a></li>
<li><strong>Vulnerability Type</strong>: PHP Object Injection</li>
<li><strong>Affected Versions</strong>: &lt;= 2.8.12</li>
<li><strong>Patched Versions</strong>: 2.8.13</li>
<li><strong>CVSS severity</strong>: High (9)</li>
<li><strong>Required Privilege</strong>: Unauthenticated</li>
<li><strong>Product</strong>: <a href="https://wordpress.org/plugins/w3-total-cache/"target="_blank" rel="external nofollow noopener noreferrer">WordPress W3 Total Cache Plugin</a></li>
</ul>
<h2 class="heading-element" id="requirements"><span>Requirements</span>
  <a href="#requirements" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li><strong>Local WordPress &amp; Debugging</strong>
<ul>
<li><a href="https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/"target="_blank" rel="external nofollow noopener noreferrer">Virtual Machine</a></li>
<li><a href="https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/"target="_blank" rel="external nofollow noopener noreferrer">Docker</a></li>
</ul>
</li>
<li><strong>Plugin Version</strong> - <strong>W3 Total Cache</strong>:
<ul>
<li><code>2.8.12</code> – <strong>vulnerable</strong></li>
<li><code>2.8.13</code> – <strong>patched</strong></li>
</ul>
</li>
<li><strong>Diff Tool (diff)</strong> → <a href="https://meldmerge.org/"target="_blank" rel="external nofollow noopener noreferrer"><strong>Meld</strong></a> hoặc bất kỳ công cụ diff nào.</li>
</ul>
<h2 class="heading-element" id="cause"><span>Cause</span>
  <a href="#cause" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Theo như mô tả, lỗ hổng xuất phát từ hàm <code>_parse_dynamic_mfunc</code></p>
<div class="highlight" title="PgCache_ContentGrabber.php v2.8.12" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="hl"><span class="lnt">11
</span></span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">_parse_dynamic_mfunc</span><span class="p">(</span> <span class="nv">$matches</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$code1</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$code2</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$code</span>  <span class="o">=</span> <span class="p">(</span> <span class="nv">$code1</span> <span class="o">?</span> <span class="nv">$code1</span> <span class="o">:</span> <span class="nv">$code2</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nv">$code</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$code</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span> <span class="nv">$code</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span> <span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ob_start</span><span class="p">();</span>
</span></span><span class="line hl"><span class="cl">            <span class="nv">$result</span> <span class="o">=</span> <span class="k">eval</span><span class="p">(</span> <span class="nv">$code</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$output</span> <span class="o">=</span> <span class="nx">ob_get_contents</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ob_end_clean</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="nx">\Exception</span> <span class="nv">$ex</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$result</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="k">false</span> <span class="o">===</span> <span class="nv">$result</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$output</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span> <span class="s1">&#39;Unable to execute code: %s&#39;</span><span class="p">,</span> <span class="nx">htmlspecialchars</span><span class="p">(</span> <span class="nv">$code</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$output</span> <span class="o">=</span> <span class="nx">htmlspecialchars</span><span class="p">(</span> <span class="s1">&#39;Invalid mfunc tag syntax. The correct format is: &lt;!-- W3TC_DYNAMIC_SECURITY mfunc PHP code --&gt;&lt;!-- /mfunc W3TC_DYNAMIC_SECURITY --&gt; or &lt;!-- W3TC_DYNAMIC_SECURITY mfunc --&gt;PHP code&lt;!-- /mfunc W3TC_DYNAMIC_SECURITY --&gt;.&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hàm <code>eval()</code> xuất hiện tại dòng 11. Nó là một hàm rất đặc biệt và nguy hiểm vì nó cho phép thực thi một chuỗi PHP như là code thực sự. Ví dụ:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$command</span> <span class="o">=</span> <span class="s1">&#39;system(&#34;rm -rf /&#34;)&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">eval</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 class="heading-element" id="analysis"><span>Analysis</span>
  <a href="#analysis" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Khi plugin được install và active, nó sẽ thêm vào đầu dòng của <code>wp-config.php</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="sd">/** Enable W3 Total Cache */</span>
</span></span><span class="line"><span class="cl"><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;WP_CACHE&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> <span class="c1">// Added by W3 Total Cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Dùng để đăng kí tính năng cache cho WordPress. <code>WP_CACHE</code> được gọi trong <code>wp-settings.php</code></p>
<div class="highlight" title="wp-settings.php" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="hl"><span class="lnt">1
</span></span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line hl"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="nx">WP_CACHE</span> <span class="o">&amp;&amp;</span> <span class="nx">apply_filters</span><span class="p">(</span> <span class="s1">&#39;enable_loading_advanced_cache_dropin&#39;</span><span class="p">,</span> <span class="k">true</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">file_exists</span><span class="p">(</span> <span class="nx">WP_CONTENT_DIR</span> <span class="o">.</span> <span class="s1">&#39;/advanced-cache.php&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// For an advanced caching plugin to use. Uses a static drop-in because you would only want one.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">include</span> <span class="nx">WP_CONTENT_DIR</span> <span class="o">.</span> <span class="s1">&#39;/advanced-cache.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Re-initialize any hooks added manually by advanced-cache.php.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span> <span class="nv">$wp_filter</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$wp_filter</span> <span class="o">=</span> <span class="nx">WP_Hook</span><span class="o">::</span><span class="na">build_preinitialized_hooks</span><span class="p">(</span> <span class="nv">$wp_filter</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>WordPress sẽ tự động load file <code>advanced-cache.php</code> nếu nó tồn tại. Khi plugin được active thì nó đã tạo ra file này:</p>
<div class="highlight" title="advanced-cache.php" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="hl"><span class="lnt">40
</span></span><span class="lnt">41
</span><span class="hl"><span class="lnt">42
</span></span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * File: advanced-cache.php
</span></span></span><span class="line"><span class="cl"><span class="sd"> *
</span></span></span><span class="line"><span class="cl"><span class="sd"> * W3 Total Cache advanced cache module.
</span></span></span><span class="line"><span class="cl"><span class="sd"> *
</span></span></span><span class="line"><span class="cl"><span class="sd"> * @package W3TC
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">defined</span><span class="p">(</span> <span class="s1">&#39;ABSPATH&#39;</span> <span class="p">)</span> <span class="o">||</span> <span class="k">die</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">global</span> <span class="nv">$w3tc_start_microtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$w3tc_start_microtime</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span> <span class="k">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * Abort W3TC loading if WordPress is upgrading.
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="nx">defined</span><span class="p">(</span> <span class="s1">&#39;WP_INSTALLING&#39;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">WP_INSTALLING</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">defined</span><span class="p">(</span> <span class="s1">&#39;W3TC_IN_MINIFY&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">defined</span><span class="p">(</span> <span class="s1">&#39;W3TC_DIR&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">define</span><span class="p">(</span> <span class="s1">&#39;W3TC_DIR&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="nx">defined</span><span class="p">(</span> <span class="s1">&#39;WP_PLUGIN_DIR&#39;</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">WP_PLUGIN_DIR</span> <span class="o">:</span> <span class="nx">WP_CONTENT_DIR</span> <span class="o">.</span> <span class="s1">&#39;/plugins&#39;</span> <span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;/w3-total-cache&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">@</span><span class="nx">is_dir</span><span class="p">(</span> <span class="nx">W3TC_DIR</span> <span class="p">)</span> <span class="o">||</span> <span class="o">!</span> <span class="nx">file_exists</span><span class="p">(</span> <span class="nx">W3TC_DIR</span> <span class="o">.</span> <span class="s1">&#39;/w3-total-cache-api.php&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span> <span class="nx">defined</span><span class="p">(</span> <span class="s1">&#39;WP_ADMIN&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Only display errors in wp-admin.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">printf</span><span class="p">(</span> <span class="s1">&#39;&lt;strong&gt;W3 Total Cache Error:&lt;/strong&gt; some files appear to be missing or out of place. Please re-install plugin or remove &lt;strong&gt;%s&lt;/strong&gt;. &lt;br /&gt;&#39;</span><span class="p">,</span> <span class="no">__FILE__</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">require_once</span> <span class="nx">W3TC_DIR</span> <span class="o">.</span> <span class="s1">&#39;/w3-total-cache-api.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span> <span class="nx">class_exists</span><span class="p">(</span> <span class="s1">&#39;\W3TC\Dispatcher&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$w3tc_redirect</span> <span class="o">=</span> <span class="nx">\W3TC\Dispatcher</span><span class="o">::</span><span class="na">component</span><span class="p">(</span> <span class="s1">&#39;Mobile_Redirect&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$w3tc_redirect</span><span class="o">-&gt;</span><span class="na">process</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nv">$w3tc_config</span> <span class="o">=</span> <span class="nx">\W3TC\Dispatcher</span><span class="o">::</span><span class="na">config</span><span class="p">();</span>
</span></span><span class="line hl"><span class="cl">			<span class="k">if</span> <span class="p">(</span> <span class="nv">$w3tc_config</span><span class="o">-&gt;</span><span class="na">get_boolean</span><span class="p">(</span> <span class="s1">&#39;pgcache.enabled&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nv">$o</span> <span class="o">=</span> <span class="nx">\W3TC\Dispatcher</span><span class="o">::</span><span class="na">component</span><span class="p">(</span> <span class="s1">&#39;PgCache_ContentGrabber&#39;</span> <span class="p">);</span>
</span></span><span class="line hl"><span class="cl">				<span class="nv">$o</span><span class="o">-&gt;</span><span class="na">process</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Khi tính năng page cache (<code>pgcache</code>) được bật thì <code>$o-&gt;process()</code> để xử lí logic của page cache.</p>
<p><figure><a class="lightgallery" href="/posts/2025-11-22-cve-2025-9501/page_cache.png" title="Enable page cache" data-thumbnail="/posts/2025-11-22-cve-2025-9501/page_cache.png" data-sub-html="<h2>Page Cache</h2><p>Enable page cache</p>"><img loading="lazy" src='/posts/2025-11-22-cve-2025-9501/page_cache.png' alt="Page Cache" height="593" width="1227"></a><figcaption class="image-caption">Enable page cache</figcaption>
  </figure></p>
<p>Trong <code>process()</code>, plugin chuẩn bị cơ chế can thiệp vào nội dung trang trước khi trả về cho trình duyệt.</p>
<div class="highlight" title="PgCache_ContentGrabber.php v2.8.12" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="hl"><span class="lnt">5
</span></span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">process</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">run_extensions_dropin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Skip caching for some pages.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line hl"><span class="cl">    <span class="nx">Util_Bus</span><span class="o">::</span><span class="na">add_ob_callback</span><span class="p">(</span> <span class="s1">&#39;pagecache&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;ob_callback&#39;</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Tại dòng cuối, hàm gọi:</p>
<div class="highlight" title="PgCache_ContentGrabber.php v2.8.12" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">Util_Bus</span><span class="o">::</span><span class="na">add_ob_callback</span><span class="p">(</span> <span class="s1">&#39;pagecache&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;ob_callback&#39;</span> <span class="p">)</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Điều này có nghĩa là:</p>
<ul>
<li>Plugin đăng ký một callback tên <code>pagecache</code>.</li>
<li>Callback thực tế là phương thức <code>ob_callback</code> của object hiện tại.</li>
<li>Callback này sẽ được gọi <strong>sau khi WordPress sinh xong HTML</strong>, để plugin có cơ hội xử lý (như tối ưu, nén, ghi cache…) trước khi gửi cho trình duyệt.</li>
</ul>
<p>Hàm <code>add_ob_callback()</code> chỉ làm nhiệm vụ lưu callback lại để sử dụng về sau:</p>
<div class="highlight" title="Util_Bus.php v2.8.12" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="hl"><span class="lnt">2
</span></span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">add_ob_callback</span><span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$callback</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">    <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;_w3tc_ob_callbacks&#39;</span><span class="p">][</span> <span class="nv">$key</span> <span class="p">]</span> <span class="o">=</span> <span class="nv">$callback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hàm <code>ob_callback()</code> này được gọi khi output buffer xả nội dung HTML ra, và nó kiểm tra xem trang có “nội dung động” hay không:</p>
<div class="highlight" title="PgCache_ContentGrabber.php v2.8.12" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="hl"><span class="lnt"> 3
</span></span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="hl"><span class="lnt">14
</span></span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">ob_callback</span><span class="p">(</span> <span class="nv">$buffer</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line hl"><span class="cl">    <span class="nv">$has_dynamic</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_has_dynamic</span><span class="p">(</span> <span class="nv">$buffer</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We can&#39;t capture output in ob_callback so we use shutdown function.
</span></span></span><span class="line hl"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span> <span class="nv">$has_dynamic</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_shutdown_buffer</span> <span class="o">=</span> <span class="nv">$buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">register_shutdown_function</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                <span class="s1">&#39;shutdown&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>$buffer</code> là toàn bộ HTML mà WordPress vừa tạo ra.</li>
<li><code>_has_dynamic()</code> kiểm tra xem trong HTML có phần nào <strong>không thể cache trực tiếp</strong>, tức nó không được cố định:</li>
</ol>
<div class="highlight" title="PgCache_ContentGrabber.php v2.8.12" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">_has_dynamic</span><span class="p">(</span> <span class="nv">$buffer</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">defined</span><span class="p">(</span> <span class="s1">&#39;W3TC_DYNAMIC_SECURITY&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">preg_match</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;~&lt;!--\s*m(func|clude)\s*&#39;</span> <span class="o">.</span> <span class="nx">W3TC_DYNAMIC_SECURITY</span> <span class="o">.</span> <span class="s1">&#39;(.*)--&gt;(.*)&lt;!--\s*/m(func|clude)\s*&#39;</span> <span class="o">.</span> <span class="nx">W3TC_DYNAMIC_SECURITY</span> <span class="o">.</span> <span class="s1">&#39;\s*--&gt;~Uis&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$buffer</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Theo như <a href="https://1fix.io/blog/2015/02/22/page-fragment-caching-w3-total-cache/"target="_blank" rel="external nofollow noopener noreferrer">tài liệu</a> tôi tìm được thì <code>W3TC_DYNAMIC_SECURITY</code> sẽ được cấu hình trong <code>wp-config.php</code> nếu muốn sử dụng <code>page fragment caching</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;W3TC_DYNAMIC_SECURITY&#39;</span><span class="p">,</span> <span class="s1">&#39;W3TC_DYNAMIC_SECURITY_VALUE&#39;</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Nội dung động sẽ có dạng:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;!--</span> <span class="nx">mfunc</span><span class="p">{</span><span class="nx">W3TC_DYNAMIC_SECURITY_VALUE</span><span class="p">}</span> <span class="o">--&gt;</span> <span class="nx">PHP</span> <span class="nx">code</span> <span class="o">&lt;!--</span> <span class="o">/</span><span class="nx">mfunc</span><span class="p">{</span><span class="nx">W3TC_DYNAMIC_SECURITY_VALUE</span><span class="p">}</span> <span class="o">--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">or</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;!--</span> <span class="nx">mclude</span><span class="p">{</span><span class="nx">W3TC_DYNAMIC_SECURITY_VALUE</span><span class="p">}</span> <span class="o">--&gt;</span> <span class="nx">PHP</span> <span class="nx">code</span> <span class="o">&lt;!--</span> <span class="o">/</span><span class="nx">mclude</span><span class="p">{</span><span class="nx">W3TC_DYNAMIC_SECURITY_VALUE</span><span class="p">}</span> <span class="o">--&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>
<p>Nếu <strong>không có nội dung động</strong>, hàm trả về <code>$buffer</code> bình thường để có thể ghi cache ngay.</p>
</li>
<li>
<p>Nếu <strong>có nội dung động</strong>:</p>
<ul>
<li>Toàn bộ HTML được lưu lại vào <code>$this-&gt;_shutdown_buffer</code></li>
<li>Hàm trả về chuỗi rỗng (tạm thời không xuất gì ra)</li>
<li>Plugin đăng ký <code>register_shutdown_function()</code> để gọi phương thức <code>shutdown()</code> sau khi PHP kết thúc chạy toàn bộ request
⇒ Việc xử lý HTML bị dời sang cuối cùng, sau khi mọi nội dung động đã sẵn sàng.</li>
</ul>
</li>
</ol>
<div class="highlight" title="PgCache_ContentGrabber.php v2.8.12" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="hl"><span class="lnt"> 5
</span></span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">shutdown</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$compression</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_page_key_extension</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Parse dynamic content.
</span></span></span><span class="line hl"><span class="cl"><span class="c1"></span>    <span class="nv">$buffer</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_parse_dynamic</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_shutdown_buffer</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Compress page according to headers already set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$compressed_buffer</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_compress</span><span class="p">(</span> <span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$compression</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="nv">$compressed_buffer</span><span class="p">;</span> <span class="c1">// phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>shutdown</code> sẽ gọi đến <code>_parse_dynamic()</code> để Xử lý các khối động trong HTML - tìm trong toàn bộ HTML các khối đánh dấu nội dung động của W3TC và thay thế chúng bằng kết quả thực tế:</p>
<div class="highlight" title="PgCache_ContentGrabber.php v2.8.12" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="hl"><span class="lnt"> 7
</span></span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="hl"><span class="lnt">10
</span></span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">_parse_dynamic</span><span class="p">(</span> <span class="nv">$buffer</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">defined</span><span class="p">(</span> <span class="s1">&#39;W3TC_DYNAMIC_SECURITY&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$buffer</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span>
</span></span><span class="line hl"><span class="cl">        <span class="s1">&#39;~&lt;!--\s*mfunc\s*&#39;</span> <span class="o">.</span> <span class="nx">W3TC_DYNAMIC_SECURITY</span> <span class="o">.</span> <span class="s1">&#39;(.*)--&gt;(.*)&lt;!--\s*/mfunc\s*&#39;</span> <span class="o">.</span> <span class="nx">W3TC_DYNAMIC_SECURITY</span> <span class="o">.</span> <span class="s1">&#39;\s*--&gt;~Uis&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">            <span class="s1">&#39;_parse_dynamic_mfunc&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$buffer</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$buffer</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;~&lt;!--\s*mclude\s*&#39;</span> <span class="o">.</span> <span class="nx">W3TC_DYNAMIC_SECURITY</span> <span class="o">.</span> <span class="s1">&#39;(.*)--&gt;(.*)&lt;!--\s*/mclude\s*&#39;</span> <span class="o">.</span> <span class="nx">W3TC_DYNAMIC_SECURITY</span> <span class="o">.</span> <span class="s1">&#39;\s*--&gt;~Uis&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;_parse_dynamic_mclude&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$buffer</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Nếu hằng <code>W3TC_DYNAMIC_SECURITY</code> chưa tồn tại → trả về nguyên HTML, coi như không có nội dung động.</p>
</li>
<li>
<p>Nếu có, hàm lần lượt chạy hai <code>preg_replace_callback()</code>:</p>
<ol>
<li>
<p>Tìm các cặp ghi chú dạng:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;!-- mfunc{security} --&gt; ... &lt;!-- /mfunc{security} --&gt;</span></span></code></pre></td></tr></table>
</div>
</div><p>và gọi <code>_parse_dynamic_mfunc()</code> để xử lý nội dung bên trong.</p>
</li>
<li>
<p>Tìm các cặp ghi chú:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;!-- mclude{security} --&gt; ... &lt;!-- /mclude{security} --&gt;</span></span></code></pre></td></tr></table>
</div>
</div><p>và gọi <code>_parse_dynamic_mclude()</code> để xử lý tương tự.</p>
</li>
</ol>
</li>
<li>
<p>Mỗi callback sẽ nhận đoạn HTML khớp với regex và trả về kết quả động đã được chạy.</p>
</li>
</ul>
<p>Kết quả cuối cùng là <code>$buffer</code> với các khối mfunc/mclude đã được thay thế bằng nội dung thực, sẵn sàng để nén và xuất ra cho người dùng.</p>
<h2 class="heading-element" id="flow"><span>Flow</span>
  <a href="#flow" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="diagram-container">
  <pre class="mermaid">
graph TD

A["User requests any front‑end page (unauthenticated)"]
--> B["WordPress loads wp-settings.php"]

B --> C["WP_CACHE = true → Load advanced-cache.php"]
C --> D["advanced-cache.php runs Dispatcher"]
D --> E["PgCache_ContentGrabber->process()"]

E --> F["Util_Bus::add_ob_callback('pagecache', 'ob_callback')"]
F --> G["WordPress renders full HTML into output buffer"]
G --> H["ob_callback($buffer) triggered"]

H --> I{"_has_dynamic($buffer) ?"}
I -->|No| J["Return buffer as-is → Serve cached page"]
I -->|Yes| K["Save buffer to _shutdown_buffer"]
K --> L["register_shutdown_function(shutdown)"]
L --> M["After request completes → shutdown()"]

M --> N["_parse_dynamic(_shutdown_buffer)"]

N --> O{"HTML contains <!-- mfunc ... --> ?"}
O -->|Yes| P["_parse_dynamic_mfunc()"]
P --> Q["Extract payload from comment and run eval()"]

O -->|Or mclude| R["_parse_dynamic_mclude() (include type)"]

Q --> S["Output replaced with execution result"]
R --> S

S --> T["Page optionally compressed"]
T --> U["echo back to user"]
</pre>
  <pre class="mermaid-dark">
graph TD

A["User requests any front‑end page (unauthenticated)"]
--> B["WordPress loads wp-settings.php"]

B --> C["WP_CACHE = true → Load advanced-cache.php"]
C --> D["advanced-cache.php runs Dispatcher"]
D --> E["PgCache_ContentGrabber->process()"]

E --> F["Util_Bus::add_ob_callback('pagecache', 'ob_callback')"]
F --> G["WordPress renders full HTML into output buffer"]
G --> H["ob_callback($buffer) triggered"]

H --> I{"_has_dynamic($buffer) ?"}
I -->|No| J["Return buffer as-is → Serve cached page"]
I -->|Yes| K["Save buffer to _shutdown_buffer"]
K --> L["register_shutdown_function(shutdown)"]
L --> M["After request completes → shutdown()"]

M --> N["_parse_dynamic(_shutdown_buffer)"]

N --> O{"HTML contains <!-- mfunc ... --> ?"}
O -->|Yes| P["_parse_dynamic_mfunc()"]
P --> Q["Extract payload from comment and run eval()"]

O -->|Or mclude| R["_parse_dynamic_mclude() (include type)"]

Q --> S["Output replaced with execution result"]
R --> S

S --> T["Page optionally compressed"]
T --> U["echo back to user"]
</pre>
  <pre class="mermaid-neutral">
graph TD

A["User requests any front‑end page (unauthenticated)"]
--> B["WordPress loads wp-settings.php"]

B --> C["WP_CACHE = true → Load advanced-cache.php"]
C --> D["advanced-cache.php runs Dispatcher"]
D --> E["PgCache_ContentGrabber->process()"]

E --> F["Util_Bus::add_ob_callback('pagecache', 'ob_callback')"]
F --> G["WordPress renders full HTML into output buffer"]
G --> H["ob_callback($buffer) triggered"]

H --> I{"_has_dynamic($buffer) ?"}
I -->|No| J["Return buffer as-is → Serve cached page"]
I -->|Yes| K["Save buffer to _shutdown_buffer"]
K --> L["register_shutdown_function(shutdown)"]
L --> M["After request completes → shutdown()"]

M --> N["_parse_dynamic(_shutdown_buffer)"]

N --> O{"HTML contains <!-- mfunc ... --> ?"}
O -->|Yes| P["_parse_dynamic_mfunc()"]
P --> Q["Extract payload from comment and run eval()"]

O -->|Or mclude| R["_parse_dynamic_mclude() (include type)"]

Q --> S["Output replaced with execution result"]
R --> S

S --> T["Page optionally compressed"]
T --> U["echo back to user"]
</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone" aria-hidden="true"></i><i class="fa-solid fa-check text-success" aria-hidden="true"></i></div>
<template><pre>
graph TD

A["User requests any front‑end page (unauthenticated)"]
--> B["WordPress loads wp-settings.php"]

B --> C["WP_CACHE = true → Load advanced-cache.php"]
C --> D["advanced-cache.php runs Dispatcher"]
D --> E["PgCache_ContentGrabber->process()"]

E --> F["Util_Bus::add_ob_callback('pagecache', 'ob_callback')"]
F --> G["WordPress renders full HTML into output buffer"]
G --> H["ob_callback($buffer) triggered"]

H --> I{"_has_dynamic($buffer) ?"}
I -->|No| J["Return buffer as-is → Serve cached page"]
I -->|Yes| K["Save buffer to _shutdown_buffer"]
K --> L["register_shutdown_function(shutdown)"]
L --> M["After request completes → shutdown()"]

M --> N["_parse_dynamic(_shutdown_buffer)"]

N --> O{"HTML contains <!-- mfunc ... --> ?"}
O -->|Yes| P["_parse_dynamic_mfunc()"]
P --> Q["Extract payload from comment and run eval()"]

O -->|Or mclude| R["_parse_dynamic_mclude() (include type)"]

Q --> S["Output replaced with execution result"]
R --> S

S --> T["Page optionally compressed"]
T --> U["echo back to user"]
</pre></template>
</div>
<h2 class="heading-element" id="proof-of-concept-poc"><span>Proof of Concept (PoC)</span>
  <a href="#proof-of-concept-poc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>Install và active plugin, hàm thành bước setup cơ bản</li>
<li>Bật tùy chọn Page Cache</li>
<li>Cấu <code>W3TC_DYNAMIC_SECURITY</code> trong <code>wp-config.php</code></li>
<li>Comment một post bất kì với content :</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;!--</span> <span class="nx">mfuncvalue</span> <span class="o">--&gt;</span><span class="nx">phpinfo</span><span class="p">();</span><span class="o">&lt;!--</span> <span class="o">/</span><span class="nx">mfuncvalue</span> <span class="o">--&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="/posts/2025-11-22-cve-2025-9501/result.png" title="Kết quả" data-thumbnail="/posts/2025-11-22-cve-2025-9501/result.png" data-sub-html="<h2>Result</h2><p>Kết quả</p>"><img loading="lazy" src='/posts/2025-11-22-cve-2025-9501/result.png' alt="Result" height="1078" width="1918"></a><figcaption class="image-caption">Kết quả</figcaption>
  </figure></p>
<div class="alert alert-note"><p class="alert-title"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Ghi chú</p><p>Giá trị của <code>W3TC_DYNAMIC_SECURITY</code> có thể bị lộ khi quên bật tính năng Page Cache mà sử dụng nó ở nơi Unauthenticated User có thể thấy được.
<figure><a class="lightgallery" href="/posts/2025-11-22-cve-2025-9501/miss_page_cache.png" title="Sử dụng khi quên bật Page Cache" data-thumbnail="/posts/2025-11-22-cve-2025-9501/miss_page_cache.png" data-sub-html="<h2>Miss Page Cache</h2><p>Sử dụng khi quên bật Page Cache</p>"><img loading="lazy" src='/posts/2025-11-22-cve-2025-9501/miss_page_cache.png' alt="Miss Page Cache" height="259" width="427"></a><figcaption class="image-caption">Sử dụng khi quên bật Page Cache</figcaption>
  </figure></p></div><h1 class="heading-element" id="conclusion"><span>Conclusion</span>
  <a href="#conclusion" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>Lỗ hổng CVE-2025-9501 xuất phát từ việc plugin W3 Total Cache sử dụng <code>eval()</code> để xử lý các khối “dynamic fragment caching” (<code>&lt;!-- mfunc ... --&gt;</code>) mà không có bất kỳ bước xác thực, lọc hoặc sandbox nào. Điều này cho phép kẻ tấn công chưa xác thực có thể chèn trực tiếp mã PHP vào nội dung trang, và mã này sẽ được thực thi trong giai đoạn <code>shutdown</code>, sau khi WordPress đã kết thúc toàn bộ xử lý chính, dẫn đến Remote Code Execution (RCE).</p>
<p>Vấn đề càng nghiêm trọng hơn khi logic cache và xử lý đầu ra nằm ngoài vòng đời chuẩn của WordPress, khiến các lớp bảo vệ như hook, nonce hoặc kiểm tra quyền truy cập không còn hiệu lực. W3TC 2.8.13 đã loại bỏ việc gọi <code>eval()</code> trong cơ chế xử lý động, chính thức vá lỗ hổng này.</p>
<h1 class="heading-element" id="key-takeaways"><span>Key Takeaways</span>
  <a href="#key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><ul>
<li>Việc sử dụng <code>eval()</code> trong sản phẩm production gần như luôn dẫn đến RCE nếu đầu vào không được kiểm soát nghiêm ngặt.</li>
<li>Plugin đã xử lý nội dung động <strong>sau toàn bộ vòng đời WordPress</strong>, khiến nhiều lớp bảo vệ của core bị bypass.</li>
<li>Page Fragment Caching của W3TC cho phép chạy code PHP từ HTML comment – chỉ cần một cấu hình sai hoặc thiếu chặn đầu vào là đủ cho tấn công.</li>
<li>RCE được kích hoạt trong <code>register_shutdown_function()</code>, khiến payload chạy ở thời điểm cuối của request – khó bị phát hiện bởi quá trình phân tích thông thường.</li>
<li>Cập nhật plugin ngay lập tức là cách bảo vệ duy nhất trong trường hợp hệ thống vẫn đang sử dụng &lt;= 2.8.12.</li>
<li>Đối với mọi hệ thống PHP, <strong>tuyệt đối tránh <code>eval()</code> nếu không có sandbox và validation cực kỳ chặt</strong>.</li>
</ul>
<h2 class="heading-element" id="references"><span>References</span>
  <a href="#references" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://book.hacktricks.wiki/en/pentesting-web/command-injection.html"target="_blank" rel="external nofollow noopener noreferrer">Command Injection</a></p>
<p><a href="https://patchstack.com/database/wordpress/plugin/w3-total-cache/vulnerability/wordpress-w3-total-cache-plugin-2-8-13-unauthenticated-command-injection-vulnerability"target="_blank" rel="external nofollow noopener noreferrer">WordPress W3 Total Cache Plugin &lt; 2.8.13 is vulnerable to Remote Code Execution (RCE)</a></p></div><hr class="awesome-hr" />
    <h2 id="see-also">Nội dung liên quan</h2>
    <ul><li>
          <a href="/vi/posts/2025-11-21-cve-2025-2939/" title="CVE-2025-2939 Analysis &amp; POC">CVE-2025-2939 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-20-cve-2025-49386/" title="CVE-2025-53572 Analysis &amp; POC">CVE-2025-53572 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-19-cve-2025-6742/" title="CVE-2025-6742 Analysis &amp; POC">CVE-2025-6742 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-18-cve-2025-53572/" title="CVE-2025-53572 Analysis &amp; POC">CVE-2025-53572 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-17-cve-2025-49401/" title="CVE-2025-49401 Analysis &amp; POC">CVE-2025-49401 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-14-cve-2025-9083/" title="CVE-2025-9083 Analysis &amp; POC">CVE-2025-9083 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-13-cve-2025-7847/" title="CVE-2025-7847 Analysis &amp; POC">CVE-2025-7847 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-04-cve-2025-62065/" title="CVE-2025-62065 Analysis &amp; POC">CVE-2025-62065 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-03-cve-2025-2940/" title="CVE-2025-2940 Analysis &amp; POC">CVE-2025-2940 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-11-02-cve-2025-1043/" title="CVE-2025-1043 Analysis &amp; POC">CVE-2025-1043 Analysis &amp; POC</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="Cập nhật ngày 2025-11-23 02:14:28">Cập nhật ngày 2025-11-23&nbsp;<a class="git-hash" href="https://github.com/w41bu1/w41bu1.github.io/commit/64409d4575c22b56f3e35752ec093ab7eae95230" rel="external nofollow noopener noreferrer" target="_blank" title="Add post 2025-11-22-CVE-2025-9501&#10&#10Commit: 64409d4575c22b56f3e35752ec093ab7eae95230 [64409d4]&#10Author: w41bu1&#10Date: 2025-11-23 02:14:28"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i>64409d4</a></span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/vi/posts/2025-11-22-cve-2025-9501/index.md" title="Đọc với định dạng Markdown" class="link-to-markdown">Đọc với định dạng Markdown</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/blob/main/content/posts%5c2025-11-22-CVE-2025-9501%5cindex.vi.md?plain=1" title="Xem mã nguồn"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-source">Xem mã nguồn</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/edit/main/content/posts%5c2025-11-22-CVE-2025-9501%5cindex.vi.md" title="Chỉnh sửa trang này"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-edit">Chỉnh sửa trang này</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/issues/new?title=[BUG]%20CVE-2025-9501&#43;Analysis&#43;%26&#43;POC&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cCVE-2025-9501&#43;Analysis&#43;%26&#43;POC%7c%0A%7cURL%7chttp://localhost:1313/vi/posts/2025-11-22-cve-2025-9501/%7c%0A%7cFilename%7chttps://github.com/w41bu1/w41bu1.github.io/blob/main/content/posts%5c2025-11-22-CVE-2025-9501%5cindex.vi.md?plain=1%7c" title="Báo cáo lỗi"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-report">Báo cáo lỗi</a></span><span><a href="vscode://file/D:%5cwork%5cproject%5cw41bu1.github.io%5ccontent%5cposts%5c2025-11-22-CVE-2025-9501%5cindex.vi.md" title="Mở trong trình chỉnh sửa"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-vscode">Mở trong trình chỉnh sửa</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Chia sẻ trên X" data-sharer="twitter" data-url="http://localhost:1313/vi/posts/2025-11-22-cve-2025-9501/" data-title="CVE-2025-9501 Analysis &amp; POC" data-hashtags="analyst,plugin,remote code execution"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Facebook" data-sharer="facebook" data-url="http://localhost:1313/vi/posts/2025-11-22-cve-2025-9501/" data-hashtag="analyst"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Linkedin" data-sharer="linkedin" data-url="http://localhost:1313/vi/posts/2025-11-22-cve-2025-9501/"><i class="fa-brands fa-linkedin fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/vi/posts/2025-11-22-cve-2025-9501/" data-title="CVE-2025-9501 Analysis &amp; POC"><i class="fa-brands fa-hacker-news fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/vi/tags/analyst/" class="post-tag" title="Nhãn - Analyst">Analyst</a><a href="/vi/tags/plugin/" class="post-tag" title="Nhãn - Plugin">Plugin</a><a href="/vi/tags/remote-code-execution/" class="post-tag" title="Nhãn - Remote Code Execution">Remote Code Execution</a></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">Quay lại</a></span>&nbsp;|&nbsp;<span><a href="/vi/">Trang chủ</a></span>
    </section>
  </div><div class="post-nav"><a href="/vi/posts/2025-11-21-cve-2025-2939/" class="post-nav-item" rel="prev" title="CVE-2025-2939 Analysis &amp; POC"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>CVE-2025-2939 Analysis &amp; POC</a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Nội dung"><h2 class="toc-title">Nội dung&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside><dialog id="toc-dialog" aria-labelledby="toc-dialog-title" role="dialog">
      <div class="toc">
        <h2 class="toc-title">Nội dung</h2>
        <div class="toc-content" id="toc-content-drawer"><nav >
  <ul>
    <li><a href="#cve--basic-info">CVE &amp; Basic Info</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#cause">Cause</a></li>
    <li><a href="#analysis">Analysis</a></li>
    <li><a href="#flow">Flow</a></li>
    <li><a href="#proof-of-concept-poc">Proof of Concept (PoC)</a></li>
  </ul>

  <ul>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div>
    </dialog></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="github.com/w41bu1">Bui Van Y</a></span><span class="license footer-divider">w41bu1</span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='Tổng khách truy cập'><i class="fa-regular fa-user fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='Tổng lượt truy cập'><i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div><div class="footer-line beian"><span class="gov"><i class="fa-solid fa-user-secret"></i></span><span class="icp footer-divider"><i class="fa-solid fa-bug"></i></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons"><div class="fixed-button back-to-top animate__faster d-none" role="button" aria-label="Lên trên"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><svg viewBox="0 0 100 100">
              <circle class="bg" cx="50" cy="50" r="50"></circle>
              <circle class="progress" cx="50" cy="50" r="50"></circle>
            </svg></div><div id="toc-drawer-button" class="fixed-button toc-drawer-button d-none" role="button" aria-label="Nội dung"><i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Trang web này hoạt động tốt nhất khi JavaScript được kích hoạt.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script src="/js/config/23ee62933704ee64bec61244c685768f.js" defer></script><script src="/js/lib/mermaid.js" type="module"></script><script src="/js/theme.min.js" defer></script><script src="/js/flyfish.min.js" defer></script></body>
</html>
