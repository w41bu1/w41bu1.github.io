<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="vi">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>CVE-2024-13887 Analysis &amp; POC - Bui Van Y</title><meta name="author" content="Bui Van Y">
<meta name="description" content="Security Vulnerability in WordPress Business Directory Plugin."><meta name="keywords" content='analyst, plugin, idor'>
  <meta itemprop="name" content="CVE-2024-13887 Analysis & POC">
  <meta itemprop="description" content="Security Vulnerability in WordPress Business Directory Plugin.">
  <meta itemprop="datePublished" content="2025-12-31T19:00:00+07:00">
  <meta itemprop="dateModified" content="2025-12-30T13:05:39+07:00">
  <meta itemprop="wordCount" content="1680">
  <meta itemprop="image" content="http://localhost:1313/posts/2025-12-31-cve-2024-13887/app.png">
  <meta itemprop="keywords" content="Analyst,Plugin,Idor"><meta property="og:url" content="http://localhost:1313/vi/posts/2025-12-31-cve-2024-13887/">
  <meta property="og:site_name" content="Bui Van Y">
  <meta property="og:title" content="CVE-2024-13887 Analysis & POC">
  <meta property="og:description" content="Security Vulnerability in WordPress Business Directory Plugin.">
  <meta property="og:locale" content="vi">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-31T19:00:00+07:00">
    <meta property="article:modified_time" content="2025-12-30T13:05:39+07:00">
    <meta property="article:tag" content="Analyst">
    <meta property="article:tag" content="Plugin">
    <meta property="article:tag" content="Idor">
    <meta property="og:image" content="http://localhost:1313/posts/2025-12-31-cve-2024-13887/app.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/posts/2025-12-31-cve-2024-13887/app.png">
  <meta name="twitter:title" content="CVE-2024-13887 Analysis & POC">
  <meta name="twitter:description" content="Security Vulnerability in WordPress Business Directory Plugin.">
<meta name="application-name" content="Bui Van Y">
<meta name="apple-mobile-web-app-title" content="Bui Van Y"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/svg-spinners--wind-toy.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/vi/posts/2025-12-31-cve-2024-13887/" title="CVE-2024-13887 Analysis &amp; POC - Bui Van Y" /><link rel="prev" type="text/html" href="http://localhost:1313/vi/posts/2025-12-30-cve-2024-12114/" title="CVE-2024-12114 Analysis &amp; POC" /><link rel="next" type="text/html" href="http://localhost:1313/vi/posts/2026-01-01-cve-2025-11749/" title="CVE-2025-11749 Analysis &amp; POC" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/vi/posts/2025-12-31-cve-2024-13887/index.md" title="CVE-2024-13887 Analysis & POC - Bui Van Y"><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "CVE-2024-13887 Analysis \u0026 POC",
    "inLanguage": "vi",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/vi\/posts\/2025-12-31-cve-2024-13887\/"
    },"image": ["http:\/\/localhost:1313\/images\/avatar.png"],"genre": "posts","keywords": "analyst, plugin, idor","wordcount":  1680 ,
    "url": "http:\/\/localhost:1313\/vi\/posts\/2025-12-31-cve-2024-13887\/","datePublished": "2025-12-31T19:00:00+07:00","dateModified": "2025-12-30T13:05:39+07:00","publisher": {
      "@type": "Organization",
      "name": "/images/avatar.png","logo": "http:\/\/localhost:1313\/images\/avatar.png"},"author": {
        "@type": "Person",
        "name": "Bui Van Y"
      },"description": "Security Vulnerability in WordPress Business Directory Plugin."
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-instant-intensity="viewport" data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/vi/" title="Bui Van Y"><img class="logo" src='/images/svg-spinners--wind-toy.svg' alt="Bui Van Y" height="32" width="32"><span class="header-title-text">Bui Van Y</span></a><span class="typeit header-subtitle"><template>w41bu1</template></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/vi/posts/"><i class="fa-solid fa-file-alt fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/vi/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/vi/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Tìm tiêu đề hoặc nội dung..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Tìm kiếm">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Xoá">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" role="button" aria-label="Đổi chủ đề" title="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></li><li class="menu-item language-switch">
            <span role="button" aria-label="Chọn Ngôn ngữ" title="Chọn Ngôn ngữ"><i class="fa-solid fa-language fa-fw" aria-hidden="true"></i></span>
            <ul class="sub-menu"><li class="menu-item"><a href="/posts/2025-12-31-cve-2024-13887/" class="menu-link" title="English">English</a></li><li class="menu-item"><span class="text-secondary" title="Vietnamese">Vietnamese</span></li></ul>
          </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/vi/" title="Bui Van Y"><img class="logo" src='/images/svg-spinners--wind-toy.svg' alt="Bui Van Y" height="26" width="26"><span class="header-title-text">Bui Van Y</span></a><span class="typeit header-subtitle"><template>w41bu1</template></span></div>
      <div class="theme-switch" role="button" aria-label="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></div>
      <div class="menu-toggle" id="menu-toggle-mobile" role="button" aria-labelledby="menu-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Tìm tiêu đề hoặc nội dung..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Tìm kiếm">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Xoá">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Huỷ
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/vi/posts/"><i class="fa-solid fa-file-alt fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item"><a class="menu-link" href="/vi/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="/vi/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system"><span class="menu-system-item language-switch">
              <span role="button" aria-label="Chọn Ngôn ngữ" title="Chọn Ngôn ngữ">Vietnamese<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i></span>
              <select id="language-select" class="language-select" onchange="location = this.value;"><option value="/posts/2025-12-31-cve-2024-13887/">English</option><option value="/vi/posts/2025-12-31-cve-2024-13887/" selected disabled>Vietnamese</option></select>
            </span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"><div class="details related-details open">
      <div class="details-summary related-summary">
        <i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden="true"></i>
        <span class="related-title">Nội dung liên quan</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
      <div class="details-content related-content">
        <ul class="related-list"><li class="related-item">
              <a href="/vi/posts/2025-12-30-cve-2024-12114/" title="CVE-2024-12114 Analysis &amp; POC">CVE-2024-12114 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-28-cve-2025-10039/" title="CVE-2025-10039 Analysis &amp; POC">CVE-2025-10039 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-27-cve-2025-13748/" title="CVE-2025-13748 Analysis &amp; POC">CVE-2025-13748 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-26-cve-2025-3769/" title="CVE-2025-3769 Analysis &amp; POC">CVE-2025-3769 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-25-cve-2025-3281/" title="CVE-2025-3281 Analysis &amp; POC">CVE-2025-3281 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-24-cve-2025-64283/" title="CVE-2025-64283 Analysis &amp; POC">CVE-2025-64283 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-22-cve-2025-57886/" title="CVE-2025-57886 Analysis &amp; POC">CVE-2025-57886 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-21-cve-2025-12954/" title="CVE-2025-12954 Analysis &amp; POC">CVE-2025-12954 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-20-cve-2025-67985/" title="CVE-2025-67985 Analysis &amp; POC">CVE-2025-67985 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-16-cve-2025-13956/" title="CVE-2025-13956 Analysis &amp; POC">CVE-2025-13956 Analysis &amp; POC</a></li></ul>
      </div>
    </div></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>CVE-2024-13887 Analysis &amp; POC</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="github.com/w41bu1" title="Tác giả" rel=" author" class="author"><img class="avatar" src='/images/avatar.png' alt="Bui Van Y" height="16" width="16">&nbsp;Bui Van Y</a></span><span class="post-included-in">&nbsp;trong <a href="/vi/categories/cve-analysis/" class="post-category" title="Danh mục - CVE Analysis"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> CVE Analysis</a></span></div><div class="post-meta-line"><span title="đăng ngày 2025-12-31 19:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-12-31">2025-12-31</time></span>&nbsp;<span title="Cập nhật ngày 2025-12-30 13:05:39"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2025-12-30">2025-12-30</time></span>&nbsp;<span title="1680 từ"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>Khoảng 1700 từ</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>8 phút</span>&nbsp;</div>
    </div><div class="featured-image"><img loading="eager" src='/posts/2025-12-31-cve-2024-13887/app.png' sizes="(max-width: 680px) 100vw, (max-width: 960px) 80vw, (max-width: 1440px) 56vw, 800px" alt="/posts/2025-12-31-cve-2024-13887/app.png" height="500" width="1544"></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Nội dung</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cve--basic-info">CVE &amp; Basic Info</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#analysis">Analysis</a></li>
    <li><a href="#flow">Flow</a></li>
    <li><a href="#proof-of-concept-poc">Proof of Concept (PoC)</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#key-takeaways">Key Takeaways</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 class="heading-element" id="cve--basic-info"><span>CVE &amp; Basic Info</span>
  <a href="#cve--basic-info" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Plugin <strong>Business Directory Plugin – Easy Listing Directories for WordPress</strong> tồn tại lỗ hổng <strong>Insecure Direct Object Reference (IDOR)</strong> trong tất cả các phiên bản từ trước đến <strong>6.4.14</strong>, thông qua hàm <code>ajax_listing_submit_image_upload</code> do thiếu kiểm tra hợp lệ đối với một khóa do người dùng kiểm soát. Điều này cho phép kẻ tấn công <strong>chưa xác thực</strong> có thể <strong>tải lên hình ảnh tùy ý vào các listing</strong>.</p>
<ul>
<li><strong>CVE ID</strong>: <a href="https://www.cve.org/CVERecord?id=CVE-2024-13887" target="_blank" rel="external nofollow noopener noreferrer">CVE-2024-13887</a></li>
<li><strong>Vulnerability Type</strong>: Insecure Direct Object References (IDOR)</li>
<li><strong>Affected Versions</strong>: &lt;= 6.4.14</li>
<li><strong>Patched Versions</strong>: 6.4.15</li>
<li><strong>CVSS severity</strong>: Low (5.3)</li>
<li><strong>Required Privilege</strong>: Unauthenticated</li>
<li><strong>Product</strong>: <a href="https://wordpress.org/plugins/business-directory-plugin/" target="_blank" rel="external nofollow noopener noreferrer">WordPress Business Directory Plugin</a></li>
</ul>
<h2 class="heading-element" id="requirements"><span>Requirements</span>
  <a href="#requirements" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li><strong>Local WordPress &amp; Debugging</strong>
<ul>
<li><a href="https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/" target="_blank" rel="external nofollow noopener noreferrer">Virtual Machine</a></li>
<li><a href="https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/" target="_blank" rel="external nofollow noopener noreferrer">Docker</a></li>
</ul>
</li>
<li><strong>Plugin Version</strong> - <strong>Business Directory</strong>:
<ul>
<li><code>6.4.14</code> – <strong>vulnerable</strong></li>
<li><code>6.4.15</code> – <strong>patched</strong></li>
</ul>
</li>
<li><strong>Diff Tool (diff)</strong> → <a href="https://meldmerge.org/" target="_blank" rel="external nofollow noopener noreferrer"><strong>Meld</strong></a> hoặc bất kỳ công cụ diff nào.</li>
</ul>
<h2 class="heading-element" id="analysis"><span>Analysis</span>
  <a href="#analysis" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Plugin đăng ký AJAX handler <strong>cho người dùng đã đăng nhập</strong>:</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true" title="class-wpbdp.php v6.4.14" data-open="true"><div class="chroma">
<div class="code-header language-php"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i><span class="title-inner">class-wpbdp.php v6.4.14</span></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Chuyển đổi số dòng" role="button" title="Chuyển đổi số dòng"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Chuyển đổi xuống dòng" role="button" title="Chuyển đổi xuống dòng"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Sao chép vào bộ nhớ tạm" role="button" title="Sao chép vào bộ nhớ tạm"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">add_action</span><span class="p">(</span> <span class="s1">&#39;wp_ajax_nopriv_wpbdp-listing-submit-image-upload&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="o">&amp;</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;ajax_listing_submit_image_upload&#39;</span> <span class="p">)</span> <span class="p">);</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p><code>wp_ajax_nopriv</code> là hook dành cho tất cả người dùng, kết cả chưa đăng nhập. Khi có request tới endpoint <code>/wp-admin/admin-ajax.php</code> với param <code>action=wpbdp-listing-submit-image-upload</code> thì callback <code>ajax_listing_submit_image_upload</code> được gọi:</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true" title="class-wpbdp.php v6.4.14" data-open="true"><div class="chroma">
<div class="code-header language-php"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i><span class="title-inner">class-wpbdp.php v6.4.14</span></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Chuyển đổi số dòng" role="button" title="Chuyển đổi số dòng"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Chuyển đổi xuống dòng" role="button" title="Chuyển đổi xuống dòng"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Sao chép vào bộ nhớ tạm" role="button" title="Sao chép vào bộ nhớ tạm"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="hl"><span class="lnt"> 4
</span></span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="hl"><span class="lnt">37
</span></span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">ajax_listing_submit_image_upload</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WPBDP_AJAX_Response</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="nv">$listing_id</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;listing_id&#39;</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line hl"><span class="cl">    <span class="nv">$files</span>  <span class="o">=</span> <span class="nx">wpbdp_flatten_files_array</span><span class="p">(</span> <span class="nx">isset</span><span class="p">(</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">?</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$listing</span>         <span class="o">=</span> <span class="nx">WPBDP_Listing</span><span class="o">::</span><span class="na">get</span><span class="p">(</span> <span class="nv">$listing_id</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$slots_available</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$plan</span>            <span class="o">=</span> <span class="nv">$listing</span><span class="o">-&gt;</span><span class="na">get_fee_plan</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$plan</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">send_error</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;Please select a plan before uploading images to the listing&#39;</span><span class="p">,</span> <span class="s1">&#39;business-directory-plugin&#39;</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$slots_available</span> <span class="o">=</span> <span class="nx">absint</span><span class="p">(</span> <span class="nv">$plan</span><span class="o">-&gt;</span><span class="na">fee_images</span> <span class="p">)</span> <span class="o">-</span> <span class="nx">absint</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;images_count&#39;</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="nv">$slots_available</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">send_error</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;Can not upload any more images for this listing.&#39;</span><span class="p">,</span> <span class="s1">&#39;business-directory-plugin&#39;</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span> <span class="nv">$slots_available</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">(</span> <span class="nv">$files</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">send_error</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sprintf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nx">_nx</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;You\&#39;re trying to upload %1$d images, but only have %2$d slot available. Please adjust your selection.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;You\&#39;re trying to upload %1$d images, but only have %2$d slots available. Please adjust your selection.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$slots_available</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;listing image upload&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;business-directory-plugin&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">count</span><span class="p">(</span> <span class="nv">$files</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$slots_available</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$files</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$image_error</span>   <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">        <span class="nv">$attachment_id</span> <span class="o">=</span> <span class="nx">wpbdp_media_upload</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;image&#39;</span>      <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;min-size&#39;</span>   <span class="o">=&gt;</span> <span class="nx">intval</span><span class="p">(</span> <span class="nx">wpbdp_get_option</span><span class="p">(</span> <span class="s1">&#39;image-min-filesize&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;max-size&#39;</span>   <span class="o">=&gt;</span> <span class="nx">intval</span><span class="p">(</span> <span class="nx">wpbdp_get_option</span><span class="p">(</span> <span class="s1">&#39;image-max-filesize&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;min-width&#39;</span>  <span class="o">=&gt;</span> <span class="nx">wpbdp_get_option</span><span class="p">(</span> <span class="s1">&#39;image-min-width&#39;</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;min-height&#39;</span> <span class="o">=&gt;</span> <span class="nx">wpbdp_get_option</span><span class="p">(</span> <span class="s1">&#39;image-min-height&#39;</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$image_error</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span> <span class="c1">// TODO: handle errors.
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="nv">$image_error</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$errors</span><span class="p">[</span> <span class="nv">$file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="nv">$image_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$attachments</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$attachment_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$attachments</span> <span class="k">as</span> <span class="nv">$attachment_id</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span> <span class="o">.=</span> <span class="nx">wpbdp_render</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;submit-listing-images-single&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;image_id&#39;</span>   <span class="o">=&gt;</span> <span class="nv">$attachment_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;listing_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$listing_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$has_images</span> <span class="o">=</span> <span class="nv">$listing</span><span class="o">-&gt;</span><span class="na">get_images</span><span class="p">(</span> <span class="s1">&#39;ids&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$listing</span><span class="o">-&gt;</span><span class="na">set_images</span><span class="p">(</span> <span class="nv">$attachments</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Maybe set thumbnail if there aren&#39;t already images on this listing.
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$has_images</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$image_id</span> <span class="o">=</span> <span class="nx">reset</span><span class="p">(</span> <span class="nv">$attachments</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$listing</span><span class="o">-&gt;</span><span class="na">set_thumbnail_id</span><span class="p">(</span> <span class="nv">$image_id</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nv">$errors</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$error_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$errors</span> <span class="k">as</span> <span class="nv">$fname</span> <span class="o">=&gt;</span> <span class="nv">$error</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$error_msg</span> <span class="o">.=</span> <span class="nx">sprintf</span><span class="p">(</span> <span class="s1">&#39;&amp;#149; %s: %s&#39;</span><span class="p">,</span> <span class="nv">$fname</span><span class="p">,</span> <span class="nv">$error</span> <span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;&lt;br /&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span> <span class="s1">&#39;uploadErrors&#39;</span><span class="p">,</span> <span class="nv">$error_msg</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span> <span class="s1">&#39;is_admin&#39;</span><span class="p">,</span> <span class="nx">wpbdp_user_is_admin</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span> <span class="s1">&#39;slots_available&#39;</span><span class="p">,</span> <span class="nv">$slots_available</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span> <span class="s1">&#39;attachmentIds&#39;</span><span class="p">,</span> <span class="nv">$attachments</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nv">$html</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Mở rộng hoặc thu gọn khối mã" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p>Hàm thực hiện lấy <code>listing_id</code> và <code>images</code> từ request:</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-php"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Chuyển đổi số dòng" role="button" title="Chuyển đổi số dòng"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Chuyển đổi xuống dòng" role="button" title="Chuyển đổi xuống dòng"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Sao chép vào bộ nhớ tạm" role="button" title="Sao chép vào bộ nhớ tạm"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$listing_id</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;listing_id&#39;</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$files</span>  <span class="o">=</span> <span class="nx">wpbdp_flatten_files_array</span><span class="p">(</span> <span class="nx">isset</span><span class="p">(</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">?</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">()</span> <span class="p">);</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p>Kết thúc hàm nếu plan chưa được chọn:</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-php"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Chuyển đổi số dòng" role="button" title="Chuyển đổi số dòng"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Chuyển đổi xuống dòng" role="button" title="Chuyển đổi xuống dòng"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Sao chép vào bộ nhớ tạm" role="button" title="Sao chép vào bộ nhớ tạm"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$plan</span> <span class="o">=</span> <span class="nv">$listing</span><span class="o">-&gt;</span><span class="na">get_fee_plan</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$plan</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">send_error</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;Please select a plan before uploading images to the listing&#39;</span><span class="p">,</span> <span class="s1">&#39;business-directory-plugin&#39;</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p><figure><a class="lightgallery" target="_blank" href="/posts/2025-12-31-cve-2024-13887/plan.png" title="Chọn plan" data-thumbnail="/posts/2025-12-31-cve-2024-13887/plan.png" data-sub-html="<h2>Plan</h2><p>Chọn plan</p>"><img loading="lazy" src='/posts/2025-12-31-cve-2024-13887/plan.png' alt="Plan" height="459" width="705"></a><figcaption class="image-caption">Chọn plan</figcaption>
  </figure></p>
<p>Sau đó kiểm tra slot còn lại có thể upload:</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-php"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Chuyển đổi số dòng" role="button" title="Chuyển đổi số dòng"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Chuyển đổi xuống dòng" role="button" title="Chuyển đổi xuống dòng"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Sao chép vào bộ nhớ tạm" role="button" title="Sao chép vào bộ nhớ tạm"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$slots_available</span> <span class="o">=</span> <span class="nx">absint</span><span class="p">(</span> <span class="nv">$plan</span><span class="o">-&gt;</span><span class="na">fee_images</span> <span class="p">)</span> <span class="o">-</span> <span class="nx">absint</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;images_count&#39;</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="nv">$slots_available</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">send_error</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;Can not upload any more images for this listing.&#39;</span><span class="p">,</span> <span class="s1">&#39;business-directory-plugin&#39;</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span> <span class="nv">$slots_available</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">(</span> <span class="nv">$files</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">send_error</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sprintf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_nx</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;You\&#39;re trying to upload %1$d images, but only have %2$d slot available. Please adjust your selection.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;You\&#39;re trying to upload %1$d images, but only have %2$d slots available. Please adjust your selection.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$slots_available</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;listing image upload&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;business-directory-plugin&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">count</span><span class="p">(</span> <span class="nv">$files</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$slots_available</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Mở rộng hoặc thu gọn khối mã" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p><figure><a class="lightgallery" target="_blank" href="/posts/2025-12-31-cve-2024-13887/slot.png" title="Slot" data-thumbnail="/posts/2025-12-31-cve-2024-13887/slot.png" data-sub-html="<h2>Slot</h2><p>Slot</p>"><img loading="lazy" src='/posts/2025-12-31-cve-2024-13887/slot.png' alt="Slot" height="439" width="509"></a><figcaption class="image-caption">Slot</figcaption>
  </figure></p>
<p>Nếu <code>slot &lt;= 0</code> thì trả về lỗi. Nếu không, duyệt qua các file và gọi đến <code>wpbdp_media_upload</code> để upload file.</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-php"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Chuyển đổi số dòng" role="button" title="Chuyển đổi số dòng"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Chuyển đổi xuống dòng" role="button" title="Chuyển đổi xuống dòng"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Sao chép vào bộ nhớ tạm" role="button" title="Sao chép vào bộ nhớ tạm"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span> <span class="nv">$files</span> <span class="k">as</span> <span class="nv">$i</span> <span class="o">=&gt;</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$image_error</span>   <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$attachment_id</span> <span class="o">=</span> <span class="nx">wpbdp_media_upload</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;image&#39;</span>      <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;min-size&#39;</span>   <span class="o">=&gt;</span> <span class="nx">intval</span><span class="p">(</span> <span class="nx">wpbdp_get_option</span><span class="p">(</span> <span class="s1">&#39;image-min-filesize&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;max-size&#39;</span>   <span class="o">=&gt;</span> <span class="nx">intval</span><span class="p">(</span> <span class="nx">wpbdp_get_option</span><span class="p">(</span> <span class="s1">&#39;image-max-filesize&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;min-width&#39;</span>  <span class="o">=&gt;</span> <span class="nx">wpbdp_get_option</span><span class="p">(</span> <span class="s1">&#39;image-min-width&#39;</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;min-height&#39;</span> <span class="o">=&gt;</span> <span class="nx">wpbdp_get_option</span><span class="p">(</span> <span class="s1">&#39;image-min-height&#39;</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$image_error</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span> <span class="c1">// TODO: handle errors.
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nv">$image_error</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$errors</span><span class="p">[</span> <span class="nv">$file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="nv">$image_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$attachments</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$attachment_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Mở rộng hoặc thu gọn khối mã" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p>Cuối cùng hàm sẽ trả về thông tin upload dạng JSON.</p>
<div class="details admonition bug open disabled">
  <div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-bug" aria-hidden="true"></i><br></div>
  <div class="details-content">
    <div class="admonition-content"><p>lỗ hổng xảy ra khi không có sự ràng buộc giữa <code>listing_id</code> và người dùng được phép thực hiện upload, attacker có thể thực hiện upload images bất kì thông qua việc thay đổi tham số <code>listing_id</code></p></div>
  </div>
</div><p>Bản vá <code>v6.4.15</code> đã triển khai một số biện pháp để khắc phục:</p>
<p><figure><a class="lightgallery" target="_blank" href="/posts/2025-12-31-cve-2024-13887/patch.png" title="Bản vá" data-thumbnail="/posts/2025-12-31-cve-2024-13887/patch.png" data-sub-html="<h2>Patch</h2><p>Bản vá</p>"><img loading="lazy" src='/posts/2025-12-31-cve-2024-13887/patch.png' alt="Patch" height="678" width="1915"></a><figcaption class="image-caption">Bản vá</figcaption>
  </figure></p>
<ul>
<li>Thực hiện kiểm tra nonce bằng <code>check_ajax_referer</code> =&gt; chống CSRF</li>
<li>Kiểm tra owner của listing, nếu không phải sẽ trả về lỗi.</li>
</ul>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-php"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Chuyển đổi số dòng" role="button" title="Chuyển đổi số dòng"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Chuyển đổi xuống dòng" role="button" title="Chuyển đổi xuống dòng"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Sao chép vào bộ nhớ tạm" role="button" title="Sao chép vào bộ nhớ tạm"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">wpbdp_user_is_admin</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$listing</span><span class="o">-&gt;</span><span class="na">owned_by_user</span><span class="p">(</span> <span class="nx">get_current_user_id</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">send_error</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">&#39;You do not have permission to upload images to this listing&#39;</span><span class="p">,</span> <span class="s1">&#39;business-directory-plugin&#39;</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div>
</div>
</div><h2 class="heading-element" id="flow"><span>Flow</span>
  <a href="#flow" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="diagram-container">
  <pre class="mermaid">
flowchart TD
A["Unauthenticated Attacker"]
--> B["Send POST request to /wp-admin/admin-ajax.php"]

B --> C["action=wpbdp-listing-submit-image-upload"]

C --> D["WordPress triggers ajax_listing_submit_image_upload()"]

D --> E["No authentication required (wp_ajax_nopriv_)"]

E --> F["Extract listing_id from request"]

F --> G["Load listing object by ID"]

G --> H{"Listing has fee plan?"}

H -- No --> I["Return error: select a plan"]
H -- Yes --> J["Calculate remaining image slots"]

J --> K{"slots_available > 0?"}

K -- No --> L["Return error: no available slots"]
K -- Yes --> M["Process uploaded files"]

M --> N["Call wpbdp_media_upload()"]

N --> O["Attach uploaded image to listing"]

O --> P["Set thumbnail if needed"]

P --> Q["Return success response (JSON)"]

Q --> R["Image successfully attached to arbitrary listing"]

R --> S["IDOR: No ownership / permission validation"]
</pre>
  <pre class="mermaid-dark">
flowchart TD
A["Unauthenticated Attacker"]
--> B["Send POST request to /wp-admin/admin-ajax.php"]

B --> C["action=wpbdp-listing-submit-image-upload"]

C --> D["WordPress triggers ajax_listing_submit_image_upload()"]

D --> E["No authentication required (wp_ajax_nopriv_)"]

E --> F["Extract listing_id from request"]

F --> G["Load listing object by ID"]

G --> H{"Listing has fee plan?"}

H -- No --> I["Return error: select a plan"]
H -- Yes --> J["Calculate remaining image slots"]

J --> K{"slots_available > 0?"}

K -- No --> L["Return error: no available slots"]
K -- Yes --> M["Process uploaded files"]

M --> N["Call wpbdp_media_upload()"]

N --> O["Attach uploaded image to listing"]

O --> P["Set thumbnail if needed"]

P --> Q["Return success response (JSON)"]

Q --> R["Image successfully attached to arbitrary listing"]

R --> S["IDOR: No ownership / permission validation"]
</pre>
  <pre class="mermaid-neutral">
flowchart TD
A["Unauthenticated Attacker"]
--> B["Send POST request to /wp-admin/admin-ajax.php"]

B --> C["action=wpbdp-listing-submit-image-upload"]

C --> D["WordPress triggers ajax_listing_submit_image_upload()"]

D --> E["No authentication required (wp_ajax_nopriv_)"]

E --> F["Extract listing_id from request"]

F --> G["Load listing object by ID"]

G --> H{"Listing has fee plan?"}

H -- No --> I["Return error: select a plan"]
H -- Yes --> J["Calculate remaining image slots"]

J --> K{"slots_available > 0?"}

K -- No --> L["Return error: no available slots"]
K -- Yes --> M["Process uploaded files"]

M --> N["Call wpbdp_media_upload()"]

N --> O["Attach uploaded image to listing"]

O --> P["Set thumbnail if needed"]

P --> Q["Return success response (JSON)"]

Q --> R["Image successfully attached to arbitrary listing"]

R --> S["IDOR: No ownership / permission validation"]
</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone" aria-hidden="true"></i></div>
<template><pre>
flowchart TD
A["Unauthenticated Attacker"]
--> B["Send POST request to /wp-admin/admin-ajax.php"]

B --> C["action=wpbdp-listing-submit-image-upload"]

C --> D["WordPress triggers ajax_listing_submit_image_upload()"]

D --> E["No authentication required (wp_ajax_nopriv_)"]

E --> F["Extract listing_id from request"]

F --> G["Load listing object by ID"]

G --> H{"Listing has fee plan?"}

H -- No --> I["Return error: select a plan"]
H -- Yes --> J["Calculate remaining image slots"]

J --> K{"slots_available > 0?"}

K -- No --> L["Return error: no available slots"]
K -- Yes --> M["Process uploaded files"]

M --> N["Call wpbdp_media_upload()"]

N --> O["Attach uploaded image to listing"]

O --> P["Set thumbnail if needed"]

P --> Q["Return success response (JSON)"]

Q --> R["Image successfully attached to arbitrary listing"]

R --> S["IDOR: No ownership / permission validation"]
</pre></template>
</div>
<h2 class="heading-element" id="proof-of-concept-poc"><span>Proof of Concept (PoC)</span>
  <a href="#proof-of-concept-poc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Gửi request:</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-sh"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Chuyển đổi số dòng" role="button" title="Chuyển đổi số dòng"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Chuyển đổi xuống dòng" role="button" title="Chuyển đổi xuống dòng"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Sao chép vào bộ nhớ tạm" role="button" title="Sao chép vào bộ nhớ tạm"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -X POST http://localhost/wp-admin/admin-ajax.php <span class="se">\
</span></span></span><span class="line"><span class="cl">  -F <span class="s2">&#34;action=wpbdp-listing-submit-image-upload&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl">  -F <span class="s2">&#34;listing_id=88&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl">  -F <span class="s2">&#34;images=@/path/to/image.jpg&#34;</span></span></span></code></pre></td></tr></table></div>
</div>
</div><h2 class="heading-element" id="conclusion"><span>Conclusion</span>
  <a href="#conclusion" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Lỗ hổng CVE-2024-13887 xuất phát từ việc endpoint <code>wpbdp-listing-submit-image-upload</code> cho phép truy cập không cần xác thực và không kiểm tra quyền sở hữu <code>listing_id</code>. Điều này cho phép attacker upload hình ảnh vào bất kỳ listing hợp lệ nào chỉ bằng cách thay đổi tham số đầu vào. Bản vá 6.4.15 đã khắc phục bằng cách bổ sung kiểm tra nonce và xác thực quyền sở hữu listing.</p>
<h2 class="heading-element" id="key-takeaways"><span>Key Takeaways</span>
  <a href="#key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>IDOR xảy ra do thiếu kiểm tra quyền sở hữu tài nguyên.</li>
<li><code>wp_ajax_nopriv</code> là điểm tấn công nguy hiểm nếu không có xác thực bổ sung.</li>
<li>Không nên tin tưởng dữ liệu đầu vào như <code>listing_id</code>.</li>
<li>Luôn kết hợp <strong>authentication + authorization</strong> khi xử lý AJAX endpoint.</li>
</ul>
<h2 class="heading-element" id="references"><span>References</span>
  <a href="#references" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://book.hacktricks.wiki/en/pentesting-web/idor.html" target="_blank" rel="external nofollow noopener noreferrer">IDOR</a></p>
<p><a href="https://patchstack.com/database/wordpress/plugin/business-directory-plugin/vulnerability/wordpress-business-directory-plugin-plugin-6-4-14-insecure-direct-object-reference-to-listing-arbitrary-image-addition-vulnerability" target="_blank" rel="external nofollow noopener noreferrer">WordPress Business Directory Plugin &lt;= 6.4.14 is vulnerable to Insecure Direct Object References (IDOR)</a></p></div><hr class="awesome-hr" />
    <h2 id="see-also">Nội dung liên quan</h2>
    <ul><li>
          <a href="/vi/posts/2025-12-30-cve-2024-12114/" title="CVE-2024-12114 Analysis &amp; POC">CVE-2024-12114 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-28-cve-2025-10039/" title="CVE-2025-10039 Analysis &amp; POC">CVE-2025-10039 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-27-cve-2025-13748/" title="CVE-2025-13748 Analysis &amp; POC">CVE-2025-13748 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-26-cve-2025-3769/" title="CVE-2025-3769 Analysis &amp; POC">CVE-2025-3769 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-25-cve-2025-3281/" title="CVE-2025-3281 Analysis &amp; POC">CVE-2025-3281 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-24-cve-2025-64283/" title="CVE-2025-64283 Analysis &amp; POC">CVE-2025-64283 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-22-cve-2025-57886/" title="CVE-2025-57886 Analysis &amp; POC">CVE-2025-57886 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-21-cve-2025-12954/" title="CVE-2025-12954 Analysis &amp; POC">CVE-2025-12954 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-20-cve-2025-67985/" title="CVE-2025-67985 Analysis &amp; POC">CVE-2025-67985 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-16-cve-2025-13956/" title="CVE-2025-13956 Analysis &amp; POC">CVE-2025-13956 Analysis &amp; POC</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="Cập nhật ngày 2025-12-30 13:05:39">Cập nhật ngày 2025-12-30&nbsp;<a class="git-hash" href="https://github.com/w41bu1/w41bu1.github.io/commit/7c314807b3c74321009abbe1ff292b9307609094" rel="external nofollow noopener noreferrer" target="_blank" title="Update post 2025-12-31-CVE-2024-13887&#10&#10Commit: 7c314807b3c74321009abbe1ff292b9307609094 [7c314807]&#10Author: w41bu1&#10Date: 2025-12-30 13:05:39"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i>7c314807</a></span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/vi/posts/2025-12-31-cve-2024-13887/index.md" title="Đọc với định dạng Markdown" class="link-to-markdown">Đọc với định dạng Markdown</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/blob/main/content/posts/2025-12-31-CVE-2024-13887/index.vi.md?plain=1" title="Xem mã nguồn" target="_blank" rel="external nofollow noopener noreferrer" class="link-to-source">Xem mã nguồn</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/edit/main/content/posts/2025-12-31-CVE-2024-13887/index.vi.md" title="Chỉnh sửa trang này" target="_blank" rel="external nofollow noopener noreferrer" class="link-to-edit">Chỉnh sửa trang này</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/issues/new?title=[BUG]%20CVE-2024-13887&#43;Analysis&#43;%26&#43;POC&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cCVE-2024-13887&#43;Analysis&#43;%26&#43;POC%7c%0A%7cURL%7chttp://localhost:1313/vi/posts/2025-12-31-cve-2024-13887/%7c%0A%7cFilename%7chttps://github.com/w41bu1/w41bu1.github.io/blob/main/content/posts/2025-12-31-CVE-2024-13887/index.vi.md?plain=1%7c" title="Báo cáo lỗi" target="_blank" rel="external nofollow noopener noreferrer" class="link-to-report">Báo cáo lỗi</a></span><span><a href="vscode://file//home/w41/Project/w41bu1.github.io/content/posts/2025-12-31-CVE-2024-13887/index.vi.md" title="Mở trong trình chỉnh sửa" target="_blank" rel="external nofollow noopener noreferrer" class="link-to-vscode">Mở trong trình chỉnh sửa</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Chia sẻ trên X" data-sharer="twitter" data-url="http://localhost:1313/vi/posts/2025-12-31-cve-2024-13887/" data-title="CVE-2024-13887 Analysis &amp; POC" data-hashtags="analyst,plugin,idor"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Facebook" data-sharer="facebook" data-url="http://localhost:1313/vi/posts/2025-12-31-cve-2024-13887/" data-hashtag="analyst"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Linkedin" data-sharer="linkedin" data-url="http://localhost:1313/vi/posts/2025-12-31-cve-2024-13887/"><i class="fa-brands fa-linkedin fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/vi/posts/2025-12-31-cve-2024-13887/" data-title="CVE-2024-13887 Analysis &amp; POC"><i class="fa-brands fa-hacker-news fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/vi/tags/analyst/" class="post-tag" title="Nhãn - Analyst">Analyst</a><a href="/vi/tags/plugin/" class="post-tag" title="Nhãn - Plugin">Plugin</a><a href="/vi/tags/idor/" class="post-tag" title="Nhãn - Idor">Idor</a></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">Quay lại</a></span>&nbsp;|&nbsp;<span><a href="/vi/">Trang chủ</a></span>
    </section>
  </div><div class="post-nav"><a href="/vi/posts/2025-12-30-cve-2024-12114/" class="post-nav-item" rel="prev" title="CVE-2024-12114 Analysis &amp; POC"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>CVE-2024-12114 Analysis &amp; POC</a><a href="/vi/posts/2026-01-01-cve-2025-11749/" class="post-nav-item" rel="next" title="CVE-2025-11749 Analysis &amp; POC">CVE-2025-11749 Analysis &amp; POC<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Nội dung"><h2 class="toc-title">Nội dung&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside><dialog id="toc-dialog" aria-labelledby="toc-dialog-title" role="dialog">
      <div class="toc">
        <h2 class="toc-title">Nội dung</h2>
        <div class="toc-content" id="toc-content-drawer"><nav >
  <ul>
    <li><a href="#cve--basic-info">CVE &amp; Basic Info</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#analysis">Analysis</a></li>
    <li><a href="#flow">Flow</a></li>
    <li><a href="#proof-of-concept-poc">Proof of Concept (PoC)</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#key-takeaways">Key Takeaways</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div>
    </dialog></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2026</span><span class="author" itemprop="copyrightHolder">
              <a href="github.com/w41bu1">Bui Van Y</a></span><span class="license footer-divider">w41bu1</span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='Tổng khách truy cập'><i class="fa-regular fa-user fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='Tổng lượt truy cập'><i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div><div class="footer-line beian"><span class="gov"><i class="fa-solid fa-user-secret"></i></span><span class="icp footer-divider"><i class="fa-solid fa-bug"></i></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons"><div class="fixed-button back-to-top animate__faster d-none" role="button" aria-label="Lên trên"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><svg viewBox="0 0 100 100">
              <circle class="bg" cx="50" cy="50" r="50"></circle>
              <circle class="progress" cx="50" cy="50" r="50"></circle>
            </svg></div><div id="toc-drawer-button" class="fixed-button toc-drawer-button d-none" role="button" aria-label="Nội dung"><i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Trang web này hoạt động tốt nhất khi JavaScript được kích hoạt.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script src="/vi/js/config/84528e0b6570ec6566f31a9bedecb110.js" defer></script><script src="/js/lib/mermaid.js" type="module"></script><script src="/js/theme.min.js" defer></script><script src="/js/flyfish.min.js" defer></script></body>
</html>
