# CVE-2025-64384 Analysis & POC


<!--more-->

## CVE & Basic Info
Lỗ hổng **Missing Authorization** trong **jetmonsters JetFormBuilder** **jetformbuilder** cho phép khai thác **Incorrectly Configured Access Control Security Levels**. Vấn đề này ảnh hưởng đến **JetFormBuilder**: từ **n/a** đến **<= 3.5.3**.

* **CVE ID**: [CVE-2025-64384](https://www.cve.org/CVERecord?id=CVE-2025-64384)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 3.5.3
* **Patched Versions**: 3.5.4
* **CVSS severity**: Low (5.3)
* **Required Privilege**: Contributor
* **Product**: [WordPress JetFormBuilder Plugin](https://wordpress.org/plugins/jetformbuilder/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **JetFormBuilder**:  
    * `3.5.3` – **vulnerable**  
    * `3.5.4` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Thực hiện diff code:

![Diff](diff.png "Sự khác biệt giữa bản lỗi và bản vá")

**Bản lỗi (v3.5.3):**

class `Generate_Form_Endpoint` tồn tại các hàm trả về giá trị tương ứng với các tham số để đăng ký REST API trong WordPress
* route: `/ai/generate`
* method: `POST`
* callback: `run_callback` dùng để tạo form bằng AI với có giới hạn (15 request / month)
![AI](ai.png "Tạo form với AI")

Đây là hàm dùng để đăng ký một endpoint mới cho REST API. Cấu trúc cơ bản như sau:

```php
register_rest_route( 
    string $namespace, 
    string $route, 
    array  $args = array(), 
    bool   $override = false 
);
```

`$namespace`: Không gian tên cho route, thường là tên plugin hoặc module.

    Ví dụ: "myplugin/v1"

`$route`: Đường dẫn của endpoint (sau namespace).

    Ví dụ: "/items"

`$args`: Mảng cấu hình cho route, gồm:
* `methods`: Phương thức HTTP (GET, POST, PUT, DELETE...).
* `callback`: Hàm xử lý khi endpoint được gọi.
* `permission_callback`: Hàm kiểm tra quyền truy cập.
* `args`: (tuỳ chọn) Các tham số truyền vào endpoint.

`$override`: Mặc định `false`. Nếu `true`, sẽ ghi đè route đã tồn tại.

Đối chiếu với các hàm trong class `Generate_Form_Endpoint`, ta thấy API nếu được đăng ký sẽ thiếu thành phần `permission_callback` để kiểm tra quyền truy cập, khiến cho tất cả user (kể các Unauthenticated) có thể gọi đến endpoint này, sử dụng chức năng tạo form bằng AI một cách tuỳ ý.

**Bản vá (v3.5.4):**

```php {title="generate-form-endpoint.php v3.5.4" data-open=true hl_lines=[]}
class Generate_Form_Endpoint extends Rest_Api_Private_Endpoint_Base
```

Gián tiếp kế thừa `Rest_Api_Endpoint_Base` thông quan việc kế thừa `Rest_Api_Private_Endpoint_Base`

```php {title="rest-api-private-endpoint-base.php v3.5.4" data-open=true hl_lines=[3]}
abstract class Rest_Api_Private_Endpoint_Base extends Rest_Api_Endpoint_Base {
	public function check_permission(): bool {
		return current_user_can( 'edit_jet_fb_forms' ); // just for admin
	}
}
```

`check_permission` được tạo để ghi đè lại `check_permission` của `Rest_Api_Endpoint_Base`, xác định rằng nó chỉ dành cho admin.

```php {title="rest-api-endpoint-base.php" data-open=true hl_lines=[11]}
abstract class Rest_Api_Endpoint_Base implements Rest_Fetch_Endpoint {
    public function check_permission(): bool {
		return true; // permission_callback: true
	}
    ...
}
```

---

Plugin đã đăng ký một action hook:

```php {title="rest-api-controller-base.php" data-open=true hl_lines=[]}
add_action( 'rest_api_init', array( $this, 'register_routes' ) );
```

`rest_api_init`: Hook này được gọi khi WordPress khởi tạo **REST API**, khi đó callback `register_routes` được gọi:

```php {title="rest-api-controller-base.php" data-open=true hl_lines=[]}
public function register_routes() {
    foreach ( $this->routes() as $route ) {
        $endpoint_args = $route->get_overridden_args()
            ?: array( // phpcs:ignore Universal.Operators.DisallowShortTernary.Found
                'methods'             => $route::get_methods(),
                'callback'            => array( $route, 'run_callback' ),
                'permission_callback' => array( $route, 'check_permission' ),
                'args'                => $route->get_common_args(),
            );

        $result = register_rest_route(
            $route::get_namespace(), // jet-form-builder/v1/
            "/{$route::get_rest_base()}",
            $endpoint_args,
            $route->get_override()
        );

        if ( ! $result ) {
            _doing_it_wrong(
                __METHOD__,
                // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
                "Error on register REST API route: {$route::get_namespace()}/{$route::get_rest_base()}",
                '1.4.0'
            );
        }
    }
}
```

Hàm `register_routes` sẽ duyệt qua các route và gọi đến `register_rest_route` để đăng ký API, trong đó `$this->routes()` là các route được đăng ký bằng 2 cách:
1. Kế thừa `Rest_Api_Controller_Base`:
```php {title="controller.php" data-open=true hl_lines=[]}
class Controller extends Rest_Api_Controller_Base {
    protected $routes = array();
    public function __construct() {
        $this->routes = array(
            new Get_Form_Fields(),
            new Install_Migrations_Endpoint(),
        );
    }

    public function routes(): array {
        return $this->routes;
    }
}
```

2. Gọi đến:
```php
$rest_api->get_controller()->install( new Generate_Form_Endpoint() );
```

## Flow
{{< mermaid >}}
graph TD
A["Attacker (Unauthenticated user)"] 
--> B["Send POST request to /wp-json/jet-form-builder/v1/ai/generate"]
--> C["WordPress REST API receives request"]
--> D["JetFormBuilder register_routes() is triggered via rest_api_init"]
--> E["Generate_Form_Endpoint registered with: methods: POST callback: run_callback permission_callback: true (default)"]
--> F{"Is permission_callback properly defined?"}
F -- No (<=3.5.3) --> G["Access granted to all users"]
G --> H["run_callback executed → AI form generation"]
H --> I["Attacker bypasses intended restriction (15 requests/month)"]
F -- Yes (>=3.5.4) --> J["check_permission() requires current_user_can('edit_jet_fb_forms')"]
J --> K["Only Admin can access → Exploit prevented"]

{{< /mermaid >}}

## Proof of Concept (PoC)
Gửi request với Unauthenticated user:

```http
POST /wp-json/jet-form-builder/v1/ai/generate HTTP/1.1
Host: localhost
...
prompt=create malicious form submit
```

![Result](resp.png "Kết quả")

## Conclusion

CVE-2025-64384 xuất phát từ việc **thiếu `permission_callback`** cho REST API `/ai/generate` trong JetFormBuilder <= 3.5.3, cho phép người dùng **không xác thực** gọi endpoint và lạm dụng tính năng tạo form bằng AI. Bản vá 3.5.4 đã buộc kiểm tra quyền bằng `current_user_can('edit_jet_fb_forms')`, giới hạn truy cập chỉ cho admin và loại bỏ khả năng khai thác.

## Key Takeaways

* Luôn khai báo `permission_callback` khi đăng ký REST API.
* Không dựa vào giới hạn logic nếu chưa có kiểm soát quyền truy cập.
* Kế thừa đúng base class có thể ngăn lỗi bảo mật nghiêm trọng.

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress JetFormBuilder Plugin <= 3.5.3 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/jetformbuilder/vulnerability/wordpress-jetformbuilder-plugin-3-5-3-broken-access-control-vulnerability)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-09-cve-2025-64384/  

