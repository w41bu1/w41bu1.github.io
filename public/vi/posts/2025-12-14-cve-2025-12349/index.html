<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="vi">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>CVE-2025-12349 Analysis &amp; POC - Bui Van Y</title><meta name="author" content="Bui Van Y">
<meta name="description" content="Security Vulnerability in WordPress Email Subscribers &amp; Newsletters Plugin."><meta name="keywords" content='analyst, plugin, broken access control'>
  <meta itemprop="name" content="CVE-2025-12349 Analysis & POC">
  <meta itemprop="description" content="Security Vulnerability in WordPress Email Subscribers &amp; Newsletters Plugin.">
  <meta itemprop="datePublished" content="2025-12-14T19:00:00+07:00">
  <meta itemprop="dateModified" content="2025-12-13T13:29:18+07:00">
  <meta itemprop="wordCount" content="2089">
  <meta itemprop="image" content="http://localhost:1313/posts/2025-12-14-cve-2025-12349/app.png">
  <meta itemprop="keywords" content="Analyst,Plugin,Broken Access Control"><meta property="og:url" content="http://localhost:1313/vi/posts/2025-12-14-cve-2025-12349/">
  <meta property="og:site_name" content="Bui Van Y">
  <meta property="og:title" content="CVE-2025-12349 Analysis & POC">
  <meta property="og:description" content="Security Vulnerability in WordPress Email Subscribers &amp; Newsletters Plugin.">
  <meta property="og:locale" content="vi">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-14T19:00:00+07:00">
    <meta property="article:modified_time" content="2025-12-13T13:29:18+07:00">
    <meta property="article:tag" content="Analyst">
    <meta property="article:tag" content="Plugin">
    <meta property="article:tag" content="Broken Access Control">
    <meta property="og:image" content="http://localhost:1313/posts/2025-12-14-cve-2025-12349/app.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/posts/2025-12-14-cve-2025-12349/app.png">
  <meta name="twitter:title" content="CVE-2025-12349 Analysis & POC">
  <meta name="twitter:description" content="Security Vulnerability in WordPress Email Subscribers &amp; Newsletters Plugin.">
<meta name="application-name" content="Bui Van Y">
<meta name="apple-mobile-web-app-title" content="Bui Van Y"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/svg-spinners--wind-toy.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/vi/posts/2025-12-14-cve-2025-12349/" title="CVE-2025-12349 Analysis &amp; POC - Bui Van Y" /><link rel="prev" type="text/html" href="http://localhost:1313/vi/posts/2025-12-13-cve-2025-12174/" title="CVE-2025-12174 Analysis &amp; POC" /><link rel="next" type="text/html" href="http://localhost:1313/vi/posts/2025-12-15-cve-2025-14508/" title="CVE-2025-14508 Analysis &amp; POC" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/vi/posts/2025-12-14-cve-2025-12349/index.md" title="CVE-2025-12349 Analysis & POC - Bui Van Y"><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "CVE-2025-12349 Analysis \u0026 POC",
    "inLanguage": "vi",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/vi\/posts\/2025-12-14-cve-2025-12349\/"
    },"image": ["http:\/\/localhost:1313\/images\/avatar.png"],"genre": "posts","keywords": "analyst, plugin, broken access control","wordcount":  2089 ,
    "url": "http:\/\/localhost:1313\/vi\/posts\/2025-12-14-cve-2025-12349\/","datePublished": "2025-12-14T19:00:00+07:00","dateModified": "2025-12-13T13:29:18+07:00","publisher": {
      "@type": "Organization",
      "name": "/images/avatar.png","logo": "http:\/\/localhost:1313\/images\/avatar.png"},"author": {
        "@type": "Person",
        "name": "Bui Van Y"
      },"description": "Security Vulnerability in WordPress Email Subscribers \u0026 Newsletters Plugin."
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-instant-intensity="viewport" data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/vi/" title="Bui Van Y"><img class="logo" src='/images/svg-spinners--wind-toy.svg' alt="Bui Van Y" height="32" width="32"><span class="header-title-text">Bui Van Y</span></a><span class="typeit header-subtitle"><template>w41bu1</template></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/vi/posts/"><i class="fa-solid fa-file-alt fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/vi/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/vi/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Tìm tiêu đề hoặc nội dung..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Tìm kiếm">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Xoá">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" role="button" aria-label="Đổi chủ đề" title="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></li><li class="menu-item language-switch">
            <span role="button" aria-label="Chọn Ngôn ngữ" title="Chọn Ngôn ngữ"><i class="fa-solid fa-language fa-fw" aria-hidden="true"></i></span>
            <ul class="sub-menu"><li class="menu-item"><a href="/posts/2025-12-14-cve-2025-12349/" class="menu-link" title="English">English</a></li><li class="menu-item"><span class="text-secondary" title="Vietnamese">Vietnamese</span></li></ul>
          </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/vi/" title="Bui Van Y"><img class="logo" src='/images/svg-spinners--wind-toy.svg' alt="Bui Van Y" height="26" width="26"><span class="header-title-text">Bui Van Y</span></a><span class="typeit header-subtitle"><template>w41bu1</template></span></div>
      <div class="theme-switch" role="button" aria-label="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></div>
      <div class="menu-toggle" id="menu-toggle-mobile" role="button" aria-labelledby="menu-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Tìm tiêu đề hoặc nội dung..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Tìm kiếm">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Xoá">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Huỷ
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/vi/posts/"><i class="fa-solid fa-file-alt fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item"><a class="menu-link" href="/vi/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="/vi/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system"><span class="menu-system-item language-switch">
              <span role="button" aria-label="Chọn Ngôn ngữ" title="Chọn Ngôn ngữ">Vietnamese<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i></span>
              <select id="language-select" class="language-select" onchange="location = this.value;"><option value="/posts/2025-12-14-cve-2025-12349/">English</option><option value="/vi/posts/2025-12-14-cve-2025-12349/" selected disabled>Vietnamese</option></select>
            </span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"><div class="details related-details open">
      <div class="details-summary related-summary">
        <i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden="true"></i>
        <span class="related-title">Nội dung liên quan</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
      <div class="details-content related-content">
        <ul class="related-list"><li class="related-item">
              <a href="/vi/posts/2025-12-16-cve-2025-13956/" title="CVE-2025-13956 Analysis &amp; POC">CVE-2025-13956 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-15-cve-2025-14508/" title="CVE-2025-14508 Analysis &amp; POC">CVE-2025-14508 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-13-cve-2025-12174/" title="CVE-2025-12174 Analysis &amp; POC">CVE-2025-12174 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-12-cve-2025-66072/" title="CVE-2025-66072 Analysis &amp; POC">CVE-2025-66072 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-11-cve-2025-11368/" title="CVE-2025-11368 Analysis &amp; POC">CVE-2025-11368 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-10-cve-2025-11815/" title="CVE-2025-11815 Analysis &amp; POC">CVE-2025-11815 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-09-cve-2025-64384/" title="CVE-2025-64384 Analysis &amp; POC">CVE-2025-64384 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-08-cve-2025-12887/" title="CVE-2025-12887 Analysis &amp; POC">CVE-2025-12887 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-07-cve-2025-11726/" title="CVE-2025-11726 Analysis &amp; POC">CVE-2025-11726 Analysis &amp; POC</a></li><li class="related-item">
              <a href="/vi/posts/2025-12-20-cve-2025-67985/" title="CVE-2025-67985 Analysis &amp; POC">CVE-2025-67985 Analysis &amp; POC</a></li></ul>
      </div>
    </div></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>CVE-2025-12349 Analysis &amp; POC</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="github.com/w41bu1" title="Tác giả" rel=" author" class="author"><img class="avatar" src='/images/avatar.png' alt="Bui Van Y" height="16" width="16">&nbsp;Bui Van Y</a></span><span class="post-included-in">&nbsp;trong <a href="/vi/categories/cve-analysis/" class="post-category" title="Danh mục - CVE Analysis"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> CVE Analysis</a></span></div><div class="post-meta-line"><span title="đăng ngày 2025-12-14 19:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-12-14">2025-12-14</time></span>&nbsp;<span title="Cập nhật ngày 2025-12-13 13:29:18"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2025-12-13">2025-12-13</time></span>&nbsp;<span title="2089 từ"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>Khoảng 2100 từ</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>10 phút</span>&nbsp;</div>
    </div><div class="featured-image"><img src='/posts/2025-12-14-cve-2025-12349/app.png' alt="/posts/2025-12-14-cve-2025-12349/app.png"></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Nội dung</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cve--basic-info">CVE &amp; Basic Info</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#analysis">Analysis</a></li>
    <li><a href="#flow">Flow</a></li>
    <li><a href="#proof-of-concept-poc">Proof of Concept (PoC)</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#key-takeaways">Key Takeaways</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 class="heading-element" id="cve--basic-info"><span>CVE &amp; Basic Info</span>
  <a href="#cve--basic-info" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Plugin <strong>Icegram Express – Email Subscribers, Newsletters and Marketing Automation</strong> cho <strong>WordPress</strong> bị <strong>lỗ hổng Authorization</strong> trong các phiên bản <strong>từ trước đến và bao gồm 5.9.10</strong>. Nguyên nhân là do plugin <strong>không xác thực đúng quyền của người dùng</strong> khi thực hiện hành động trong hàm <strong><code>trigger_mailing_queue_sending</code></strong>.
Điều này cho phép <strong>kẻ tấn công không cần xác thực (unauthenticated attackers)</strong> có thể <strong>ép hệ thống gửi email ngay lập tức</strong>, <strong>bỏ qua lịch gửi (schedule)</strong>, <strong>tăng tải máy chủ</strong>, và <strong>thay đổi trạng thái của plugin</strong> (ví dụ: <strong><code>last-cron-hit</code></strong>), từ đó <strong>tạo điều kiện cho hành vi lạm dụng hoặc các hiệu ứng giống DoS</strong>.</p>
<ul>
<li><strong>CVE ID</strong>: <a href="https://www.cve.org/CVERecord?id=CVE-2025-12349"target="_blank" rel="external nofollow noopener noreferrer">CVE-2025-12349</a></li>
<li><strong>Vulnerability Type</strong>: Broken Access Control</li>
<li><strong>Affected Versions</strong>: &lt;= 5.9.10</li>
<li><strong>Patched Versions</strong>: 5.9.11</li>
<li><strong>CVSS severity</strong>: Low (5.3)</li>
<li><strong>Required Privilege</strong>: Unauthenticated</li>
<li><strong>Product</strong>: <a href="https://wordpress.org/plugins/email-subscribers/"target="_blank" rel="external nofollow noopener noreferrer">WordPress Email Subscribers &amp; Newsletters Plugin</a></li>
</ul>
<h2 class="heading-element" id="requirements"><span>Requirements</span>
  <a href="#requirements" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li><strong>Local WordPress &amp; Debugging</strong>
<ul>
<li><a href="https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/"target="_blank" rel="external nofollow noopener noreferrer">Virtual Machine</a></li>
<li><a href="https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/"target="_blank" rel="external nofollow noopener noreferrer">Docker</a></li>
</ul>
</li>
<li><strong>Plugin Version</strong> - <strong>Email Subscribers &amp; Newsletters</strong>:
<ul>
<li><code>5.9.10</code> – <strong>vulnerable</strong></li>
<li><code>5.9.11</code> – <strong>patched</strong></li>
</ul>
</li>
<li><strong>Diff Tool (diff)</strong> → <a href="https://meldmerge.org/"target="_blank" rel="external nofollow noopener noreferrer"><strong>Meld</strong></a> hoặc bất kỳ công cụ diff nào.</li>
</ul>
<h2 class="heading-element" id="analysis"><span>Analysis</span>
  <a href="#analysis" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Plugin đăng ký <strong>action hook</strong> như sau:</p>
<div class="highlight" title="class-es-queue.php v5.9.10" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">add_action</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">array</span><span class="p">(</span> <span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;trigger_mailing_queue_sending&#39;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hook <strong><code>wp_ajax_nopriv_</code></strong> là cơ chế cho phép <strong>tất cả người dùng</strong>, bao gồm cả <strong>người dùng chưa đăng nhập</strong>, truy cập vào <strong>AJAX endpoint</strong> của WordPress.</p>
<p>Vì vậy, khi truy cập endpoint <strong><code>/wp-admin/admin-ajax.php</code></strong> với tham số:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">action=ig_es_trigger_mailing_queue_sending</span></span></code></pre></td></tr></table>
</div>
</div><p>WordPress sẽ <strong>gọi trực tiếp callback</strong> <strong><code>trigger_mailing_queue_sending</code></strong> mà <strong>không có bất kỳ kiểm tra xác thực hay phân quyền nào</strong>, dẫn đến việc <strong>bất kỳ ai</strong> cũng có thể kích hoạt <strong>logic gửi email qua cron</strong>, <strong>bỏ qua lịch gửi</strong>, và <strong>làm thay đổi trạng thái nội bộ của plugin</strong>.</p>
<div class="highlight" title="class-es-queue.php v5.9.10" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="hl"><span class="lnt">3
</span></span><span class="lnt">4
</span><span class="hl"><span class="lnt">5
</span></span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">trigger_mailing_queue_sending</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Call cron action only when it is not locked.
</span></span></span><span class="line hl"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cron</span><span class="o">-&gt;</span><span class="na">is_locked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Start processing of campaigns which are scheduled for current date time.
</span></span></span><span class="line hl"><span class="cl"><span class="c1"></span>        <span class="nx">do_action</span><span class="p">(</span> <span class="s1">&#39;ig_es_cron_worker&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hàm <strong><code>trigger_mailing_queue_sending()</code></strong> có nhiệm vụ <strong>kích hoạt tiến trình cron gửi email</strong> của plugin.</p>
<ul>
<li>Đầu tiên, hàm kiểm tra trạng thái <strong>lock</strong> của cron thông qua <strong><code>ES()-&gt;cron-&gt;is_locked()</code></strong>.</li>
<li>Nếu cron <strong>đang bị khóa</strong>, hàm sẽ <strong>không thực hiện gì</strong>, nhằm tránh việc nhiều tiến trình gửi email chạy song song.</li>
<li>Nếu cron <strong>chưa bị khóa</strong>, hàm sẽ gọi <strong><code>do_action( 'ig_es_cron_worker' )</code></strong>.</li>
</ul>
<p>2 callback đã được đăng ký cho action hook <code>ig_es_cron_worker</code>:</p>
<div class="highlight" title="class-es-queue.php v5.9.10" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">add_action</span><span class="p">(</span> <span class="s1">&#39;ig_es_cron_worker&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="o">&amp;</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;process_campaigns&#39;</span> <span class="p">),</span> <span class="mi">10</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">add_action</span><span class="p">(</span> <span class="s1">&#39;ig_es_cron_worker&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="o">&amp;</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;process_queue&#39;</span> <span class="p">),</span> <span class="mi">30</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hook này sẽ gọi callback theo thứ tự ưu tiên: <code>process_campaigns()</code> chạy trước và <code>process_queue()</code> chạy sau</p>
<div class="highlight" title="class-es-queue.php v5.9.10" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">process_campaigns</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cron</span><span class="o">-&gt;</span><span class="na">should_unlock</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cron</span><span class="o">-&gt;</span><span class="na">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cron</span><span class="o">-&gt;</span><span class="na">set_last_hit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$es_c_croncount</span> <span class="o">=</span> <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mailer</span><span class="o">-&gt;</span><span class="na">get_total_emails_send_now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nv">$es_c_croncount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$notification</span> <span class="o">=</span> <span class="nx">ES_DB_Mailing_Queue</span><span class="o">::</span><span class="na">get_notification_to_be_sent</span><span class="p">(</span> <span class="nv">$campaign_hash</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$notification_guid</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span> <span class="nv">$notification</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">?</span> <span class="nv">$notification</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$campaign_id</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span> <span class="nv">$notification</span><span class="p">[</span><span class="s1">&#39;campaign_id&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">?</span> <span class="nv">$notification</span><span class="p">[</span><span class="s1">&#39;campaign_id&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">is_null</span><span class="p">(</span> <span class="nv">$notification_guid</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nv">$cron_job</span> <span class="o">=</span> <span class="s1">&#39;ig_es_cron_worker&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">is_cron_job_locked</span><span class="p">(</span> <span class="nv">$cron_job</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nv">$locking_status</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_cron_job</span><span class="p">(</span> <span class="nv">$cron_job</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;locked&#39;</span> <span class="o">===</span> <span class="nv">$locking_status</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">ES_DB_Mailing_Queue</span><span class="o">::</span><span class="na">update_sent_status</span><span class="p">(</span> <span class="nv">$notification_guid</span><span class="p">,</span> <span class="s1">&#39;Sending&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nv">$emails_data</span> <span class="o">=</span> <span class="nx">ES_DB_Sending_Queue</span><span class="o">::</span><span class="na">get_emails_to_be_sent_by_hash</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$notification_guid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$es_c_croncount</span>
</span></span><span class="line"><span class="cl">                    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span> <span class="nx">count</span><span class="p">(</span> <span class="nv">$emails_data</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mailer</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">$notification</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">$notification</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">array_column</span><span class="p">(</span> <span class="nv">$emails_data</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="k">array</span><span class="p">(</span> <span class="s1">&#39;guid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$notification_guid</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span> <span class="nx">ES_DB_Sending_Queue</span><span class="o">::</span><span class="na">get_total_emails_to_be_sent_by_hash</span><span class="p">(</span> <span class="nv">$notification_guid</span> <span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">ES_DB_Mailing_Queue</span><span class="o">::</span><span class="na">update_sent_status</span><span class="p">(</span> <span class="nv">$notification_guid</span><span class="p">,</span> <span class="s1">&#39;Sent&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">unlock_cron_job</span><span class="p">(</span> <span class="nv">$cron_job</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Hàm <code>process_campaigns()</code>:</strong></p>
<ul>
<li>Mở khóa cron nếu cần và cập nhật thời điểm cron chạy.</li>
<li>Lấy <strong>giới hạn số email</strong> có thể gửi trong một lần chạy.</li>
<li>Lấy <strong>campaign đang chờ gửi</strong> từ <code>ig_es_mailing_queue</code>.</li>
<li>Kiểm tra và <strong>lock cron job</strong> để tránh chạy song song.</li>
<li>Chuyển trạng thái campaign sang <strong><code>Sending</code></strong>.</li>
<li>Lấy danh sách email cần gửi theo <strong>batch size</strong> từ <code>ig_es_sending_queue</code>.</li>
<li>Thực hiện <strong>gửi email hàng loạt</strong>.</li>
<li>Nếu đã gửi hết email, cập nhật trạng thái campaign sang <strong><code>Sent</code></strong>.</li>
<li>Cuối cùng <strong>unlock cron job</strong> để các lần chạy sau tiếp tục xử lý.</li>
</ul>
<div class="highlight" title="class-es-queue.php v5.9.10" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">process_queue</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cron</span><span class="o">-&gt;</span><span class="na">should_unlock</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cron</span><span class="o">-&gt;</span><span class="na">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cron</span><span class="o">-&gt;</span><span class="na">set_last_hit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$email_sending_limit</span> <span class="o">=</span> <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mailer</span><span class="o">-&gt;</span><span class="na">get_total_emails_send_now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nv">$email_sending_limit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$micro_time</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span> <span class="k">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$notifications</span> <span class="o">=</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">get_results</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$batch_start_time</span> <span class="o">=</span> <span class="nx">time</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="nx">is_array</span><span class="p">(</span> <span class="nv">$notifications</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">count</span><span class="p">(</span> <span class="nv">$notifications</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$contacts</span> <span class="o">=</span> <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contacts_db</span><span class="o">-&gt;</span><span class="na">get_details_by_ids</span><span class="p">(</span> <span class="nv">$contact_ids</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$campaigns_notifications</span> <span class="k">as</span> <span class="nv">$campaign_id</span> <span class="o">=&gt;</span> <span class="nv">$notifications</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$notifications</span> <span class="k">as</span> <span class="nv">$notification</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;optin_confirmation&#39;</span> <span class="o">===</span> <span class="nv">$notification_type</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="o">...</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span> <span class="s1">&#39;optin_welcome_email&#39;</span> <span class="o">===</span> <span class="nv">$notification_type</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="o">...</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="o">...</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nv">$email_sending_limit</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span> <span class="nv">$email_sent</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">delete_from_queue</span><span class="p">(</span> <span class="nv">$campaign_id</span><span class="p">,</span> <span class="nv">$contact_id</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$email_sending_limit</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">IG_ES_Background_Process_Helper</span><span class="o">::</span><span class="na">time_exceeded</span><span class="p">(</span> <span class="nv">$batch_start_time</span><span class="p">,</span> <span class="mf">0.8</span> <span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">IG_ES_Background_Process_Helper</span><span class="o">::</span><span class="na">memory_exceeded</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Hàm <code>process_queue()</code>:</strong></p>
<ul>
<li>Kiểm tra và mở khóa cron nếu cần, sau đó cập nhật thời điểm cron chạy lần cuối.</li>
<li>Xác định số lượng email tối đa có thể gửi trong một lần thực thi.</li>
<li>Truy vấn bảng <code>ig_queue</code> để lấy các email đã đến thời điểm gửi nhưng chưa được gửi.</li>
<li>Gom các bản ghi theo <code>campaign_id</code> và lấy thông tin contact tương ứng.</li>
<li>Với từng contact trong queue, xác định loại email và thực hiện gửi phù hợp.</li>
<li>Nếu gửi thành công, xóa bản ghi tương ứng khỏi queue.</li>
<li>Dừng xử lý khi đạt giới hạn gửi, gần hết thời gian thực thi hoặc vượt giới hạn bộ nhớ.</li>
</ul>
<div class="details admonition bug open disabled">
  <div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-bug" aria-hidden="true"></i>Lỗi</div>
  <div class="details-content">
    <div class="admonition-content"><p><strong>Lỗ hổng phát sinh do không thực hiện bất kỳ kiểm tra quyền (capability/permission) nào.</strong>
Hàm xử lý được gắn với hook <strong><code>wp_ajax_nopriv_</code></strong>, cho phép <strong>người dùng chưa đăng nhập</strong> gọi trực tiếp endpoint AJAX. Khi callback được thực thi, code <strong>không kiểm tra quyền người dùng</strong>, <strong>không xác thực nonce</strong>, dẫn đến việc <strong>bất kỳ ai</strong> cũng có thể kích hoạt logic nội bộ (cron gửi email), <strong>bỏ qua lịch gửi</strong>, và <strong>thay đổi trạng thái hệ thống</strong>.</p></div>
  </div>
</div><p><strong>Bản vá (v5.9.11)</strong> khắc phục lỗ hổng bằng cách <strong>bổ sung kiểm soát truy cập và xác thực yêu cầu</strong> trước khi cho phép kích hoạt cron gửi email.</p>
<div class="highlight" title="class-es-queue.php v5.9.10" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="hl"><span class="lnt"> 3
</span></span><span class="lnt"> 4
</span><span class="hl"><span class="lnt"> 5
</span></span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">trigger_mailing_queue_sending</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$can_access_campaign</span> <span class="o">=</span> <span class="nx">ES_Common</span><span class="o">::</span><span class="na">ig_es_can_access</span><span class="p">(</span> <span class="s1">&#39;campaigns&#39;</span> <span class="p">);</span>
</span></span><span class="line hl"><span class="cl">    <span class="nv">$nonce</span> <span class="o">=</span> <span class="nx">ig_es_get_request_data</span><span class="p">(</span> <span class="s1">&#39;nonce&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line hl"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$can_access_campaign</span> <span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="k">empty</span><span class="p">(</span> <span class="nv">$nonce</span> <span class="p">)</span> <span class="o">||</span> <span class="o">!</span> <span class="nx">wp_verify_nonce</span><span class="p">(</span> <span class="nv">$nonce</span><span class="p">,</span> <span class="s1">&#39;ig-es-trigger-mailing-queue-sending-nonce&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="c1">// Call cron action only when it is not locked.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">ES</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cron</span><span class="o">-&gt;</span><span class="na">is_locked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>		
</span></span><span class="line"><span class="cl">        <span class="c1">// Start processing of campaigns which are scheduled for current date time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">do_action</span><span class="p">(</span> <span class="s1">&#39;ig_es_cron_worker&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>Kiểm tra quyền (capability check)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$can_access_campaign</span> <span class="o">=</span> <span class="nx">ES_Common</span><span class="o">::</span><span class="na">ig_es_can_access</span><span class="p">(</span> <span class="s1">&#39;campaigns&#39;</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Chỉ người dùng có quyền truy cập <strong>campaigns</strong> mới được phép tiếp tục. Nếu không có quyền → <strong>return</strong> ngay.</p>
<div class="highlight" title="class-es-common.php v5.9.11" data-open="true"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="hl"><span class="lnt"> 4
</span></span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="hl"><span class="lnt"> 8
</span></span><span class="lnt"> 9
</span><span class="hl"><span class="lnt">10
</span></span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">ig_es_can_access</span><span class="p">(</span> <span class="nv">$page</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$user</span> <span class="o">=</span> <span class="nx">wp_get_current_user</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">exists</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="nv">$default_permission</span> <span class="o">=</span> <span class="s1">&#39;manage_options&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="nv">$can_access</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">has_cap</span><span class="p">(</span> <span class="nv">$default_permission</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Is Admin? Have full access.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span> <span class="nv">$can_access</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// We are using this filter in ES Premium to check permission.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">apply_filters</span><span class="p">(</span> <span class="s1">&#39;ig_es_can_access&#39;</span><span class="p">,</span> <span class="nv">$can_access</span><span class="p">,</span> <span class="nv">$page</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Hàm <strong><code>ig_es_can_access()</code></strong> dùng để kiểm tra quyền truy cập của người dùng hiện tại. Nếu người dùng <strong>chưa đăng nhập</strong> thì bị từ chối ngay. Mặc định, chỉ những user có quyền <strong><code>manage_options</code></strong> (Administrator) mới được phép truy cập. Trường hợp không có quyền này, kết quả sẽ phụ thuộc vào <strong>filter <code>ig_es_can_access</code></strong> để cho phép mở rộng hoặc tùy chỉnh quyền.</p>
</li>
<li>
<p><strong>Xác thực nonce (CSRF protection)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$nonce</span> <span class="o">=</span> <span class="nx">ig_es_get_request_data</span><span class="p">(</span> <span class="s1">&#39;nonce&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">wp_verify_nonce</span><span class="p">(</span> <span class="nv">$nonce</span><span class="p">,</span> <span class="s1">&#39;ig-es-trigger-mailing-queue-sending-nonce&#39;</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Đảm bảo request là hợp lệ và được tạo từ giao diện hợp pháp của WordPress, ngăn việc gọi trực tiếp từ bên ngoài.</p>
</li>
<li>
<p><strong>Giữ nguyên logic cũ nhưng đặt sau kiểm tra bảo mật</strong>
Chỉ sau khi <strong>đã qua kiểm tra quyền và nonce</strong>, hàm mới kiểm tra <strong>cron lock</strong> và gọi:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">do_action</span><span class="p">(</span> <span class="s1">&#39;ig_es_cron_worker&#39;</span> <span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>👉 Kết quả: endpoint AJAX <strong>không còn bị lạm dụng bởi người dùng chưa đăng nhập</strong>, ngăn việc <strong>ép gửi email</strong>, <strong>bỏ qua lịch</strong>, và <strong>DoS-like behavior</strong> như trước.</p>
<h2 class="heading-element" id="flow"><span>Flow</span>
  <a href="#flow" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="diagram-container">
  <pre class="mermaid">
graph TD

A["Unauthenticated attacker"] --> B["Send request to /wp-admin/admin-ajax.php?action=ig_es_trigger_mailing_queue_sending"]
B --> C["wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending hook"]
C --> D["trigger_mailing_queue_sending() is executed"]
D --> E{"Capability check?"}
E -- No --> F["No permission validation"]
F --> G{"Nonce verification?"}
G -- No --> H["No CSRF protection"]
H --> I{"Cron locked?"}
I -- No --> J["do_action('ig_es_cron_worker')"]
J --> K["process_campaigns()"]
J --> L["process_queue()"]
K --> M["Force email campaigns to send immediately"]
L --> N["Force queued emails to be sent"]
M --> O["Bypass schedule & update campaign states"]
N --> O
O --> P["Broken Access Control / Abuse / DoS-like behavior"]
</pre>
  <pre class="mermaid-dark">
graph TD

A["Unauthenticated attacker"] --> B["Send request to /wp-admin/admin-ajax.php?action=ig_es_trigger_mailing_queue_sending"]
B --> C["wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending hook"]
C --> D["trigger_mailing_queue_sending() is executed"]
D --> E{"Capability check?"}
E -- No --> F["No permission validation"]
F --> G{"Nonce verification?"}
G -- No --> H["No CSRF protection"]
H --> I{"Cron locked?"}
I -- No --> J["do_action('ig_es_cron_worker')"]
J --> K["process_campaigns()"]
J --> L["process_queue()"]
K --> M["Force email campaigns to send immediately"]
L --> N["Force queued emails to be sent"]
M --> O["Bypass schedule & update campaign states"]
N --> O
O --> P["Broken Access Control / Abuse / DoS-like behavior"]
</pre>
  <pre class="mermaid-neutral">
graph TD

A["Unauthenticated attacker"] --> B["Send request to /wp-admin/admin-ajax.php?action=ig_es_trigger_mailing_queue_sending"]
B --> C["wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending hook"]
C --> D["trigger_mailing_queue_sending() is executed"]
D --> E{"Capability check?"}
E -- No --> F["No permission validation"]
F --> G{"Nonce verification?"}
G -- No --> H["No CSRF protection"]
H --> I{"Cron locked?"}
I -- No --> J["do_action('ig_es_cron_worker')"]
J --> K["process_campaigns()"]
J --> L["process_queue()"]
K --> M["Force email campaigns to send immediately"]
L --> N["Force queued emails to be sent"]
M --> O["Bypass schedule & update campaign states"]
N --> O
O --> P["Broken Access Control / Abuse / DoS-like behavior"]
</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone" aria-hidden="true"></i><i class="fa-solid fa-check text-success" aria-hidden="true"></i></div>
<template><pre>
graph TD

A["Unauthenticated attacker"] --> B["Send request to /wp-admin/admin-ajax.php?action=ig_es_trigger_mailing_queue_sending"]
B --> C["wp_ajax_nopriv_ig_es_trigger_mailing_queue_sending hook"]
C --> D["trigger_mailing_queue_sending() is executed"]
D --> E{"Capability check?"}
E -- No --> F["No permission validation"]
F --> G{"Nonce verification?"}
G -- No --> H["No CSRF protection"]
H --> I{"Cron locked?"}
I -- No --> J["do_action('ig_es_cron_worker')"]
J --> K["process_campaigns()"]
J --> L["process_queue()"]
K --> M["Force email campaigns to send immediately"]
L --> N["Force queued emails to be sent"]
M --> O["Bypass schedule & update campaign states"]
N --> O
O --> P["Broken Access Control / Abuse / DoS-like behavior"]
</pre></template>
</div>
<h2 class="heading-element" id="proof-of-concept-poc"><span>Proof of Concept (PoC)</span>
  <a href="#proof-of-concept-poc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Gưi request với Unauthenticated user:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/wp-admin/admin-ajax.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">localhost</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="g">action=ig_es_trigger_mailing_queue_sending</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 class="heading-element" id="conclusion"><span>Conclusion</span>
  <a href="#conclusion" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>CVE-2025-12349 xuất phát từ việc plugin Icegram Express đăng ký AJAX endpoint với <code>wp_ajax_nopriv_</code> nhưng không thực hiện bất kỳ kiểm tra quyền hay xác thực nonce nào trong hàm <code>trigger_mailing_queue_sending</code>. Điều này cho phép người dùng chưa đăng nhập kích hoạt trực tiếp cron nội bộ của plugin, dẫn đến việc ép gửi email, bỏ qua lịch gửi, cập nhật trạng thái campaign và gây áp lực không cần thiết lên hệ thống. Bản vá ở phiên bản 5.9.11 đã khắc phục triệt để vấn đề bằng cách bổ sung kiểm tra capability và xác thực nonce trước khi cho phép thực thi logic cron.</p>
<h2 class="heading-element" id="key-takeaways"><span>Key Takeaways</span>
  <a href="#key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>Không bao giờ gắn logic nhạy cảm vào <code>wp_ajax_nopriv_</code> mà thiếu kiểm tra quyền.</li>
<li>AJAX endpoint trong WordPress luôn phải kết hợp <strong>capability check</strong> và <strong>nonce verification</strong>.</li>
<li>Cron hoặc background process có tác động hệ thống cần được bảo vệ như các hành động quản trị.</li>
<li>Broken Access Control có thể dẫn đến lạm dụng chức năng ngay cả khi không rò rỉ dữ liệu trực tiếp.</li>
</ul>
<h2 class="heading-element" id="references"><span>References</span>
  <a href="#references" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/"target="_blank" rel="external nofollow noopener noreferrer">Broken Access Control</a></p>
<p><a href="https://patchstack.com/database/wordpress/plugin/email-subscribers/vulnerability/wordpress-email-subscribers-newsletters-plugin-5-9-10-missing-authentication-to-unauthenticated-mailing-queue-trigger-vulnerability"target="_blank" rel="external nofollow noopener noreferrer">WordPress Email Subscribers &amp; Newsletters Plugin &lt;= 5.9.10 is vulnerable to Broken Access Control</a></p></div><hr class="awesome-hr" />
    <h2 id="see-also">Nội dung liên quan</h2>
    <ul><li>
          <a href="/vi/posts/2025-12-16-cve-2025-13956/" title="CVE-2025-13956 Analysis &amp; POC">CVE-2025-13956 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-15-cve-2025-14508/" title="CVE-2025-14508 Analysis &amp; POC">CVE-2025-14508 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-13-cve-2025-12174/" title="CVE-2025-12174 Analysis &amp; POC">CVE-2025-12174 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-12-cve-2025-66072/" title="CVE-2025-66072 Analysis &amp; POC">CVE-2025-66072 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-11-cve-2025-11368/" title="CVE-2025-11368 Analysis &amp; POC">CVE-2025-11368 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-10-cve-2025-11815/" title="CVE-2025-11815 Analysis &amp; POC">CVE-2025-11815 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-09-cve-2025-64384/" title="CVE-2025-64384 Analysis &amp; POC">CVE-2025-64384 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-08-cve-2025-12887/" title="CVE-2025-12887 Analysis &amp; POC">CVE-2025-12887 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-07-cve-2025-11726/" title="CVE-2025-11726 Analysis &amp; POC">CVE-2025-11726 Analysis &amp; POC</a></li><li>
          <a href="/vi/posts/2025-12-20-cve-2025-67985/" title="CVE-2025-67985 Analysis &amp; POC">CVE-2025-67985 Analysis &amp; POC</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="Cập nhật ngày 2025-12-13 13:29:18">Cập nhật ngày 2025-12-13&nbsp;<a class="git-hash" href="https://github.com/w41bu1/w41bu1.github.io/commit/1c5baf21eabec5b7a97be4031fd5dae730cfae2a" rel="external nofollow noopener noreferrer" target="_blank" title="Add post 2025-12-14-CVE-2025-12349&#10&#10Commit: 1c5baf21eabec5b7a97be4031fd5dae730cfae2a [1c5baf2]&#10Author: w41bu1&#10Date: 2025-12-13 13:29:18"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i>1c5baf2</a></span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/vi/posts/2025-12-14-cve-2025-12349/index.md" title="Đọc với định dạng Markdown" class="link-to-markdown">Đọc với định dạng Markdown</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/blob/main/content/posts%5c2025-12-14-CVE-2025-12349%5cindex.vi.md?plain=1" title="Xem mã nguồn"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-source">Xem mã nguồn</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/edit/main/content/posts%5c2025-12-14-CVE-2025-12349%5cindex.vi.md" title="Chỉnh sửa trang này"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-edit">Chỉnh sửa trang này</a></span><span><a href="https://github.com/w41bu1/w41bu1.github.io/issues/new?title=[BUG]%20CVE-2025-12349&#43;Analysis&#43;%26&#43;POC&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cCVE-2025-12349&#43;Analysis&#43;%26&#43;POC%7c%0A%7cURL%7chttp://localhost:1313/vi/posts/2025-12-14-cve-2025-12349/%7c%0A%7cFilename%7chttps://github.com/w41bu1/w41bu1.github.io/blob/main/content/posts%5c2025-12-14-CVE-2025-12349%5cindex.vi.md?plain=1%7c" title="Báo cáo lỗi"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-report">Báo cáo lỗi</a></span><span><a href="vscode://file/D:%5cProject%5cw41bu1.github.io%5ccontent%5cposts%5c2025-12-14-CVE-2025-12349%5cindex.vi.md" title="Mở trong trình chỉnh sửa"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-vscode">Mở trong trình chỉnh sửa</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Chia sẻ trên X" data-sharer="twitter" data-url="http://localhost:1313/vi/posts/2025-12-14-cve-2025-12349/" data-title="CVE-2025-12349 Analysis &amp; POC" data-hashtags="analyst,plugin,broken access control"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Facebook" data-sharer="facebook" data-url="http://localhost:1313/vi/posts/2025-12-14-cve-2025-12349/" data-hashtag="analyst"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Linkedin" data-sharer="linkedin" data-url="http://localhost:1313/vi/posts/2025-12-14-cve-2025-12349/"><i class="fa-brands fa-linkedin fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Chia sẻ trên Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/vi/posts/2025-12-14-cve-2025-12349/" data-title="CVE-2025-12349 Analysis &amp; POC"><i class="fa-brands fa-hacker-news fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/vi/tags/analyst/" class="post-tag" title="Nhãn - Analyst">Analyst</a><a href="/vi/tags/plugin/" class="post-tag" title="Nhãn - Plugin">Plugin</a><a href="/vi/tags/broken-access-control/" class="post-tag" title="Nhãn - Broken Access Control">Broken Access Control</a></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">Quay lại</a></span>&nbsp;|&nbsp;<span><a href="/vi/">Trang chủ</a></span>
    </section>
  </div><div class="post-nav"><a href="/vi/posts/2025-12-13-cve-2025-12174/" class="post-nav-item" rel="prev" title="CVE-2025-12174 Analysis &amp; POC"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>CVE-2025-12174 Analysis &amp; POC</a><a href="/vi/posts/2025-12-15-cve-2025-14508/" class="post-nav-item" rel="next" title="CVE-2025-14508 Analysis &amp; POC">CVE-2025-14508 Analysis &amp; POC<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Nội dung"><h2 class="toc-title">Nội dung&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside><dialog id="toc-dialog" aria-labelledby="toc-dialog-title" role="dialog">
      <div class="toc">
        <h2 class="toc-title">Nội dung</h2>
        <div class="toc-content" id="toc-content-drawer"><nav >
  <ul>
    <li><a href="#cve--basic-info">CVE &amp; Basic Info</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#analysis">Analysis</a></li>
    <li><a href="#flow">Flow</a></li>
    <li><a href="#proof-of-concept-poc">Proof of Concept (PoC)</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#key-takeaways">Key Takeaways</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div>
    </dialog></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="github.com/w41bu1">Bui Van Y</a></span><span class="license footer-divider">w41bu1</span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='Tổng khách truy cập'><i class="fa-regular fa-user fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='Tổng lượt truy cập'><i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div><div class="footer-line beian"><span class="gov"><i class="fa-solid fa-user-secret"></i></span><span class="icp footer-divider"><i class="fa-solid fa-bug"></i></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons"><div class="fixed-button back-to-top animate__faster d-none" role="button" aria-label="Lên trên"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><svg viewBox="0 0 100 100">
              <circle class="bg" cx="50" cy="50" r="50"></circle>
              <circle class="progress" cx="50" cy="50" r="50"></circle>
            </svg></div><div id="toc-drawer-button" class="fixed-button toc-drawer-button d-none" role="button" aria-label="Nội dung"><i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Trang web này hoạt động tốt nhất khi JavaScript được kích hoạt.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script src="/vi/js/config/cb82c7acbf337b4b0e884a3a842737b1.js" defer></script><script src="/js/lib/mermaid.js" type="module"></script><script src="/js/theme.min.js" defer></script><script src="/js/flyfish.min.js" defer></script></body>
</html>
