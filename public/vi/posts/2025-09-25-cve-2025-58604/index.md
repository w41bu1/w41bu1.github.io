# CVE-2025-58604 Analysis & POC


<!--more-->

Lỗ hổng xảy ra trên plugin **Mail Mint** của WordPress trước phiên bản **1.18.6**. Điều này có thể cho phép kẻ tấn công trực tiếp tương tác với cơ sở dữ liệu của bạn, bao gồm không giới hạn ở việc đánh cắp thông tin.

* **CVE ID**: [CVE-2025-58604](https://www.cve.org/CVERecord?id=CVE-2025-58604)
* **Product**: [WordPress Mail Mint Plugin](https://wordpress.org/plugins/mail-mint/)
* **Vulnerability Type**: SQL Injection
* **Affected Versions**: <= 1.18.5
* **CVSS severity**: Low (7.6)
* **Required Privilege**: Administrator

## Requirements

* **Local WordPress & Debugging**: [Local WordPress and Debugging](https://w41bu1.github.io/2025-08-21-wordpress-local-and-debugging/).
* **Mail Mint**:  v1.18.5(vul) và v1.18.6(fix)
* **diff tool**: **meld** hoặc bất cứ tool nào có thể compare để thấy được sự khác biệt giữa 2 version

## Analysis

Ứng dụng đã đưa trực tiếp dữ liệu từ người dùng vào câu query SQL mà **không sử dụng các biện pháp bảo vệ** khiến lỗ hổng SQL Injection xảy ra.

### Patch Diff

Dùng diff tool bất kì để so sánh sự khác biệt giữa bản lỗi và bản vá.
Có sự khác biệt rõ ở file **/app/Utilities/Helper/Import.php**

```php
public static function get_wp_users_by_learndash_with_limit_offset($courses, $number = 5, $offset = 0)
{
    // other logic

    global $wpdb;
    $total_query = "SELECT COUNT(DISTINCT user_id) as total
                    FROM {$wpdb->prefix}usermeta
                    WHERE meta_key IN ('" . implode("', '", $keys) . "')";

    $total = $wpdb->get_var($total_query); //phpcs:ignore

    // Final query to retrieve user IDs with limit and offset.
    $final_query = "SELECT user_id
                    FROM {$wpdb->prefix}usermeta
                    WHERE meta_key IN ('" . implode("', '", $keys) . "')
                    GROUP BY user_id
                    LIMIT $number OFFSET $offset";

    $users = $wpdb->get_results($final_query, ARRAY_A); //phpcs:ignore

    // other logic
}
```

Bản vá sử dụng `$wpdb->prepare()` thay vì truyền trực tiếp dữ liệu từ người dùng vào câu query.

```php
public static function get_wp_users_by_learndash_with_limit_offset($courses, $number = 5, $offset = 0)
{
    // other logic

    global $wpdb;
    // Total query (safe with prepare)
    $total_query = $wpdb->prepare(
        "SELECT COUNT(DISTINCT user_id) as total
        FROM {$wpdb->usermeta}
        WHERE meta_key IN ($placeholders)",
        $keys
    );

    $total = $wpdb->get_var($total_query); //phpcs:ignore

    // Final query with LIMIT & OFFSET (safe with prepare)
    $final_query = $wpdb->prepare(
        "SELECT user_id
        FROM {$wpdb->usermeta}
        WHERE meta_key IN ($placeholders)
        GROUP BY user_id
        LIMIT %d OFFSET %d",
        array_merge($keys, array($number, $offset))
    );

    $users = $wpdb->get_results($final_query, ARRAY_A); //phpcs:ignore

    // other logic
}
```

{{< figure src="diff.png" caption="Patch Diff" alt="Patch Diff" >}}

### How it work?

Lỗ hổng nằm trong hàm `get_wp_users_by_learndash_with_limit_offset($courses, $number = 5, $offset = 0)` của class `Import`. Để xác định nơi nó được gọi, ta tìm kiếm với tự khóa `get_wp_users_by_learndash_with_limit_offset` trong thư mục chứa plugin.

{{< figure src="search_import.png" caption="Search Import" alt="Search Import" >}}

Kết quả cho thấy hàm này được gọi trong:

* `retrieve_contacts_associated_with_learndash()`
* `perform_learndash_user_import()`

thuộc class `ContactImportAction` trong file **/app/API/Actions/Admin/Contact/ContactImportAction.php**.

Tiếp theo, để xác định nơi `retrieve_contacts_associated_with_learndash()` được sử dụng, ta tìm kiếm từ khóa `retrieve_contacts_associated_with_learndash` trong thư mục plugin.

{{< figure src="search_1.png" caption="Search 1" alt="Search 1" >}}

Hàm này được gọi trong `map_contacts_with_learndash()` thuộc class `ContactImportController` trong file **/app/API/Controllers/Admin/Contact/ContactImportController.php**.

Tiếp tục tìm kiếm từ khóa `map_contacts_with_learndash` để xem hàm này được đăng ký ở đâu:

{{< figure src="search_2.png" caption="Search 2" alt="Search 2" >}}

Ta phát hiện rằng nó được dùng làm callback của REST API thông qua hàm `register_rest_route()` trong WordPress:

```php
class ContactImportRoute extends AdminRoute {
    public function register_routes() {
        register_rest_route(
            $this->namespace, // mrm/v1
            $this->rest_base . '/learndash/map', // contacts/import/learndash/map/
            array(
                array(
                    'methods'             => WP_REST_Server::CREATABLE, // POST
                    'callback'            => array( $this->controller, 'map_contacts_with_learndash' ),
                    'permission_callback' => PermissionManager::current_user_can('mint_manage_contacts'), // Admin
                    'args'                => array(
                        'selectedCourses' => array(
                            'description' 		=> __( 'The selected courses from which to import contacts.', 'mrm' ),
                            'required'    		=> true,
                            'type'              => 'array',
                            'sanitize_callback' => 'rest_sanitize_array',
                            )
                        ), // array + required
                ),
            )
        );
        // other logic
    }
    // other logic
}
```

**Luồng gọi hàm**:

1. `POST /wp-json/mrm/v1/contacts/import/learndash/map` được gửi tới REST API cùng tham số bắt buộc `selectedCourses`.
2. `map_contacts_with_learndash(WP_REST_Request $request)` là callback được gọi:

* Nhận `$request` làm tham số đầu vào.
* Lấy các tham số của `$request` chuyển thành mảng `$params`

3. Callback gọi `retrieve_contacts_associated_with_learndash()` với đối số là `$params`.
4. `retrieve_contacts_associated_with_learndash()` gọi `get_wp_users_by_learndash_with_limit_offset($courses, $number = 5, $offset = 0)`:

* `$courses` = `$params['selectedCourses']`, `$number` = `5`
* `$keys` là một mảng được tạo ra bằng cách lấy tất cả giá trị `value` trong `$courses`, sau đó ghép chuỗi theo mẫu `course_{COURSE_ID}_access_from`
* Trước khi đưa vào câu query, mảng `$keys` được nối thành một chuỗi bằng hàm `implode()`. Nếu `$keys` chỉ có một phần tử, kết quả của `implode()` chính là giá trị chuỗi của phần tử đó.

5. Thực thi query, trả về JSON chứa `formatted_users` + `total_users`

## Exploit

Sau khi phân tích, ta thấy tham số `selectedCourses` được xử lý qua nhiều logic trước khi truyền vào query chứa SQLi, quan trọng ta vẫn kiểm soát được giá trị của key `value`.

**POST request qua BurpSuite**:
Ta gửi request với một key duy nhất => dễ dàng kiểm soát câu query.

{{< figure src="request_success.png" caption="Get all user info" alt="Get all user info" >}}

Khi đó, câu query trở thành:

```sql
SELECT user_id 
FROM wp_usermeta 
WHERE meta_key IN ('course_abc') OR 1=1 -- _access_from') GROUP BY user_id LIMIT 5 OFFSET 0
```

* `')` thoát khỏi `IN`
* `1=1` luôn đúng => trả về tất cả `user_id` trong `wp_usermeta`

Đoạn code còn lại trong `get_wp_users_by_learndash_with_limit_offset` sẽ truy vấn meta thông tin của tất cả user trả về:

```php
$formatted_users = array_map(
    function ($user) {
        $user->usermeta = array_map(
            function ($user_data) {
                return reset($user_data);
            },
            get_user_meta($user->ID)
        );
        return $user;
    },
    $contacts
);
```

## Conclusion

Lỗ hổng **CVE-2025-58604** trong plugin WordPress **Mail Mint** trước phiên bản **1.18.6** xuất phát từ việc không sử dụng cơ chế chuẩn bị truy vấn `($wpdb->prepare)` mà truyền trực tiếp dữ liệu từ người dùng vào câu lệnh SQL dẫn đến lỗ hổng SQL Injection.

Bản vá chính thức đã thay thế việc nối chuỗi bằng cách dùng `$wpdb->prepare`, giúp đảm bảo dữ liệu đầu vào được kiểm soát và an toàn hơn.

**Key takeaways**:

* Luôn sử dụng `$wpdb->prepare()` khi làm việc với database trong WordPress để tránh SQL Injection.
* Thường xuyên cập nhật plugin và kiểm tra bảo mật để tránh trở thành mục tiêu tấn công.

## References

[SQL Injection cheat sheet - PortSwigger](https://portswigger.net/web-security/sql-injection/cheat-sheet)

[WordPress Mail Mint Plugin <= 1.18.5 is vulnerable to SQL Injection](https://patchstack.com/database/wordpress/plugin/mail-mint/vulnerability/wordpress-mail-mint-plugin-1-18-5-sql-injection-vulnerability)


---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-09-25-cve-2025-58604/  

